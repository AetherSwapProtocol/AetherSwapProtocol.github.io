<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Swap Solana fonctionnel</title>
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
<style>
  body { background:#121212; color:#eee; font-family:sans-serif; padding:20px; }
  button { padding:10px 20px; margin:10px 0; }
  select, input { width: 100%; padding: 10px; margin:5px 0 15px; border-radius:6px; border:none; }
</style>
</head>
<body>

<h1>Swap Solana simple</h1>

<button id="connectWalletBtn">Connect Wallet</button>
<p id="walletAddress">Wallet non connecté</p>

<label>Token A</label>
<select id="tokenASelect"></select>
<label>Montant Token A</label>
<input type="number" id="amountInput" placeholder="Montant à swap" min="0" step="any" />

<label>Token B</label>
<select id="tokenBSelect"></select>

<button id="swapBtn" disabled>Swap</button>

<p id="status"></p>

<script>
  const connectBtn = document.getElementById('connectWalletBtn');
  const walletAddressP = document.getElementById('walletAddress');
  const tokenASelect = document.getElementById('tokenASelect');
  const tokenBSelect = document.getElementById('tokenBSelect');
  const amountInput = document.getElementById('amountInput');
  const swapBtn = document.getElementById('swapBtn');
  const statusP = document.getElementById('status');

  let walletPublicKey = null;
  let tokens = [];

  async function loadTokens() {
    try {
      const res = await fetch('https://quote-api.jup.ag/v6/tokens');
      const data = await res.json();
      tokens = data.tokens || data;
      for (const token of tokens) {
        const optionA = document.createElement('option');
        optionA.value = token.address;
        optionA.textContent = token.symbol;
        tokenASelect.appendChild(optionA);

        const optionB = document.createElement('option');
        optionB.value = token.address;
        optionB.textContent = token.symbol;
        tokenBSelect.appendChild(optionB);
      }
    } catch (e) {
      statusP.textContent = 'Erreur chargement tokens';
    }
  }

  connectBtn.onclick = async () => {
    if (window.solana && window.solana.isPhantom) {
      try {
        const resp = await window.solana.connect();
        walletPublicKey = resp.publicKey;
        walletAddressP.textContent = 'Connecté : ' + walletPublicKey.toString();
        swapBtn.disabled = false;
        statusP.textContent = '';
      } catch {
        statusP.textContent = 'Connexion annulée';
      }
    } else {
      alert('Phantom Wallet non détecté');
    }
  };

  swapBtn.onclick = async () => {
    if (!walletPublicKey) {
      alert('Connecte ton wallet');
      return;
    }
    const inputMint = tokenASelect.value;
    const outputMint = tokenBSelect.value;
    const amount = parseFloat(amountInput.value);

    if (!inputMint || !outputMint || isNaN(amount) || amount <= 0) {
      alert('Token ou montant invalide');
      return;
    }

    statusP.textContent = 'Obtention de la transaction...';

    // Trouver le decimals du token A
    const tokenA = tokens.find(t => t.address === inputMint);
    const decimals = tokenA ? tokenA.decimals : 6;

    try {
      const swapResponse = await fetch('https://quote-api.jup.ag/v6/swap', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userPublicKey: walletPublicKey.toString(),
          inputMint,
          outputMint,
          amount: Math.floor(amount * Math.pow(10, decimals)),
          slippageBps: 100,
          swapMode: 'ExactIn',
        }),
      });

      const swapJson = await swapResponse.json();

      if (!swapJson.swapTransaction) {
        statusP.textContent = 'Erreur: transaction swap introuvable';
        return;
      }

      const transaction = solanaWeb3.Transaction.from(
        Uint8Array.from(atob(swapJson.swapTransaction), c => c.charCodeAt(0))
      );

      const signedTx = await window.solana.signAndSendTransaction(transaction);

      statusP.innerHTML = `Swap envoyé! <a href="https://solscan.io/tx/${signedTx}" target="_blank" style="color:#4caf50;">Voir sur Solscan</a>`;
    } catch (e) {
      statusP.textContent = 'Erreur lors du swap: ' + (e.message || e);
      console.error(e);
    }
  };

  loadTokens();
</script>
</body>
</html>