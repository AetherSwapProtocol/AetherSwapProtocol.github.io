<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mon DEX Solana</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.75.1/lib/index.iife.js"></script>
</head>
<body class="bg-[#0B0B1F] text-white font-sans">

  <!-- Header -->
  <header class="p-4 bg-[#1A1A40] flex justify-between items-center">
    <h1 class="text-xl font-bold">Mon DEX</h1>
    <button id="connect-btn" class="bg-gradient-to-r from-cyan-500 to-blue-500 px-4 py-2 rounded-lg">Connect Wallet</button>
  </header>

  <!-- Graph -->
  <section class="max-w-xl mx-auto mt-6 bg-[#111827] p-4 rounded-lg">
    <h2 class="text-lg mb-2">Prix SOL/USDC</h2>
    <canvas id="priceChart" height="100"></canvas>
  </section>

  <!-- Swap -->
  <main class="max-w-xl mx-auto mt-6 p-6 bg-[#111827] rounded-lg">
    <div class="mb-4">
      <label class="block mb-1">From</label>
      <div class="flex">
        <select id="from-token" class="bg-gray-800 p-2 rounded-l w-24">
          <option value="SOL">SOL</option>
        </select>
        <input id="from-amount" type="number" placeholder="0.0" class="bg-gray-800 p-2 flex-1 rounded-r text-right">
      </div>
    </div>

    <div class="mb-4">
      <label class="block mb-1">To</label>
      <div class="flex">
        <select id="to-token" class="bg-gray-800 p-2 rounded-l w-24">
          <option value="USDC">USDC</option>
        </select>
        <input id="to-amount" type="number" placeholder="0.0" class="bg-gray-800 p-2 flex-1 rounded-r text-right" disabled>
      </div>
      <p class="text-sm text-gray-400 mt-2" id="rate-info"></p>
    </div>

    <button id="swap-button" class="w-full bg-gradient-to-r from-purple-500 to-blue-500 py-3 rounded-lg font-semibold hover:opacity-90">
      Swap
    </button>
  </main>

  <!-- JS -->
  <script>
    const getMint = (token) => ({
      SOL: 'So11111111111111111111111111111111111111112',
      USDC: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'
    })[token];

    let wallet = null;

    document.getElementById('connect-btn').onclick = async () => {
      const provider = window.phantom?.solana;
      if (!provider) return alert("Phantom Wallet not found.");
      const resp = await provider.connect();
      wallet = resp.publicKey;
      alert("Connecté : " + wallet.toString());
    };

    document.getElementById('from-amount').addEventListener('input', async () => {
      const amount = parseFloat(document.getElementById('from-amount').value);
      const from = document.getElementById('from-token').value;
      const to = document.getElementById('to-token').value;
      if (!amount || from === to) return;
      try {
        const quoteUrl = `https://quote-api.jup.ag/v6/quote?inputMint=${getMint(from)}&outputMint=${getMint(to)}&amount=${(amount * 1e9).toFixed(0)}&slippage=1`;
        const res = await fetch(quoteUrl);
        const data = await res.json();
        const out = data.data[0];
        document.getElementById('to-amount').value = (out.outAmount / 1e6).toFixed(2);
        document.getElementById('rate-info').textContent = `1 ${from} ≈ ${(out.outAmount / amount / 1e6).toFixed(4)} ${to}`;
      } catch (e) {
        console.error('Quote error', e);
      }
    });

    document.getElementById('swap-button').onclick = async () => {
      const from = document.getElementById('from-token').value;
      const to = document.getElementById('to-token').value;
      const amount = parseFloat(document.getElementById('from-amount').value);
      if (!wallet || !amount || from === to) return alert("Infos manquantes");
      const quoteRes = await fetch(`https://quote-api.jup.ag/v6/swap`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userPublicKey: wallet.toString(),
          wrapUnwrapSOL: true,
          inputMint: getMint(from),
          outputMint: getMint(to),
          amount: (amount * 1e9).toFixed(0),
          slippageBps: 100,
          feeBps: 10,
          feeAccount: "H3z4XmmpLwjm2MhfRuEFhK4DjGHhkbQvmgSUUCTrm6hw"
        })
      });
      const { swapTransaction } = await quoteRes.json();
      const tx = solanaWeb3.Transaction.from(Uint8Array.from(atob(swapTransaction), c => c.charCodeAt(0)));
      tx.feePayer = wallet;
      tx.recentBlockhash = (await new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta')).getRecentBlockhash()).blockhash;
      const signed = await window.phantom.solana.signTransaction(tx);
      const sig = await new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta')).sendRawTransaction(signed.serialize());
      alert("Swap envoyé ! Signature : " + sig);
    };

    const ctx = document.getElementById('priceChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'SOL/USD',
          data: [],
          borderColor: '#00D2FF',
          backgroundColor: 'rgba(0, 210, 255, 0.2)',
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false }},
        scales: { x: { display: false }, y: { display: true }}
      }
    });

    async function loadChartData() {
      const res = await fetch('https://api.coingecko.com/api/v3/coins/solana/market_chart?vs_currency=usd&days=1');
      const data = await res.json();
      chart.data.labels = data.prices.map(p => new Date(p[0]).toLocaleTimeString());
      chart.data.datasets[0].data = data.prices.map(p => p[1]);
      chart.update();
    }

    loadChartData();
  </script>
</body>
</html>