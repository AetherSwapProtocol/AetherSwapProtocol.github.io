<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AetherSwap PRO | Solana DEX Aggregator</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              500: '#7e22ce',
              600: '#6b21a8'
            },
            secondary: {
              500: '#3b82f6',
              600: '#2563eb'
            }
          },
          boxShadow: {
            glass: '0 4px 30px rgba(0,0,0,0.1)'
          }
        }
      }
    }
  </script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e1b4b);
      color: white;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }
    .glass {
      background: rgba(255 255 255 / 0.05);
      border: 1px solid rgba(255 255 255 / 0.1);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(126, 34, 206, 0.3);
      border-radius: 1rem;
      max-width: 420px;
      width: 100%;
      padding: 1.5rem 1.75rem;
    }
    .token-scroll::-webkit-scrollbar {
      width: 8px;
    }
    .token-scroll::-webkit-scrollbar-thumb {
      background-color: rgba(126, 34, 206, 0.5);
      border-radius: 4px;
    }
    .token-scroll {
      max-height: 280px;
      overflow-y: auto;
    }
    .btn-primary {
      background: linear-gradient(90deg, #6e45e2 0%, #88a0f7 100%);
      transition: background 0.3s ease;
    }
    .btn-primary:hover {
      background: linear-gradient(90deg, #7e22ce 0%, #3b82f6 100%);
    }
  </style>

  <!-- Solana web3 CDN -->
  <script src="https://unpkg.com/@solana/web3.js@1.78.0/lib/index.iife.min.js"></script>
</head>

<body>
  <main class="glass space-y-6">
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-extrabold tracking-wide text-primary-500">AetherSwap PRO</h1>
      <button id="walletButton" class="btn-primary px-4 py-2 rounded-lg font-semibold text-white">Connect Wallet</button>
    </header>

    <!-- FROM Token -->
    <section>
      <div class="flex justify-between mb-1">
        <label class="font-semibold" for="fromAmount">From</label>
        <span class="text-sm text-gray-400">Balance: <span id="fromBalance">0.00</span></span>
      </div>
      <div class="flex items-center bg-gray-900 rounded-xl p-3 space-x-3">
        <button id="fromSelect" class="flex items-center space-x-2 rounded-lg bg-gray-800 px-3 py-1">
          <img id="fromLogo" class="w-7 h-7 rounded-full hidden" alt="token logo" />
          <span id="fromSymbol" class="font-semibold">Select Token</span>
          <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linejoin="round" stroke-linecap="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
        </button>
        <input
          type="number"
          id="fromAmount"
          placeholder="0.0"
          min="0"
          step="any"
          class="bg-transparent text-right flex-grow text-lg font-bold focus:outline-none"
        />
      </div>
      <div class="text-right text-xs text-gray-400 mt-1">≈ $<span id="fromUsd">0.00</span></div>
    </section>

    <!-- Switch Button -->
    <div class="flex justify-center">
      <button id="switchBtn" class="p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition">
        <svg class="w-6 h-6 text-primary-500 rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h8m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
        </svg>
      </button>
    </div>

    <!-- TO Token -->
    <section>
      <div class="flex justify-between mb-1">
        <label class="font-semibold" for="toAmount">To</label>
        <span class="text-sm text-gray-400">Balance: <span id="toBalance">0.00</span></span>
      </div>
      <div class="flex items-center bg-gray-900 rounded-xl p-3 space-x-3">
        <button id="toSelect" class="flex items-center space-x-2 rounded-lg bg-gray-800 px-3 py-1">
          <img id="toLogo" class="w-7 h-7 rounded-full hidden" alt="token logo" />
          <span id="toSymbol" class="font-semibold">Select Token</span>
          <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linejoin="round" stroke-linecap="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
        </button>
        <input
          type="text"
          id="toAmount"
          placeholder="0.0"
          readonly
          class="bg-transparent text-right flex-grow text-lg font-bold focus:outline-none"
        />
      </div>
      <div class="text-right text-xs text-gray-400 mt-1">≈ $<span id="toUsd">0.00</span></div>
    </section>

    <!-- Swap Button -->
    <button
      id="swapButton"
      disabled
      class="btn-primary w-full py-3 rounded-xl text-lg font-bold mt-6 transition disabled:opacity-50 disabled:cursor-not-allowed"
    >
      Connect Wallet
    </button>

    <!-- Token Selection Modal -->
    <div
      id="tokenModal"
      class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50"
      aria-modal="true"
      role="dialog"
    >
      <div class="bg-gray-900 rounded-xl w-full max-w-md max-h-[80vh] flex flex-col p-4">
        <div class="flex items-center mb-3">
          <input
            type="text"
            id="tokenSearch"
            placeholder="Search token by symbol or name"
            class="flex-grow rounded-lg px-3 py-2 bg-gray-800 text-white focus:outline-none"
          />
          <button id="closeTokenModal" class="ml-3 text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div id="tokenList" class="token-scroll overflow-y-auto"></div>
      </div>
    </div>
  </main>

  <script>
    // Globals
    const API_BASE = 'https://lite-api.jup.ag/ultra/v1';

    let wallet = null;
    let connected = false;
    let publicKey = null;

    let tokens = [];
    let filteredTokens = [];
    let selectingFor = null; // 'from' or 'to'

    let fromToken = null;
    let toToken = null;

    let fromAmount = 0;
    let toAmount = 0;

    let fromBalance = 0;
    let toBalance = 0;

    let prices = {}; // symbol => price USD

    const walletButton = document.getElementById('walletButton');
    const swapButton = document.getElementById('swapButton');

    const fromSelect = document.getElementById('fromSelect');
    const toSelect = document.getElementById('toSelect');

    const fromLogo = document.getElementById('fromLogo');
    const fromSymbol = document.getElementById('fromSymbol');
    const toLogo = document.getElementById('toLogo');
    const toSymbol = document.getElementById('toSymbol');

    const fromAmountInput = document.getElementById('fromAmount');
    const toAmountInput = document.getElementById('toAmount');

    const fromBalanceSpan = document.getElementById('fromBalance');
    const toBalanceSpan = document.getElementById('toBalance');

    const fromUsdSpan = document.getElementById('fromUsd');
    const toUsdSpan = document.getElementById('toUsd');

    const tokenModal = document.getElementById('tokenModal');
    const tokenList = document.getElementById('tokenList');
    const tokenSearch = document.getElementById('tokenSearch');
    const closeTokenModalBtn = document.getElementById('closeTokenModal');

    // Helper: Format number with commas and 4 decimals max
    function formatNumber(num) {
      if (!num) return '0.00';
      return Number(num).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 4 });
    }

    // Show modal
    function openTokenModal(forToken) {
      selectingFor = forToken; // 'from' or 'to'
      tokenSearch.value = '';
      filteredTokens = tokens;
      renderTokenList();
      tokenModal.classList.remove('hidden');
      tokenModal.classList.add('flex');
      tokenSearch.focus();
    }

    function closeTokenModal() {
      tokenModal.classList.add('hidden');
      tokenModal.classList.remove('flex');
      selectingFor = null;
    }

    closeTokenModalBtn.onclick = closeTokenModal;
    tokenModal.onclick = e => {
      if (e.target === tokenModal) closeTokenModal();
    };

    // Fetch tokens list from Jupiter Ultra v1 tokens endpoint
    async function fetchTokens() {
      try {
        const res = await fetch(`${API_BASE}/tokens`);
        if (!res.ok) throw new Error('Failed to load tokens');
        const data = await res.json();
        tokens = data.tokens;
        filteredTokens = tokens;
      } catch (e) {
        alert('Error loading tokens: ' + e.message);
      }
    }

    // Render tokens in modal
    function renderTokenList() {
      tokenList.innerHTML = '';
      if (filteredTokens.length === 0) {
        tokenList.innerHTML = '<p class="text-center text-gray-400 mt-10">No tokens found.</p>';
        return;
      }
      filteredTokens.forEach(token => {
        const tokenEl = document.createElement('button');
        tokenEl.type = 'button';
        tokenEl.className = 'w-full flex items-center p-2 space-x-3 rounded-lg hover:bg-primary-600 transition';
        tokenEl.innerHTML = `
          <img src="${token.logoURI}" alt="${token.symbol}" class="w-8 h-8 rounded-full" />
          <div class="flex-grow text-left">
            <p class="font-semibold">${token.symbol}</p>
            <p class="text-xs text-gray-400 truncate max-w-xs">${token.name}</p>
          </div>
          <div class="text-sm font-mono text-gray-300">${token.extensions?.coingeckoId ? '$' : ''}</div>
        `;
        tokenEl.onclick = () => selectToken(token);
        tokenList.appendChild(tokenEl);
      });
    }

    // Token search filter
    tokenSearch.oninput = () => {
      const val = tokenSearch.value.toLowerCase();
      filteredTokens = tokens.filter(t => t.symbol.toLowerCase().includes(val) || t.name.toLowerCase().includes(val));
      renderTokenList();
    };

    // Select token from modal
    async function selectToken(token) {
      if (selectingFor === 'from') {
        fromToken = token;
        fromSymbol.textContent = token.symbol;
        fromLogo.src = token.logoURI;
        fromLogo.classList.remove('hidden');
      } else if (selectingFor === 'to') {
        toToken = token;
        toSymbol.textContent = token.symbol;
        toLogo.src = token.logoURI;
        toLogo.classList.remove('hidden');
      }
      closeTokenModal();

      if (connected && fromToken) {
        await fetchBalanceAndPrices();
        updateUI();
      }
      checkSwapReady();
    }

    // Fetch balances (SOL and SPL tokens) for wallet
    async function fetchBalances() {
      if (!publicKey) return;
      try {
        const res = await fetch(`https://api.mainnet-beta.solana.com`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            jsonrpc: "2.0",
            id: 1,
            method: "getTokenAccountsByOwner",
            params: [
              publicKey.toString(),
              { programId: "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA" },
              { encoding: "jsonParsed" }
            ]
          })
        });
        const data = await res.json();

        // Reset balances
        fromBalance = 0;
        toBalance = 0;

        if (fromToken && fromToken.address === "So11111111111111111111111111111111111111112") {
          // SOL balance fallback (getBalance RPC)
          const balanceRes = await fetch(`https://api.mainnet-beta.solana.com`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              jsonrpc: "2.0",
              id: 1,
              method: "getBalance",
              params: [publicKey.toString()]
            })
          });
          const balanceData = await balanceRes.json();
          fromBalance = balanceData.result?.value / 1e9 || 0;
        } else if (fromToken) {
          // Find SPL balance from token accounts
          const tokenAccount = data.result.value.find(acc =>
            acc.account.data.parsed.info.mint === fromToken.address
          );
          fromBalance = tokenAccount
            ? tokenAccount.account.data.parsed.info.tokenAmount.uiAmount
            : 0;
        }

        if (toToken && toToken.address === "So11111111111111111111111111111111111111112") {
          const balanceRes = await fetch(`https://api.mainnet-beta.solana.com`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              jsonrpc: "2.0",
              id: 1,
              method: "getBalance",
              params: [publicKey.toString()]
            })
          });
          const balanceData = await balanceRes.json();
          toBalance = balanceData.result?.value / 1e9 || 0;
        } else if (toToken) {
          const tokenAccount = data.result.value.find(acc =>
            acc.account.data.parsed.info.mint === toToken.address
          );
          toBalance = tokenAccount
            ? tokenAccount.account.data.parsed.info.tokenAmount.uiAmount
            : 0;
        }

        fromBalanceSpan.textContent = formatNumber(fromBalance);
        toBalanceSpan.textContent = formatNumber(toBalance);
      } catch (e) {
        console.error('Error fetching balances:', e);
      }
    }

    // Fetch prices via Coingecko or Jupiter
    async function fetchPrices() {
      if (!fromToken && !toToken) return;

      // Collect coingecko ids from tokens
      let ids = [];
      if (fromToken?.extensions?.coingeckoId) ids.push(fromToken.extensions.coingeckoId);
      if (toToken?.extensions?.coingeckoId) ids.push(toToken.extensions.coingeckoId);

      if (ids.length === 0) return;

      try {
        const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids.join(',')}&vs_currencies=usd`);
        if (!res.ok) throw new Error('Failed to fetch prices');
        const data = await res.json();

        if (fromToken?.extensions?.coingeckoId) prices[fromToken.symbol] = data[fromToken.extensions.coingeckoId]?.usd || 0;
        if (toToken?.extensions?.coingeckoId) prices[toToken.symbol] = data[toToken.extensions.coingeckoId]?.usd || 0;

      } catch (e) {
        console.error('Error fetching prices:', e);
      }
    }

    // Update USD display for amounts
    function updateUsdDisplay() {
      fromUsdSpan.textContent = formatNumber(fromAmount * (prices[fromToken?.symbol] || 0));
      toUsdSpan.textContent = formatNumber(toAmount * (prices[toToken?.symbol] || 0));
    }

    // Update all UI elements
    function updateUI() {
      fromAmountInput.value = fromAmount ? fromAmount : '';
      toAmountInput.value = toAmount ? toAmount : '';
      fromBalanceSpan.textContent = formatNumber(fromBalance);
      toBalanceSpan.textContent = formatNumber(toBalance);
      updateUsdDisplay();
    }

    // Enable or disable swap button
    function checkSwapReady() {
      if (connected && fromToken && toToken && fromAmount > 0 && fromAmount <= fromBalance) {
        swapButton.disabled = false;
        swapButton.textContent = "Swap";
      } else if (!connected) {
        swapButton.disabled = false;
        swapButton.textContent = "Connect Wallet";
      } else {
        swapButton.disabled = true;
        swapButton.textContent = "Enter Amount";
      }
    }

    // Wallet connection logic
    async function connectWallet() {
      if (window.solana && window.solana.isPhantom) {
        try {
          const resp = await window.solana.connect();
          publicKey = resp.publicKey;
          wallet = window.solana;
          connected = true;
          walletButton.textContent = `Wallet: ${publicKey.toString().slice(0, 4)}...${publicKey.toString().slice(-4)}`;
          walletButton.disabled = true;
          await fetchBalanceAndPrices();
          checkSwapReady();
        } catch (err) {
          alert('Wallet connection rejected');
        }
      } else {
        alert('Phantom Wallet is not installed');
      }
    }

    // Fetch balances and prices together
    async function fetchBalanceAndPrices() {
      await fetchBalances();
      await fetchPrices();
      updateUI();
    }

    // Switch from/to tokens
    function switchTokens() {
      [fromToken, toToken] = [toToken, fromToken];
      [fromAmount, toAmount] = [toAmount, fromAmount];
      updateUI();
      checkSwapReady();
    }

    // Event listeners
    walletButton.onclick = connectWallet;
    fromSelect.onclick = () => openTokenModal('from');
    toSelect.onclick = () => openTokenModal('to');
    switchBtn.onclick = () => {
      switchTokens();
      fetchBalanceAndPrices();
    };

    fromAmountInput.oninput = e => {
      const val = parseFloat(e.target.value);
      if (isNaN(val) || val < 0) {
        fromAmount = 0;
      } else {
        fromAmount = val;
      }
      checkSwapReady();
      updateUsdDisplay();
      // TODO: update quote for toAmount (Bloc 2)
    };

    // Init
    (async () => {
      await fetchTokens();
    })();
  </script>
</body>
</html>