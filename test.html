<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>AetherSwap</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root {
  --bg: rgba(15,18,27,0.8);
  --accent1: #6f7cff;
  --accent2: #9d4eff;
  --glass: rgba(255,255,255,0.05);
  --white80: rgba(255,255,255,0.8);
  --text: #e6eaf0;
}
* { box-sizing:border-box; }
body {
  margin:0; display:flex;
  justify-content:center; align-items:center;
  min-height:100vh;
  font-family:Inter,sans-serif;
  background:#0b0d14;
  color:var(--text);
}
#app {
  width:100%; max-width:440px;
  padding:24px;
  border-radius:16px;
  background:var(--glass);
  backdrop-filter:blur(20px);
  border:1px solid rgba(255,255,255,0.1);
  box-shadow:0 8px 32px rgba(0,0,0,0.3);
}
h1 { text-align:center; color:var(--accent1); margin-top:0; }
button, input { font-family:Inter,sans-serif; }

/* Wallet */
#wallet-section { text-align:center; margin-bottom:16px; }
#connect-btn, #swap-btn { 
  width:100%;
  padding:12px;
  border:none;
  border-radius:8px;
  background:linear-gradient(135deg,var(--accent1),var(--accent2));
  color:#fff;
  font-size:1rem;
  cursor:pointer;
  transition:opacity .3s;
}
#swap-btn:disabled { opacity:0.5; cursor:not-allowed; }
#disconnect-btn {
  margin-top:8px; background:none; border:1px solid var(--accent2);
  color:var(--accent2); padding:6px 12px; width:auto;
  cursor:pointer; border-radius:8px;
}
#wallet-info { display:none; margin-bottom:16px; }
#wallet-address { font-family:monospace; }
#wallet-balance { font-weight:600; }

/* Swap UI */
#swap-ui { display:none; }
.token-row {
  display:flex; align-items:center; margin-bottom:12px;
}
.token-btn {
  flex:1;
  padding:8px;
  background:var(--glass);
  border:1px solid transparent;
  border-radius:8px;
  display:flex;
  align-items:center;
  gap:8px;
  cursor:pointer;
  transition:border .3s;
}
.token-btn:hover { border-color:var(--accent1); }
.token-logo {
  width:28px; height:28px; border-radius:50%; background:#ccc;
}
.token-symbol { flex:1; font-weight:600; }
.balance { font-size:0.85rem; color:#aaa; }
.amount-input {
  width:100px; text-align:right;
  padding:8px; margin-left:8px;
  border:none; background:var(--glass);
  border-radius:8px; color:var(--text);
}

/* Invert */
#invert-btn {
  display:block;
  margin:10px auto;
  cursor:pointer;
}

/* Slippage & rate */
#slippage { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
#rate-display { font-size:0.9rem; color:#aaa; margin-bottom:12px; }

/* Modal */
#modal-bg {
  position:fixed; inset:0;
  background:rgba(0,0,0,0.7);
  display:none; justify-content:center; align-items:center;
}
#modal {
  background:var(--glass);
  border-radius:12px;
  padding:16px;
  width:90%; max-width:360px; max-height:80vh;
  overflow:auto;
}
#modal-search {
  width:100%; padding:8px; border:none;
  border-radius:8px; margin-bottom:12px;
  background:rgba(255,255,255,0.1); color:#fff;
}
.token-item {
  display:flex; align-items:center; padding:8px; border-radius:8px;
  gap:8px; cursor:pointer; transition:background .2s;
}
.token-item:hover { background:rgba(255,255,255,0.1); }
.token-item img { width:24px; height:24px; border-radius:50%; }
.token-item .sym { flex:1; font-weight:600; }
.token-item .bal { font-size:0.8rem; color:#aaa; }

/* loader toast */
#loader { text-align:center; margin:16px 0; display:none; }
.spinner {
  display:inline-block; width:32px; height:32px;
  border:4px solid rgba(255,255,255,0.2);
  border-top-color:var(--accent1);
  border-radius:50%;
  animation:spin .8s linear infinite;
}
@keyframes spin { to {transform:rotate(360deg);} }
#toasts {
  position:fixed; bottom:16px; left:50%;
  transform:translateX(-50%);
  display:flex; flex-direction:column; gap:8px;
  max-width:360px; width:90vw;
}
.toast {
  padding:12px 16px;
  border-radius:8px;
  color:#fff;
  font-weight:500;
  animation:slideIn .3s ease;
}
.toast.success { background:#3ebb6e; }
.toast.error { background:#bb3e3e; }
@keyframes slideIn { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }

/* Responsive */
@media(max-width:480px){
  .amount-input{width:80px;}
}
</style>
<body>
<div id="app">
  <h1>AetherSwap</h1>
  <div id="wallet-section">
    <button id="connect-btn">Connect Phantom</button>
    <div id="wallet-info">
      <div id="wallet-address"></div>
      <div id="wallet-balance"></div>
      <button id="disconnect-btn">Disconnect</button>
    </div>
  </div>

  <div id="swap-ui">
    <div class="token-row">
      <div class="token-btn" id="btn-from">
        <img class="token-logo" id="logo-from">
        <span class="token-symbol" id="sym-from">Select Token A</span>
        <span class="balance" id="bal-from"></span>
      </div>
      <input class="amount-input" id="amt-from" type="number" placeholder="0.0">
    </div>

    <img id="invert-btn" src="data:image/svg+xml;base64,PHN2ZyB..."/> <!-- SVG flÃ¨che up/down -->

    <div class="token-row">
      <div class="token-btn" id="btn-to">
        <img class="token-logo" id="logo-to">
        <span class="token-symbol" id="sym-to">Select Token B</span>
        <span class="balance" id="bal-to"></span>
      </div>
      <input class="amount-input" id="amt-to" type="text" disabled placeholder="0.0">
    </div>

    <div id="slippage">
      <label>Slippage (%)</label>
      <input type="number" id="slip" min="0" max="10" step="0.1" value="0.5">
    </div>

    <div id="rate-display">Rate: -</div>

    <button id="swap-btn" disabled>Swap</button>
    <div id="loader"><div class="spinner"></div></div>
  </div>
</div>

<div id="modal-bg">
  <div id="modal">
    <input id="modal-search" placeholder="Search token...">
    <div id="token-list"></div>
  </div>
</div>

<div id="toasts"></div>

<script type="module">
// Modules
import { Connection, PublicKey, Transaction } from 'https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/+esm';
import { PhantomWalletAdapter } from 'https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-phantom@0.18.0/+esm';
// Globals
const connection = new Connection('https://api.mainnet-beta.solana.com','confirmed');
const wallet = new PhantomWalletAdapter();
let pubkey = null;
let tokens = [], selFrom=null, selTo=null, quote=null;

// Elements
const btnConnect = document.getElementById('connect-btn');
const infoWallet = document.getElementById('wallet-info');
const addrEl = document.getElementById('wallet-address');
const balEl = document.getElementById('wallet-balance');
const btnDisc = document.getElementById('disconnect-btn');
const swapUI = document.getElementById('swap-ui');
const els = {
  btnFrom: document.getElementById('btn-from'),
  btnTo: document.getElementById('btn-to'),
  logoFrom: document.getElementById('logo-from'),
  logoTo: document.getElementById('logo-to'),
  symFrom: document.getElementById('sym-from'),
  symTo: document.getElementById('sym-to'),
  balFrom: document.getElementById('bal-from'),
  balTo: document.getElementById('bal-to'),
  amtFrom: document.getElementById('amt-from'),
  amtTo: document.getElementById('amt-to'),
  slip: document.getElementById('slip'),
  rate: document.getElementById('rate-display'),
  swapBtn: document.getElementById('swap-btn'),
  loader: document.getElementById('loader'),
  modalBg: document.getElementById('modal-bg'),
  modalSearch: document.getElementById('modal-search'),
  tokenList: document.getElementById('token-list'),
};
const toasts = document.getElementById('toasts');

function toast(msg,type='success'){
  const div=document.createElement('div');
  div.className='toast '+type; div.textContent=msg;
  toasts.appendChild(div);
  setTimeout(()=>{div.remove()},4000);
}

// Load token list
async function loadTokens(){
  const res = await fetch('https://cache.jup.ag/tokens');
  const list = (await res.json()).filter(t=>t.chainId===101);
  list.sort((a,b)=>(a.rank||9999)-(b.rank||9999));
  tokens=list.slice(0,100);
}

// Update balances
async function updBal(){
  if(!pubkey)return;
  const sol = await connection.getBalance(pubkey)/1e9;
  balEl.textContent=sol.toFixed(4)+' SOL';
  const tkns = await connection.getParsedTokenAccountsByOwner(pubkey,{programId:new PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA')});
  tokens.forEach(t=>t.ui=0);
  tkns.value.forEach(({account})=>{
    const info=account.data.parsed.info;
    const m=info.mint;
    const t = tokens.find(x=>x.address===m);
    if(t) t.ui=info.tokenAmount.uiAmount;
  });
}

// Phantom connect
async function connect(){
  try{
    await wallet.connect();
    pubkey=wallet.publicKey;
    addrEl.textContent=pubkey.toBase58();
    infoWallet.style.display='block'; swapUI.style.display='block';
    btnConnect.style.display='none';
    await updBal();
    toast('Connected');
  }catch(e){toast('Conn fail','error');}
}
btnConnect.onclick=connect;
btnDisc.onclick=async()=>{
  await wallet.disconnect(); pubkey=null;
  infoWallet.style.display='none'; swapUI.style.display='none';
  btnConnect.style.display='block'; toast('Disconnected');
};

// Token modal
let target=null;
els.btnFrom.onclick=()=>openModal('from');
els.btnTo.onclick=()=>openModal('to');
function openModal(which){
  target=which;
  els.modalBg.style.display='flex';
  els.modalSearch.value='';
  renderList();
}
els.modalBg.onclick=e=>{ if(e.target===els.modalBg)els.modalBg.style.display='none'; };
els.modalSearch.oninput=renderList;
function renderList(){
  const f=els.modalSearch.value.toLowerCase();
  els.tokenList.innerHTML='';
  tokens.filter(t=>
    t.symbol.toLowerCase().includes(f)||
    t.name.toLowerCase().includes(f)||
    t.address.toLowerCase().includes(f)
  ).forEach(t=>{
    const div=document.createElement('div'); div.className='token-item';
    const img=document.createElement('img'); img.src=t.logoURI;
    const sym=document.createElement('div'); sym.textContent=t.symbol; sym.className='sym';
    const bal=document.createElement('div'); bal.textContent=(t.ui||0).toFixed(4); bal.className='bal';
    div.append(img,sym,bal);
    div.onclick=()=>{
      if(target==='from'){ selFrom=t; els.logoFrom.src=t.logoURI; els.symFrom.textContent=t.symbol; els.balFrom.textContent=(t.ui||0).toFixed(4);}
      else { selTo=t; els.logoTo.src=t.logoURI; els.symTo.textContent=t.symbol; els.balTo.textContent=(t.ui||0).toFixed(4);}
      els.amtFrom.value=''; els.amtTo.value=''; els.rate.textContent='Rate: -'; quote=null;
      els.modalBg.style.display='none'; updateUI();
    };
    els.tokenList.append(div);
  });
}

// Swap logic
els.amtFrom.oninput=updateUI;
els.slip.onchange=updateUI;
async function updateUI(){
  els.rate.textContent='Rate: -';
  els.amtTo.value='';
  quote=null;
  els.swapBtn.disabled=true;
  if(!pubkey||!selFrom||!selTo) return;
  const amt=parseFloat(els.amtFrom.value);
  if(isNaN(amt)||amt<=0||amt>selFrom.ui){return;}
  const url=`https://quote-api.jup.ag/v1/quote?inputMint=${selFrom.address}&outputMint=${selTo.address}&amount=${Math.floor(amt*Math.pow(10,selFrom.decimals))}&slippageBps=${Math.floor(parseFloat(els.slip.value)*100)}`;
  const res=await fetch(url); if(!res.ok) {toast('Quote error','error');return;}
  const json=await res.json(); if(!json.data.length){toast('No route','error');return;}
  const best=json.data[0];
  const out=best.outAmount/Math.pow(10,selTo.decimals);
  els.amtTo.value=out.toFixed(6);
  els.rate.textContent=`1 ${selFrom.symbol} â ${(out/amt).toFixed(6)} ${selTo.symbol}`;
  quote=best;
  els.swapBtn.disabled=false;
}

// Invert
els.invertBtn=document.getElementById('invert-btn');
els.invertBtn.onclick=()=>{ [selFrom,selTo]=[selTo,selFrom]; 
  [els.logoFrom.src,els.logoTo.src]=[els.logoTo.src,els.logoFrom.src];
  [els.symFrom.textContent,els.symTo.textContent]=[els.symTo.textContent,els.symFrom.textContent];
  [els.balFrom.textContent,els.balTo.textContent]=[els.balTo.textContent,els.balFrom.textContent];
  els.amtFrom.value=''; els.amtTo.value=''; els.rate.textContent='Rate: -'; quote=null;
};

// Perform Swap
els.swapBtn.onclick=async()=>{
  if(!quote){toast('No quote','error');return;}
  els.swapBtn.disabled=true; els.loader.style.display='block';
  try{
    const rawTx = Uint8Array.from(atob(quote.swapTransaction),c=>c.charCodeAt(0));
    let tx = Transaction.from(rawTx);
    tx.feePayer=pubkey; tx.recentBlockhash=(await connection.getRecentBlockhash()).blockhash;
    const signed=await wallet.signTransaction(tx);
    const txid=await connection.sendRawTransaction(signed.serialize());
    toast('Sent '+txid,'success');
    await connection.confirmTransaction(txid,'confirmed');
    updateUI(); updBal();
    toast('Confirmed','success');
  }catch(e){toast('Swap failed','error'); console.error(e);}
  els.loader.style.display='none'; els.swapBtn.disabled=false;
};

// Init
(async()=>{
  await loadTokens();
  try{ await wallet.connect({onlyIfTrusted:true}); connect(); }catch{}
})();
</script>
</body>
</html>