<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AetherSwap - Phantom + Jupiter Swap Demo</title>

<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors: {
          primary: {
            500: '#7e22ce',
            600: '#6b21a8'
          },
          secondary: {
            500: '#3b82f6',
            600: '#2563eb'
          }
        }
      }
    }
  }
</script>

<style>
  body {
    background: #0f172a;
    font-family: "Inter", sans-serif;
  }
  .glass {
    background: rgba(255 255 255 / 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255 255 255 / 0.1);
    border-radius: 16px;
  }
  .token-list::-webkit-scrollbar {
    width: 6px;
  }
  .token-list::-webkit-scrollbar-thumb {
    background: rgba(126, 34, 206, 0.5);
    border-radius: 3px;
  }
</style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 text-white">

<div class="max-w-md w-full glass p-6 space-y-6 shadow-lg">

  <!-- Header -->
  <h1 class="text-3xl font-extrabold tracking-wide text-primary-500 text-center select-none">AetherSwap</h1>

  <!-- Wallet Connect -->
  <button id="btnConnect" class="w-full bg-primary-500 hover:bg-primary-600 py-3 rounded-lg font-semibold transition">Connect Phantom Wallet</button>
  <div id="walletInfo" class="text-center text-sm mt-2"></div>

  <!-- Swap Form -->
  <div id="swapForm" class="space-y-5 hidden">

    <!-- From Token -->
    <div>
      <label class="block mb-1 font-semibold">From</label>
      <button id="btnFromToken" class="flex items-center justify-between w-full bg-gray-800 rounded-lg p-3 hover:bg-gray-700 transition">
        <div class="flex items-center space-x-3">
          <img id="fromLogo" src="" alt="" class="w-7 h-7 rounded-full hidden" />
          <span id="fromSymbol" class="font-semibold">Select Token</span>
        </div>
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <input type="number" id="inputFromAmount" min="0" placeholder="Amount" class="w-full mt-2 p-3 rounded-lg bg-gray-900 text-white text-right font-bold" />
      <div class="text-xs text-gray-400 mt-1">Balance: <span id="fromBalance">0</span></div>
    </div>

    <!-- To Token -->
    <div>
      <label class="block mb-1 font-semibold">To</label>
      <button id="btnToToken" class="flex items-center justify-between w-full bg-gray-800 rounded-lg p-3 hover:bg-gray-700 transition">
        <div class="flex items-center space-x-3">
          <img id="toLogo" src="" alt="" class="w-7 h-7 rounded-full hidden" />
          <span id="toSymbol" class="font-semibold">Select Token</span>
        </div>
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <input type="text" id="inputToAmount" readonly placeholder="Estimated amount" class="w-full mt-2 p-3 rounded-lg bg-gray-900 text-gray-400 text-right font-bold" />
      <div class="text-xs text-gray-400 mt-1">Balance: <span id="toBalance">0</span></div>
    </div>

    <!-- Swap Button -->
    <button id="btnSwap" class="w-full bg-secondary-500 hover:bg-secondary-600 py-3 rounded-lg font-semibold transition disabled:opacity-50" disabled>Swap</button>

    <!-- Status -->
    <div id="status" class="text-center text-sm mt-2 min-h-[1.5rem]"></div>
  </div>
</div>

<!-- Token Selection Modal -->
<div id="tokenModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
  <div class="bg-gray-900 rounded-xl w-full max-w-md max-h-[80vh] overflow-hidden flex flex-col">
    <div class="flex items-center p-4 border-b border-gray-700">
      <input id="tokenSearch" type="text" placeholder="Search token..." class="flex-grow p-2 rounded bg-gray-800 text-white" />
      <button id="btnCloseModal" class="ml-3 text-gray-400 hover:text-white" title="Close">&times;</button>
    </div>
    <div id="tokenList" class="overflow-y-auto token-list flex-grow p-2 space-y-2"></div>
  </div>
</div>

<script type="module">
(async () => {
  const btnConnect = document.getElementById("btnConnect");
  const walletInfo = document.getElementById("walletInfo");
  const swapForm = document.getElementById("swapForm");
  const btnFromToken = document.getElementById("btnFromToken");
  const btnToToken = document.getElementById("btnToToken");
  const fromSymbolEl = document.getElementById("fromSymbol");
  const toSymbolEl = document.getElementById("toSymbol");
  const fromLogo = document.getElementById("fromLogo");
  const toLogo = document.getElementById("toLogo");
  const inputFromAmount = document.getElementById("inputFromAmount");
  const inputToAmount = document.getElementById("inputToAmount");
  const fromBalanceEl = document.getElementById("fromBalance");
  const toBalanceEl = document.getElementById("toBalance");
  const btnSwap = document.getElementById("btnSwap");
  const status = document.getElementById("status");

  const tokenModal = document.getElementById("tokenModal");
  const tokenSearch = document.getElementById("tokenSearch");
  const tokenListEl = document.getElementById("tokenList");

  const JUPITER_API_BASE = "https://lite-api.jup.ag/ultra/v1";

  let wallet = null;
  let publicKey = null;
  let tokens = [];
  let balances = {};
  let fromToken = null;
  let toToken = null;
  let currentQuote = null;

  // Utilitaires debounce
  function debounce(fn, delay) {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn(...args), delay);
    };
  }

  // Format nombre avec 2 décimales et séparateur
  function formatNumber(num) {
    return Number(num).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 });
  }

  // Check Phantom wallet availability
  function isPhantomInstalled() {
    return window.solana && window.solana.isPhantom;
  }

  // Connect wallet
  async function connectWallet() {
    if (!isPhantomInstalled()) {
      alert("Phantom wallet is not installed! Please install it from https://phantom.app");
      return;
    }
    try {
      wallet = window.solana;
      const resp = await wallet.connect();
      publicKey = resp.publicKey.toString();
      walletInfo.textContent = `Connected: ${publicKey.slice(0, 6)}...${publicKey.slice(-4)}`;
      btnConnect.textContent = "Disconnect Wallet";
      swapForm.classList.remove("hidden");
      await loadBalances();
    } catch (e) {
      alert("Wallet connection failed: " + e.message);
    }
  }

  // Disconnect wallet
  function disconnectWallet() {
    if (wallet) wallet.disconnect();
    wallet = null;
    publicKey = null;
    walletInfo.textContent = "";
    btnConnect.textContent = "Connect Phantom Wallet";
    swapForm.classList.add("hidden");
    resetForm();
  }

  btnConnect.onclick = async () => {
    if (wallet) disconnectWallet();
    else await connectWallet();
  };

  // Fetch token list (top 500 tokens from Jupiter Ultra)
  async function fetchTokens() {
    try {
      const res = await fetch(`${JUPITER_API_BASE}/search?limit=500`);
      const json = await res.json();
      tokens = json.tokens || [];
    } catch (e) {
      console.error("Failed to fetch tokens", e);
      tokens = [];
    }
  }

  // Fetch balances of wallet tokens
  async function loadBalances() {
    if (!publicKey) return;
    try {
      const res = await fetch(`${JUPITER_API_BASE}/balances/${publicKey}`);
      const json = await res.json();
      balances = {};
      for (const token of json.tokens || []) {
        balances[token.mint] = token.uiAmount || 0;
      }
      updateBalancesUI();
    } catch (e) {
      console.error("Failed to fetch balances", e);
      balances = {};
      updateBalancesUI();
    }
  }

  // Update balances in UI
  function updateBalancesUI() {
    fromBalanceEl.textContent = fromToken ? formatNumber(balances[fromToken.address] || 0) : "0";
    toBalanceEl.textContent = toToken ? formatNumber(balances[toToken.address] || 0) : "0";
  }

  // Reset form
  function resetForm() {
    fromToken = null;
    toToken = null;
    currentQuote = null;
    fromSymbolEl.textContent = "Select Token";
    toSymbolEl.textContent = "Select Token";
    fromLogo.src = "";
    fromLogo.classList.add("hidden");
    toLogo.src = "";
    toLogo.classList.add("hidden");
    inputFromAmount.value = "";
    inputToAmount.value = "";
    fromBalanceEl.textContent = "0";
    toBalanceEl.textContent = "0";
    btnSwap.disabled = true;
    status.textContent = "";
  }

  // Open modal for token selection
  function openTokenModal(forFrom) {
    tokenModal.classList.remove("hidden");
    tokenSearch.value = "";
    renderTokenList(tokens);
    selectingFrom = forFrom;
    tokenSearch.focus();
  }

  // Close token modal
  function closeTokenModal() {
    tokenModal.classList.add("hidden");
  }

  let selectingFrom = true;

  // Render token list with search filter
  function renderTokenList(list) {
    const search = tokenSearch.value.trim().toLowerCase();
    let filtered = list;
    if (search.length > 0) {
      filtered = list.filter(t => 
        t.symbol.toLowerCase().includes(search) ||
        t.name.toLowerCase().includes(search) ||
        t.address.toLowerCase().includes(search)
      );
    }
    tokenListEl.innerHTML = "";
    for (const token of filtered) {
      const div = document.createElement("div");
      div.className = "flex items-center p-2 hover:bg-gray-700 rounded cursor-pointer transition";
      div.innerHTML = `
        <img src="${token.logoURI || ''}" alt="${token.symbol}" class="w-8 h-8 rounded-full mr-3" onerror="this.style.display='none'"/>
        <div class="flex-1">
          <div class="font-semibold">${token.symbol}</div>
          <div class="text-xs text-gray-400">${token.name}</div>
        </div>
        <div class="text-xs text-gray-400">${formatNumber(balances[token.address] || 0)}</div>
      `;
      div.onclick = () => selectToken(token);
      tokenListEl.appendChild(div);
    }
  }

  tokenSearch.addEventListener("input", () => renderTokenList(tokens));

  // Select token from modal
  function selectToken(token) {
    if (selectingFrom) {
      fromToken = token;
      fromSymbolEl.textContent = token.symbol;
      fromLogo.src = token.logoURI || "";
      fromLogo.classList.remove("hidden");
    } else {
      toToken = token;
      toSymbolEl.textContent = token.symbol;
      toLogo.src = token.logoURI || "";
      toLogo.classList.remove("hidden");
    }
    updateBalancesUI();
    closeTokenModal();
    tryQuote();
  }

  btnFromToken.onclick = () => openTokenModal(true);
  btnToToken.onclick = () => openTokenModal(false);
  document.getElementById("btnCloseModal").onclick = closeTokenModal;
  tokenModal.onclick = e => { if(e.target === tokenModal) closeTokenModal(); };

  // Fetch quote from Jupiter API
  let quoteRequestAbort = null;
  async function tryQuote() {
    inputToAmount.value = "";
    btnSwap.disabled = true;
    status.textContent = "";

    if (!fromToken || !toToken) return;
    const amount = Number(inputFromAmount.value);
    if (!amount || amount <= 0) return;

    if (quoteRequestAbort) quoteRequestAbort.abort();
    quoteRequestAbort = new AbortController();

    const body = {
      inputMint: fromToken.address,
      outputMint: toToken.address,
      amount: Math.floor(amount * Math.pow(10, fromToken.decimals)), // to smallest unit
      userPublicKey: publicKey,
      slippageBps: 50, // 0.5%
      forceFetch: true
    };

    try {
      status.textContent = "Fetching quote...";
      const resp = await fetch(`${JUPITER_API_BASE}/order`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
        signal: quoteRequestAbort.signal
      });
      if (!resp.ok) throw new Error("Quote fetch failed");
      const data = await resp.json();
      if (data && data.routes && data.routes.length > 0) {
        currentQuote = data.routes[0];
        const outAmount = currentQuote.outAmount / Math.pow(10, toToken.decimals);
        inputToAmount.value = outAmount.toFixed(toToken.decimals);
        btnSwap.disabled = false;
        status.textContent = `Estimated output: ${inputToAmount.value} ${toToken.symbol}`;
      } else {
        currentQuote = null;
        inputToAmount.value = "";
        btnSwap.disabled = true;
        status.textContent = "No swap route found";
      }
    } catch (e) {
      if (e.name === 'AbortError') return;
      console.error(e);
      status.textContent = "Error fetching quote";
    }
  }

  inputFromAmount.addEventListener("input", debounce(tryQuote, 400));

  // Execute swap
  async function doSwap() {
    if (!wallet || !currentQuote) return alert("Wallet not connected or no quote");

    btnSwap.disabled = true;
    status.textContent = "Processing swap...";

    try {
      // 1) Build order request with Jupiter API (same as quote)
      const orderReqBody = {
        route: currentQuote,
        userPublicKey: publicKey,
        wrapUnwrapSOL: true,
        feeBps: 0 // no fee for demo, adapt if needed
      };

      const orderResp = await fetch(`${JUPITER_API_BASE}/execute`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(orderReqBody)
      });

      if (!orderResp.ok) throw new Error("Swap execution failed");

      const execData = await orderResp.json();
      if (execData.txId) {
        status.innerHTML = `✅ Swap completed! <a href="https://explorer.solana.com/tx/${execData.txId}" target="_blank" class="underline text-secondary-500">View on Explorer</a>`;
        await loadBalances();
        resetForm();
      } else {
        throw new Error("No transaction id received");
      }
    } catch (e) {
      console.error(e);
      alert("Swap failed: " + e.message);
      status.textContent = "Swap failed";
    } finally {
      btnSwap.disabled = false;
    }
  }

  btnSwap.onclick = doSwap;

  // INIT
  await fetchTokens();
})();
</script>

</body>
</html>