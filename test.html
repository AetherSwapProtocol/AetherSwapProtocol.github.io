<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AetherSwap PRO | DEX Aggregator</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: { 500: '#7e22ce', 600: '#6b21a8', 700: '#5a1d8a' },
            secondary: { 500: '#3b82f6', 600: '#2563eb' }
          },
          boxShadow: {
            glass: '0 8px 32px 0 rgba(31, 38, 135, 0.37)',
          }
        },
      },
    };
  </script>

  <!-- Polyfill Buffer -->
  <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script>
  <script>window.Buffer = buffer.Buffer;</script>

  <!-- Solana Web3.js -->
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.69.0/lib/index.iife.min.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      font-family: 'Inter', sans-serif;
    }
    .glass {
      background: rgba(255, 255, 255, 0.07);
      border-radius: 1rem;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb {
      background: #7e22ce;
      border-radius: 4px;
    }
    .token-item:hover {
      background-color: rgba(126, 34, 206, 0.15);
      cursor: pointer;
      transform: scale(1.02);
      transition: 0.15s ease;
    }
  </style>
</head>
<body class="text-white min-h-screen flex flex-col items-center justify-center p-4">

<div class="max-w-md w-full glass p-6 space-y-6">
  <header class="flex items-center justify-between">
    <h1 class="text-3xl font-extrabold tracking-wide select-none">AetherSwap PRO</h1>
    <button id="connectBtn" class="bg-primary-500 hover:bg-primary-600 rounded px-4 py-2 font-semibold transition">
      Connect Wallet
    </button>
  </header>

  <div id="walletAddress" class="font-mono text-sm truncate"></div>

  <section class="space-y-4">
    <!-- FROM Token -->
    <div>
      <label for="fromAmount" class="block mb-1 font-semibold">From</label>
      <div class="flex items-center space-x-3 bg-gray-800 rounded-xl p-3">
        <button id="fromTokenBtn" class="flex items-center space-x-2">
          <img id="fromTokenLogo" src="" alt="" class="w-7 h-7 rounded-full hidden" />
          <span id="fromTokenSymbol" class="font-semibold">Select Token</span>
          <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <input
          id="fromAmount"
          type="number"
          min="0"
          step="any"
          placeholder="0.0"
          class="bg-transparent text-right flex-grow text-lg font-bold focus:outline-none"
        />
      </div>
      <div class="text-xs text-gray-400 mt-1">Balance: <span id="fromBalance">0.00</span></div>
    </div>

    <!-- Switch Button -->
    <div class="flex justify-center">
      <button id="switchBtn" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition" title="Switch">
        <svg class="w-6 h-6 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
        </svg>
      </button>
    </div>

    <!-- TO Token -->
    <div>
      <label for="toAmount" class="block mb-1 font-semibold">To</label>
      <div class="flex items-center space-x-3 bg-gray-800 rounded-xl p-3">
        <button id="toTokenBtn" class="flex items-center space-x-2">
          <img id="toTokenLogo" src="" alt="" class="w-7 h-7 rounded-full hidden" />
          <span id="toTokenSymbol" class="font-semibold">Select Token</span>
          <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <input
          id="toAmount"
          type="text"
          readonly
          placeholder="0.0"
          class="bg-transparent text-right flex-grow text-lg font-bold focus:outline-none"
        />
      </div>
      <div class="text-xs text-gray-400 mt-1">Balance: <span id="toBalance">0.00</span></div>
    </div>
  </section>

  <button id="swapBtn" disabled class="w-full bg-primary-500 hover:bg-primary-600 rounded-lg py-3 font-bold transition disabled:opacity-50 disabled:cursor-not-allowed">
    Connect Wallet to Swap
  </button>
</div>
<!-- Token Selection Modal -->
<div
  id="tokenModal"
  class="fixed inset-0 bg-black bg-opacity-70 flex flex-col max-w-md w-full p-4 top-16 rounded-lg hidden z-50 mx-auto glass"
  style="max-height: 75vh; overflow-y: auto;"
>
  <div class="flex justify-between items-center mb-3">
    <input
      id="tokenSearch"
      type="text"
      placeholder="Search tokens..."
      class="flex-grow rounded-lg p-2 text-black focus:outline-none"
    />
    <button id="closeModal" class="ml-2 px-3 py-1 rounded bg-red-600 hover:bg-red-700 font-semibold text-white">
      Close
    </button>
  </div>
  <div id="tokenList" class="space-y-2 overflow-auto"></div>
</div>

<script>
const API_BASE = "https://quote-api.jup.ag";
const PLATFORM_FEE_BPS = 25; // 0.25%
const PLATFORM_FEE_ACCOUNT = "YourWalletAddressHere"; // Remplace-le

let wallet = null, publicKey = null;
let tokens = [], balances = {};
let fromToken = null, toToken = null, quote = null;

const connectBtn = document.getElementById("connectBtn");
const walletAddressEl = document.getElementById("walletAddress");
const fromTokenBtn = document.getElementById("fromTokenBtn");
const toTokenBtn = document.getElementById("toTokenBtn");
const fromTokenSymbol = document.getElementById("fromTokenSymbol");
const toTokenSymbol = document.getElementById("toTokenSymbol");
const fromTokenLogo = document.getElementById("fromTokenLogo");
const toTokenLogo = document.getElementById("toTokenLogo");
const fromAmountInput = document.getElementById("fromAmount");
const toAmountInput = document.getElementById("toAmount");
const fromBalanceEl = document.getElementById("fromBalance");
const toBalanceEl = document.getElementById("toBalance");
const swapBtn = document.getElementById("swapBtn");
const tokenModal = document.getElementById("tokenModal");
const tokenListEl = document.getElementById("tokenList");
const tokenSearch = document.getElementById("tokenSearch");
const closeModalBtn = document.getElementById("closeModal");

function shortenAddress(addr) {
  return addr.slice(0, 4) + "â€¦" + addr.slice(-4);
}

function setTokenUI(token, symbolEl, logoEl) {
  if (!token) {
    symbolEl.textContent = "Select Token";
    logoEl.style.display = "none";
    logoEl.src = "";
  } else {
    symbolEl.textContent = token.symbol;
    logoEl.src = token.logoURI || "";
    logoEl.style.display = "block";
  }
}

async function connectWallet() {
  if (!window.solana || !window.solana.isPhantom) {
    alert("Please install Phantom Wallet.");
    return;
  }
  try {
    const res = await window.solana.connect();
    publicKey = res.publicKey.toString();
    walletAddressEl.textContent = "Wallet: " + shortenAddress(publicKey);
    connectBtn.textContent = "Disconnect Wallet";
    await loadBalances();
    enableSwapIfReady();
  } catch (err) {
    console.error("Wallet connection failed", err);
  }
}

async function disconnectWallet() {
  if (window.solana && window.solana.isConnected) await window.solana.disconnect();
  publicKey = null;
  walletAddressEl.textContent = "";
  connectBtn.textContent = "Connect Wallet";
  swapBtn.disabled = true;
}

connectBtn.onclick = async () => {
  if (publicKey) await disconnectWallet();
  else await connectWallet();
};

async function loadTokens() {
  try {
    const res = await fetch(`${API_BASE}/v4/tokens`);
    const json = await res.json();
    tokens = json;
  } catch (err) {
    console.error("Token load failed", err);
  }
}

async function loadBalances() {
  if (!publicKey) return;
  try {
    const res = await fetch(`${API_BASE}/v4/wallet/${publicKey}`);
    const json = await res.json();
    balances = json.tokens || {};
    updateBalancesUI();
  } catch (err) {
    console.error("Balance fetch failed", err);
  }
}

function updateBalancesUI() {
  fromBalanceEl.textContent = balances[fromToken?.address]?.uiAmountString || "0.00";
  toBalanceEl.textContent = balances[toToken?.address]?.uiAmountString || "0.00";
}

// Token modal logic
let selectingFor = null;
fromTokenBtn.onclick = () => openTokenModal("from");
toTokenBtn.onclick = () => openTokenModal("to");
closeModalBtn.onclick = () => tokenModal.classList.add("hidden");

tokenSearch.oninput = () => renderTokenList(tokenSearch.value.toLowerCase());

function openTokenModal(forToken) {
  selectingFor = forToken;
  tokenModal.classList.remove("hidden");
  tokenSearch.value = "";
  renderTokenList("");
  tokenSearch.focus();
}

function renderTokenList(filter) {
  tokenListEl.innerHTML = "";
  const filtered = tokens.filter(t =>
    !filter || t.symbol.toLowerCase().includes(filter) || t.name.toLowerCase().includes(filter)
  );
  if (filtered.length === 0) {
    tokenListEl.innerHTML = "<div class='text-gray-400 text-center py-4'>No tokens found</div>";
    return;
  }
  for (const token of filtered) {
    const div = document.createElement("div");
    div.className = "flex items-center space-x-3 p-3 rounded-lg token-item";
    div.innerHTML = `
      <img src="${token.logoURI}" alt="${token.symbol}" class="w-8 h-8 rounded-full" />
      <div class="flex flex-col flex-grow">
        <span class="font-semibold">${token.symbol}</span>
        <span class="text-xs text-gray-400">${token.name}</span>
      </div>`;
    div.onclick = () => selectToken(token);
    tokenListEl.appendChild(div);
  }
}

function selectToken(token) {
  if (selectingFor === "from") {
    fromToken = token;
    setTokenUI(token, fromTokenSymbol, fromTokenLogo);
    fromAmountInput.value = "";
  } else {
    toToken = token;
    setTokenUI(token, toTokenSymbol, toTokenLogo);
    toAmountInput.value = "";
  }
  tokenModal.classList.add("hidden");
  updateBalancesUI();
  updateQuote();
}

document.getElementById("switchBtn").onclick = () => {
  [fromToken, toToken] = [toToken, fromToken];
  setTokenUI(fromToken, fromTokenSymbol, fromTokenLogo);
  setTokenUI(toToken, toTokenSymbol, toTokenLogo);
  fromAmountInput.value = "";
  toAmountInput.value = "";
  updateBalancesUI();
  updateQuote();
};
</script>
<script>
function debounce(func, timeout = 300){
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => { func.apply(this, args); }, timeout);
  };
}

fromAmountInput.oninput = debounce(() => {
  updateQuote();
}, 400);

async function updateQuote() {
  if (!fromToken || !toToken || !publicKey) {
    swapBtn.disabled = true;
    toAmountInput.value = "";
    return;
  }

  const amount = parseFloat(fromAmountInput.value);
  if (!amount || amount <= 0) {
    swapBtn.disabled = true;
    toAmountInput.value = "";
    return;
  }

  swapBtn.disabled = true;
  swapBtn.textContent = "Fetching quote...";

  const inputAmount = BigInt(Math.floor(amount * (10 ** fromToken.decimals))).toString();

  const params = new URLSearchParams({
    inputMint: fromToken.address,
    outputMint: toToken.address,
    amount: inputAmount,
    slippageBps: "50",
    feeBps: PLATFORM_FEE_BPS.toString(),
    feeAccount: PLATFORM_FEE_ACCOUNT,
    onlyDirectRoutes: "false",
    asLegacyTransaction: "true",
    userPublicKey: publicKey
  });

  try {
    const res = await fetch(`${API_BASE}/v6/quote?${params}`);
    const data = await res.json();

    if (!data || !data.routes || data.routes.length === 0) throw new Error("No route");

    quote = data.routes[0];
    const outAmount = Number(quote.outAmount) / (10 ** toToken.decimals);
    toAmountInput.value = outAmount.toFixed(6);
    swapBtn.disabled = false;
    swapBtn.textContent = "Swap Now";
  } catch (err) {
    console.error("Quote error", err);
    toAmountInput.value = "";
    swapBtn.disabled = true;
    swapBtn.textContent = "Swap Now";
  }
}

swapBtn.onclick = async () => {
  if (!quote || !publicKey) return alert("Invalid quote or wallet.");

  swapBtn.disabled = true;
  swapBtn.textContent = "Swapping...";

  try {
    const res = await fetch(`${API_BASE}/v6/swap`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        route: quote,
        userPublicKey: publicKey,
        wrapUnwrapSOL: true,
        feeAccount: PLATFORM_FEE_ACCOUNT,
        asLegacyTransaction: true
      })
    });

    const { swapTransaction } = await res.json();
    const txBuffer = Uint8Array.from(atob(swapTransaction), c => c.charCodeAt(0));

    const signed = await window.solana.signTransaction(
      window.solanaWeb3.Transaction.from(txBuffer)
    );

    const sig = await window.solana.connect().then(() =>
      window.solana.sendRawTransaction(signed.serialize())
    );

    alert("Swap submitted! Signature: " + sig);
    fromAmountInput.value = "";
    toAmountInput.value = "";
    swapBtn.disabled = true;
    swapBtn.textContent = "Connect Wallet to Swap";
    await loadBalances();
  } catch (err) {
    console.error("Swap failed", err);
    alert("Swap failed: " + err.message);
    swapBtn.disabled = false;
    swapBtn.textContent = "Swap Now";
  }
};

// Auto-init
(async () => {
  await loadTokens();
  fromToken = tokens.find(t => t.symbol === "SOL") || tokens[0];
  toToken = tokens.find(t => t.symbol === "USDC") || tokens[1];
  setTokenUI(fromToken, fromTokenSymbol, fromTokenLogo);
  setTokenUI(toToken, toTokenSymbol, toTokenLogo);
})();

function enableSwapIfReady() {
  const amount = parseFloat(fromAmountInput.value || "0");
  if (publicKey && fromToken && toToken && amount > 0) {
    swapBtn.disabled = false;
    swapBtn.textContent = "Swap Now";
  } else {
    swapBtn.disabled = true;
    swapBtn.textContent = "Connect Wallet to Swap";
  }
}
</script>

</body>
</html>