<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AetherSwap PRO - Full Swap</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
<style>
  :root {
    --bg:#0f111a; --card:#1a1c28; --border:#2c2f3f; --primary:#4a3aff; --text:#fff;
    --err:#e04f5f; --ok:#4ade80; --hover:#3f43b2;
  }
  body {
    margin:0; padding:12px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg); color: var(--text); display:flex; justify-content:center; min-height:100vh; box-sizing:border-box;
  }
  .container {
    max-width:440px; width:100%; background: var(--card);
    border:1px solid var(--border); border-radius: 16px; padding: 20px; display:flex; flex-direction:column; gap: 18px;
  }
  h1 { margin:0; font-weight:600; font-size:1.5rem; text-align:center; }
  .wallet-select {
    display:flex; gap:10px; justify-content:center;
  }
  .wallet-button {
    flex:1; cursor:pointer; border-radius:12px; border:1px solid var(--border);
    background: transparent; color: var(--text); padding:10px; display:flex; justify-content:center; align-items:center; gap:8px;
    font-weight:600; user-select:none; transition: background 0.3s;
  }
  .wallet-button.selected {
    background: var(--primary); color: #000;
  }
  .wallet-button:hover:not(.selected) {
    background: var(--hover);
  }
  .token-row {
    background: var(--bg); border-radius: 14px; border: 1px solid var(--border);
    padding: 14px 18px; cursor: pointer; display:flex; justify-content: space-between; align-items: center;
  }
  .token-info {
    display:flex; align-items:center; gap: 10px;
  }
  .token-logo {
    width: 28px; height: 28px; border-radius: 50%; background:#222;
    object-fit: contain;
  }
  .amount-wrap {
    position: relative;
  }
  input.amount-input {
    width: 100%; padding: 14px 18px; font-size: 1.1rem; border-radius: 14px; border: 1px solid var(--border);
    background: var(--bg); color: var(--text);
  }
  .amount-btns {
    position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
    display:flex; gap:8px;
  }
  button.btn-mini {
    background: var(--border); border:none; color: var(--text); padding: 6px 12px; border-radius: 8px; cursor: pointer;
    font-weight: 600; transition: background 0.3s;
  }
  button.btn-mini:hover {
    background: var(--primary); color: #000;
  }
  .swap-options {
    display:flex; align-items:center; gap: 10px; justify-content:center; font-size: 0.9rem;
  }
  .swap-options input[type=number] {
    width: 65px; padding: 6px 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text);
    text-align:center;
  }
  .swap-info {
    text-align:center; font-size: 0.95rem; color: var(--text); min-height: 22px;
  }
  button.swap-btn {
    width: 100%; padding: 14px; font-weight: 700; font-size: 1.2rem;
    background: var(--primary); border: none; border-radius: 16px; cursor: pointer; display:flex; align-items:center; justify-content:center; gap:10px;
    color: #000;
    transition: background 0.3s;
  }
  button.swap-btn:disabled {
    background: #444; cursor: not-allowed;
  }
  #invert-btn {
    margin: 8px auto 16px auto; width: 60px; height: 34px; border-radius: 14px;
    border: 1px solid var(--border); background: var(--bg); color: var(--text);
    display: flex; justify-content:center; align-items:center; cursor:pointer; transition: background 0.3s;
  }
  #invert-btn:hover {
    background: var(--hover);
  }
  #chart-container {
    height: 180px; margin-bottom: 8px;
  }
  canvas {
    user-select:none;
  }
  .history {
    border: 1px solid var(--border); border-radius: 14px; padding: 12px; max-height: 140px; overflow-y: auto;
  }
  .history h2 {
    margin: 0 0 8px 0; font-weight: 600; font-size: 1.1rem; text-align:center;
  }
  .history-item {
    font-size: 0.85rem; padding: 6px 0; border-bottom: 1px solid var(--border);
    display:flex; justify-content:space-between; gap:10px; flex-wrap: wrap;
  }
  .history-item:last-child {
    border:none;
  }
  .history-success {
    color: var(--ok);
  }
  .history-error {
    color: var(--err);
  }
  .tx-link {
    color: var(--primary);
    text-decoration:none;
  }
  .tx-link:hover {
    text-decoration: underline;
  }
  .modal {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.75);
    display: none; justify-content: center; align-items: center; z-index: 1100;
  }
  .modal.show {
    display: flex;
  }
  .modal-content {
    background: var(--card);
    border-radius: 16px;
    max-width: 360px;
    width: 90vw;
    max-height: 75vh;
    overflow-y: auto;
    box-sizing: border-box;
    padding: 16px;
  }
  .token-search input {
    width: 100%;
    padding: 10px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text);
    font-size: 1rem;
    box-sizing: border-box;
    margin-bottom: 12px;
  }
  .token-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .token-item:hover {
    background: var(--hover);
  }
  .token-item img {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: contain;
  }
</style>
</head>
<body>
<div class="container" role="main" aria-label="AetherSwap PRO Swap Interface">
  <h1>AetherSwap PRO</h1>
  <section class="wallet-select" aria-label="Wallet selection">
    <button id="wallet-phantom" class="wallet-button" aria-pressed="false" aria-label="Select Phantom Wallet"><i class="fa-brands fa-phoenix-squadron" aria-hidden="true"></i> Phantom</button>
    <button id="wallet-wc" class="wallet-button" aria-pressed="false" aria-label="Select WalletConnect"><i class="fa-solid fa-qrcode" aria-hidden="true"></i> WalletConnect</button>
  </section>

  <section id="from-token-row" class="token-row" tabindex="0" aria-label="Select token to swap from">
    <div class="token-info">
      <img id="from-logo" class="token-logo" alt="Token from logo" src="">
      <span id="from-symbol">Select From Token</span>
    </div>
    <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
  </section>

  <section id="to-token-row" class="token-row" tabindex="0" aria-label="Select token to swap to">
    <div class="token-info">
      <img id="to-logo" class="token-logo" alt="Token to logo" src="">
      <span id="to-symbol">Select To Token</span>
    </div>
    <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
  </section>

  <button id="invert-btn" aria-label="Invert tokens" title="Invert tokens"><i class="fa-solid fa-arrow-down-up-across-line" aria-hidden="true"></i></button>

  <section id="chart-container" aria-label="Price chart"></section>

  <div class="amount-wrap">
    <input id="amount" class="amount-input" type="number" aria-label="Amount to swap" placeholder="Enter amount" min="0" step="any" autocomplete="off" />
    <div class="amount-btns">
      <button id="btn-half" class="btn-mini" aria-label="Set amount to half balance">Â½</button>
      <button id="btn-max" class="btn-mini" aria-label="Set amount to max balance">Max</button>
    </div>
  </div>

  <div class="swap-options" aria-label="Slippage settings">
    <label for="slippage">Slippage %:</label>
    <input type="number" id="slippage" min="0.1" max="5" step="0.1" value="0.5" aria-describedby="slippage-desc" />
    <span id="slippage-desc" style="font-size:0.8rem;opacity:0.6;margin-left:6px;">(0.1% - 5%)</span>
  </div>

  <div class="swap-info" id="details" aria-live="polite" aria-atomic="true">Rate: - | Fee: - | Impact: -</div>

  <button id="connect-swap-btn" class="swap-btn" aria-live="polite" aria-atomic="true" aria-disabled="true" disabled>
    <i class="fa-solid fa-wallet" aria-hidden="true"></i>
    <span id="btn-text">Connect Wallet</span>
  </button>

  <section class="history" aria-label="Swap history">
    <h2>Swap History</h2>
    <div id="history-list">No swaps yet.</div>
  </section>
</div>

<!-- Token Selection Modal -->
<div class="modal" id="token-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="-1">
  <div class="modal-content">
    <h3 id="modal-title" style="margin-top:0;">Select Token</h3>
    <div class="token-search">
      <input id="token-search" type="search" aria-label="Search or paste token SPL address" placeholder="Search or paste SPL address" autocomplete="off" />
    </div>
    <div id="token-list" tabindex="0" role="list"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.70.1/lib/index.iife.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
<script src="https://terminal.jup.ag/main-v4.js"></script>
<script>
(() => {
  const REFERRAL = 'H3z4XmmpLwjm2MhfRuEFhK4DjGHhkbQvmgSUUCTrm6hw';
  const FEE_BPS = 10; // 0.1%
  const tokenMap = new Map();
  let walletType = null;
  let provider = null;
  let pubKey = null;
  let fromToken = null;
  let toToken = null;
  let chart = null;
  let priceData = [];
  let wcProvider = null;
  let connection = null;
  let balance = 0;

  // Elements
  const wPhantom = document.getElementById('wallet-phantom');
  const wWC = document.getElementById('wallet-wc');
  const fRow = document.getElementById('from-token-row');
  const tRow = document.getElementById('to-token-row');
  const fLogo = document.getElementById('from-logo');
  const tLogo = document.getElementById('to-logo');
  const fSym = document.getElementById('from-symbol');
  const tSym = document.getElementById('to-symbol');
  const modal = document.getElementById('token-modal');
  const searchI = document.getElementById('token-search');
  const tokenList = document.getElementById('token-list');
  const amountI = document.getElementById('amount');
  const halfBtn = document.getElementById('btn-half');
  const maxBtn = document.getElementById('btn-max');
  const slippageI = document.getElementById('slippage');
  const detailsI = document.getElementById('details');
  const btn = document.getElementById('connect-swap-btn');
  const btnText = document.getElementById('btn-text');
  const invertBtn = document.getElementById('invert-btn');
  const chartContainer = document.getElementById('chart-container');
  const hist = document.getElementById('history-list');

  // Utility functions
  function sanitizeAmount(val) {
    if (!val) return 0;
    let n = parseFloat(val);
    return isNaN(n) || n < 0 ? 0 : n;
  }
  // Wallet select handler
  function selectWallet(type) {
    walletType = type;
    [wPhantom, wWC].forEach(b => b.classList.toggle('selected', b.id.includes(type)));
  }
  wPhantom.onclick = () => selectWallet('phantom');
  wWC.onclick = () => selectWallet('walletconnect');

  // Modal open/close
  let selectionSide = null;
  function openModal(side) {
    selectionSide = side;
    searchI.value = '';
    renderTokenList(Array.from(tokenMap.values()));
    modal.classList.add('show');
    searchI.focus();
  }
  function closeModal() {
    modal.classList.remove('show');
  }
  fRow.onclick = () => openModal('from');
  tRow.onclick = () => openModal('to');
  fRow.onkeydown = e => { if(e.key === 'Enter' || e.key === ' ') openModal('from'); };
  tRow.onkeydown = e => { if(e.key === 'Enter' || e.key === ' ') openModal('to'); };
  modal.onclick = e => { if (e.target === modal) closeModal(); };
  window.addEventListener('keydown', e => { if (e.key === 'Escape' && modal.classList.contains('show')) closeModal(); });
  
  // Render token list filtered by search
  function renderTokenList(tokens) {
    tokenList.innerHTML = '';
    if (tokens.length === 0) {
      tokenList.innerHTML = '<div style="padding:8px;text-align:center;">No tokens found</div>';
      return;
    }
    tokens.forEach(t => {
      const el = document.createElement('div');
      el.className = 'token-item';
      el.tabIndex = 0;
      el.setAttribute('role', 'listitem');
      el.innerHTML = `<img src="${t.logoURI}" alt="${t.symbol} logo" /> <span>${t.symbol}</span>`;
      el.onclick = () => selectToken(t);
      el.onkeydown = e => { if(e.key === 'Enter' || e.key === ' ') selectToken(t); };
      tokenList.appendChild(el);
    });
  }
  searchI.oninput = () => {
    const q = searchI.value.trim().toLowerCase();
    if (q.length === 0) return renderTokenList(Array.from(tokenMap.values()));
    // Try exact address match first:
    if (/^[A-Za-z0-9]{32,44}$/.test(q)) {
      const t = tokenMap.get(q);
      if (t) return renderTokenList([t]);
    }
    // Fallback: filter by symbol or name
    const filtered = Array.from(tokenMap.values()).filter(t => t.symbol.toLowerCase().includes(q) || t.name.toLowerCase().includes(q));
    renderTokenList(filtered);
  };

  // Select token from modal
  function selectToken(token) {
    if (selectionSide === 'from') {
      fromToken = token;
      fLogo.src = token.logoURI;
      fSym.textContent = token.symbol;
    } else if (selectionSide === 'to') {
      toToken = token;
      tLogo.src = token.logoURI;
      tSym.textContent = token.symbol;
    }
    closeModal();
    resetChart();
    updateRate();
    loadPriceChart();
    updateBalance();
  }

  // Fetch tokens list from Jupiter
  async function fetchTokens() {
    try {
      const res = await fetch('https://cache.jup.ag/tokens');
      if(!res.ok) throw new Error('Failed to fetch tokens');
      const tokens = await res.json();
      tokens.forEach(t => tokenMap.set(t.address, t));
      // Default tokens SOL & USDC
      if(tokenMap.has('So11111111111111111111111111111111111111112')) selectToken(tokenMap.get('So11111111111111111111111111111111111111112'));
      if(tokenMap.has('EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v')) {
        if(!toToken) selectToken(tokenMap.get('EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'));
      }
    } catch (e) {
      console.error('Tokens fetch error:', e);
    }
  }

  // Reset chart
  function resetChart() {
    priceData = [];
    if(chart) {
      chart.destroy();
      chart = null;
    }
    chartContainer.innerHTML = '';
  }

  // Load price chart with Chart.js and price stream update
  async function loadPriceChart() {
    resetChart();
    if(!fromToken || !toToken) return;
    const canvas = document.createElement('canvas');
    canvas.height = 180;
    chartContainer.appendChild(canvas);

    chart = new Chart(canvas.getContext('2d'), {
      type: 'line',
      data: {
        datasets: [{
          label: `${fromToken.symbol} / ${toToken.symbol}`,
          data: [],
          borderColor: '#4a3aff',
          backgroundColor: 'rgba(74,58,255,0.25)',
          tension: 0.25,
          pointRadius: 0,
          fill: true,
        }]
      },
      options: {
        animation: false,
        scales: {
          x: { 
            type: 'time',
            time: { unit: 'minute', tooltipFormat: 'HH:mm' },
            grid: { color: '#222' },
            ticks: { color: '#bbb' }
          },
          y: {
            beginAtZero: false,
            grid: { color: '#222' },
            ticks: { color: '#bbb' }
          }
        },
        plugins: { legend: { display: false } },
        interaction: { intersect: false, mode: 'index' },
        maintainAspectRatio: false
      }
    });
    await updatePriceTick();
    setInterval(updatePriceTick, 15000);
  }

  // Update chart data price tick
  async function updatePriceTick() {
    if(!chart || !fromToken || !toToken) return;
    try {
      const url = `https://api.jup.ag/price/v2?ids=${fromToken.address}&vsToken=${toToken.address}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('Price fetch error');
      const data = await res.json();
      if(typeof data.price !== 'number') return;
      priceData.push({ x: Date.now(), y: data.price });
      if(priceData.length > 30) priceData.shift();
      chart.data.datasets[0].data = priceData;
      chart.update('none');
    } catch(e) {
      // fail silently
    }
  }

  // Update user's token balance
  async function updateBalance() {
    if(!fromToken || !pubKey) return;
    try {
      if(!connection) connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
      // We consider native SOL token balance or SPL token balance
      if(fromToken.address === 'So11111111111111111111111111111111111111112') {
        const balLamports = await connection.getBalance(pubKey);
        balance = balLamports / 1e9;
      } else {
        // SPL Token balance query
        const tokenAccounts = await connection.getParsedTokenAccountsByOwner(pubKey, { mint: new solanaWeb3.PublicKey(fromToken.address) });
        if(tokenAccounts.value.length > 0) {
          const uiAmount = tokenAccounts.value[0].account.data.parsed.info.tokenAmount.uiAmount;
          balance = uiAmount || 0;
        } else balance = 0;
      }
      // Enable/disable max and half buttons accordingly
      maxBtn.disabled = balance === 0;
      halfBtn.disabled = balance === 0;
    } catch(e) {
      balance = 0;
      maxBtn.disabled = true;
      halfBtn.disabled = true;
    }
  }

  // Update rate, fees and impact details using Jupiter API
  async function updateRate() {
    if(!fromToken || !toToken || !pubKey) {
      detailsI.textContent = 'Rate: - | Fee: - | Impact: -';
      btn.disabled = true;
      btn.setAttribute('aria-disabled', 'true');
      return;
    }
    let amt = sanitizeAmount(amountI.value);
    if(amt <= 0) {
      detailsI.textContent = 'Rate: - | Fee: - | Impact: -';
      btn.disabled = true;
      btn.setAttribute('aria-disabled', 'true');
      return;
    }
    try {
      const slippageBps = Math.round(parseFloat(slippageI.value) * 100);
      if(slippageBps < 10 || slippageBps > 500) throw new Error('Slippage must be between 0.1% and 5%');
      const inputAmount = Math.floor(amt * Math.pow(10, fromToken.decimals));
      const quote = await window.Jupiter.quote({
        inputMint: fromToken.address,
        outputMint: toToken.address,
        amount: inputAmount,
        slippageBps
      });
      if(!quote.routes || quote.routes.length === 0) throw new Error('No route found');
      const route = quote.routes[0];
      const rate = (route.outAmount / Math.pow(10, route.outDecimals)) / amt;
      const fee = (amt * 0.001).toFixed(6);
      const impact = (route.priceImpactPct * 100).toFixed(2);
      detailsI.textContent = `Rate: 1 ${route.inSymbol} â ${rate.toFixed(6)} ${route.outSymbol} | Fee: ${fee} | Impact: ${impact}%`;
      btn.disabled = false;
      btn.setAttribute('aria-disabled', 'false');
    } catch(e) {
      detailsI.textContent = `Error: ${e.message}`;
      btn.disabled = true;
      btn.setAttribute('aria-disabled', 'true');
    }
  }

  // Perform the swap execution
  async function doSwap() {
    btn.disabled = true;
    btnText.textContent = 'Processing...';
    try {
      const amt = sanitizeAmount(amountI.value);
      const slippageBps = Math.round(parseFloat(slippageI.value) * 100);
      if(amt <= 0) throw new Error('Invalid amount');
      if(!fromToken || !toToken) throw new Error('Select tokens first');
      const inputAmount = Math.floor(amt * Math.pow(10, fromToken.decimals));
      const quote = await window.Jupiter.quote({
        inputMint: fromToken.address,
        outputMint: toToken.address,
        amount: inputAmount,
        slippageBps
      });
      if(!quote.routes || quote.routes.length === 0) throw new Error('No route found');
      const routeInfo = quote.routes[0];
      const exchange = await window.Jupiter.exchange({ routeInfo, userPublicKey: pubKey });
      const txId = await exchange.execute();
      alert(`Swap completed!\nTx: ${txId}`);
      addHistory({ from: fromToken.symbol, to: toToken.symbol, amount: amt, date: new Date().toISOString(), tx: txId, success: true });
      amountI.value = '';
      updateRate();
      updateBalance();
    } catch(e) {
      alert(`Swap failed: ${e.message}`);
      addHistory({ from: fromToken?.symbol || '', to: toToken?.symbol || '', amount: amountI.value || '0', date: new Date().toISOString(), tx: null, success: false, error: e.message });
    } finally {
      btn.disabled = false;
      btnText.textContent = `Swap`;
    }
  }

  // Add swap to history localStorage & render
  function addHistory(item) {
    const histArr = JSON.parse(localStorage.getItem('aetherswap_history') || '[]');
    histArr.unshift(item);
    localStorage.setItem('aetherswap_history', JSON.stringify(histArr.slice(0, 20)));
    renderHistory();
  }
  function renderHistory() {
    const histArr = JSON.parse(localStorage.getItem('aetherswap_history') || '[]');
    if(histArr.length === 0) {
      hist.textContent = 'No swaps yet.';
      return;
    }
    hist.innerHTML = '';
    histArr.forEach(item => {
      const div = document.createElement('div');
      div.className = 'history-item ' + (item.success ? 'history-success' : 'history-error');
      const date = new Date(item.date).toLocaleString();
      div.innerHTML = `<div>${date}</div><div>${item.amount} ${item.from} â ${item.to}</div><div>${item.success ? `<a href="https://solscan.io/tx/${item.tx}" target="_blank" rel="noopener" class="tx-link">Tx Link</a>` : `Failed`}</div>`;
      hist.appendChild(div);
    });
  }

  // Invert tokens and refresh UI
  function invertTokens() {
    [fromToken, toToken] = [toToken, fromToken];
    if(fromToken) {
      fLogo.src = fromToken.logoURI;
      fSym.textContent = fromToken.symbol;
    } else {
      fLogo.src = '';
      fSym.textContent = 'Select From Token';
    }
    if(toToken) {
      tLogo.src = toToken.logoURI;
      tSym.textContent = toToken.symbol;
    } else {
      tLogo.src = '';
      tSym.textContent = 'Select To Token';
    }
    amountI.value = '';
    resetChart();
    updateRate();
    loadPriceChart();
    updateBalance();
  }
  invertBtn.onclick = invertTokens;

  // Connect wallet
  async function connectWallet() {
    if(!walletType) {
      alert('Please select a wallet type.');
      return;
    }
    try {
      if(walletType === 'phantom') {
        if(!window.solana || !window.solana.isPhantom) throw new Error('Phantom wallet not found');
        const resp = await window.solana.connect();
        pubKey = resp.publicKey;
      } else if(walletType === 'walletconnect') {
        wcProvider = new WalletConnectProvider.default({ infuraId: '' });
        await wcProvider.enable();
        provider = wcProvider;
        pubKey = new solanaWeb3.PublicKey(await wcProvider.send('solana_account', []));
      }
      btnText.textContent = 'Swap';
      btn.disabled = true; // Disabled until user inputs amount
      btn.setAttribute('aria-disabled', 'true');
      updateBalance();
    } catch(e) {
      alert('Wallet connection failed: ' + e.message);
    }
  }

  // Event listeners
  btn.onclick = async () => {
    if(!pubKey) {
      await connectWallet();
    } else {
      await doSwap();
    }
  };
  amountI.oninput = () => {
    updateRate();
  };
  slippageI.oninput = () => {
    updateRate();
  };
  maxBtn.onclick = () => {
    amountI.value = balance.toFixed(fromToken?.decimals || 9);
    updateRate();
  };
  halfBtn.onclick = () => {
    amountI.value = (balance / 2).toFixed(fromToken?.decimals || 9);
    updateRate();
  };

  // Initialization
  async function init() {
    await fetchTokens();
    await window.Jupiter.init({
      displayMode: 'hidden',
      endpoint: 'https://api.mainnet-beta.solana.com',
      platformFeeAndAccounts: {
        feeBps: FEE_BPS,
        referralAccount: REFERRAL
      }
    });
    renderHistory();
  }
  init();
})();
</script>
</body>
</html>