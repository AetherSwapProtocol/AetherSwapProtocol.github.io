<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AetherSwap PRO 2025</title>
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.70.1/lib/index.iife.min.js"></script>
<script src="https://terminal.jup.ag/main-v4.js"></script>
<style>
  :root {
    --primary: #6e45e2;
    --dark-bg: #0f0f2d;
    --dark-card-bg: rgba(18, 18, 41, 0.95);
    --light-bg: #f9f9fb;
    --light-card-bg: #ffffff;
    --text-dark: #1a1a2e;
    --text-light: #ffffff;
  }
  body {
    margin: 0; padding: 0;
    font-family: Arial, sans-serif;
    background: var(--dark-bg);
    color: var(--text-light);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    transition: background 0.3s, color 0.3s;
  }
  body.light {
    background: var(--light-bg);
    color: var(--text-dark);
  }
  .swap-card {
    width: 400px;
    background: var(--dark-card-bg);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    position: relative;
    transition: background 0.3s, color 0.3s;
  }
  body.light .swap-card {
    background: var(--light-card-bg);
    color: var(--text-dark);
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  }
  .token-box {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255,255,255,0.08);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 12px;
    cursor: pointer;
  }
  body.light .token-box {
    background: #eee;
  }
  .amount-input {
    width: 100%;
    font-size: 24px;
    background: transparent;
    border: none;
    color: inherit;
    margin-top: 4px;
  }
  .amount-input::placeholder {
    color: rgba(255,255,255,0.5);
  }
  body.light .amount-input::placeholder {
    color: rgba(0,0,0,0.3);
  }
  .balance {
    font-size: 12px;
    opacity: 0.7;
    text-align: right;
  }
  .swap-button {
    width: 100%;
    padding: 16px;
    background: var(--primary);
    border: none;
    border-radius: 12px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    margin-top: 16px;
    transition: background 0.3s;
  }
  .swap-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  .info-line {
    font-size: 13px;
    margin-top: 4px;
    opacity: 0.85;
  }
  .modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .modal-content {
    width: 90%;
    max-width: 360px;
    background: #1e1e3f;
    border-radius: 16px;
    padding: 16px;
    max-height: 80vh;
    overflow-y: auto;
    color: white;
  }
  body.light .modal-content {
    background: #fafafa;
    color: var(--text-dark);
  }
  .modal-content input {
    width: 100%;
    padding: 8px;
    margin-bottom: 12px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
  }
  .token-item {
    padding: 8px;
    border-bottom: 1px solid #333;
    cursor: pointer;
    display: flex;
    align-items: center;
  }
  body.light .token-item {
    border-bottom: 1px solid #ccc;
  }
  .token-item:hover {
    background: #2e2e5f;
  }
  body.light .token-item:hover {
    background: #ddd;
  }
  .token-logo {
    width: 24px;
    height: 24px;
    margin-right: 12px;
    border-radius: 4px;
  }
  /* Toggle button top-right */
  .theme-toggle {
    position: absolute;
    top: 16px;
    right: 16px;
    cursor: pointer;
    width: 36px;
    height: 36px;
    fill: var(--text-light);
    transition: fill 0.3s;
  }
  body.light .theme-toggle {
    fill: var(--text-dark);
  }
  /* Success animation overlay */
  #success-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
  }
  #success-box {
    background: var(--primary);
    padding: 24px;
    border-radius: 16px;
    color: white;
    text-align: center;
    max-width: 320px;
    font-size: 18px;
    box-shadow: 0 0 20px var(--primary);
  }
  #success-check {
    margin: 0 auto 16px;
    width: 72px;
    height: 72px;
    stroke: white;
    stroke-width: 8;
    stroke-linecap: round;
    stroke-linejoin: round;
    fill: none;
    stroke-dasharray: 100;
    stroke-dashoffset: 100;
    animation: checkmark 0.6s ease forwards;
  }
  @keyframes checkmark {
    to {
      stroke-dashoffset: 0;
    }
  }
  a.tx-link {
    color: #fff;
    text-decoration: underline;
    word-break: break-all;
  }
  body.light #success-box {
    background: var(--primary);
    color: white;
    box-shadow: 0 0 20px var(--primary);
  }
  /* MAX button style */
  #max-btn {
    position: absolute;
    right: 16px;
    top: 44px;
    background: var(--primary);
    border: none;
    color: white;
    font-weight: bold;
    border-radius: 12px;
    padding: 4px 10px;
    font-size: 14px;
    cursor: pointer;
    user-select: none;
    transition: background 0.3s;
  }
  #max-btn:hover {
    background: #8f6ffb;
  }
  /* Container relative for input + max */
  .input-container {
    position: relative;
    width: 100%;
  }
  /* Disconnect button */
  #disconnect-btn {
    position: absolute;
    top: 16px;
    left: 16px;
    background: transparent;
    border: 1.5px solid var(--primary);
    color: var(--primary);
    border-radius: 12px;
    padding: 6px 12px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s, color 0.3s;
  }
  #disconnect-btn:hover {
    background: var(--primary);
    color: white;
  }
  body.light #disconnect-btn {
    color: var(--text-dark);
    border-color: var(--text-dark);
  }
  body.light #disconnect-btn:hover {
    background: var(--text-dark);
    color: white;
  }
</style>
</head>
<body>
  <div class="swap-card" role="main" aria-label="AetherSwap PRO Swap interface">
    <button id="disconnect-btn" style="display:none;" aria-label="Disconnect wallet">Disconnect</button>
    <!-- Theme toggle SVG button -->
    <svg class="theme-toggle" id="theme-toggle" viewBox="0 0 24 24" aria-label="Toggle theme" role="button" tabindex="0" >
      <circle cx="12" cy="12" r="5" />
      <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
    </svg>

    <h2 style="text-align: center; margin-top: 0;">AetherSwap PRO</h2>

    <div class="token-box" onclick="openTokenModal('input')" tabindex="0" role="button" aria-label="Select input token">
      <div>
        <div id="input-token-name" aria-live="polite" aria-atomic="true">SOL</div>
        <div class="input-container">
          <input type="number" id="input-amount" class="amount-input" placeholder="0.0" min="0" step="any" autocomplete="off" aria-label="Input amount" />
          <button id="max-btn" title="Max amount" aria-label="Max amount">MAX</button>
        </div>
      </div>
      <div class="balance" id="input-balance" aria-live="polite" aria-atomic="true">Balance: -</div>
    </div>

    <div class="token-box" onclick="openTokenModal('output')" tabindex="0" role="button" aria-label="Select output token">
      <div>
        <div id="output-token-name" aria-live="polite" aria-atomic="true">Select token</div>
        <div style="margin-top: 4px; font-size: 16px;" id="estimated-output" aria-live="polite" aria-atomic="true">~0</div>
      </div>
    </div>

    <div class="info-line" id="rate-info" aria-live="polite" aria-atomic="true">Rate: -</div>
    <div class="info-line">Protocol fee: 0.1%</div>
    <div class="info-line">Network fee: ~0.0005 SOL</div>

    <button class="swap-button" id="swap-btn" aria-live="polite" aria-atomic="true">Connect Wallet</button>
  </div>

  <div class="modal" id="token-modal" role="dialog" aria-modal="true" aria-labelledby="token-modal-label">
    <div class="modal-content">
      <input type="text" id="token-search" placeholder="Search or paste SPL mint" aria-label="Search tokens or paste mint address" />
      <div id="token-list" role="listbox" aria-live="polite"></div>
    </div>
  </div>

  <div id="success-overlay" role="alert" aria-live="assertive" aria-atomic="true">
    <div id="success-box">
      <svg id="success-check" viewBox="0 0 52 52" aria-hidden="true">
        <path d="M14 27l10 10 14-18" />
      </svg>
      <div>Swap successful!</div>
      <a href="#" target="_blank" rel="noopener" class="tx-link" id="tx-link">View transaction</a>
    </div>
  </div>

<script>
  const REFERRAL_ACCOUNT = 'H3z4XmmpLwjm2MhfRuEFhK4DjGHhkbQvmgSUUCTrm6hw';
  const FEE_BPS = 10;

  let inputMint = 'So11111111111111111111111111111111111111112'; // SOL default
  let outputMint = null;
  let inputDecimals = 9;
  let outputDecimals = 0;
  let userWallet = null;
  let selectedTarget = null;
  let userBalanceLamports = 0;
  let jupiterTokens = [];

  const modal = document.getElementById("token-modal");
  const list = document.getElementById("token-list");
  const search = document.getElementById("token-search");
  const swapBtn = document.getElementById("swap-btn");
  const inputAmount = document.getElementById("input-amount");
  const inputBalanceElem = document.getElementById("input-balance");
  const inputTokenNameElem = document.getElementById("input-token-name");
  const outputTokenNameElem = document.getElementById("output-token-name");
  const estimatedOutputElem = document.getElementById("estimated-output");
  const rateInfoElem = document.getElementById("rate-info");
  const maxBtn = document.getElementById("max-btn");
  const successOverlay = document.getElementById("success-overlay");
  const txLink = document.getElementById("tx-link");
  const themeToggle = document.getElementById("theme-toggle");
  const disconnectBtn = document.getElementById("disconnect-btn");

  // Open modal with dynamic token list
  async function fetchJupiterTokens() {
    try {
      const res = await fetch('https://cache.jup.ag/tokens');
      if (!res.ok) throw new Error("Failed to fetch tokens");
      const json = await res.json();
      return json.data;
    } catch (e) {
      console.error(e);
      return [];
    }
  }

  async function initTokenModal() {
    if(jupiterTokens.length === 0) {
      jupiterTokens = await fetchJupiterTokens();
    }
    renderJupiterTokenList("");
  }

  function renderJupiterTokenList(query) {
    const q = query.toLowerCase();
    const filtered = jupiterTokens.filter(token =>
      token.symbol.toLowerCase().includes(q) || token.address.toLowerCase().includes(q)
    );
    list.innerHTML = "";
    if(filtered.length === 0) {
      const nores = document.createElement('div');
      nores.className = 'token-item';
      nores.textContent = 'No tokens found';
      list.appendChild(nores);
      return;
    }
    filtered.forEach(token => {
      const div = document.createElement('div');
      div.className = 'token-item';
      div.setAttribute('role', 'option');
      div.setAttribute('tabindex', '0');
      div.innerHTML = `
        <img src="${token.logoURI}" alt="${token.symbol}" class="token-logo" />
        <strong>${token.symbol}</strong> — ${token.name}
      `;
      div.onclick = () => selectToken(token);
      div.onkeydown = e => {
        if(e.key === "Enter") selectToken(token);
      };
      list.appendChild(div);
    });
  }

  search.oninput = () => renderJupiterTokenList(search.value.trim());

  async function selectToken(token) {
    if (selectedTarget === 'input') {
      inputMint = token.address;
      inputDecimals = token.decimals ?? 9;
      inputTokenNameElem.innerText = token.symbol;
      userBalanceLamports = 0;
      inputBalanceElem.innerText = "Balance: -";
      inputAmount.value = "";
      await updateBalance();
    } else {
      outputMint = token.address;
      outputDecimals = token.decimals ?? 9;
      outputTokenNameElem.innerText = token.symbol;
      estimatedOutputElem.innerText = "~0";
    }
    modal.style.display = "none";
    await updateRatePreview();
  }

  window.onclick = e => {
    if (e.target === modal) modal.style.display = "none";
  };

  async function connectWallet() {
    if(window.solana?.isPhantom) {
      try {
        if(!window.solana.isConnected) {
          await window.solana.connect();
        }
        userWallet = window.solana.publicKey;
        swapBtn.innerText = "Swap Now";
        disconnectBtn.style.display = "inline-block";
        await window.Jupiter.init({
          displayMode: "hidden",
          endpoint: "https://api.mainnet-beta.solana.com",
          platformFeeAndAccounts: {
            feeBps: FEE_BPS,
            referralAccount: REFERRAL_ACCOUNT
          }
        });
        await updateBalance();
      } catch (e) {
        alert("Wallet connection failed");
        console.error(e);
      }
    } else {
      if(confirm("Phantom Wallet is not detected. Install it now?")) {
        window.open("https://phantom.app/", "_blank");
      }
    }
  }

  async function updateBalance() {
    if (!userWallet) return;
    const conn = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com");
    try {
      if (inputMint === 'So11111111111111111111111111111111111111112') {
        const bal = await conn.getBalance(userWallet);
        userBalanceLamports = bal;
        inputBalanceElem.innerText = `Balance: ${(bal / 1e9).toFixed(6)} SOL`;
      } else {
        // For SPL tokens balance fetch
        const accounts = await conn.getTokenAccountsByOwner(userWallet, { mint: new solanaWeb3.PublicKey(inputMint) });
        let bal = 0;
        if(accounts.value.length > 0) {
          const info = accounts.value[0].account.data;
          // Parsing raw data needs more code or external lib, so fallback:
          // We'll just display "-" for now for SPL tokens.
          bal = 0;
        }
        userBalanceLamports = bal;
        inputBalanceElem.innerText = "Balance: -";
      }
    } catch {
      inputBalanceElem.innerText = "Balance: -";
    }
  }

  async function updateRatePreview() {
    const amount = parseFloat(inputAmount.value);
    if (!inputMint || !outputMint || !amount || amount <= 0 || !window.Jupiter) {
      estimatedOutputElem.innerText = "~0";
      rateInfoElem.innerText = "Rate: -";
      return;
    }
    try {
      const quote = await window.Jupiter.quote({
        inputMint,
        outputMint,
        amount: Math.floor(amount * Math.pow(10, inputDecimals)),
        slippageBps: 50,
      });
      const route = quote.routes[0];
      if (route) {
        const outAmt = route.outAmount / Math.pow(10, route.outDecimals);
        estimatedOutputElem.innerText = "~" + outAmt.toFixed(6);
        rateInfoElem.innerText = `Rate: 1 ${route.inSymbol} ≈ ${(outAmt / amount).toFixed(6)} ${route.outSymbol}`;
      } else {
        estimatedOutputElem.innerText = "~0";
        rateInfoElem.innerText = "Rate: -";
      }
    } catch {
      estimatedOutputElem.innerText = "~0";
      rateInfoElem.innerText = "Rate: -";
    }
  }

  async function doSwap() {
    if (!userWallet) return connectWallet();
    const amount = parseFloat(inputAmount.value);
    if (!outputMint || !amount || amount <= 0) {
      alert("Please select output token and enter a valid amount.");
      return;
    }
    swapBtn.disabled = true;
    swapBtn.innerText = "Processing...";
    try {
      const quote = await window.Jupiter.quote({
        inputMint,
        outputMint,
        amount: Math.floor(amount * Math.pow(10, inputDecimals)),
        slippageBps: 50,
      });
      const routeInfo = quote.routes[0];
      if (!routeInfo) throw new Error("No swap route found.");
      const { execute } = await window.Jupiter.exchange({ routeInfo, userPublicKey: userWallet });
      const txid = await execute();
      showSuccess(txid);
    } catch (e) {
      alert("Swap failed: " + e.message);
      console.error(e);
    } finally {
      swapBtn.disabled = false;
      swapBtn.innerText = "Swap Now";
    }
  }

  function showSuccess(txid) {
    txLink.href = `https://explorer.solana.com/tx/${txid}`;
    txLink.innerText = txid;
    successOverlay.style.display = "flex";
    setTimeout(() => {
      successOverlay.style.display = "none";
      inputAmount.value = "";
      estimatedOutputElem.innerText = "~0";
      rateInfoElem.innerText = "Rate: -";
    }, 7000);
  }

  maxBtn.onclick = e => {
    e.stopPropagation();
    if(userBalanceLamports > 0) {
      let maxAmount = userBalanceLamports / Math.pow(10, inputDecimals);
      if(inputMint === 'So11111111111111111111111111111111111111112') maxAmount -= 0.001;
      if(maxAmount < 0) maxAmount = 0;
      inputAmount.value = maxAmount.toFixed(6);
      updateRatePreview();
    }
  };

  inputAmount.addEventListener("input", updateRatePreview);
  swapBtn.addEventListener("click", () => userWallet ? doSwap() : connectWallet());

  disconnectBtn.onclick = () => {
    if(window.solana?.isPhantom && window.solana.isConnected) {
      window.solana.disconnect();
      userWallet = null;
      swapBtn.innerText = "Connect Wallet";
      disconnectBtn.style.display = "none";
      inputBalanceElem.innerText = "Balance: -";
      inputAmount.value = "";
      estimatedOutputElem.innerText = "~0";
      rateInfoElem.innerText = "Rate: -";
    }
  };

  themeToggle.onclick = () => {
    document.body.classList.toggle("light");
  };
  themeToggle.onkeydown = e => {
    if(e.key === "Enter" || e.key === " ") {
      document.body.classList.toggle("light");
    }
  };

  // Initialize on page load
  (async () => {
    if(window.solana?.isPhantom) {
      window.solana.on("connect", () => {
        userWallet = window.solana.publicKey;
        swapBtn.innerText = "Swap Now";
        disconnectBtn.style.display = "inline-block";
        updateBalance();
      });
      window.solana.on("disconnect", () => {
        userWallet = null;
        swapBtn.innerText = "Connect Wallet";
        disconnectBtn.style.display = "none";
        inputBalanceElem.innerText = "Balance: -";
        inputAmount.value = "";
        estimatedOutputElem.innerText = "~0";
        rateInfoElem.innerText = "Rate: -";
      });
      if(window.solana.isConnected) {
        userWallet = window.solana.publicKey;
        swapBtn.innerText = "Swap Now";
        disconnectBtn.style.display = "inline-block";
        await window.Jupiter.init({
          displayMode: "hidden",
          endpoint: "https://api.mainnet-beta.solana.com",
          platformFeeAndAccounts: {
            feeBps: FEE_BPS,
            referralAccount: REFERRAL_ACCOUNT
          }
        });
        await updateBalance();
      }
    }
  })();

  // Open token modal helper exposed globally
  window.openTokenModal = async (target) => {
    selectedTarget = target;
    search.value = "";
    modal.style.display = "flex";
    search.focus();
    if(jupiterTokens.length === 0) {
      await initTokenModal();
    } else {
      renderJupiterTokenList("");
    }
  };
</script>
</body>
</html>