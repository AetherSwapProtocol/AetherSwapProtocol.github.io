<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AetherSwap DEX</title>
  <script type="module" crossorigin src="https://esm.sh/@solana/web3.js@1.89.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solflare-wallet/sdk@1.0.7/dist/index.iife.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #0b0c10;
      color: white;
    }
    header {
      padding: 20px;
      text-align: center;
      background: #1f2833;
    }
    button {
      padding: 10px 16px;
      background: #45a29e;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #swap-container {
      max-width: 420px;
      margin: 40px auto;
      padding: 20px;
      background: #1f2833;
      border-radius: 12px;
    }
    .token-select {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #0d1117;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
    }
    .token-info {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    .token-logo {
      width: 20px;
      height: 20px;
      margin-right: 8px;
      border-radius: 50%;
    }
    input[type="number"] {
      width: 50%;
      padding: 10px;
      background: #c5c6c7;
      border: none;
      border-radius: 5px;
      text-align: right;
    }
    .status {
      margin-top: 15px;
      padding: 10px;
      background: #c5c6c7;
      color: black;
      border-radius: 5px;
      font-size: 0.9em;
    }
    #chart-container {
      margin-top: 20px;
      border-radius: 12px;
      overflow: hidden;
      height: 250px;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .slippage-row {
      text-align: center;
      margin-bottom: 10px;
    }
    #slippage-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #slippage-modal .modal-content {
      background: #1f2833;
      padding: 20px;
      border-radius: 12px;
      max-width: 420px;
      width: 90%;
    }
    .slippage-option {
      margin: 8px 0;
      background: #45a29e;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <h1>AetherSwap</h1>
    <button onclick="connectWallet()">Connect Wallet</button>
  </header>

  <div id="swap-container">
    <div class="token-select">
      <div class="token-info" onclick="selectToken('from')">
        <img id="from-logo" class="token-logo" src="" alt="" />
        <span id="from-symbol">Select From</span>
      </div>
      <input id="from-amount" type="number" placeholder="0.0" />
    </div>

    <div style="text-align:center; margin:10px;">
      <button onclick="switchTokens()">⇅</button>
    </div>

    <div class="token-select">
      <div class="token-info" onclick="selectToken('to')">
        <img id="to-logo" class="token-logo" src="" alt="" />
        <span id="to-symbol">Select To</span>
      </div>
      <input id="to-amount" type="number" placeholder="0.0" />
    </div>

    <div class="slippage-row">
      <button onclick="toggleSlippageModal()">Slippage: <span id="slippage-display">0.5%</span></button>
    </div>

    <div id="price-line" style="text-align:center; margin: 10px;">-</div>
    <button onclick="executeSwap()">Swap</button>
    <div id="tx-status" class="status" style="display:none;"></div>

    <div id="chart-container">
      <iframe id="chart-iframe" src="https://s.tradingview.com/widgetembed/?symbol=SOLUSDT&interval=15&theme=dark"></iframe>
    </div>
  </div>

  <div id="slippage-modal">
    <div class="modal-content">
      <h3>Choose Slippage</h3>
      <div class="slippage-option" onclick="setSlippage(0.1)">0.1%</div>
      <div class="slippage-option" onclick="setSlippage(0.5)">0.5%</div>
      <div class="slippage-option" onclick="setSlippage(1)">1%</div>
      <div style="margin-top:10px;">
        <input type="number" id="custom-slippage" placeholder="Custom %" min="0" step="0.01" />
        <button onclick="setCustomSlippage()">Set Custom</button>
      </div>
      <div class="slippage-option" onclick="toggleSlippageModal()">Close</div>
    </div>
  </div>

  <!-- Token modal & JavaScript logic will be injected in next part -->


<script>
let connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com");
let publicKey = null;
let selectedWallet = null;
let tokens = [];
let fromToken = null;
let toToken = null;
let slippage = 0.5;

async function connectWallet() {
  try {
    if (window.solana?.isPhantom) {
      const res = await window.solana.connect();
      publicKey = res.publicKey.toString();
      selectedWallet = 'phantom';
    } else {
      const provider = new window.Solflare();
      await provider.connect();
      publicKey = provider.publicKey.toString();
      selectedWallet = 'solflare';
    }
    alert("Connected: " + publicKey);
  } catch (err) {
    alert("Wallet connection failed.");
  }
}

function toggleSlippageModal() {
  const modal = document.getElementById("slippage-modal");
  modal.style.display = modal.style.display === "flex" ? "none" : "flex";
}

function setSlippage(value) {
  slippage = value;
  document.getElementById("slippage-display").textContent = value + "%";
  toggleSlippageModal();
}

function setCustomSlippage() {
  const val = parseFloat(document.getElementById("custom-slippage").value);
  if (!isNaN(val) && val > 0) {
    setSlippage(val);
  }
}

function updateChart(symbol) {
  const tvSymbol = (symbol || "SOL").toUpperCase() + "USDT";
  const url = `https://s.tradingview.com/widgetembed/?symbol=${tvSymbol}&interval=15&theme=dark`;
  document.getElementById("chart-iframe").src = url;
}

function switchTokens() {
  [fromToken, toToken] = [toToken, fromToken];
  updateTokenUI();
  updateChart(toToken?.symbol);
  updateQuote();
}

function updateTokenUI() {
  if (fromToken) {
    document.getElementById("from-symbol").textContent = fromToken.symbol;
    document.getElementById("from-logo").src = fromToken.logoURI;
  }
  if (toToken) {
    document.getElementById("to-symbol").textContent = toToken.symbol;
    document.getElementById("to-logo").src = toToken.logoURI;
  }
}

async function loadTokens() {
  const res = await fetch("https://quote-api.jup.ag/v6/tokens");
  tokens = await res.json();
}

function selectToken(side) {
  const list = tokens.map(t => `<div class="slippage-option" onclick="setToken('${side}', '${t.address}')">${t.symbol} - ${t.name}</div>`).join("");
  const modal = document.createElement("div");
  modal.id = "token-selector";
  modal.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;padding:20px;overflow:auto;";
  modal.innerHTML = `<div style="background:#1f2833;padding:20px;border-radius:12px;">${list}<br><button onclick="document.body.removeChild(document.getElementById('token-selector'))">Close</button></div>`;
  document.body.appendChild(modal);
}

function setToken(side, address) {
  const token = tokens.find(t => t.address === address);
  if (side === 'from') fromToken = token;
  else {
    toToken = token;
    updateChart(token.symbol);
  }
  updateTokenUI();
  updateQuote();
  document.body.removeChild(document.getElementById('token-selector'));
}

async function updateQuote() {
  const amount = parseFloat(document.getElementById("from-amount").value);
  if (!fromToken || !toToken || !amount || amount <= 0) return;
  const smallest = BigInt(amount * Math.pow(10, fromToken.decimals));
  const url = `https://quote-api.jup.ag/v6/quote?inputMint=${fromToken.address}&outputMint=${toToken.address}&amount=${smallest}&slippageBps=${slippage * 100}`;
  const res = await fetch(url);
  const data = await res.json();
  const best = data.routes?.[0];
  if (best?.outAmount) {
    const out = Number(best.outAmount) / Math.pow(10, toToken.decimals);
    document.getElementById("to-amount").value = out.toFixed(6);
    document.getElementById("price-line").textContent = `1 ${fromToken.symbol} ≈ ${(out / amount).toFixed(6)} ${toToken.symbol}`;
  }
}

async function executeSwap() {
  if (!publicKey || !fromToken || !toToken) return alert("Connect wallet and select tokens.");
  const amount = parseFloat(document.getElementById("from-amount").value);
  if (!amount || amount <= 0) return alert("Invalid amount.");
  const amountSmallest = BigInt(amount * Math.pow(10, fromToken.decimals));
  const quoteUrl = `https://quote-api.jup.ag/v6/quote?inputMint=${fromToken.address}&outputMint=${toToken.address}&amount=${amountSmallest}&slippageBps=${slippage * 100}`;
  const quoteRes = await fetch(quoteUrl);
  const quoteData = await quoteRes.json();
  const route = quoteData.routes?.[0];
  if (!route) return alert("No route found.");
  const swapRes = await fetch("https://quote-api.jup.ag/v6/swap", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      route,
      userPublicKey: publicKey,
      wrapUnwrapSOL: true,
    }),
  });
  const { swapTransaction } = await swapRes.json();
  const txBuf = Uint8Array.from(atob(swapTransaction), c => c.charCodeAt(0));
  const tx = solanaWeb3.VersionedTransaction.deserialize(txBuf);
  let sig;
  if (selectedWallet === "phantom") {
    const signed = await window.solana.signTransaction(tx);
    sig = await connection.sendRawTransaction(signed.serialize());
  } else {
    const provider = new window.Solflare();
    const signed = await provider.signTransaction(tx);
    sig = await connection.sendRawTransaction(signed.serialize());
  }
  document.getElementById("tx-status").style.display = "block";
  document.getElementById("tx-status").innerHTML = `✅ Tx sent: <a href="https://solscan.io/tx/${sig}" target="_blank">${sig}</a>`;
}

document.getElementById("from-amount").addEventListener("input", updateQuote);
loadTokens();
</script>
</body>
</html>