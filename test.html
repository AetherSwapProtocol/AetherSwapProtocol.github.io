<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AetherSwap PRO - Full Swap Interface</title>

<!-- Fonts & Icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

<!-- Solana web3.js -->
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.70.1/lib/index.iife.min.js"></script>

<!-- WalletConnect -->
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>

<!-- Jupiter SDK -->
<script src="https://terminal.jup.ag/main-v4.js"></script>

<style>
  /* Reset & base */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #0f0f2d;
    color: #eee;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    padding: 20px;
  }

  /* Container */
  #app {
    max-width: 420px;
    width: 100%;
    background: rgba(20, 20, 48, 0.95);
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(10,10,40,0.7);
    padding: 24px;
  }

  h1 {
    margin: 0 0 20px 0;
    font-weight: 700;
    text-align: center;
    color: #7b66ff;
  }

  /* Token selectors */
  .token-selector {
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 14px 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .token-selector:hover {
    background: rgba(123,102,255,0.2);
  }
  .token-info {
    display: flex;
    align-items: center;
  }
  .token-logo {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    margin-right: 12px;
    background: #222244;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .token-logo img {
    max-width: 24px;
    max-height: 24px;
    border-radius: 50%;
  }
  .token-symbol {
    font-weight: 600;
    font-size: 1.1rem;
  }
  .token-label {
    font-size: 0.8rem;
    color: #bbb;
  }
  .token-arrow {
    font-size: 1.2rem;
    color: #7b66ff;
  }

  /* Input amount */
  #amount {
    width: 100%;
    font-size: 1.3rem;
    padding: 12px 16px;
    border-radius: 12px;
    border: none;
    outline: none;
    background: rgba(255,255,255,0.1);
    color: #eee;
    margin-bottom: 10px;
  }

  /* Buttons max / half */
  .btn-inline-group {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
  }
  button.inline-btn {
    flex: 1;
    padding: 8px 0;
    background: #7b66ff;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button.inline-btn:hover {
    background: #6152cc;
  }

  /* Slippage */
  #slippage-container {
    margin-bottom: 20px;
  }
  label.slippage-label {
    font-weight: 600;
    margin-right: 12px;
  }
  #slippage {
    width: 60px;
    padding: 6px 8px;
    border-radius: 8px;
    border: none;
    background: rgba(255,255,255,0.1);
    color: #eee;
  }

  /* Swap Button */
  #swap-button {
    width: 100%;
    background: #7b66ff;
    border: none;
    padding: 16px 0;
    border-radius: 14px;
    font-weight: 700;
    font-size: 1.2rem;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #swap-button:disabled {
    background: #444477;
    cursor: not-allowed;
  }
  #swap-button:hover:not(:disabled) {
    background: #6152cc;
  }

  /* Info & Rate */
  #rate-info {
    margin-top: 16px;
    font-size: 0.9rem;
    color: #aaa;
    user-select: none;
  }

  /* History */
  #history {
    margin-top: 24px;
    max-height: 180px;
    overflow-y: auto;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 12px;
  }
  .history-item {
    padding: 6px 8px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: 0.85rem;
    display: flex;
    justify-content: space-between;
    color: #ccc;
  }
  .history-item a.tx-link {
    color: #7b66ff;
    text-decoration: none;
  }
  .history-item a.tx-link:hover {
    text-decoration: underline;
  }

  /* Modal overlay */
  #token-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  #token-modal.active {
    display: flex;
  }
  #token-modal .modal-content {
    background: #121236;
    border-radius: 14px;
    max-width: 380px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    padding: 20px;
  }
  #token-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  #token-modal .modal-header h2 {
    margin: 0;
    font-weight: 700;
    color: #7b66ff;
  }
  #token-modal .modal-close {
    cursor: pointer;
    font-size: 1.3rem;
    color: #aaa;
    transition: color 0.3s ease;
  }
  #token-modal .modal-close:hover {
    color: #fff;
  }
  #token-search {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 12px;
    border-radius: 12px;
    border: none;
    outline: none;
    background: rgba(255,255,255,0.1);
    color: #eee;
    font-size: 1rem;
  }
  .token-list-item {
    display: flex;
    align-items: center;
    padding: 8px 10px;
    border-radius: 10px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
  }
  .token-list-item:hover {
    background: rgba(123,102,255,0.3);
  }
  .token-list-item img {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    margin-right: 14px;
    background: #222244;
  }
  .token-list-item .token-symbol {
    font-weight: 600;
    color: #ddd;
  }
  .token-list-item .token-name {
    color: #999;
    font-size: 0.85rem;
    margin-left: 8px;
  }

  /* Mini chart */
  #price-chart {
    width: 100%;
    height: 130px;
    margin-top: 16px;
  }

  /* Responsive */
  @media (max-width: 480px) {
    #app {
      max-width: 100%;
      border-radius: 0;
      height: 100vh;
      overflow-y: auto;
      padding: 20px;
    }
  }
</style>
</head>
<body>
<div id="app" role="main" aria-label="AetherSwap PRO Swap Interface">

  <h1>AetherSwap PRO</h1>

  <!-- From Token -->
  <div class="token-selector" id="from-token-selector" tabindex="0" aria-haspopup="listbox" aria-expanded="false" aria-label="Select token to swap from">
    <div class="token-info">
      <div class="token-logo" id="from-token-logo"><!-- Logo here --></div>
      <div>
        <div class="token-symbol" id="from-token-symbol">Select From Token</div>
        <div class="token-label">From</div>
      </div>
    </div>
    <div class="token-arrow"><i class="fa fa-chevron-down"></i></div>
  </div>

  <!-- Amount input -->
  <input id="amount" type="number" min="0" step="any" inputmode="decimal" placeholder="Amount to swap" aria-label="Amount to swap" />

  <div class="btn-inline-group" role="group" aria-label="Amount quick select buttons">
    <button class="inline-btn" id="max-btn" type="button">Max</button>
    <button class="inline-btn" id="half-btn" type="button">Half</button>
  </div>

  <!-- To Token -->
  <div class="token-selector" id="to-token-selector" tabindex="0" aria-haspopup="listbox" aria-expanded="false" aria-label="Select token to swap to">
    <div class="token-info">
      <div class="token-logo" id="to-token-logo"><!-- Logo here --></div>
      <div>
        <div class="token-symbol" id="to-token-symbol">Select To Token</div>
        <div class="token-label">To</div>
      </div>
    </div>
    <div class="token-arrow"><i class="fa fa-chevron-down"></i></div>
  </div>

  <!-- Slippage -->
  <div id="slippage-container">
    <label for="slippage" class="slippage-label">Slippage (%)</label>
    <input type="number" id="slippage" min="0.1" max="5" step="0.1" value="0.5" aria-label="Slippage percentage" />
  </div>

  <!-- Swap Button -->
  <button id="swap-button" disabled aria-disabled="true" aria-live="polite">Connect Wallet</button>

  <!-- Rate Info -->
  <div id="rate-info" aria-live="polite" aria-atomic="true" role="status"></div>

  <!-- Mini Price Chart -->
  <canvas id="price-chart" aria-label="Price chart of selected token pair" role="img"></canvas>

  <!-- History -->
  <section id="history" aria-label="Swap transaction history">
    <h2 style="color:#7b66ff; font-weight:600; font-size:1.1rem; margin-bottom:12px;">Swap History</h2>
    <div id="history-list" tabindex="0" style="outline:none;"></div>
  </section>

</div>

<!-- Token Selection Modal -->
<div id="token-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-desc">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title">Select a Token</h2>
      <div class="modal-close" id="modal-close" role="button" tabindex="0" aria-label="Close token selection modal">&times;</div>
    </div>
    <input type="search" id="token-search" placeholder="Search or paste token address..." aria-describedby="modal-desc" autocomplete="off" />
    <div id="token-list" role="listbox" tabindex="0" aria-label="List of tokens"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<script>
(() => {
  'use strict';

  // Config
  const REFERRAL = 'H3z4XmmpLwjm2MhfRuEFhK4DjGHhkbQvmgSUUCTrm6hw';
  const FEE_BPS = 10; // 0.1%
  const MAX_HISTORY = 20;

  // DOM Elements
  const fromSelector = document.getElementById('from-token-selector');
  const toSelector = document.getElementById('to-token-selector');
  const fromLogo = document.getElementById('from-token-logo');
  const toLogo = document.getElementById('to-token-logo');
  const fromSymbol = document.getElementById('from-token-symbol');
  const toSymbol = document.getElementById('to-token-symbol');
  const amountInput = document.getElementById('amount');
  const maxBtn = document.getElementById('max-btn');
  const halfBtn = document.getElementById('half-btn');
  const slippageInput = document.getElementById('slippage');
  const swapButton = document.getElementById('swap-button');
  const rateInfo = document.getElementById('rate-info');
  const historyList = document.getElementById('history-list');

  // Modal Elements
  const tokenModal = document.getElementById('token-modal');
  const tokenSearchInput = document.getElementById('token-search');
  const tokenList = document.getElementById('token-list');
  const modalCloseBtn = document.getElementById('modal-close');

  // Chart
  const priceChartCanvas = document.getElementById('price-chart');
  let priceChart;

  // State
  let tokens = [];
  let fromToken = null;
  let toToken = null;
  let userPublicKey = null;
  let walletProvider = null;
  let balance = 0;

  // Helper: Format lamports to SOL
  const lamportsToSOL = lamports => lamports / 1e9;
  const solToLamports = sol => Math.round(sol * 1e9);

  // Load tokens list from Jupiter API
  async function fetchTokens() {
    try {
      const resp = await fetch('https://cache.jup.ag/tokens');
      tokens = await resp.json();
      // Sort tokens by symbol ascending
      tokens.sort((a,b) => a.symbol.localeCompare(b.symbol));
    } catch(e) {
      console.error('Failed to fetch tokens', e);
      tokens = [];
    }
  }

  // Show modal for token selection
  let selectingFor = null; // 'from' or 'to'
  function openTokenModal(forWhich) {
    selectingFor = forWhich;
    tokenSearchInput.value = '';
    filterAndRenderTokens('');
    tokenModal.classList.add('active');
    tokenModal.focus();
  }
  function closeTokenModal() {
    tokenModal.classList.remove('active');
  }

  // Filter and render tokens list
  function filterAndRenderTokens(query) {
    const q = query.trim().toLowerCase();
    tokenList.innerHTML = '';

    const filtered = tokens.filter(t => {
      return (
        t.symbol.toLowerCase().includes(q) ||
        t.name.toLowerCase().includes(q) ||
        t.address.toLowerCase().startsWith(q)
      );
    }).slice(0, 100); // Limit to 100

    if(filtered.length === 0) {
      tokenList.innerHTML = '<div style="color:#777; padding:10px;">No tokens found</div>';
      return;
    }

    filtered.forEach(token => {
      const item = document.createElement('div');
      item.className = 'token-list-item';
      item.setAttribute('role','option');
      item.tabIndex = 0;
      item.innerHTML = `
        <img src="${token.logoURI}" alt="${token.symbol} logo" loading="lazy" />
        <div>
          <span class="token-symbol">${token.symbol}</span>
          <span class="token-name">${token.name}</span>
        </div>
      `;
      item.onclick = () => {
        selectToken(token);
        closeTokenModal();
      };
      item.onkeydown = (e) => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          selectToken(token);
          closeTokenModal();
        }
      };
      tokenList.appendChild(item);
    });
  }

  // Select token and update UI
  function selectToken(token) {
    if(selectingFor === 'from') {
      fromToken = token;
      fromLogo.innerHTML = `<img src="${token.logoURI}" alt="${token.symbol} logo">`;
      fromSymbol.textContent = token.symbol;
    } else if(selectingFor === 'to') {
      toToken = token;
      toLogo.innerHTML = `<img src="${token.logoURI}" alt="${token.symbol} logo">`;
      toSymbol.textContent = token.symbol;
    }
    updateSwapButtonState();
    updateRateInfo();
    updatePriceChart();
  }

  // Connect Phantom Wallet
  async function connectPhantom() {
    if(window.solana && window.solana.isPhantom) {
      try {
        const resp = await window.solana.connect();
        userPublicKey = resp.publicKey.toString();
        walletProvider = 'phantom';
        swapButton.textContent = 'Swap Now';
        swapButton.disabled = false;
        updateBalance();
      } catch(e) {
        alert('Wallet connection failed');
      }
    } else {
      alert('Phantom Wallet not detected');
    }
  }

  // WalletConnect placeholder (can extend)
  async function connectWalletConnect() {
    alert('WalletConnect currently not implemented, please use Phantom Wallet');
  }

  // Update user balance
  async function updateBalance() {
    if(!userPublicKey || !fromToken) return;
    try {
      const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
      if(fromToken.address === 'So11111111111111111111111111111111111111112') {
        const bal = await connection.getBalance(new solanaWeb3.PublicKey(userPublicKey));
        balance = lamportsToSOL(bal);
      } else {
        // Token account balance fetch (simplified)
        balance = 0; // Placeholder
      }
      console.log('Balance:', balance);
    } catch(e) {
      console.error('Failed to fetch balance', e);
    }
  }

  // Max / Half buttons
  maxBtn.onclick = () => {
    amountInput.value = balance ? balance.toFixed(6) : '';
  };
  halfBtn.onclick = () => {
    amountInput.value = balance ? (balance/2).toFixed(6) : '';
  };

  // Initialize Jupiter SDK
  let jupiter;
  async function initJupiter() {
    try {
      jupiter = await window.Jupiter.init({
        endpoint: 'https://api.mainnet-beta.solana.com',
        platformFeeAndAccounts: {
          feeBps: FEE_BPS,
          referralAccount: REFERRAL
        },
        displayMode: 'hidden'
      });
      console.log('Jupiter initialized');
    } catch(e) {
      console.error('Failed to init Jupiter', e);
    }
  }

  // Update Swap Button state
  function updateSwapButtonState() {
    if(userPublicKey && fromToken && toToken && amountInput.value > 0) {
      swapButton.disabled = false;
      swapButton.textContent = 'Swap Now';
      swapButton.setAttribute('aria-disabled', 'false');
    } else if(!userPublicKey) {
      swapButton.disabled = false;
      swapButton.textContent = 'Connect Wallet';
      swapButton.setAttribute('aria-disabled', 'false');
    } else {
      swapButton.disabled = true;
      swapButton.textContent = 'Enter valid amount & tokens';
      swapButton.setAttribute('aria-disabled', 'true');
    }
  }

  // Update Rate Info and preview swap quote
  let quoteCache = null;
  async function updateRateInfo() {
    if(!jupiter || !fromToken || !toToken) {
      rateInfo.textContent = '';
      return;
    }
    const amt = parseFloat(amountInput.value);
    if(!amt || amt <= 0) {
      rateInfo.textContent = '';
      return;
    }
    try {
      const inputAmountLamports = Math.round(amt * Math.pow(10, fromToken.decimals));
      const routes = await jupiter.computeRoutes({
        inputMint: fromToken.address,
        outputMint: toToken.address,
        amount: inputAmountLamports,
        slippageBps: Math.round(parseFloat(slippageInput.value) * 100),
        forceFetch: true
      });
      if(routes.routesInfos.length === 0) {
        rateInfo.textContent = 'No route found for this swap.';
        quoteCache = null;
        return;
      }
      const bestRoute = routes.routesInfos[0];
      const outAmount = bestRoute.outAmount;
      const outAmountFmt = (outAmount / Math.pow(10, toToken.decimals)).toFixed(6);
      const priceImpact = (bestRoute.priceImpactPct * 100).toFixed(2);
      rateInfo.textContent = 
        `Estimated output: ${outAmountFmt} ${toToken.symbol} | Price impact: ${priceImpact}% | Fee: ${FEE_BPS / 100}%`;
      quoteCache = bestRoute;
    } catch(e) {
      console.error('Error fetching route', e);
      rateInfo.textContent = 'Error fetching swap info.';
      quoteCache = null;
    }
  }

  // Execute Swap
  async function executeSwap() {
    if(!userPublicKey) {
      await connectPhantom();
      updateSwapButtonState();
      return;
    }
    if(!quoteCache) {
      alert('No valid swap quote available.');
      return;
    }
    swapButton.disabled = true;
    swapButton.textContent = 'Swapping...';
    try {
      const { execute } = await jupiter.exchange(quoteCache);
      const txid = await execute();
      alert(`Swap successful!\nTransaction ID:\n${txid}`);
      addToHistory(txid, fromToken.symbol, toToken.symbol, amountInput.value);
    } catch(e) {
      alert(`Swap failed: ${e.message || e}`);
      console.error(e);
    } finally {
      swapButton.disabled = false;
      swapButton.textContent = 'Swap Now';
    }
  }

  // Add swap to local history
  function addToHistory(txid, fromSym, toSym, amount) {
    const hist = JSON.parse(localStorage.getItem('aetherswap_history') || '[]');
    hist.unshift({ txid, fromSym, toSym, amount, timestamp: Date.now() });
    if(hist.length > MAX_HISTORY) hist.pop();
    localStorage.setItem('aetherswap_history', JSON.stringify(hist));
    renderHistory();
  }

  // Render swap history
  function renderHistory() {
    const hist = JSON.parse(localStorage.getItem('aetherswap_history') || '[]');
    historyList.innerHTML = '';
    if(hist.length === 0) {
      historyList.innerHTML = `<div style="color:#777; padding:10px;">No swap history yet.</div>`;
      return;
    }
    hist.forEach(item => {
      const dateStr = new Date(item.timestamp).toLocaleString();
      const el = document.createElement('div');
      el.className = 'history-item';
      el.innerHTML = `
        <div>${dateStr}</div>
        <div>${item.amount} ${item.fromSym} â†’ ${item.toSym} 
          <a href="https://solscan.io/tx/${item.txid}" target="_blank" rel="noopener noreferrer" class="tx-link" aria-label="View transaction on Solscan">
            <i class="fa fa-external-link-alt"></i>
          </a>
        </div>
      `;
      historyList.appendChild(el);
    });
  }

  // Invert tokens
  function invertTokens() {
    const tmp = fromToken;
    fromToken = toToken;
    toToken = tmp;
    selectToken(fromToken, 'from');
    selectToken(toToken, 'to');
    updateRateInfo();
    updateSwapButtonState();
    updatePriceChart();
  }

  // Update Price Chart
  let priceChartInstance = null;
  async function updatePriceChart() {
    if(!fromToken || !toToken) {
      if(priceChartInstance) priceChartInstance.destroy();
      return;
    }
    // Use CoinGecko API as example for price history
    const fromId = coingeckoId(fromToken);
    const toId = coingeckoId(toToken);
    if(!fromId || !toId) {
      if(priceChartInstance) priceChartInstance.destroy();
      return;
    }
    try {
      const url = `https://api.coingecko.com/api/v3/coins/${fromId}/market_chart?vs_currency=${toId}&days=1&interval=hourly`;
      const resp = await fetch(url);
      if(!resp.ok) throw new Error('Failed to fetch chart data');
      const data = await resp.json();
      const prices = data.prices || [];
      const labels = prices.map(p => {
        const d = new Date(p[0]);
        return `${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
      });
      const values = prices.map(p => p[1]);
      if(priceChartInstance) priceChartInstance.destroy();
      priceChartInstance = new Chart(priceChartCanvas.getContext('2d'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: `${fromToken.symbol}/${toToken.symbol}`,
            data: values,
            borderColor: '#7b66ff',
            backgroundColor: 'rgba(123,102,255,0.3)',
            fill: true,
            tension: 0.3,
            pointRadius: 0
          }]
        },
        options: {
          animation: false,
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { display: false },
            y: {
              ticks: { color: '#bbb' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            }
          }
        }
      });
    } catch(e) {
      console.warn('Chart update failed:', e);
      if(priceChartInstance) priceChartInstance.destroy();
    }
  }

  // Map token address to CoinGecko id (partial list for demo)
  function coingeckoId(token) {
    const mapping = {
      'So11111111111111111111111111111111111111112': 'solana',
      'Es9vMFrzaCERzGpo5D6UPjWNyCBL8xY1aBAY2mKYdX7j': 'usd-coin',
      'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA': 'wrapped-solana'
    };
    return mapping[token.address] || null;
  }

  // Event listeners
  fromSelector.onclick = () => openTokenModal('from');
  fromSelector.onkeydown = (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openTokenModal('from'); } };
  toSelector.onclick = () => openTokenModal('to');
  toSelector.onkeydown = (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openTokenModal('to'); } };
  modalCloseBtn.onclick = closeTokenModal;
  modalCloseBtn.onkeydown = (e) => { if(e.key === 'Enter' || e.key === ' ') { closeTokenModal(); } };
  tokenSearchInput.oninput = () => filterAndRenderTokens(tokenSearchInput.value);

  amountInput.oninput = () => {
    updateRateInfo();
    updateSwapButtonState();
  };
  slippageInput.oninput = () => {
    if(parseFloat(slippageInput.value) < 0.1) slippageInput.value = '0.1';
    if(parseFloat(slippageInput.value) > 5) slippageInput.value = '5';
    updateRateInfo();
  };

  swapButton.onclick = async () => {
    if(!userPublicKey) {
      await connectPhantom();
      updateSwapButtonState();
    } else {
      await executeSwap();
    }
  };

  // Keyboard accessibility
  document.addEventListener('keydown', e => {
    if(e.key === 'Escape' && tokenModal.classList.contains('active')) {
      closeTokenModal();
    }
  });

  // Init
  (async () => {
    await fetchTokens();
    await initJupiter();
    renderHistory();
    updateSwapButtonState();
  })();

})();
</script>
</body>
</html>