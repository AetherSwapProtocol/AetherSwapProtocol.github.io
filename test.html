<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AetherSwap Dex</title>
<style>
  :root {
    --primary: #6e45e2;
    --primary-hover: #5934ba;
    --bg: #0f0f0f;
    --surface: #1a1a2f;
    --text: #eee;
    --text-muted: #aaa;
    --radius: 16px;
    --shadow: 0 8px 24px rgba(0,0,0,0.7);
    --focus: 3px solid var(--primary);
    --transition: 0.3s ease;
  }
  * { box-sizing: border-box; }
  body {
    margin:0; padding:24px;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    justify-content: center;
    min-height: 100vh;
  }
  .container {
    max-width: 440px;
    width: 100%;
    background: var(--surface);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  h1 {
    margin:0 0 12px;
    font-weight: 700;
    color: var(--primary);
    text-align: center;
  }
  .token-select {
    background: rgba(255 255 255 / 0.05);
    border-radius: var(--radius);
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: background var(--transition);
    user-select: none;
  }
  .token-select:hover, .token-select:focus {
    background: rgba(110 69 226 / 0.4);
    outline: var(--focus);
  }
  .token-select img {
    width: 32px; height: 32px;
    border-radius: 50%;
    background: #fff;
    object-fit: contain;
    flex-shrink: 0;
  }
  .token-symbol {
    flex-grow: 1;
    font-weight: 700;
  }
  input[type=number] {
    width: 100%;
    font-size: 1.2rem;
    background: rgba(255 255 255 / 0.05);
    border: none;
    border-radius: var(--radius);
    padding: 12px;
    color: var(--text);
    text-align: right;
    font-weight: 600;
  }
  input[type=number]::placeholder {
    color: var(--text-muted);
  }
  input[readonly] {
    user-select: none;
    cursor: default;
  }
  .switch-btn {
    background: none;
    border: none;
    color: var(--primary);
    font-size: 1.5rem;
    align-self: center;
    cursor: pointer;
    padding: 6px;
    margin: 12px 0;
    transition: color var(--transition);
  }
  .switch-btn:hover {
    color: var(--primary-hover);
  }
  .btn {
    background: var(--primary);
    border: none;
    color: white;
    font-weight: 700;
    border-radius: var(--radius);
    padding: 16px;
    cursor: pointer;
    transition: background var(--transition);
    user-select: none;
  }
  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .slippage-container {
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-muted);
    font-weight: 600;
  }
  select, input.slip-custom {
    background: rgba(255 255 255 / 0.05);
    border: none;
    border-radius: var(--radius);
    color: var(--text);
    font-size: 1rem;
    padding: 6px 12px;
    width: 100px;
    text-align: right;
  }
  input.slip-custom {
    display: none;
  }
  .history {
    max-height: 160px;
    overflow-y: auto;
    font-size: 0.9rem;
    color: var(--text-muted);
    border-top: 1px solid rgba(255 255 255 / 0.1);
    padding-top: 12px;
  }
  .history div {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
  }
  .history a {
    color: var(--primary);
    text-decoration: none;
  }
  .history a:hover {
    text-decoration: underline;
  }
  /* Modal */
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(15, 15, 45, 0.9);
    display: none;
    justify-content: center;
    align-items: flex-start;
    padding: 40px 12px;
    z-index: 9999;
  }
  .modal.active {
    display: flex;
  }
  .modal-content {
    background: var(--surface);
    border-radius: var(--radius);
    width: 100%;
    max-width: 420px;
    box-shadow: var(--shadow);
    padding: 16px;
    color: var(--text);
    position: relative;
  }
  .modal-content h2 {
    margin: 0 0 12px 0;
    color: var(--primary);
  }
  .modal-content input[type=search] {
    width: 100%;
    padding: 8px;
    border: none;
    border-radius: var(--radius);
    margin-bottom: 12px;
    background: rgba(255 255 255 / 0.05);
    color: var(--text);
    font-size: 1rem;
  }
  .token-list {
    max-height: 320px;
    overflow-y: auto;
    border-top: 1px solid rgba(255 255 255 / 0.1);
  }
  .token-list div {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px;
    cursor: pointer;
    border-radius: var(--radius);
    transition: background var(--transition);
  }
  .token-list div:hover, .token-list div:focus {
    background: rgba(110 69 226 / 0.3);
    outline: none;
  }
  .token-list img {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #fff;
    object-fit: contain;
    flex-shrink: 0;
  }
  .close-btn {
    position: absolute;
    top: 12px;
    right: 16px;
    background: none;
    border: none;
    color: var(--primary);
    font-size: 1.8rem;
    cursor: pointer;
  }
  /* Loader */
  .loader {
    border: 4px solid rgba(255 255 255 / 0.1);
    border-top: 4px solid var(--primary);
    border-radius: 50%;
    width: 24px;
    height: 24px;
    animation: spin 1s linear infinite;
    display: inline-block;
  }
  @keyframes spin {
    0% {transform: rotate(0deg);}
    100% {transform: rotate(360deg);}
  }
  /* Responsive */
  @media (max-width: 460px) {
    .container {
      padding: 16px;
    }
    .token-list {
      max-height: 240px;
    }
  }
</style>
</head>
<body>

<div class="container" role="main" aria-label="AetherSwap PRO">
  <h1>AetherSwap</h1>

  <div id="fromToken" class="token-select" tabindex="0" role="button" aria-label="Select input token">
    <img id="fromIcon" src="" alt="From Token icon" />
    <div id="fromSymbol" class="token-symbol">Select Token</div>
  </div>

  <input id="fromAmount" type="number" min="0" step="any" placeholder="0.0" aria-label="Input amount" />

  <button class="switch-btn" id="switchBtn" title="Switch tokens" aria-label="Switch tokens" tabindex="0">&#8646;</button>

  <div id="toToken" class="token-select" tabindex="0" role="button" aria-label="Select output token">
    <img id="toIcon" src="" alt="To Token icon" />
    <div id="toSymbol" class="token-symbol">Select Token</div>
  </div>

  <input id="toAmount" type="number" readonly placeholder="0.0" aria-label="Output amount" />

  <div class="slippage-container" aria-label="Slippage tolerance">
    <label for="slippageSelect">Slippage:</label>
    <select id="slippageSelect" aria-label="Slippage tolerance select">
      <option value="10">0.1%</option>
      <option value="50" selected>0.5%</option>
      <option value="100">1%</option>
      <option value="custom">Custom</option>
    </select>
    <input id="slippageCustom" class="slip-custom" type="number" min="0" max="100" step="0.01" placeholder="%" aria-label="Custom slippage tolerance" />
  </div>

  <button id="connectBtn" class="btn">Connect Wallet</button>
  <button id="swapBtn" class="btn" disabled>Swap Now</button>

  <div class="history" aria-live="polite" aria-atomic="true" aria-relevant="additions">
    <strong>Swap History</strong>
    <div id="historyList"></div>
  </div>
</div>

<!-- Token selection modal -->
<div id="tokenModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" tabindex="-1">
  <div class="modal-content">
    <button id="modalClose" class="close-btn" aria-label="Close token selection modal">&times;</button>
    <h2 id="modalTitle">Select a token</h2>
    <input id="tokenSearch" type="search" placeholder="Search or paste token address..." aria-label="Search tokens" autocomplete="off" />
    <div id="tokenList" class="token-list"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.70.1/lib/index.iife.min.js"></script>

<script>
(() => {
  const API_BASE = 'https://lite-api.jup.ag';

  // Elements
  const fromTokenEl = document.getElementById('fromToken');
  const toTokenEl = document.getElementById('toToken');
  const fromIcon = document.getElementById('fromIcon');
  const toIcon = document.getElementById('toIcon');
  const fromSymbol = document.getElementById('fromSymbol');
  const toSymbol = document.getElementById('toSymbol');
  const fromAmountInput = document.getElementById('fromAmount');
  const toAmountInput = document.getElementById('toAmount');
  const slippageSelect = document.getElementById('slippageSelect');
  const slippageCustom = document.getElementById('slippageCustom');
  const connectBtn = document.getElementById('connectBtn');
  const swapBtn = document.getElementById('swapBtn');
  const switchBtn = document.getElementById('switchBtn');
  const historyList = document.getElementById('historyList');
  const tokenModal = document.getElementById('tokenModal');
  const modalCloseBtn = document.getElementById('modalClose');
  const tokenSearchInput = document.getElementById('tokenSearch');
  const tokenListEl = document.getElementById('tokenList');

  // State
  let tokens = [];
  let filteredTokens = [];
  let selectingFor = null; // "from" or "to"
  let wallet = null;
  let currentQuote = null;

  // Helpers
  function setLoading(button, loading) {
    if (loading) {
      button.disabled = true;
      button.innerHTML = `<span class="loader" aria-label="Loading"></span>`;
    } else {
      button.disabled = false;
      if(button === connectBtn) button.textContent = wallet ? `Connected: ${wallet.publicKey.toString().slice(0,4)}...${wallet.publicKey.toString().slice(-4)}` : 'Connect Wallet';
      if(button === swapBtn) button.textContent = 'Swap Now';
    }
  }

  function formatAmount(amount, decimals) {
    return Number(amount / Math.pow(10, decimals)).toFixed(6);
  }

  // Load tokens
  async function loadTokens() {
    try {
      setLoading(connectBtn, true);
      const res = await fetch(`${API_BASE}/tokens/v2/search`);
      if(!res.ok) throw new Error('Failed to load tokens');
      const data = await res.json();
      tokens = data.tokens || [];
      filteredTokens = [...tokens];
      renderTokenList(filteredTokens);
    } catch(e) {
      console.error('Tokens load error:', e);
      tokenListEl.innerHTML = '<p style="color:#f55;">Failed to load tokens list.</p>';
    } finally {
      setLoading(connectBtn, false);
    }
  }

  // Render token list
  function renderTokenList(list) {
    tokenListEl.innerHTML = '';
    if (!list.length) {
      tokenListEl.innerHTML = '<p>No tokens found.</p>';
      return;
    }
    list.forEach(token => {
      const div = document.createElement('div');
      div.tabIndex = 0;
      div.setAttribute('role', 'button');
      div.setAttribute('aria-label', `Select ${token.symbol} token`);
      div.className = 'token-item';

      const img = document.createElement('img');
      img.src = token.logoURI || '';
      img.alt = token.symbol;
      div.appendChild(img);

      const span = document.createElement('span');
      span.textContent = `${token.symbol} - ${token.name}`;
      div.appendChild(span);

      div.onclick = () => {
        selectToken(token);
        closeModal();
      };
      div.onkeydown = e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          selectToken(token);
          closeModal();
        }
      };

      tokenListEl.appendChild(div);
    });
  }

  // Modal control
  function openModal(forToken) {
    selectingFor = forToken;
    tokenSearchInput.value = '';
    filteredTokens = [...tokens];
    renderTokenList(filteredTokens);
    tokenModal.classList.add('active');
    tokenModal.focus();
  }
  function closeModal() {
    tokenModal.classList.remove('active');
  }

  tokenSearchInput.addEventListener('input', () => {
    const q = tokenSearchInput.value.trim().toLowerCase();
    if (!q) filteredTokens = [...tokens];
    else {
      filteredTokens = tokens.filter(t =>
        t.symbol.toLowerCase().includes(q) ||
        t.name.toLowerCase().includes(q) ||
        t.address.toLowerCase().startsWith(q)
      );
    }
    renderTokenList(filteredTokens);
  });

  modalCloseBtn.addEventListener('click', closeModal);
  tokenModal.addEventListener('keydown', e => { if(e.key === 'Escape') closeModal(); });

  // Token selection update UI
  function selectToken(token) {
    if(selectingFor === 'from') {
      window.tokenState.from = token;
      fromIcon.src = token.logoURI || '';
      fromIcon.alt = token.symbol;
      fromSymbol.textContent = token.symbol;
    }
    else if(selectingFor === 'to') {
      window.tokenState.to = token;
      toIcon.src = token.logoURI || '';
      toIcon.alt = token.symbol;
      toSymbol.textContent = token.symbol;
    }
    // reset amounts and quote on token change
    fromAmountInput.value = '';
    toAmountInput.value = '';
    currentQuote = null;
    swapBtn.disabled = true;
  }

  // Switch tokens
  switchBtn.addEventListener('click', () => {
    if(!window.tokenState.from && !window.tokenState.to) return;
    const temp = window.tokenState.from;
    window.tokenState.from = window.tokenState.to;
    window.tokenState.to = temp;
    // Update UI
    if(window.tokenState.from) {
      fromIcon.src = window.tokenState.from.logoURI || '';
      fromIcon.alt = window.tokenState.from.symbol;
      fromSymbol.textContent = window.tokenState.from.symbol;
    } else {
      fromIcon.src = '';
      fromSymbol.textContent = 'Select Token';
    }
    if(window.tokenState.to) {
      toIcon.src = window.tokenState.to.logoURI || '';
      toIcon.alt = window.tokenState.to.symbol;
      toSymbol.textContent = window.tokenState.to.symbol;
    } else {
      toIcon.src = '';
      toSymbol.textContent = 'Select Token';
    }
    fromAmountInput.value = '';
    toAmountInput.value = '';
    currentQuote = null;
    swapBtn.disabled = true;
  });

  // Clicking token selects
  fromTokenEl.addEventListener('click', () => openModal('from'));
  fromTokenEl.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      openModal('from');
    }
  });
  toTokenEl.addEventListener('click', () => openModal('to'));
  toTokenEl.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      openModal('to');
    }
  });

  // Phantom Wallet connect
  async function connectWallet() {
    if(!window.solana || !window.solana.isPhantom) {
      alert('Phantom Wallet not found. Please install it.');
      return;
    }
    try {
      const resp = await window.solana.connect();
      wallet = window.solana;
      connectBtn.textContent = `Connected: ${wallet.publicKey.toString().slice(0,4)}...${wallet.publicKey.toString().slice(-4)}`;
      connectBtn.disabled = true;
      fromAmountInput.disabled = false;
      swapBtn.disabled = false;
      return wallet;
    } catch(e) {
      alert('Wallet connection rejected or failed.');
      console.error(e);
    }
  }
  connectBtn.addEventListener('click', connectWallet);

  // Save last swaps history in localStorage
  function addToHistory(from, to, fromAmount, toAmount, txSig) {
    const history = JSON.parse(localStorage.getItem('aetherswap_history') || '[]');
    history.unshift({
      time: Date.now(),
      from,
      to,
      fromAmount,
      toAmount,
      txSig
    });
    if(history.length > 10) history.pop();
    localStorage.setItem('aetherswap_history', JSON.stringify(history));
    renderHistory();
  }
  function renderHistory() {
    const history = JSON.parse(localStorage.getItem('aetherswap_history') || '[]');
    historyList.innerHTML = '';
    if(!history.length) return;
    history.forEach(h => {
      const div = document.createElement('div');
      const date = new Date(h.time).toLocaleString();
      div.innerHTML = `<span title="${date}">${h.fromAmount} ${h.from.symbol || h.from} → ${h.toAmount} ${h.to.symbol || h.to}</span> 
        <a href="https://solscan.io/tx/${h.txSig}" target="_blank" rel="noopener noreferrer" aria-label="View transaction on Solscan">${h.txSig.slice(0,6)}...${h.txSig.slice(-6)}</a>`;
      historyList.appendChild(div);
    });
  }

  // Get slippage value in basis points (1% = 100)
  function getSlippageBps() {
    if(slippageSelect.value === 'custom') {
      const val = Number(slippageCustom.value);
      if(isNaN(val) || val < 0) return 50; // default 0.5%
      return Math.min(val * 100, 500); // max 5%
    }
    return Number(slippageSelect.value);
  }
  slippageSelect.addEventListener('change', () => {
    if(slippageSelect.value === 'custom') {
      slippageCustom.style.display = 'inline-block';
      slippageCustom.focus();
    } else {
      slippageCustom.style.display = 'none';
      slippageCustom.value = '';
    }
  });

  // Fetch quote from Jupiter V2 API
  let quoteAbortController = null;
  async function fetchQuote() {
    if(!wallet) {
      toAmountInput.value = '';
      swapBtn.disabled = true;
      return;
    }
    if(!window.tokenState.from || !window.tokenState.to) return;
    const inputAmt = Number(fromAmountInput.value);
    if(!inputAmt || inputAmt <= 0) {
      toAmountInput.value = '';
      swapBtn.disabled = true;
      return;
    }

    // Abort previous quote if any
    if(quoteAbortController) quoteAbortController.abort();
    quoteAbortController = new AbortController();

    try {
      setLoading(swapBtn, true);
      const fromToken = window.tokenState.from;
      const toToken = window.tokenState.to;
      // convert amount to base units
      const amountBaseUnits = BigInt(Math.floor(inputAmt * Math.pow(10, fromToken.decimals)));

      const params = {
        inputMint: fromToken.address,
        outputMint: toToken.address,
        amount: amountBaseUnits.toString(),
        slippageBps: getSlippageBps(),
        userPublicKey: wallet.publicKey.toString(),
        onlyDirectRoutes: false
      };

      const res = await fetch(`${API_BASE}/swap/v2/quote`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(params),
        signal: quoteAbortController.signal,
      });

      if(!res.ok) throw new Error('Quote API error');
      const data = await res.json();
      if(!data || !data.data || !data.data[0]) {
        toAmountInput.value = '';
        swapBtn.disabled = true;
        return;
      }

      currentQuote = data.data[0];

      // Set output amount
      const outputAmountRaw = BigInt(currentQuote.outAmount);
      const outputDecimals = toToken.decimals;
      const outputAmount = Number(outputAmountRaw) / Math.pow(10, outputDecimals);
      toAmountInput.value = outputAmount.toFixed(6);

      swapBtn.disabled = false;

    } catch(e) {
      if(e.name !== 'AbortError') {
        console.error(e);
        toAmountInput.value = '';
        swapBtn.disabled = true;
      }
    } finally {
      setLoading(swapBtn, false);
    }
  }

  // Debounce input
  let debounceTimer;
  fromAmountInput.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(fetchQuote, 400);
  });
  slippageSelect.addEventListener('change', fetchQuote);
  slippageCustom.addEventListener('input', fetchQuote);

  // Swap execution
  async function executeSwap() {
    if(!wallet || !currentQuote) {
      alert('Please connect wallet and provide valid swap info.');
      return;
    }

    setLoading(swapBtn, true);
    try {
      // Get swap instructions
      const body = {
        route: currentQuote.route,
        userPublicKey: wallet.publicKey.toString(),
        wrapUnwrapSOL: true
      };
      const res = await fetch(`${API_BASE}/swap/v2/swap-instructions`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      if(!res.ok) throw new Error('Swap instructions error');
      const data = await res.json();

      if(!data || !data.unsignedTransaction) throw new Error('Invalid swap instructions');

      const txBase64 = data.unsignedTransaction;
      // Deserialize transaction
      const transaction = window.solanaWeb3.Transaction.from(Buffer.from(txBase64, 'base64'));

      // Send transaction
      const signedTx = await wallet.signTransaction(transaction);
      const connection = new window.solanaWeb3.Connection(window.solanaWeb3.clusterApiUrl('mainnet-beta'), 'confirmed');
      const txid = await connection.sendRawTransaction(signedTx.serialize());
      await connection.confirmTransaction(txid, 'confirmed');

      addToHistory(window.tokenState.from, window.tokenState.to, fromAmountInput.value, toAmountInput.value, txid);
      alert(`Swap successful! Txid:\n${txid}`);

      // Reset inputs
      fromAmountInput.value = '';
      toAmountInput.value = '';
      currentQuote = null;
      swapBtn.disabled = true;

    } catch(e) {
      console.error(e);
      alert('Swap failed: ' + (e.message || e));
    } finally {
      setLoading(swapBtn, false);
    }
  }
  swapBtn.addEventListener('click', executeSwap);

  // Init token state
  window.tokenState = { from: null, to: null };

  // Load tokens on start
  loadTokens();

  // Load swap history on start
  renderHistory();

  // Disable inputs before wallet connected
  fromAmountInput.disabled = true;

})();
</script>
</body>
</html>