<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AetherSwap PRO | DEX Aggregator Ultra API</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors: {
          primary: {
            500: '#7e22ce',
            600: '#6b21a8'
          },
          secondary: {
            500: '#3b82f6',
            600: '#2563eb'
          },
          backgroundGlass: 'rgba(255,255,255,0.1)',
          backgroundGlassHover: 'rgba(255,255,255,0.15)'
        },
        backdropBlur: {
          xs: '2px'
        }
      }
    }
  }
</script>

<style>
  /* Glassmorphism scrollbar */
  ::-webkit-scrollbar {
    width: 6px;
  }
  ::-webkit-scrollbar-thumb {
    background: rgba(126, 34, 206, 0.6);
    border-radius: 3px;
  }
  /* Modal scrollbar */
  .token-list::-webkit-scrollbar {
    width: 6px;
  }
  .token-list::-webkit-scrollbar-thumb {
    background-color: rgba(126, 34, 206, 0.5);
    border-radius: 3px;
  }
</style>

</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">

  <div class="max-w-lg w-full bg-[rgba(255,255,255,0.07)] backdrop-blur-xs rounded-2xl shadow-xl overflow-hidden border border-[rgba(126,34,206,0.3)]">
    <!-- Header -->
    <header class="flex items-center justify-between px-6 py-4 border-b border-[rgba(126,34,206,0.3)]">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-primary-500 to-secondary-500 flex items-center justify-center text-white font-extrabold text-xl select-none">A</div>
        <h1 class="text-2xl font-bold tracking-wide select-none">AetherSwap PRO</h1>
      </div>
      <div class="flex items-center space-x-2 text-sm text-green-400 font-semibold select-none">
        <div class="w-3 h-3 rounded-full bg-green-400 animate-pulse"></div>
        <span>Solana Mainnet</span>
      </div>
    </header>

    <!-- Swap Interface Container -->
    <main class="p-6 space-y-6">

      <!-- From Token Block -->
      <section>
        <div class="flex justify-between mb-1">
          <label class="font-semibold text-sm">From</label>
          <span class="text-xs text-gray-400 select-none">Balance: <span id="fromTokenBalance">0.00</span></span>
        </div>
        <div
          id="fromTokenSelector"
          class="flex items-center bg-[rgba(255,255,255,0.1)] hover:bg-[rgba(255,255,255,0.15)] cursor-pointer rounded-xl px-4 py-3 select-none transition"
        >
          <img id="fromTokenLogo" class="w-8 h-8 rounded-full mr-3" src="" alt="token logo" onerror="this.style.display='none'" />
          <span id="fromTokenSymbol" class="text-lg font-semibold">Select a token</span>
          <svg class="ml-auto w-5 h-5 text-gray-400 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="fromTokenCaret">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        <input
          id="fromAmount"
          type="number"
          min="0"
          placeholder="0.0"
          class="mt-2 w-full bg-transparent border-b border-[rgba(126,34,206,0.5)] text-3xl font-extrabold text-white placeholder:text-gray-400 focus:outline-none focus:border-primary-500 transition"
        />
        <div class="text-xs text-gray-400 mt-1 select-none">≈ $<span id="fromAmountUSD">0.00</span></div>
      </section>

      <!-- Switch Button -->
      <button
        id="switchTokens"
        aria-label="Switch tokens"
        class="mx-auto flex items-center justify-center w-12 h-12 bg-[rgba(255,255,255,0.1)] hover:bg-[rgba(255,255,255,0.15)] rounded-full transition cursor-pointer"
      >
        <svg class="w-6 h-6 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"
          />
        </svg>
      </button>

      <!-- To Token Block -->
      <section>
        <div class="flex justify-between mb-1">
          <label class="font-semibold text-sm">To</label>
          <span class="text-xs text-gray-400 select-none">Balance: <span id="toTokenBalance">0.00</span></span>
        </div>
        <div
          id="toTokenSelector"
          class="flex items-center bg-[rgba(255,255,255,0.1)] hover:bg-[rgba(255,255,255,0.15)] cursor-pointer rounded-xl px-4 py-3 select-none transition"
        >
          <img id="toTokenLogo" class="w-8 h-8 rounded-full mr-3" src="" alt="token logo" onerror="this.style.display='none'" />
          <span id="toTokenSymbol" class="text-lg font-semibold">Select a token</span>
          <svg class="ml-auto w-5 h-5 text-gray-400 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="toTokenCaret">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        <input
          id="toAmount"
          type="text"
          readonly
          placeholder="0.0"
          class="mt-2 w-full bg-transparent border-b border-[rgba(126,34,206,0.5)] text-3xl font-extrabold text-white placeholder:text-gray-400 focus:outline-none focus:border-primary-500 transition"
        />
        <div class="text-xs text-gray-400 mt-1 select-none">≈ $<span id="toAmountUSD">0.00</span></div>
      </section>

      <!-- Swap Details -->
      <section
        class="bg-[rgba(255,255,255,0.05)] rounded-xl p-4 space-y-2 select-none"
      >
        <div class="flex justify-between text-sm text-gray-300">
          <span>Exchange Rate</span>
          <span id="exchangeRate">-</span>
        </div>
        <div class="flex justify-between text-sm text-gray-300">
          <span>Price Impact</span>
          <span id="priceImpact" class="font-semibold">-</span>
        </div>
        <div class="flex justify-between text-sm text-gray-300">
          <span>Network Fee</span>
          <span id="networkFee">-</span>
        </div>
        <div class="flex justify-between text-sm text-purple-400 font-semibold">
          <span>AetherSwap Fee</span>
          <span>0.15%</span>
        </div>
      </section>

      <!-- Swap Button -->
      <button
        id="swapButton"
        disabled
        class="w-full py-3 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-xl font-extrabold text-white shadow-lg hover:brightness-110 transition disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Connect Wallet
      </button>
    </main>
  </div>

  <!-- Token Modal -->
  <div
    id="tokenModal"
    class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 hidden"
  >
    <div
      class="bg-[rgba(255,255,255,0.05)] backdrop-blur-xs rounded-2xl max-w-md w-full max-h-[80vh] flex flex-col"
    >
      <header
        class="flex items-center justify-between px-6 py-4 border-b border-[rgba(126,34,206,0.3)]"
      >
        <h2 class="text-lg font-semibold select-none">Select a Token</h2>
        <button
          id="closeTokenModal"
          class="text-gray-400 hover:text-white transition select-none"
          aria-label="Close token selector modal"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </header>
      <div class="px-6 py-4">
        <input
          type="text"
          id="tokenSearchInput"
          placeholder="Search by token name or address"
          class="w-full rounded-xl bg-[rgba(255,255,255,0.1)] px-4 py-3 text-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
        />
      </div>
      <ul
        id="tokenList"
        class="overflow-y-auto token-list flex-1 px-6 space-y-2 scrollbar-thin scrollbar-thumb-purple-700 scrollbar-track-transparent"
      >
        <!-- Token items will be injected here -->
      </ul>
    </div>
  </div>

  <!-- Solana Web3 JS -->
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.70.1/lib/index.iife.min.js"></script>
  <script>
(() => {
  const config = {
    jupiterBase: "https://ultra-api.jup.ag/v4",
    slippageBps: 50,  // 0.5% slippage max
    feeBps: 15,       // 0.15% fee to feeRecipient
    feeRecipient: "H3z4XmmpLwjm2MhfRuEFhK4DjGHhkbQvmgSUUCTrm6hw",
    network: "mainnet-beta"
  };

  // State variables
  const state = {
    wallet: null,
    connection: null,
    tokens: [],
    fromToken: null,
    toToken: null,
    fromAmount: "",
    quote: null,
    balances: {},
    selectingFor: null
  };

  // DOM elements
  const els = {
    fromTokenSelector: document.getElementById("fromTokenSelector"),
    toTokenSelector: document.getElementById("toTokenSelector"),
    fromTokenLogo: document.getElementById("fromTokenLogo"),
    toTokenLogo: document.getElementById("toTokenLogo"),
    fromTokenSymbol: document.getElementById("fromTokenSymbol"),
    toTokenSymbol: document.getElementById("toTokenSymbol"),
    fromAmountInput: document.getElementById("fromAmount"),
    toAmountInput: document.getElementById("toAmount"),
    fromTokenBalance: document.getElementById("fromTokenBalance"),
    toTokenBalance: document.getElementById("toTokenBalance"),
    fromAmountUSD: document.getElementById("fromAmountUSD"),
    toAmountUSD: document.getElementById("toAmountUSD"),
    switchTokensBtn: document.getElementById("switchTokens"),
    swapButton: document.getElementById("swapButton"),
    tokenModal: document.getElementById("tokenModal"),
    tokenSearchInput: document.getElementById("tokenSearchInput"),
    tokenList: document.getElementById("tokenList"),
    closeTokenModalBtn: document.getElementById("closeTokenModal"),
    exchangeRate: document.getElementById("exchangeRate"),
    priceImpact: document.getElementById("priceImpact"),
    networkFee: document.getElementById("networkFee")
  };

  // Helper debounce to limit API calls on input
  function debounce(fn, delay) {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => fn(...args), delay);
    };
  }

  // Initialize app
  async function init() {
    state.connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl(config.network));
    await loadTokenList();
    setupEventListeners();
    tryAutoConnectWallet();
  }

  // Load tokens from Ultra API Jupiter
  async function loadTokenList() {
    try {
      const res = await fetch("https://token-api.jup.ag/v4/tokens");
      if (!res.ok) throw new Error("Failed to load token list");
      const json = await res.json();
      state.tokens = json.data;

      // Set defaults if possible USDC -> SOL
      state.fromToken = state.tokens.find(t => t.symbol === "USDC") || state.tokens[0];
      state.toToken = state.tokens.find(t => t.symbol === "SOL") || state.tokens[1];
      updateTokenUI();
    } catch (e) {
      console.error("Error loading tokens:", e);
      alert("Failed to load token list");
    }
  }

  // Update token selector UI
  function updateTokenUI() {
    if (state.fromToken) {
      els.fromTokenSymbol.textContent = state.fromToken.symbol;
      els.fromTokenLogo.src = state.fromToken.logoURI || "";
      els.fromTokenLogo.style.display = state.fromToken.logoURI ? "block" : "none";
      els.fromTokenBalance.textContent = state.balances[state.fromToken.address] ?? "0.00";
    }
    if (state.toToken) {
      els.toTokenSymbol.textContent = state.toToken.symbol;
      els.toTokenLogo.src = state.toToken.logoURI || "";
      els.toTokenLogo.style.display = state.toToken.logoURI ? "block" : "none";
      els.toTokenBalance.textContent = state.balances[state.toToken.address] ?? "0.00";
    }
  }

  // Setup all event listeners
  function setupEventListeners() {
    els.fromTokenSelector.addEventListener("click", () => openTokenModal("from"));
    els.toTokenSelector.addEventListener("click", () => openTokenModal("to"));
    els.closeTokenModalBtn.addEventListener("click", closeTokenModal);

    els.switchTokensBtn.addEventListener("click", switchTokens);

    els.fromAmountInput.addEventListener("input", debounce(onFromAmountChanged, 300));

    els.swapButton.addEventListener("click", onSwapButtonClicked);

    els.tokenSearchInput.addEventListener("input", debounce(onTokenSearchChanged, 200));
  }

  // Try auto connect Phantom wallet if already connected
  async function tryAutoConnectWallet() {
    if (window.solana && window.solana.isPhantom) {
      try {
        const resp = await window.solana.connect({ onlyIfTrusted: true });
        state.wallet = resp;
        els.swapButton.textContent = "Swap";
        await fetchBalances();
      } catch {
        // user not connected
        els.swapButton.textContent = "Connect Wallet";
      }
    }
  }

  // Open modal token selector
  function openTokenModal(forWhich) {
    state.selectingFor = forWhich;
    els.tokenModal.classList.remove("hidden");
    els.tokenSearchInput.value = "";
    renderTokenList(state.tokens);
    els.tokenSearchInput.focus();
  }

  // Close modal
  function closeTokenModal() {
    els.tokenModal.classList.add("hidden");
    state.selectingFor = null;
  }

  // Render tokens filtered list
  function renderTokenList(tokens) {
    els.tokenList.innerHTML = "";
    if (tokens.length === 0) {
      els.tokenList.innerHTML = `<li class="text-center text-gray-400 py-4 select-none">No tokens found</li>`;
      return;
    }
    tokens.forEach(token => {
      const li = document.createElement("li");
      li.className = "flex items-center p-3 rounded-xl hover:bg-[rgba(126,34,206,0.3)] cursor-pointer select-none";
      li.innerHTML = `
        <img src="${token.logoURI || ""}" alt="${token.symbol}" class="w-8 h-8 rounded-full mr-3" onerror="this.style.display='none'"/>
        <div class="flex-1">
          <div class="font-semibold text-white">${token.symbol}</div>
          <div class="text-xs text-gray-400">${token.name}</div>
        </div>
        <div class="text-sm text-gray-300">${state.balances[token.address] ?? "0.00"}</div>
      `;
      li.addEventListener("click", () => {
        selectToken(token);
      });
      els.tokenList.appendChild(li);
    });
  }

  // When user types in token search input
  function onTokenSearchChanged() {
    const query = els.tokenSearchInput.value.trim().toLowerCase();
    if (!query) {
      renderTokenList(state.tokens);
      return;
    }
    const filtered = state.tokens.filter(
      t =>
        t.symbol.toLowerCase().includes(query) ||
        t.name.toLowerCase().includes(query) ||
        t.address.toLowerCase().startsWith(query)
    );
    renderTokenList(filtered);
  }

  // Select token in modal
  function selectToken(token) {
    if (state.selectingFor === "from") {
      if (state.toToken && token.address === state.toToken.address) {
        alert("Cannot select same token for From and To");
        return;
      }
      state.fromToken = token;
    } else if (state.selectingFor === "to") {
      if (state.fromToken && token.address === state.fromToken.address) {
        alert("Cannot select same token for From and To");
        return;
      }
      state.toToken = token;
    }
    updateTokenUI();
    closeTokenModal();
    updateQuote();
  }

  // Fetch user token balances from Solana
  async function fetchBalances() {
    if (!state.wallet) return;

    try {
      const pubkey = state.wallet.publicKey;
      const connection = state.connection;

      // SOL balance
      const solBalance = await connection.getBalance(pubkey);
      state.balances["So11111111111111111111111111111111111111112"] = (solBalance / solanaWeb3.LAMPORTS_PER_SOL).toFixed(4);

      // SPL Token balances
      const tokenAccounts = await connection.getParsedTokenAccountsByOwner(pubkey, {
        programId: new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA")
      });

      tokenAccounts.value.forEach(acc => {
        const mint = acc.account.data.parsed.info.mint;
        const amount = acc.account.data.parsed.info.tokenAmount.uiAmount;
        state.balances[mint] = amount?.toFixed(4) || "0.00";
      });

      updateTokenUI();
    } catch (e) {
      console.error("Fetch balances failed:", e);
    }
  }

  // When input amount changes
  function onFromAmountChanged() {
    state.fromAmount = els.fromAmountInput.value.trim();
    updateQuote();
  }

  // Switch From and To tokens
  function switchTokens() {
    if (!state.fromToken || !state.toToken) return;

    const tempToken = state.fromToken;
    state.fromToken = state.toToken;
    state.toToken = tempToken;

    // Swap input values
    const tempAmount = els.fromAmountInput.value;
    els.fromAmountInput.value = els.toAmountInput.value;
    els.toAmountInput.value = tempAmount;

    updateTokenUI();
    updateQuote();
  }

  // Update quote from Jupiter Ultra API
  async function updateQuote() {
    if (!state.fromToken || !state.toToken || !state.fromAmount) {
      resetQuoteUI();
      return;
    }

    let amountNum = parseFloat(state.fromAmount);
    if (isNaN(amountNum) || amountNum <= 0) {
      resetQuoteUI();
      return;
    }

    try {
      // Convert amount to integer amount in decimals
      const amountInt = Math.floor(amountNum * Math.pow(10, state.fromToken.decimals));

      // Compose query parameters
      const params = new URLSearchParams({
        inputMint: state.fromToken.address,
        outputMint: state.toToken.address,
        amount: amountInt.toString(),
        slippageBps: config.slippageBps.toString(),
        feeBps: config.feeBps.toString(),
        feeAccount: config.feeRecipient,
        wrapUnwrapSOL: "true"
      });

      const url = `${config.jupiterBase}/quote?${params.toString()}`;
      const res = await fetch(url);
      const json = await res.json();

      if (!json.data || json.data.length === 0) {
        resetQuoteUI();
        return;
      }

      state.quote = json.data[0];

      const outAmount = parseFloat(state.quote.outAmount) / Math.pow(10, state.toToken.decimals);

      // Update amounts
      els.toAmountInput.value = outAmount.toFixed(6);

      // Exchange rate
      const rate = outAmount / amountNum;
      els.exchangeRate.textContent = `1 ${state.fromToken.symbol} = ${rate.toFixed(6)} ${state.toToken.symbol}`;

      // Price impact
      const impactPct = (state.quote.priceImpactPct || 0) * 100;
      els.priceImpact.textContent = `${impactPct.toFixed(2)}%`;
      els.priceImpact.className = impactPct > 1 ? "text-red-500 font-bold" : "text-green-400 font-semibold";

      // Network fee lamports -> SOL
      const feeLamports = state.quote.feeAmount || 0;
      const feeSOL = feeLamports / solanaWeb3.LAMPORTS_PER_SOL;
      els.networkFee.textContent = `${feeSOL.toFixed(6)} SOL`;

      // USD price estimation (mocked to 1 USD for demo)
      els.fromAmountUSD.textContent = (amountNum * 1).toFixed(2);
      els.toAmountUSD.textContent = (outAmount * 1).toFixed(2);

      // Enable swap button if wallet connected
      els.swapButton.disabled = !state.wallet;
    } catch (e) {
      console.error("Quote error:", e);
      resetQuoteUI();
    }
  }

  // Reset quote UI fields
  function resetQuoteUI() {
    els.toAmountInput.value = "";
    els.exchangeRate.textContent = "-";
    els.priceImpact.textContent = "-";
    els.networkFee.textContent = "-";
    els.fromAmountUSD.textContent = "0.00";
    els.toAmountUSD.textContent = "0.00";
    els.swapButton.disabled = true;
    state.quote = null;
  }

  // Connect wallet function
  async function connectWallet() {
    if (!window.solana || !window.solana.isPhantom) {
      alert("Please install Phantom Wallet to use AetherSwap");
      return;
    }
    try {
      const resp = await window.solana.connect();
      state.wallet = resp;
      els.swapButton.textContent = "Swap";
      await fetchBalances();
      updateQuote();
    } catch (e) {
      console.error("Wallet connection error:", e);
    }
  }

  // Handle swap button click
  async function onSwapButtonClicked() {
    if (!state.wallet) {
      await connectWallet();
      return;
    }
    if (!state.quote) {
      alert("Invalid quote, cannot swap");
      return;
    }
    try {
      els.swapButton.disabled = true;
      els.swapButton.textContent = "Processing...";

      // Fetch swap transaction from Ultra API
      const body = {
        route: state.quote,
        userPublicKey: state.wallet.publicKey.toString(),
        wrapUnwrapSOL: true,
        feeAccount: config.feeRecipient,
        feeBps: config.feeBps
      };

      const res = await fetch(`${config.jupiterBase}/swap`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.message || "Swap API failed");
      }

      const data = await res.json();
      const tx = solanaWeb3.Transaction.from(Buffer.from(data.swapTransaction, "base64"));

      // Sign transaction
      const signedTx = await window.solana.signTransaction(tx);

      // Send transaction
      const txid = await state.connection.sendRawTransaction(signedTx.serialize());
      await state.connection.confirmTransaction(txid);

      alert(`Swap successful!\nTransaction ID:\n${txid}`);
      await fetchBalances();
      updateQuote();

    } catch (e) {
      console.error("Swap error:", e);
      alert(`Swap failed: ${e.message}`);
    } finally {
      els.swapButton.disabled = false;
      els.swapButton.textContent = "Swap";
    }
  }

  // Initialize app on DOM ready
  document.addEventListener("DOMContentLoaded", init);

  // Event for switch tokens button
  els.switchTokensBtn.addEventListener("click", () => {
    switchTokens();
  });
})();
</script>
<!-- Style additionnel pour glassmorphism, animations, gradients -->
<style>
  /* Glassmorphism wrapper */
  .glass {
    background: rgba(18, 18, 18, 0.6);
    backdrop-filter: blur(12px);
    border-radius: 1rem;
    border: 1px solid rgba(126, 34, 206, 0.3);
    box-shadow: 0 4px 30px rgba(126, 34, 206, 0.2);
  }

  /* Hover gradient effect on buttons */
  .btn-gradient {
    background: linear-gradient(90deg, #6e45e2, #3b82f6);
    background-size: 200% 200%;
    animation: gradientShift 3s ease infinite;
  }
  @keyframes gradientShift {
    0% {background-position: 0% 50%;}
    50% {background-position: 100% 50%;}
    100% {background-position: 0% 50%;}
  }

  /* Smooth focus */
  input:focus, button:focus {
    outline: none;
    box-shadow: 0 0 8px rgba(110, 69, 226, 0.7);
  }

  /* Token selector hover */
  .token-selector:hover {
    border-color: #7e22ce;
    box-shadow: 0 0 8px #7e22ce;
  }

  /* Modal overlay fade */
  #tokenModal {
    transition: opacity 0.3s ease;
  }

  /* Scrollbar for token list */
  .token-list::-webkit-scrollbar {
    width: 6px;
  }
  .token-list::-webkit-scrollbar-thumb {
    background-color: rgba(110, 69, 226, 0.6);
    border-radius: 3px;
  }

  /* Disabled swap button */
  button:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }
</style>

</body>
</html>