<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AetherSwap PRO</title>
<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors: {
          primary: {500:'#7e22ce',600:'#6b21a8'},
          secondary:{500:'#3b82f6',600:'#2563eb'}
        }
      }
    }
  }
</script>
<style>
  /* Custom styles & animations */
  .modal-enter { opacity:0; transform:translateY(20px); }
  .modal-enter-active { opacity:1; transform:translateY(0); transition:all .2s ease;}
  .modal-exit { opacity:1; transform:translateY(0); }
  .modal-exit-active { opacity:0; transform:translateY(20px); transition:all .2s ease;}
  .toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#1a1a2f; color:#eee;
           padding:12px 20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.5); opacity:0;
           transition:opacity .3s ease;}
  .toast-show { opacity:1; }
</style>
</head>
<body class="dark bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

<div class="swap-container bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-md">
  <div class="network-status text-gray-400 text-sm mb-4 flex items-center gap-2">
    <span class="inline-block w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
    <span>Solana Mainnet</span>
    <span>&bull;</span>
    <span>Fast: ~0.0005 SOL</span>
  </div>

  <!-- From token -->
  <div class="token-input mb-4 border-2 border-primary-600 rounded-lg p-4 flex flex-col"
       id="fromInput">
    <div class="flex items-center justify-between cursor-pointer" id="fromSelector">
      <div class="flex items-center space-x-3">
        <img src="" alt="" id="fromLogo" class="w-8 h-8 rounded-full bg-white"/>
        <div>
          <div id="fromSymbol" class="font-bold text-lg">Select</div>
          <div class="text-xs text-gray-400">Balance: <span id="fromBalance">0.0</span></div>
        </div>
      </div>
    </div>
    <input type="text" id="fromAmount" placeholder="0.0"
           class="mt-3 w-full bg-transparent border-none text-right text-2xl font-semibold focus:outline-none"/>
    <div class="text-xs text-gray-400 text-right">≈ $<span id="fromUSD">0.00</span></div>
  </div>

  <!-- Switch → animated -->
  <button id="switchBtn"
          class="swap-arrow bg-gray-800 border-2 border-gray-700 rounded-full w-10 h-10 flex items-center justify-center mx-auto mb-4 transform transition-transform duration-300">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-primary-500"
         fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M7 7l10 10M17 7l-10 10"/>
    </svg>
  </button>

  <!-- To token -->
  <div class="token-input mb-2 p-4 rounded-lg border-2 border-gray-700" id="toInput">
    <div class="flex items-center justify-between cursor-pointer" id="toSelector">
      <div class="flex items-center space-x-3">
        <img src="" alt="" id="toLogo" class="w-8 h-8 rounded-full bg-white"/>
        <div>
          <div id="toSymbol" class="font-bold text-lg">Select</div>
          <div class="text-xs text-gray-400">Balance: <span id="toBalance">0.0</span></div>
        </div>
      </div>
    </div>
    <input type="text" id="toAmount" placeholder="0.0" readonly
           class="mt-3 w-full bg-transparent border-none text-right text-2xl font-semibold focus:outline-none"/>
    <div class="text-xs text-gray-400 text-right">≈ $<span id="toUSD">0.00</span></div>
  </div>

  <!-- Details -->
  <div class="swap-details border-t border-gray-700 pt-4 space-y-2 text-sm">
    <div class="flex justify-between"><span>Exchange Rate</span><span id="exchangeRate">‑</span></div>
    <div class="flex justify-between"><span>Price Impact</span><span id="priceImpact" class="text-green-400">‑</span></div>
    <div class="flex justify-between"><span>Network Fee</span><span id="networkFee">‑</span></div>
  </div>

  <!-- Swap button -->
  <button id="swapBtn"
          class="swap-button bg-primary-500 hover:bg-primary-600 disabled:bg-gray-700 disabled:cursor-not-allowed mt-6 py-3 text-lg font-bold rounded-lg w-full"
          disabled>Connect Wallet</button>
</div>

<!-- Token modal -->
<div id="tokenModal"
     class="token-modal fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4">
  <div class="token-modal-content bg-gray-800 rounded-xl overflow-hidden w-full max-w-md">
    <div class="token-search p-4 border-b border-gray-700">
      <input type="text" id="tokenSearch" placeholder="Search token or paste address"
             class="w-full p-2 bg-gray-700 text-gray-200 rounded-lg focus:outline-primary-500"/>
    </div>
    <div class="token-list max-h-80 overflow-y-auto"></div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">Placeholder</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.70.1/lib/index.iife.min.js"></script>
<script>
(() => {
  const config = {
    slippageBps: 50,
    apiBase: 'https://lite-api.jup.ag',
    priceAPI: 'https://lite-api.jup.ag/price/v3'
  };
  const state = {
    tokens: [], wallet:null, from:null, to:null, balances:{}, quote:null
  };
  const el = id => document.getElementById(id);

  const fromSelector = el('fromSelector'), toSelector = el('toSelector'),
        switchBtn = el('switchBtn'), swapBtn = el('swapBtn'),
        tokenModal = el('tokenModal'), tokenList = document.querySelector('.token-list'),
        tokenSearch = el('tokenSearch'), toast = el('toast');

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('toast-show');
    setTimeout(()=>toast.classList.remove('toast-show'),3500);
  }

  async function loadTokens(){
    const res = await fetch(`${config.apiBase}/tokens/v2/search`);
    state.tokens = (await res.json()).tokens;
  }

  async function loadBalances(){
    if(!state.wallet) return;
    const conn = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
    const lam = await conn.getBalance(state.wallet.publicKey);
    state.balances['So11111111111111111111111111111111111111112'] = (lam/solanaWeb3.LAMPORTS_PER_SOL).toFixed(6);
    const res = await conn.getParsedTokenAccountsByOwner(state.wallet.publicKey,{programId:new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA")});
    res.value.forEach(a => {
      const info = a.account.data.parsed.info;
      state.balances[info.mint] = info.tokenAmount.uiAmountString;
    });
  }

  function openModal(role){
    state.selecting = role;
    tokenSearch.value=''; renderTokenList(state.tokens);
    tokenModal.classList.remove('hidden');
  }
  function closeModal(){
    tokenModal.classList.add('hidden');
  }

  function renderTokenList(list){
    tokenList.innerHTML='';
    list.forEach(t=>{
      const row = document.createElement('div');
      row.className='token-item p-3 flex items-center justify-between hover:bg-gray-700 cursor-pointer';
      row.innerHTML = `
        <div class="flex items-center gap-3">
          <img src="${t.logoURI||''}" class="w-8 h-8 rounded-full"/>
          <div>
            <div class="font-semibold">${t.symbol}</div>
            <div class="text-xs text-gray-400">${t.name}</div>
          </div>
        </div>
        <div class="text-xs">${state.balances[t.address]||'0.0'}</div>`;
      row.onclick = ()=>selectToken(t);
      tokenList.appendChild(row);
    });
  }

  function selectToken(t){
    state[state.selecting] = t;
    closeModal(); updateSelectors(); clearQuote(); updateQuote();
  }

  function updateSelectors(){
    ['from','to'].forEach(key=>{
      const t = state[key];
      el(`${key}Logo`).src = t.logoURI || '';
      el(`${key}Symbol`).textContent = t.symbol;
      el(`${key}Balance`).textContent = state.balances[t.address]||'0.0';
    });
  }

  async function updateUSD(){
    const coins = [state.from,state.to];
    for(const key of ['from','to']){
      const t = state[key];
      const amt = parseFloat(el(`${key}Amount`).value);
      if(t && amt>0){
        const res = await fetch(`${config.priceAPI}?mint=${t.address}`);
        const price = (await res.json()).prices[t.address];
        el(`${key}USD`).textContent = (amt * price).toFixed(2);
      } else el(`${key}USD`).textContent='0.00';
    }
  }

  function clearQuote(){
    state.quote=null;
    ['toAmount','exchangeRate','priceImpact','networkFee'].forEach(id=>el(id).textContent='‑');
    swapBtn.disabled = !state.wallet;
  }

  async function updateQuote(){
    if(!state.from||!state.to||!el('fromAmount').value) return clearQuote();
    clearQuote(); updateUSD();
    const amt = BigInt(Math.floor(parseFloat(el('fromAmount').value) * 10**state.from.decimals));
    const res = await fetch(`${config.apiBase}/swap/v2/quote`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        inputMint: state.from.address, outputMint:state.to.address,
        amount:amt.toString(), slippageBps: config.slippageBps,
        userPublicKey:state.wallet?.publicKey.toString()
      })
    });
    const json = await res.json();
    if(!json.data?.length) return;
    state.quote = json.data[0];
    const out = Number(BigInt(state.quote.outAmount))/10**state.to.decimals;
    el('toAmount').value = out.toFixed(6);
    el('exchangeRate').textContent = `1 ${state.from.symbol} = ${(out/parseFloat(el('fromAmount').value)).toFixed(6)} ${state.to.symbol}`;
    const pi = parseFloat(state.quote.priceImpactPct)*100;
    el('priceImpact').textContent = `${pi.toFixed(2)}%`;
    el('priceImpact').className = pi>1?'text-red-400':'text-green-400';
    el('networkFee').textContent = '~0.0005 SOL';
    swapBtn.disabled = !state.wallet;
  }

  async function executeSwap(){
    if(!state.wallet) return connectWallet();
    if(!state.quote) return showToast('Invalid swap');
    swapBtn.textContent='Processing...'; swapBtn.disabled=true;
    try{
      const res = await fetch(`${config.apiBase}/swap/v2/swap-instructions`,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body: JSON.stringify({route:state.quote, userPublicKey:state.wallet.publicKey.toString(), wrapUnwrapSOL:true})
      });
      const j = await res.json();
      const tx = solanaWeb3.Transaction.from(Uint8Array.from(atob(j.unsignedTransaction),c=>c.charCodeAt(0)));
      const signed = await state.wallet.signTransaction(tx);
      const conn = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
      const txid = await conn.sendRawTransaction(signed.serialize());
      await conn.confirmTransaction(txid,'confirmed');
      showToast(`Swap successful: ${txid.slice(0,6)}...`);
      await loadBalances(); updateSelectors();
      el('fromAmount').value=''; clearQuote();
    }catch(e){ console.error(e); showToast('Swap failed'); }
    finally{ swapBtn.textContent = state.wallet?'Swap Now':'Connect Wallet'; swapBtn.disabled = !state.wallet;}
  }

  async function connectWallet(){
    if(!window.solana) return showToast('Phantom not installed');
    try{
      await window.solana.connect();
      state.wallet = window.solana; el('swapBtn').textContent='Swap Now'; swapBtn.disabled = !state.quote;
      await loadBalances(); updateSelectors();
    }catch(e){ showToast('Connection failed'); console.error(e);}
  }

  fromSelector.addEventListener('click',()=>openModal('from'));
  toSelector.addEventListener('click',()=>openModal('to'));
  tokenSearch.addEventListener('input',e=>{
    const q=e.target.value.toLowerCase();
    renderTokenList(state.tokens.filter(t=>t.symbol.toLowerCase().includes(q)||t.name.toLowerCase().includes(q)||t.address.toLowerCase().startsWith(q)));
  });
  switchBtn.addEventListener('click',()=>{
    swapBtn.classList.add('transform','rotate-180'); setTimeout(()=>swapBtn.classList.remove('rotate-180'),300);
    [state.from,state.to] = [state.to,state.from];
    updateSelectors(); el('fromAmount').value=''; el('toAmount').value=''; clearQuote();
  });
  el('fromAmount').addEventListener('input',debounce(updateQuote,300));
  swapBtn.addEventListener('click',executeSwap);
  tokenModal.addEventListener('click',e=>{ if(e.target===tokenModal) closeModal(); });

  async function init(){
    await loadTokens();
    if(window.solana?.isConnected){ state.wallet=window.solana; await connectWallet();}
  }
  // Debounce util
  function debounce(fn,ms){ let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}

  init();
})();
</script>

</body>
</html>