<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AetherSwap PRO - Swap Jupiter V4 + Wallet + Fees</title>

<!-- Tailwind CSS CDN with config -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors: {
          primary: {
            500: '#7e22ce',
            600: '#6b21a8'
          },
          secondary: {
            500: '#3b82f6',
            600: '#2563eb'
          }
        }
      }
    }
  }
</script>

<style>
  /* scrollbar for token list */
  .token-list::-webkit-scrollbar {
    width: 6px;
  }
  .token-list::-webkit-scrollbar-thumb {
    background-color: rgba(126,34,206,0.6);
    border-radius: 3px;
  }
</style>
</head>
<body class="bg-gray-900 text-gray-300 flex items-center justify-center min-h-screen p-4">

<div class="max-w-md w-full bg-gray-800 rounded-xl shadow-lg p-6">

  <h1 class="text-3xl font-bold mb-6 text-center text-purple-400">AetherSwap PRO</h1>

  <!-- Network status -->
  <div class="text-sm mb-4 flex items-center space-x-2 text-green-400">
    <div class="w-3 h-3 rounded-full bg-green-400 animate-pulse"></div>
    <span>Connected to Solana Mainnet</span>
  </div>

  <!-- From Token Input -->
  <div class="mb-4">
    <label class="block text-sm font-semibold mb-1">From</label>
    <div class="flex items-center space-x-3 bg-gray-700 rounded-lg p-3 cursor-pointer" id="fromTokenSelector">
      <img id="fromTokenLogo" class="w-8 h-8 rounded-full" src="" alt="" />
      <span id="fromTokenSymbol" class="font-semibold text-lg">Select Token</span>
      <svg class="ml-auto w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2"
        viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M19 9l-7 7-7-7" /></svg>
    </div>
    <input
      id="fromAmount"
      type="number"
      min="0"
      placeholder="0.0"
      class="w-full mt-2 p-3 text-right bg-gray-900 rounded-lg text-white text-xl font-semibold"
      autocomplete="off"
    />
    <div class="text-xs mt-1 text-gray-400">Balance: <span id="fromTokenBalance">0.00</span></div>
    <div class="text-xs mt-1 text-gray-400">≈ $<span id="fromAmountUSD">0.00</span></div>
  </div>

  <!-- Switch button -->
  <button id="switchTokens" title="Switch tokens"
    class="w-12 h-12 mx-auto rounded-full bg-purple-600 hover:bg-purple-700 transition flex items-center justify-center mb-4">
    <svg class="w-6 h-6 text-white transform rotate-90" fill="none" stroke="currentColor" stroke-width="2"
      viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
      <path d="M17 1l4 4-4 4" />
      <path d="M3 11v-1a4 4 0 014-4h14" />
    </svg>
  </button>

  <!-- To Token Input -->
  <div class="mb-4">
    <label class="block text-sm font-semibold mb-1">To</label>
    <div class="flex items-center space-x-3 bg-gray-700 rounded-lg p-3 cursor-pointer" id="toTokenSelector">
      <img id="toTokenLogo" class="w-8 h-8 rounded-full" src="" alt="" />
      <span id="toTokenSymbol" class="font-semibold text-lg">Select Token</span>
      <svg class="ml-auto w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2"
        viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M19 9l-7 7-7-7" /></svg>
    </div>
    <input
      id="toAmount"
      type="text"
      placeholder="0.0"
      readonly
      class="w-full mt-2 p-3 text-right bg-gray-900 rounded-lg text-white text-xl font-semibold cursor-not-allowed"
    />
    <div class="text-xs mt-1 text-gray-400">Balance: <span id="toTokenBalance">0.00</span></div>
    <div class="text-xs mt-1 text-gray-400">≈ $<span id="toAmountUSD">0.00</span></div>
  </div>

  <!-- Swap details -->
  <div class="border-t border-gray-700 pt-4 text-sm space-y-1 mb-4">
    <div class="flex justify-between">
      <span>Exchange Rate:</span>
      <span id="exchangeRate">-</span>
    </div>
    <div class="flex justify-between">
      <span>Price Impact:</span>
      <span id="priceImpact" class="text-green-400">-</span>
    </div>
    <div class="flex justify-between">
      <span>Network Fee:</span>
      <span id="networkFee">-</span>
    </div>
  </div>

  <!-- Connect / Swap Button -->
  <button
    id="swapButton"
    class="w-full py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold text-white disabled:opacity-50 disabled:cursor-not-allowed transition"
    disabled
  >
    Connect Wallet
  </button>

  <!-- Token Modal -->
  <div id="tokenModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50">
    <div class="bg-gray-800 rounded-lg max-w-md w-full max-h-[80vh] overflow-hidden flex flex-col">
      <div class="p-4 border-b border-gray-700">
        <input
          id="tokenSearch"
          type="text"
          placeholder="Search token by name, symbol or address"
          class="w-full p-3 rounded bg-gray-900 text-white focus:outline-none"
          autocomplete="off"
        />
      </div>
      <div id="tokenList" class="overflow-y-auto flex-grow token-list"></div>
      <button
        id="closeModal"
        class="p-3 bg-purple-700 hover:bg-purple-800 text-white font-semibold rounded-b-lg"
      >
        Close
      </button>
    </div>
  </div>

</div>

<!-- Scripts -->

<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.70.1/lib/index.iife.min.js"></script>

<script>
(() => {
  const config = {
    jupiterApi: 'https://quote-api.jup.ag/v4',
    slippageBps: 50, // 0.5%
    platformFeeAndAccounts: [
      {
        account: "H3z4XmmpLwjm2MhfRuEFhK4DjGHhkbQvmgSUUCTrm6hw",
        feeBps: 15 // 0.15%
      }
    ]
  };

  // State
  let state = {
    wallet: null,
    tokens: [],
    fromToken: null,
    toToken: null,
    fromAmount: '',
    quote: null,
    balances: {}
  };

  // DOM refs
  const fromTokenSelector = document.getElementById('fromTokenSelector');
  const toTokenSelector = document.getElementById('toTokenSelector');
  const fromTokenLogo = document.getElementById('fromTokenLogo');
  const toTokenLogo = document.getElementById('toTokenLogo');
  const fromTokenSymbol = document.getElementById('fromTokenSymbol');
  const toTokenSymbol = document.getElementById('toTokenSymbol');
  const fromAmountInput = document.getElementById('fromAmount');
  const toAmountInput = document.getElementById('toAmount');
  const fromTokenBalanceSpan = document.getElementById('fromTokenBalance');
  const toTokenBalanceSpan = document.getElementById('toTokenBalance');
  const fromAmountUSD = document.getElementById('fromAmountUSD');
  const toAmountUSD = document.getElementById('toAmountUSD');
  const switchTokensBtn = document.getElementById('switchTokens');
  const swapButton = document.getElementById('swapButton');
  const tokenModal = document.getElementById('tokenModal');
  const tokenSearch = document.getElementById('tokenSearch');
  const tokenList = document.getElementById('tokenList');
  const exchangeRateSpan = document.getElementById('exchangeRate');
  const priceImpactSpan = document.getElementById('priceImpact');
  const networkFeeSpan = document.getElementById('networkFee');
  const closeModalBtn = document.getElementById('closeModal');

  // Helpers
  function debounce(fn, delay) {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => fn(...args), delay);
    };
  }

  // Load tokens list
  async function loadTokens() {
    try {
      const res = await fetch('https://cache.jup.ag/tokens');
      const data = await res.json();
      // Filter to mainnet tokens (chainId=101)
      state.tokens = data.filter(t => t.chainId === 101);
    } catch(e) {
      console.error('Failed loading tokens', e);
      state.tokens = [];
    }
  }

  // Render token list in modal
  function renderTokenList(tokens) {
    tokenList.innerHTML = '';
    if (tokens.length === 0) {
      tokenList.innerHTML = '<p class="p-4 text-center text-gray-500">No tokens found.</p>';
      return;
    }
    tokens.forEach(token => {
      const div = document.createElement('div');
      div.className = 'flex items-center p-3 cursor-pointer hover:bg-purple-700 transition rounded';
      div.innerHTML = `
        <img src="${token.logoURI || ''}" alt="${token.symbol}" class="w-8 h-8 rounded-full mr-3" onerror="this.style.display='none'"/>
        <div class="flex-grow">
          <div class="font-semibold">${token.symbol}</div>
          <div class="text-xs text-gray-400 truncate">${token.name}</div>
        </div>
        <div class="text-xs text-gray-400">${state.balances[token.address] || '0.00'}</div>
      `;
      div.onclick = () => selectToken(token);
      tokenList.appendChild(div);
    });
  }

  // Open token modal for from or to
  let selectingFor = null;
  function openTokenModal(forToken) {
    selectingFor = forToken;
    tokenSearch.value = '';
    renderTokenList(state.tokens);
    tokenModal.classList.remove('hidden');
    tokenSearch.focus();
  }

  // Close modal
  function closeTokenModal() {
    tokenModal.classList.add('hidden');
    selectingFor = null;
  }

  // Select token from modal
  function selectToken(token) {
    if (selectingFor === 'from') {
      if (state.toToken && state.toToken.address === token.address) {
        alert("From and To token can't be the same.");
        return;
      }
      state.fromToken = token;
      fromTokenSymbol.textContent = token.symbol;
      fromTokenLogo.src = token.logoURI || '';
      fromTokenBalanceSpan.textContent = state.balances[token.address] || '0.00';
    } else if (selectingFor === 'to') {
      if (state.fromToken && state.fromToken.address === token.address) {
        alert("From and To token can't be the same.");
        return;
      }
      state.toToken = token;
      toTokenSymbol.textContent = token.symbol;
      toTokenLogo.src = token.logoURI || '';
      toTokenBalanceSpan.textContent = state.balances[token.address] || '0.00';
    }
    closeTokenModal();
    updateQuote();
  }

  // Connect Phantom Wallet
  async function connectWallet() {
    if (!window.solana || !window.solana.isPhantom) {
      alert("Phantom wallet not found. Please install it.");
      return;
    }
    try {
      await window.solana.connect();
      state.wallet = window.solana;
      updateWalletUI();
      await loadBalances();
      updateQuote();
    } catch (e) {
      console.error("Wallet connection failed", e);
    }
  }

  // Load balances from wallet
  async function loadBalances() {
    if (!state.wallet) return;

    try {
      const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
      const pubKey = state.wallet.publicKey;

      // SOL balance
      const solBalanceLamports = await connection.getBalance(pubKey);
      state.balances['So11111111111111111111111111111111111111112'] = (solBalanceLamports / solanaWeb3.LAMPORTS_PER_SOL).toFixed(4);

      // SPL token balances
      const tokenAccounts = await connection.getParsedTokenAccountsByOwner(pubKey, {
        programId: new solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA')
      });

      tokenAccounts.value.forEach(({ account }) => {
        const info = account.data.parsed.info;
        state.balances[info.mint] = info.tokenAmount.uiAmountString;
      });

      // Update balances in UI
      if (state.fromToken) fromTokenBalanceSpan.textContent = state.balances[state.fromToken.address] || '0.00';
      if (state.toToken) toTokenBalanceSpan.textContent = state.balances[state.toToken.address] || '0.00';

    } catch (e) {
      console.error("Failed to load balances", e);
    }
  }

  // Switch tokens button
  function switchTokens() {
    if (!state.fromToken || !state.toToken) return;
    // Swap tokens
    const tmp = state.fromToken;
    state.fromToken = state.toToken;
    state.toToken = tmp;

    // Swap amounts
    const fromVal = fromAmountInput.value;
    const toVal = toAmountInput.value;
    fromAmountInput.value = toVal;
    toAmountInput.value = fromVal;

    // Update UI
    fromTokenSymbol.textContent = state.fromToken.symbol;
    fromTokenLogo.src = state.fromToken.logoURI || '';
    fromTokenBalanceSpan.textContent = state.balances[state.fromToken.address] || '0.00';

    toTokenSymbol.textContent = state.toToken.symbol;
    toTokenLogo.src = state.toToken.logoURI || '';
    toTokenBalanceSpan.textContent = state.balances[state.toToken.address] || '0.00';

    updateQuote();
  }

  // Update quote from Jupiter
  async function updateQuote() {
    swapButton.disabled = true;
    swapButton.textContent = state.wallet ? "Loading quote..." : "Connect Wallet";

    toAmountInput.value = '';
    exchangeRateSpan.textContent = '-';
    priceImpactSpan.textContent = '-';
    priceImpactSpan.classList.remove('text-red-500', 'text-green-400');
    networkFeeSpan.textContent = '-';

    if (!state.fromToken || !state.toToken) return;
    if (!fromAmountInput.value || parseFloat(fromAmountInput.value) <= 0) return;

    const inputAmount = parseFloat(fromAmountInput.value);
    if (isNaN(inputAmount)) return;

    // Convert to smallest unit
    const amount = Math.floor(inputAmount * (10 ** state.fromToken.decimals));

    // Prepare params
    const params = new URLSearchParams({
      inputMint: state.fromToken.address,
      outputMint: state.toToken.address,
      amount: amount.toString(),
      slippageBps: config.slippageBps.toString()
    });

    try {
      const res = await fetch(`${config.jupiterApi}/quote?${params.toString()}`);
      const data = await res.json();
      if (!data.data || data.data.length === 0) {
        swapButton.textContent = state.wallet ? "No route found" : "Connect Wallet";
        return;
      }

      state.quote = data.data[0];
      const outAmount = parseFloat(state.quote.outAmount) / (10 ** state.toToken.decimals);
      toAmountInput.value = outAmount.toFixed(6);

      // Exchange rate
      const rate = outAmount / inputAmount;
      exchangeRateSpan.textContent = `1 ${state.fromToken.symbol} = ${rate.toFixed(6)} ${state.toToken.symbol}`;

      // Price impact
      const impactPercent = parseFloat(state.quote.priceImpactPct) * 100;
      priceImpactSpan.textContent = `${impactPercent.toFixed(2)}%`;
      if (impactPercent > 1) {
        priceImpactSpan.classList.add('text-red-500');
        priceImpactSpan.classList.remove('text-green-400');
      } else {
        priceImpactSpan.classList.add('text-green-400');
        priceImpactSpan.classList.remove('text-red-500');
      }

      // Network fee estimation (mock)
      networkFeeSpan.textContent = '~$0.50';

      // Update USD amounts (mocked price)
      fromAmountUSD.textContent = (inputAmount * (state.fromToken.price || 1)).toFixed(2);
      toAmountUSD.textContent = (outAmount * (state.toToken.price || 1)).toFixed(2);

      if (state.wallet) {
        swapButton.disabled = false;
        swapButton.textContent = 'Swap Now';
      }

    } catch (e) {
      console.error("Quote error", e);
      swapButton.textContent = state.wallet ? "Quote failed" : "Connect Wallet";
    }
  }

  // Execute swap
  async function executeSwap() {
    if (!state.wallet || !state.wallet.publicKey || !state.quote) return;

    try {
      swapButton.disabled = true;
      swapButton.textContent = "Swapping...";

      const body = {
        route: state.quote,
        userPublicKey: state.wallet.publicKey.toString(),
        wrapUnwrapSOL: true,
        platformFeeAndAccounts: config.platformFeeAndAccounts
      };

      const res = await fetch(`${config.jupiterApi}/swap`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const { swapTransaction } = await res.json();
      const txBuffer = Uint8Array.from(atob(swapTransaction), c => c.charCodeAt(0));
      const transaction = solanaWeb3.Transaction.from(txBuffer);

      const signedTx = await state.wallet.signTransaction(transaction);
      const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
      const txid = await connection.sendRawTransaction(signedTx.serialize());

      alert(`Swap submitted!\nTX: ${txid}`);
    } catch (e) {
      console.error("Swap failed", e);
      alert("Swap failed: " + e.message);
    } finally {
      swapButton.disabled = false;
      swapButton.textContent = "Swap Now";
    }
  }

  // Init everything
  async function init() {
    await loadTokens();
    fromTokenSelector.onclick = () => openTokenModal('from');
    toTokenSelector.onclick = () => openTokenModal('to');
    closeModalBtn.onclick = closeTokenModal;
    tokenSearch.oninput = debounce(() => {
      const keyword = tokenSearch.value.trim().toLowerCase();
      const filtered = state.tokens.filter(
        t =>
          t.symbol.toLowerCase().includes(keyword) ||
          t.name.toLowerCase().includes(keyword) ||
          t.address.toLowerCase().includes(keyword)
      );
      renderTokenList(filtered);
    }, 200);

    switchTokensBtn.onclick = switchTokens;

    fromAmountInput.oninput = debounce(updateQuote, 400);
    swapButton.onclick = () => {
      if (!state.wallet) connectWallet();
      else executeSwap();
    };
  }

  // DOM ready
  document.addEventListener('DOMContentLoaded', init);
})();
</script>

</body>
</html>