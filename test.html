<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AetherSwap v2</title>
  <style>
    :root {
      --bg: #0e0e11;
      --surface: #1a1a20;
      --primary: #7c3aed;
      --text: #f1f1f1;
      --muted: #aaa;
      --radius: 16px;
      --shadow: 0 8px 24px rgba(0,0,0,0.5);
      --transition: all 0.3s ease;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 32px;
      min-height: 100vh;
    }
    .swap-box {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      max-width: 420px;
      width: 100%;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .token-row {
      background: rgba(255,255,255,0.03);
      border-radius: var(--radius);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
    }
    .token-row .top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .token-select {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      background: none;
      border: none;
      color: var(--text);
      font-weight: bold;
      font-size: 1rem;
    }
    .token-select img {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #fff;
    }
    .balance {
      font-size: 0.85rem;
      color: var(--muted);
    }
    input.amount {
      width: 100%;
      font-size: 1.4rem;
      background: transparent;
      border: none;
      color: var(--text);
      text-align: right;
      font-weight: 600;
    }
    input.amount::placeholder {
      color: var(--muted);
    }
    .price-line {
      font-size: 0.85rem;
      text-align: right;
      color: var(--muted);
    }
    .switch-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: -12px 0;
    }
    .switch-btn {
      background: var(--primary);
      border: none;
      color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
      transition: var(--transition);
    }
    .switch-btn:hover {
      transform: rotate(180deg);
      background: #6b21e2;
    }
    .btn-swap {
      background: var(--primary);
      border: none;
      color: white;
      font-weight: bold;
      font-size: 1.1rem;
      border-radius: var(--radius);
      padding: 16px;
      cursor: pointer;
      transition: var(--transition);
    }
    .btn-swap:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

<div class="swap-box">
  <div class="token-row" id="tokenA">
    <div class="top">
      <button class="token-select" id="selectTokenA">
        <img id="tokenAImg" src="" alt="" />
        <span id="tokenASymbol">Select Token</span>
      </button>
      <span class="balance" id="balanceA">Balance: --</span>
    </div>
    <input type="number" class="amount" id="amountA" placeholder="0.0" min="0" step="any"/>
    <div class="price-line" id="priceA">1 A ≈ -- B</div>
  </div>

  <div class="switch-wrapper">
    <button class="switch-btn" id="switchBtn" title="Switch tokens">&#x21C5;</button>
  </div>

  <div class="token-row" id="tokenB">
    <div class="top">
      <button class="token-select" id="selectTokenB">
        <img id="tokenBImg" src="" alt="" />
        <span id="tokenBSymbol">Select Token</span>
      </button>
      <span class="balance" id="balanceB">Balance: --</span>
    </div>
    <input type="number" class="amount" id="amountB" readonly placeholder="0.0" />
    <div class="price-line" id="priceB">1 B ≈ -- A</div>
  </div>

  <button class="btn-swap" id="swapBtn" disabled>Swap</button>
</div>
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.70.1/lib/index.iife.min.js"></script>
<script>
(async () => {
  const API = "https://lite-api.jup.ag";

  const tokenState = { from: null, to: null };
  const tokenMap = new Map();
  let wallet = null;
  let quoteTimer = null;
  let currentQuote = null;

  // DOM
  const tokenAImg = document.getElementById("tokenAImg");
  const tokenASymbol = document.getElementById("tokenASymbol");
  const tokenBImg = document.getElementById("tokenBImg");
  const tokenBSymbol = document.getElementById("tokenBSymbol");
  const balanceA = document.getElementById("balanceA");
  const balanceB = document.getElementById("balanceB");
  const amountA = document.getElementById("amountA");
  const amountB = document.getElementById("amountB");
  const priceA = document.getElementById("priceA");
  const priceB = document.getElementById("priceB");
  const switchBtn = document.getElementById("switchBtn");
  const swapBtn = document.getElementById("swapBtn");

  const selectTokenA = document.getElementById("selectTokenA");
  const selectTokenB = document.getElementById("selectTokenB");

  // === Load tokens ===
  const res = await fetch(`${API}/tokens/v2/search`);
  const data = await res.json();
  const tokens = data.tokens || [];
  tokens.forEach(t => tokenMap.set(t.address, t));

  // === Phantom Wallet Connect ===
  async function connectWallet() {
    if (!window.solana || !window.solana.isPhantom) {
      alert("Phantom not found.");
      return;
    }
    wallet = await window.solana.connect();
    console.log("Connected:", wallet.publicKey.toBase58());
    fetchBalances();
  }

  await connectWallet();

  // === Select token handlers ===
  selectTokenA.onclick = () => openSelector("from");
  selectTokenB.onclick = () => openSelector("to");

  function openSelector(side) {
    const q = prompt("Search token symbol or address:");
    if (!q) return;
    const token = tokens.find(t => t.symbol.toLowerCase() === q.toLowerCase() || t.address === q);
    if (!token) return alert("Token not found");

    if (side === "from") {
      tokenState.from = token;
      tokenAImg.src = token.logoURI;
      tokenASymbol.textContent = token.symbol;
    } else {
      tokenState.to = token;
      tokenBImg.src = token.logoURI;
      tokenBSymbol.textContent = token.symbol;
    }

    fetchBalances();
    updateQuote();
  }

  // === Fetch balances ===
  async function fetchBalances() {
    if (!wallet || !tokenState.from || !tokenState.to) return;

    const conn = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl("mainnet-beta"), "confirmed");

    const result = await conn.getTokenAccountsByOwner(wallet.publicKey, {
      programId: new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA")
    });

    const accounts = result.value;

    function getBalanceFor(tokenAddress) {
      const match = accounts.find(acc => {
        const data = acc.account.data;
        return data && data.parsed && data.parsed.info.mint === tokenAddress;
      });
      return match ? match.account.data.parsed.info.tokenAmount.uiAmountString : "0";
    }

    balanceA.textContent = "Balance: " + getBalanceFor(tokenState.from.address);
    balanceB.textContent = "Balance: " + getBalanceFor(tokenState.to.address);
  }

  // === Update Quote + Price Unitaires ===
  amountA.addEventListener("input", () => {
    clearTimeout(quoteTimer);
    quoteTimer = setTimeout(updateQuote, 400);
  });

  async function updateQuote() {
    if (!tokenState.from || !tokenState.to || !wallet) return;

    const amt = parseFloat(amountA.value);
    if (!amt || isNaN(amt) || amt <= 0) {
      amountB.value = "";
      priceA.textContent = "1 A ≈ -- B";
      priceB.textContent = "1 B ≈ -- A";
      swapBtn.disabled = true;
      return;
    }

    const inputAmount = BigInt(Math.floor(amt * Math.pow(10, tokenState.from.decimals)));

    const res = await fetch(`${API}/swap/v2/quote`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        inputMint: tokenState.from.address,
        outputMint: tokenState.to.address,
        amount: inputAmount.toString(),
        slippageBps: 50,
        userPublicKey: wallet.publicKey.toBase58()
      })
    });

    const result = await res.json();
    const quote = result.data?.[0];
    if (!quote) {
      amountB.value = "";
      return;
    }

    currentQuote = quote;
    const outAmt = Number(quote.outAmount) / Math.pow(10, tokenState.to.decimals);
    const price = outAmt / amt;
    const invPrice = amt / outAmt;

    amountB.value = outAmt.toFixed(6);
    priceA.textContent = `1 ${tokenState.from.symbol} ≈ ${price.toFixed(6)} ${tokenState.to.symbol}`;
    priceB.textContent = `1 ${tokenState.to.symbol} ≈ ${invPrice.toFixed(6)} ${tokenState.from.symbol}`;
    swapBtn.disabled = false;
  }

  // === Switch tokens ===
  switchBtn.onclick = () => {
    const temp = tokenState.from;
    tokenState.from = tokenState.to;
    tokenState.to = temp;

    if (tokenState.from) {
      tokenAImg.src = tokenState.from.logoURI;
      tokenASymbol.textContent = tokenState.from.symbol;
    }
    if (tokenState.to) {
      tokenBImg.src = tokenState.to.logoURI;
      tokenBSymbol.textContent = tokenState.to.symbol;
    }

    amountA.value = "";
    amountB.value = "";
    priceA.textContent = "1 A ≈ -- B";
    priceB.textContent = "1 B ≈ -- A";
    swapBtn.disabled = true;

    fetchBalances();
  };

})();
</script>
<script>
(async () => {
  const swapBtn = document.getElementById("swapBtn");
  const amountA = document.getElementById("amountA");
  const amountB = document.getElementById("amountB");
  const historyList = document.getElementById("historyList");

  const API = "https://lite-api.jup.ag";

  // === Swap button click ===
  swapBtn.addEventListener("click", async () => {
    if (!currentQuote || !wallet || !tokenState.from || !tokenState.to) {
      alert("Missing data to execute swap");
      return;
    }

    swapBtn.disabled = true;
    swapBtn.textContent = "Swapping...";

    try {
      const route = currentQuote.route;

      const res = await fetch(`${API}/swap/v2/swap-instructions`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          route,
          userPublicKey: wallet.publicKey.toBase58(),
          wrapUnwrapSOL: true
        })
      });

      const { unsignedTransaction } = await res.json();

      if (!unsignedTransaction) throw new Error("Invalid transaction data");

      const txBuffer = Buffer.from(unsignedTransaction, "base64");
      const transaction = solanaWeb3.Transaction.from(txBuffer);

      const signed = await wallet.signTransaction(transaction);

      const conn = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl("mainnet-beta"), "confirmed");
      const txid = await conn.sendRawTransaction(signed.serialize());
      await conn.confirmTransaction(txid, "confirmed");

      alert("Swap Success!\nTx: " + txid);

      addHistory({
        txid,
        from: tokenState.from,
        to: tokenState.to,
        fromAmt: amountA.value,
        toAmt: amountB.value
      });

      amountA.value = "";
      amountB.value = "";
      swapBtn.disabled = true;
      swapBtn.textContent = "Swap";

    } catch (err) {
      console.error(err);
      alert("Swap failed: " + err.message);
      swapBtn.disabled = false;
      swapBtn.textContent = "Swap";
    }
  });

  // === Add to local history ===
  function addHistory({ txid, from, to, fromAmt, toAmt }) {
    const list = JSON.parse(localStorage.getItem("aether_history") || "[]");
    list.unshift({
      time: Date.now(),
      txid,
      from: from.symbol,
      to: to.symbol,
      fromAmt,
      toAmt
    });
    localStorage.setItem("aether_history", JSON.stringify(list.slice(0, 10)));
    renderHistory();
  }

  // === Display history ===
  function renderHistory() {
    const list = JSON.parse(localStorage.getItem("aether_history") || "[]");
    historyList.innerHTML = "";
    list.forEach(item => {
      const div = document.createElement("div");
      const time = new Date(item.time).toLocaleTimeString();
      div.innerHTML = `
        <div style="display:flex; justify-content:space-between; font-size:0.85rem;">
          <span>${item.fromAmt} ${item.from} → ${item.toAmt} ${item.to}</span>
          <a href="https://solscan.io/tx/${item.txid}" target="_blank">${item.txid.slice(0,6)}...${item.txid.slice(-6)}</a>
        </div>
      `;
      historyList.appendChild(div);
    });
  }

  renderHistory();

})();
</script>
</body>
</html>