<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AetherSwap PRO - Functional</title>
<style>
  :root {
    --primary: #6e45e2;
    --primary-hover: #5934ba;
    --bg: #0f0f0f;
    --surface: #1a1a2f;
    --text: #eee;
    --text-muted: #aaa;
    --radius-lg: 16px;
    --radius-md: 12px;
    --radius-sm: 8px;
    --shadow: 0 8px 24px rgba(0,0,0,0.7);
    --transition: 0.3s ease;
  }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    justify-content: center;
    padding: 40px 10px;
    min-height: 100vh;
  }
  .swap-container {
    max-width: 420px;
    width: 100%;
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 20px;
    box-shadow: var(--shadow);
  }
  .token-input {
    background: rgba(255 255 255 / 0.05);
    border-radius: var(--radius-md);
    padding: 12px 16px;
    margin-bottom: 14px;
    position: relative;
  }
  .token-input.active {
    border: 2px solid var(--primary);
  }
  .token-selector {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
  }
  .token-logo {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #fff;
    object-fit: contain;
  }
  .token-symbol {
    font-weight: 700;
    font-size: 1.1rem;
    user-select: none;
  }
  .token-balance {
    font-size: 0.8rem;
    color: var(--text-muted);
    user-select: none;
  }
  .dropdown-icon {
    margin-left: auto;
    color: var(--text-muted);
    user-select: none;
  }
  .amount-input {
    width: 100%;
    background: transparent;
    border: none;
    color: var(--text);
    font-size: 1.8rem;
    font-weight: 700;
    text-align: right;
    margin-top: 8px;
  }
  .amount-input:focus {
    outline: none;
  }
  .price-info {
    font-size: 0.75rem;
    margin-top: 4px;
    color: var(--text-muted);
    text-align: right;
    user-select: none;
  }
  .swap-arrow {
    background: var(--surface);
    border: 2px solid var(--primary);
    border-radius: 50%;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: -12px auto 16px;
    cursor: pointer;
    transition: transform 0.3s ease;
  }
  .swap-arrow:hover {
    background: var(--primary);
    transform: rotate(180deg);
  }
  /* Modal */
  .token-modal {
    position: fixed;
    inset: 0;
    background: rgba(0 0 0 / 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 9999;
  }
  .token-modal[aria-hidden="false"] {
    opacity: 1;
    pointer-events: all;
  }
  .token-modal-content {
    background: var(--surface);
    border-radius: var(--radius-lg);
    width: 95%;
    max-width: 400px;
    max-height: 70vh;
    overflow-y: auto;
    padding: 16px 20px 24px;
    box-sizing: border-box;
  }
  .token-modal-content header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  .token-modal-content header h2 {
    margin: 0;
    font-weight: 700;
    color: var(--primary);
  }
  #tokenModalClose {
    background: transparent;
    border: none;
    font-size: 2rem;
    line-height: 1;
    color: var(--text-muted);
    cursor: pointer;
  }
  #tokenSearch {
    width: 100%;
    padding: 10px 12px;
    border-radius: var(--radius-md);
    border: none;
    background: rgba(255 255 255 / 0.05);
    color: var(--text);
    font-size: 1rem;
    margin-bottom: 12px;
  }
  #tokenSearch:focus {
    outline: 2px solid var(--primary);
  }
  .token-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .token-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
  }
  .token-item:hover {
    background: var(--primary);
    color: #fff;
  }
  .token-item img {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: contain;
  }
  .token-item-info {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .token-item-symbol {
    font-weight: 700;
    font-size: 1rem;
  }
  .token-item-name {
    font-size: 0.75rem;
    color: var(--text-muted);
  }
  .token-item-balance {
    font-size: 0.75rem;
    user-select: none;
  }
  .swap-button {
    width: 100%;
    background: var(--primary);
    color: white;
    border: none;
    padding: 16px;
    border-radius: var(--radius-md);
    font-weight: 700;
    font-size: 1.1rem;
    cursor: pointer;
    margin-top: 16px;
    transition: all 0.3s ease;
  }
  .swap-button:hover {
    background: var(--primary-hover);
    transform: translateY(-2px);
  }
  .swap-button:disabled {
    background: #3a3a5a;
    cursor: not-allowed;
    transform: none;
  }
  .swap-details {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid rgba(255,255,255,0.1);
  }
  .detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 0.9rem;
  }
  .price-impact {
    color: var(--primary);
  }
  .price-impact.high {
    color: #ff4d4d;
  }
  .network-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-bottom: 16px;
  }
  .status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4dffb5;
  }
</style>
</head>
<body>

<div class="swap-container">

  <div class="network-status">
    <div class="status-indicator" id="networkStatusIndicator"></div>
    <span id="networkStatusText">Solana Mainnet</span>
  </div>

  <div class="token-input active" id="fromTokenInput">
    <div class="token-selector" id="fromTokenSelector" title="Select From Token">
      <img src="" alt="" class="token-logo" id="fromTokenLogo" />
      <div>
        <div class="token-symbol" id="fromTokenSymbol">Select Token</div>
        <div class="token-balance">Balance: <span id="fromTokenBalance">0.0</span></div>
      </div>
      <svg class="dropdown-icon" viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
    </div>
    <input type="number" step="any" min="0" class="amount-input" id="fromAmount" placeholder="0.0" />
    <div class="price-info">
      <small>Price: $<span id="fromTokenPrice">-</span></small>
    </div>
  </div>

  <button class="swap-arrow" id="switchTokens" title="Switch tokens" aria-label="Switch tokens">
    <svg viewBox="0 0 24 24" width="24" height="24" fill="var(--primary)">
      <path d="M4 12h12M10 6l6 6-6 6" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
    </svg>
  </button>

  <div class="token-input" id="toTokenInput">
    <div class="token-selector" id="toTokenSelector" title="Select To Token">
      <img src="" alt="" class="token-logo" id="toTokenLogo" />
      <div>
        <div class="token-symbol" id="toTokenSymbol">Select Token</div>
        <div class="token-balance">Balance: <span id="toTokenBalance">0.0</span></div>
      </div>
      <svg class="dropdown-icon" viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
    </div>
    <input type="number" step="any" min="0" class="amount-input" id="toAmount" placeholder="0.0" readonly />
    <div class="price-info">
      <small>Price: $<span id="toTokenPrice">-</span></small>
    </div>
  </div>

  <button class="swap-button" id="swapButton" disabled>Connect Wallet</button>

  <div class="swap-details" aria-live="polite" aria-atomic="true" role="region" style="margin-top:12px; font-size:0.9rem; color: var(--text-muted);">
    <div class="detail-row">
      <span>Exchange Rate</span>
      <span id="exchangeRate">-</span>
    </div>
    <div class="detail-row">
      <span>Price Impact</span>
      <span id="priceImpact" class="price-impact">-</span>
    </div>
    <div class="detail-row">
      <span>Network Fee</span>
      <span id="networkFee">-</span>
    </div>
  </div>

</div>

<!-- Token selection modal -->
<div class="token-modal" id="tokenModal" aria-hidden="true">
  <div class="token-modal-content" role="dialog" aria-modal="true" aria-labelledby="tokenModalTitle">
    <header>
      <h2 id="tokenModalTitle">Select a Token</h2>
      <button id="tokenModalClose" aria-label="Close token selection modal">&times;</button>
    </header>
    <input type="search" id="tokenSearch" placeholder="Search token name, symbol, or address" autocomplete="off" />
    <div class="token-list" id="tokenList" role="list"></div>
  </div>
</div>

<!-- Solana Web3 -->
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.70.1/lib/index.iife.min.js"></script>

<script>
(() => {
  const config = {
    jupiterAPI: 'https://quote-api.jup.ag/v1',
    slippageBps: 50, // 0.5%
  };

  // State
  let state = {
    tokens: [],
    fromToken: null,
    toToken: null,
    fromAmount: '',
    toAmount: '',
    wallet: null,
    balances: {},
    quote: null,
    selectingFor: null,
  };

  // Elements
  const els = {
    fromTokenSelector: document.getElementById('fromTokenSelector'),
    toTokenSelector: document.getElementById('toTokenSelector'),
    fromTokenLogo: document.getElementById('fromTokenLogo'),
    toTokenLogo: document.getElementById('toTokenLogo'),
    fromTokenSymbol: document.getElementById('fromTokenSymbol'),
    toTokenSymbol: document.getElementById('toTokenSymbol'),
    fromTokenBalance: document.getElementById('fromTokenBalance'),
    toTokenBalance: document.getElementById('toTokenBalance'),
    fromAmountInput: document.getElementById('fromAmount'),
    toAmountInput: document.getElementById('toAmount'),
    fromTokenPrice: document.getElementById('fromTokenPrice'),
    toTokenPrice: document.getElementById('toTokenPrice'),
    switchTokensBtn: document.getElementById('switchTokens'),
    tokenModal: document.getElementById('tokenModal'),
    tokenSearch: document.getElementById('tokenSearch'),
    tokenList: document.getElementById('tokenList'),
    tokenModalClose: document.getElementById('tokenModalClose'),
    swapButton: document.getElementById('swapButton'),
    exchangeRate: document.getElementById('exchangeRate'),
    priceImpact: document.getElementById('priceImpact'),
    networkFee: document.getElementById('networkFee'),
    networkStatusIndicator: document.getElementById('networkStatusIndicator'),
    networkStatusText: document.getElementById('networkStatusText'),
  };

  // Helpers
  const debounce = (fn, delay) => {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn(...args), delay);
    };
  };

  // Load tokens from Jupiter API (lite)
  async function loadTokens() {
    try {
      const res = await fetch('https://lite-api.jup.ag/tokens/v2/all/1d');
      if (!res.ok) throw new Error('Failed to fetch tokens');
      const data = await res.json();
      state.tokens = data.tokens
        .filter(t => t.chainId === 101)
        .sort((a,b) => a.symbol.localeCompare(b.symbol));
      renderTokenList(state.tokens);
      // Default tokens (USDC -> SOL)
      state.fromToken = state.tokens.find(t => t.symbol === 'USDC') || state.tokens[0];
      state.toToken = state.tokens.find(t => t.symbol === 'SOL') || state.tokens[1];
      updateTokenUI();
    } catch(e) {
      console.error('Load tokens error:', e);
    }
  }

  // Render token list in modal
  function renderTokenList(tokens) {
    els.tokenList.innerHTML = '';
    if (!tokens.length) {
      els.tokenList.innerHTML = '<div>No tokens found</div>';
      return;
    }
    tokens.forEach(token => {
      const div = document.createElement('div');
      div.className = 'token-item';
      div.setAttribute('role', 'listitem');
      div.innerHTML = `
        <img src="${token.logoURI || ''}" alt="${token.symbol} logo" onerror="this.style.display='none'"/>
        <div class="token-item-info">
          <div class="token-item-symbol">${token.symbol}</div>
          <div class="token-item-name">${token.name}</div>
        </div>
        <div class="token-item-balance">${state.balances[token.address] || '0.0'}</div>
      `;
      div.onclick = () => {
        selectToken(token);
      };
      els.tokenList.appendChild(div);
    });
  }

  // Open modal to select token
  function openTokenModal(forToken) {
    state.selectingFor = forToken;
    els.tokenSearch.value = '';
    renderTokenList(state.tokens);
    els.tokenModal.setAttribute('aria-hidden', 'false');
    els.tokenSearch.focus();
  }

  // Close modal
  function closeTokenModal() {
    els.tokenModal.setAttribute('aria-hidden', 'true');
    state.selectingFor = null;
  }

  // Select a token from modal
  function selectToken(token) {
    if(state.selectingFor === 'from') {
      if(state.toToken && token.address === state.toToken.address) {
        alert("From and To tokens cannot be the same");
        return;
      }
      state.fromToken = token;
    } else if(state.selectingFor === 'to') {
      if(state.fromToken && token.address === state.fromToken.address) {
        alert("From and To tokens cannot be the same");
        return;
      }
      state.toToken = token;
    }
    updateTokenUI();
    closeTokenModal();
    fetchBalance(state.wallet?.publicKey);
    fetchQuote();
  }

  // Update UI for tokens selected
  function updateTokenUI() {
    if(state.fromToken){
      els.fromTokenLogo.src = state.fromToken.logoURI || '';
      els.fromTokenSymbol.textContent = state.fromToken.symbol;
      els.fromTokenBalance.textContent = formatBalance(state.balances[state.fromToken.address]);
      els.fromTokenPrice.textContent = '-';
    }
    if(state.toToken){
      els.toTokenLogo.src = state.toToken.logoURI || '';
      els.toTokenSymbol.textContent = state.toToken.symbol;
      els.toTokenBalance.textContent = formatBalance(state.balances[state.toToken.address]);
      els.toTokenPrice.textContent = '-';
    }
  }

  // Format balance with decimals
  function formatBalance(rawBalance) {
    if(!rawBalance) return '0.0';
    return Number(rawBalance).toFixed(4);
  }

  // Connect Phantom wallet
  async function connectWallet() {
    try {
      if(!window.solana || !window.solana.isPhantom){
        alert('Phantom wallet not found. Please install it first.');
        return;
      }
      const resp = await window.solana.connect();
      state.wallet = resp;
      els.swapButton.textContent = 'Swap';
      fetchBalance(resp.publicKey);
      // Listen for account changes
      window.solana.on('accountChanged', pubkey => {
        if(pubkey) {
          state.wallet.publicKey = pubkey;
          fetchBalance(pubkey);
        } else {
          disconnectWallet();
        }
      });
    } catch(e) {
      console.error('Wallet connect error:', e);
    }
  }

  // Disconnect wallet
  function disconnectWallet() {
    state.wallet = null;
    els.swapButton.textContent = 'Connect Wallet';
    state.balances = {};
    updateTokenUI();
  }

  // Fetch balances for fromToken and toToken for wallet
  async function fetchBalance(publicKey) {
    if(!publicKey) return;
    try {
      const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
      const fromTokenBalance = await getTokenBalance(connection, publicKey, state.fromToken);
      const toTokenBalance = await getTokenBalance(connection, publicKey, state.toToken);
      state.balances[state.fromToken.address] = fromTokenBalance;
      state.balances[state.toToken.address] = toTokenBalance;
      updateTokenUI();
    } catch(e) {
      console.error('Fetch balance error:', e);
    }
  }

  // Get token balance for token (including SOL)
  async function getTokenBalance(connection, publicKey, token) {
    if(!token) return 0;
    if(token.symbol === 'SOL') {
      const bal = await connection.getBalance(publicKey);
      return bal / solanaWeb3.LAMPORTS_PER_SOL;
    }
    // SPL token
    const tokenAccount = await connection.getParsedTokenAccountsByOwner(publicKey, {mint: token.address});
    if(tokenAccount.value.length === 0) return 0;
    const amount = tokenAccount.value[0].account.data.parsed.info.tokenAmount.uiAmount;
    return amount || 0;
  }

  // Switch from and to tokens
  function switchTokens() {
    const tmp = state.fromToken;
    state.fromToken = state.toToken;
    state.toToken = tmp;
    els.fromAmountInput.value = '';
    els.toAmountInput.value = '';
    state.fromAmount = '';
    state.toAmount = '';
    updateTokenUI();
    fetchBalance(state.wallet?.publicKey);
    fetchQuote();
  }

  // Fetch quote from Jupiter API for current swap
  async function fetchQuote() {
    if(!state.fromToken || !state.toToken || !state.fromAmount || Number(state.fromAmount) <= 0) {
      els.toAmountInput.value = '';
      els.exchangeRate.textContent = '-';
      els.priceImpact.textContent = '-';
      els.networkFee.textContent = '-';
      return;
    }
    try {
      const fromMint = state.fromToken.address;
      const toMint = state.toToken.address;
      const amountRaw = toRawAmount(state.fromAmount, state.fromToken.decimals);

      const url = `${config.jupiterAPI}/quote?inputMint=${fromMint}&outputMint=${toMint}&amount=${amountRaw}&slippageBps=${config.slippageBps}&onlyDirectRoutes=true&platformFeeBps=0`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('Quote fetch failed');
      const data = await res.json();
      if(!data.data || !data.data.length) {
        els.toAmountInput.value = '';
        els.exchangeRate.textContent = '-';
        els.priceImpact.textContent = '-';
        els.networkFee.textContent = '-';
        state.quote = null;
        return;
      }
      state.quote = data.data[0]; // best quote
      // Compute toAmount to display
      const toAmountUi = toUiAmount(state.quote.outAmount, state.toToken.decimals);
      els.toAmountInput.value = toAmountUi;
      state.toAmount = toAmountUi;

      // Exchange rate = toAmount / fromAmount
      const rate = toAmountUi / Number(state.fromAmount);
      els.exchangeRate.textContent = `1 ${state.fromToken.symbol} = ${rate.toFixed(6)} ${state.toToken.symbol}`;

      // Price impact (format as %)
      const priceImpactPct = state.quote.priceImpactPct * 100;
      els.priceImpact.textContent = priceImpactPct.toFixed(3) + '%';
      els.priceImpact.className = 'price-impact' + (priceImpactPct > 1 ? ' high' : '');

      // Network fee lamports to SOL
      const feeLamports = state.quote.estimatedNetworkFees;
      const feeSOL = feeLamports / solanaWeb3.LAMPORTS_PER_SOL;
      els.networkFee.textContent = feeSOL.toFixed(6) + ' SOL';

    } catch(e) {
      console.error('Quote error:', e);
      els.toAmountInput.value = '';
      els.exchangeRate.textContent = '-';
      els.priceImpact.textContent = '-';
      els.networkFee.textContent = '-';
      state.quote = null;
    }
  }

  // Convert UI amount string to raw amount (integer)
  function toRawAmount(amount, decimals) {
    return BigInt(Math.floor(Number(amount) * (10 ** decimals))).toString();
  }

  // Convert raw amount (string or BigInt) to UI decimal number
  function toUiAmount(rawAmount, decimals) {
    if(!rawAmount) return 0;
    if(typeof rawAmount === 'string') rawAmount = BigInt(rawAmount);
    return Number(rawAmount) / (10 ** decimals);
  }

  // Swap button click handler
  async function onSwapClick() {
    if(!state.wallet) {
      connectWallet();
      return;
    }
    if(!state.quote) {
      alert('No swap quote available. Enter a valid amount.');
      return;
    }
    try {
      els.swapButton.disabled = true;
      els.swapButton.textContent = 'Swapping...';

      // 1. Fetch swap transaction from Jupiter
      const swapResponse = await fetch(`${config.jupiterAPI}/swap`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          route: state.quote,
          userPublicKey: state.wallet.publicKey.toString(),
          wrapUnwrapSOL: true,
        })
      });
      if(!swapResponse.ok) throw new Error('Swap transaction fetch failed');
      const swapData = await swapResponse.json();

      if(!swapData.transaction) {
        throw new Error('No transaction returned from swap API');
      }

      // 2. Deserialize transaction
      const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
      const tx = solanaWeb3.Transaction.from(Buffer.from(swapData.transaction, 'base64'));

      // 3. Sign and send transaction via Phantom
      const signedTx = await window.solana.signTransaction(tx);
      const txid = await connection.sendRawTransaction(signedTx.serialize());
      await connection.confirmTransaction(txid);

      alert(`Swap successful! Transaction ID: ${txid}`);
      // Refresh balances and reset amounts
      fetchBalance(state.wallet.publicKey);
      els.fromAmountInput.value = '';
      els.toAmountInput.value = '';
      state.fromAmount = '';
      state.toAmount = '';
      els.swapButton.textContent = 'Swap';
      els.swapButton.disabled = false;
    } catch(e) {
      console.error('Swap failed:', e);
      alert('Swap failed: ' + e.message);
      els.swapButton.textContent = 'Swap';
      els.swapButton.disabled = false;
    }
  }

  // Event listeners
  els.fromTokenSelector.onclick = () => openTokenModal('from');
  els.toTokenSelector.onclick = () => openTokenModal('to');
  els.tokenModalClose.onclick = closeTokenModal;

  els.tokenSearch.oninput = debounce(() => {
    const search = els.tokenSearch.value.toLowerCase().trim();
    const filtered = state.tokens.filter(t => 
      t.symbol.toLowerCase().includes(search) ||
      t.name.toLowerCase().includes(search) ||
      t.address.toLowerCase().startsWith(search)
    );
    renderTokenList(filtered);
  }, 200);

  els.switchTokensBtn.onclick = () => {
    switchTokens();
  };

  els.fromAmountInput.oninput = debounce(() => {
    state.fromAmount = els.fromAmountInput.value;
    fetchQuote();
  }, 300);

  els.swapButton.onclick = onSwapClick;

  // Initialization
  async function init() {
    els.networkStatusText.textContent = 'Solana Mainnet';
    els.networkStatusIndicator.style.backgroundColor = '#4dffb5';

    await loadTokens();

    if(window.solana && window.solana.isPhantom) {
      els.swapButton.textContent = 'Connect Wallet';
    } else {
      els.swapButton.textContent = 'Install Phantom Wallet';
      els.swapButton.disabled = true;
    }
  }

  init();

})();
</script>

</body>
</html>