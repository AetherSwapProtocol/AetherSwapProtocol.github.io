<!DOCTYPE html>
<html lang="en" class="bg-zinc-950 text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AetherSwap Perpetuals</title>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.76.0/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@phantom-wallet-adapter/solana@0.0.4/lib/index.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="font-sans">

  <!-- Header -->
  <header class="text-center p-4 bg-gradient-to-r from-violet-700 to-blue-700">
    <h1 class="text-xl font-bold">AetherSwap — Perpetual Trading</h1>
  </header>

  <!-- Token Selection Modal -->
  <div id="tokenModal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center">
    <div class="bg-zinc-900 p-4 rounded w-full max-w-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Select a Pair</h2>
        <button onclick="closeModal()" class="text-white text-sm">✕</button>
      </div>
      <input id="searchInput" placeholder="Search by name or paste address" class="w-full p-2 mb-2 bg-zinc-800 rounded" />
      <div id="tokenList" class="max-h-80 overflow-y-auto space-y-2 text-sm"></div>
    </div>
  </div>

  <!-- Token Select -->
  <div class="p-4">
    <div class="flex justify-between items-center">
      <div>
        <div class="text-sm text-gray-400">Selected Pair</div>
        <div id="selectedToken" class="text-lg font-semibold">SOL / USDC</div>
      </div>
      <button onclick="openModal()" class="bg-purple-700 hover:bg-purple-800 px-3 py-1 rounded text-sm">
        Change
      </button>
    </div>
  </div>

  <!-- Chart -->
  <div class="p-4">
    <div class="text-sm mb-2">Chart</div>
    <div class="relative border border-white/10 rounded overflow-hidden">
      <iframe id="tvChart"
        src="https://www.tradingview.com/embed-widget/mini-symbol-overview/?symbol=SOLUSDT&locale=en&colorTheme=dark&dateRange=1D&autosize=true"
        style="width: 100%; height: 300px; border: none;">
      </iframe>
      <button id="expandChartBtn" class="absolute top-2 right-2 bg-black/60 hover:bg-black/80 text-xs px-2 py-1 rounded">
        Expand
      </button>
    </div>
  </div>

  <!-- Trading Panel -->
  <div class="p-4 space-y-4">
    <div class="flex items-center justify-between text-sm">
      <span class="text-gray-400">Side</span>
      <div class="flex gap-2">
        <button id="longBtn" class="bg-green-600 px-3 py-1 rounded text-white text-xs hover:bg-green-700">Long</button>
        <button id="shortBtn" class="bg-red-600 px-3 py-1 rounded text-white text-xs hover:bg-red-700">Short</button>
      </div>
    </div>

    <div class="flex items-center justify-between text-sm">
      <span class="text-gray-400">Leverage</span>
      <input id="leverageInput" type="number" min="1" max="20" value="5"
        class="w-20 bg-zinc-900 px-2 py-1 rounded text-right text-sm outline-none" />
    </div>

    <div class="flex items-center justify-between text-sm">
      <span class="text-gray-400">Size (USDC)</span>
      <input id="sizeInput" type="number" placeholder="100"
        class="w-32 bg-zinc-900 px-2 py-1 rounded text-right text-sm outline-none" />
    </div>

    <button id="openPositionBtn" class="w-full bg-purple-600 hover:bg-purple-700 py-2 rounded text-sm font-semibold">
      Open Position
    </button>
  </div>

  <!-- Live Data -->
  <div class="p-4 space-y-1 text-sm text-gray-300">
    <div class="flex justify-between">
      <span>Live Price:</span>
      <span id="livePrice">-</span>
    </div>
    <div class="flex justify-between">
      <span>Est. Liquidation:</span>
      <span id="liquidationPrice">-</span>
    </div>
    <div class="flex justify-between">
      <span>Est. PnL:</span>
      <span id="estimatedPnL">-</span>
    </div>
  </div>

  <!-- Connect Wallet -->
  <div class="p-4 text-center">
    <button id="connectBtn" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded">
      Connect Phantom
    </button>
    <div id="walletAddress" class="mt-2 text-sm text-gray-400"></div>
  </div>

  <script>
    const modal = document.getElementById("tokenModal");
    const selectedTokenEl = document.getElementById("selectedToken");
    let selectedTokenSymbol = "SOLUSDT";
    let price = 0;

    function openModal() {
      modal.classList.remove("hidden");
      loadTokenList();
    }

    function closeModal() {
      modal.classList.add("hidden");
    }

    async function loadTokenList() {
      const res = await fetch("https://public-api.birdeye.so/public/tokenlist?sort_by=volume_24h_usd");
      const data = await res.json();
      const list = data.data.tokens;
      const tokenListEl = document.getElementById("tokenList");
      tokenListEl.innerHTML = "";
      list.slice(0, 1000).forEach(token => {
        const div = document.createElement("div");
        div.textContent = `${token.symbol} (${token.address.slice(0, 4)}...)`;
        div.className = "p-2 bg-zinc-800 rounded cursor-pointer hover:bg-zinc-700";
        div.onclick = () => selectToken(token);
        tokenListEl.appendChild(div);
      });
    }

    function selectToken(token) {
      selectedTokenSymbol = token.symbol + "USDC";
      selectedTokenEl.textContent = token.symbol + " / USDC";
      document.getElementById("tvChart").src =
        `https://www.tradingview.com/embed-widget/mini-symbol-overview/?symbol=${token.symbol}USDC&locale=en&colorTheme=dark&dateRange=1D&autosize=true`;
      closeModal();
      fetchPrice();
    }

    async function fetchPrice() {
      try {
        const response = await axios.get(`https://public-api.birdeye.so/public/price?address=So11111111111111111111111111111111111111112`);
        price = response.data.data.value;
        document.getElementById("livePrice").textContent = "$" + price.toFixed(2);
        calculateLiquidation();
      } catch (e) {
        document.getElementById("livePrice").textContent = "N/A";
      }
    }

    function calculateLiquidation() {
      const size = parseFloat(document.getElementById("sizeInput").value || 0);
      const leverage = parseFloat(document.getElementById("leverageInput").value || 1);
      if (price && size && leverage) {
        const entry = price;
        const margin = size / leverage;
        const liquidation = entry - (entry * 0.8); // mock ratio
        document.getElementById("liquidationPrice").textContent = "$" + liquidation.toFixed(2);
      }
    }

    document.getElementById("sizeInput").addEventListener("input", calculateLiquidation);
    document.getElementById("leverageInput").addEventListener("input", calculateLiquidation);

    // Wallet Connection
    const connectBtn = document.getElementById("connectBtn");
    const walletAddressEl = document.getElementById("walletAddress");
    connectBtn.addEventListener("click", async () => {
      if (window.solana && window.solana.isPhantom) {
        try {
          const resp = await window.solana.connect();
          walletAddressEl.textContent = resp.publicKey.toString();
        } catch (err) {
          alert("Connection cancelled");
        }
      } else {
        alert("Phantom wallet not found");
      }
    });

    fetchPrice();
  </script>
</body>
</html>