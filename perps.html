<!DOCTYPE html>
<html lang="en" class="bg-zinc-950 text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AetherSwap Perps</title>

  <!-- Tailwind + custom theme -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            dark: '#0e0b1e',
            purple: {
              500: '#8b5cf6',
              600: '#7c3aed',
            },
            blue: {
              500: '#6366f1',
              600: '#4f46e5',
            },
            green: {
              500: '#14f195'
            },
            zinc: {
              800: '#27272a',
            },
            aether: {
              primary: '#8b5cf6',
              secondary: '#6366f1',
              bg: '#0e0b1e',
              card: '#1C1933',
              accent: '#14f195'
            }
          }
        }
      }
    };
  </script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>

  <!-- Solana Web3 (Phantom) -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

  <!-- TradingView -->
  <script src="https://s3.tradingview.com/tv.js"></script>
</head>
<body class="font-sans flex flex-col min-h-screen">
  <!-- Header -->
  <header class="border-b border-white/10 bg-zinc-900 shadow-sm">
  <div class="container mx-auto flex justify-between items-center p-4">
    <div class="flex items-center space-x-8">
      <h1 class="text-xl font-bold text-aether-primary">AetherSwap</h1>
      <nav class="hidden md:flex space-x-6">
        <a href="perps.html" class="text-white/70 hover:text-purple-400 transition">Perpetuals</a>
        <a href="swap.html" class="text-white/70 hover:text-purple-400 transition">Swap</a>
        <a href="pools.html" class="text-white/70 hover:text-purple-400 transition">Pools</a>
      </nav>
    </div>
    <div class="flex items-center space-x-4">
      <div id="walletInfo" class="flex items-center space-x-2 hidden">
        <div class="w-2 h-2 rounded-full bg-green-400"></div>
        <span id="walletAddress" class="text-sm truncate max-w-[120px]">0x...</span>
        <span id="walletBalance" class="text-sm text-gray-400">0.00 SOL</span>
      </div>
      <button id="connectWalletBtn" class="bg-aether-primary hover:bg-purple-700 px-4 py-2 rounded text-sm transition">
        Connect Wallet
      </button>
    </div>
  </div>
</header>

  <!-- Main Content -->
<main class="flex flex-1 container mx-auto p-4">
  <!-- Left Column - Order Book -->
  <div class="w-1/4 hidden lg:block pr-4">
    <div class="bg-zinc-900 rounded-lg p-4 shadow-lg">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold text-white">Order Book</h2>
        <div class="text-xs text-gray-400">
          Depth: <select id="orderbookDepth" class="bg-zinc-800 text-gray-200 text-xs rounded px-1">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
        </div>
      </div>

      <div class="text-xs text-gray-400 flex justify-between mb-2">
        <span>Price (USDC)</span>
        <span>Size (BTC)</span>
      </div>

      <!-- Orderbook Bids -->
      <div id="bidsList" class="space-y-1 mb-4 max-h-48 overflow-y-auto">
        <!-- Dynamically injected rows -->
      </div>

      <!-- Mid Price -->
      <div class="text-center py-2 border-y border-zinc-700 my-2">
        <div class="text-xl font-mono text-white" id="currentPrice">Loading...</div>
        <div class="text-xs text-green-400" id="priceChange24h">+0.00%</div>
      </div>

      <!-- Orderbook Asks -->
      <div id="asksList" class="space-y-1 max-h-48 overflow-y-auto">
        <!-- Dynamically injected rows -->
      </div>
    </div>
  </div>

    <!-- Center Column - Chart and Trading -->
<main class="flex-1 overflow-y-auto p-4">
  <!-- Market Header -->
  <div class="flex justify-between items-center mb-4">
    <div>
      <h2 class="text-2xl font-bold text-white" id="selectedMarket">BTC-PERP</h2>
      <p class="text-sm text-gray-400">Trade perpetual futures</p>
    </div>
    <button id="refreshDataBtn" class="bg-zinc-800 text-white px-4 py-2 rounded hover:bg-zinc-700">
      ↻ Refresh
    </button>
  </div>

  <!-- Chart -->
  <div class="bg-zinc-900 rounded-lg p-4 mb-4">
    <div class="text-white font-bold mb-2">Price Chart</div>
    <div id="priceChart" class="h-64 w-full rounded overflow-hidden"></div>
  </div>

  <!-- Trade Panel -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Order Form -->
    <div class="bg-zinc-900 p-4 rounded-lg">
      <div class="flex items-center justify-between mb-2">
        <div class="flex space-x-2">
          <button id="longBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Long</button>
          <button id="shortBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Short</button>
        </div>
        <div class="text-xs text-gray-400">
          Available: <span id="availableBalance">0.00</span> USDC
        </div>
      </div>
      <div class="mb-4">
        <label for="priceInput" class="block text-sm text-gray-300">Price (USDC)</label>
        <input type="number" id="priceInput" class="w-full mt-1 p-2 bg-zinc-800 text-white rounded" placeholder="Market">
      </div>
      <div class="mb-4">
        <label for="amountInput" class="block text-sm text-gray-300">Amount</label>
        <input type="number" id="amountInput" class="w-full mt-1 p-2 bg-zinc-800 text-white rounded" placeholder="0.00">
      </div>
      <div class="mb-4">
        <label for="leverageSlider" class="block text-sm text-gray-300">Leverage: <span id="leverageValue">5x</span></label>
        <input type="range" id="leverageSlider" min="1" max="20" value="5" class="w-full mt-1">
      </div>
      <div class="mb-4">
        <div class="flex justify-between text-sm text-gray-400">
          <span>Estimated Total:</span>
          <span id="orderTotal">0.00 USDC</span>
        </div>
      </div>
      <button id="placeOrderBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded">
        Place Order
      </button>
    </div>

    <!-- Open Positions -->
    <div class="bg-zinc-900 p-4 rounded-lg">
      <div class="flex space-x-2 mb-4">
        <button id="positionsTab" class="bg-purple-600 px-3 py-1 rounded text-sm text-white">Positions</button>
        <button id="ordersTab" class="bg-zinc-800 px-3 py-1 rounded text-sm text-white">Orders</button>
        <button id="historyTab" class="bg-zinc-800 px-3 py-1 rounded text-sm text-white">History</button>
      </div>

      <div id="positionsList" class="space-y-2">
        <div class="text-center py-8 text-gray-500 text-sm">
          No open positions
        </div>
      </div>

      <div id="ordersList" class="hidden space-y-2">
        <!-- Orders go here -->
      </div>

      <div id="historyList" class="hidden space-y-2">
        <!-- Trade history goes here -->
      </div>
    </div>
  </div>
</main>

  <!-- Market Selection Modal -->
  <div id="marketModal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4">
    <div class="bg-zinc-900 p-4 rounded-lg w-full max-w-2xl max-h-[90vh] flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Select Market</h2>
        <button onclick="closeModal()" class="text-white text-sm">✕</button>
      </div>
      <input id="marketSearch" placeholder="Search markets..." class="w-full p-2 mb-4 bg-zinc-800 rounded">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 overflow-y-auto">
        <div class="space-y-2">
          <h3 class="text-sm font-semibold text-gray-400">Favorites</h3>
          <div id="favoriteMarkets">
            <!-- Filled dynamically -->
          </div>
        </div>
        <div class="space-y-2">
          <h3 class="text-sm font-semibold text-gray-400">All Markets</h3>
          <div id="allMarkets">
            <!-- Filled dynamically -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const config = {
      apiBaseUrl: 'https://api.birdeye.so',
      wsBaseUrl: 'wss://stream.birdeye.so',
      defaultMarket: 'BTC-PERP',
      updateInterval: 5000, // ms
      maxOrderbookDepth: 20
    };

    // State
    const state = {
      connected: false,
      currentMarket: config.defaultMarket,
      markets: [],
      orderbook: { bids: [], asks: [] },
      trades: [],
      priceData: [],
      positions: [],
      orders: [],
      history: [],
      walletBalance: 0,
      selectedSide: 'buy',
      leverage: 5,
      chart: null
    };

    // WebSocket connection
    let wsConnection = null;

    // DOM Elements
    const elements = {
      walletInfo: document.getElementById('walletInfo'),
      walletAddress: document.getElementById('walletAddress'),
      walletBalance: document.getElementById('walletBalance'),
      connectBtn: document.getElementById('connectBtn'),
      selectedMarket: document.getElementById('selectedMarket'),
      marketPrice: document.getElementById('marketPrice'),
      priceChange: document.getElementById('priceChange'),
      priceChange24h: document.getElementById('priceChange24h'),
      high24h: document.getElementById('high24h'),
      low24h: document.getElementById('low24h'),
      bidsList: document.getElementById('bidsList'),
      asksList: document.getElementById('asksList'),
      currentPrice: document.getElementById('currentPrice'),
      volume24h: document.getElementById('volume24h'),
      openInterest: document.getElementById('openInterest'),
      fundingRate: document.getElementById('fundingRate'),
      nextFunding: document.getElementById('nextFunding'),
      markPrice: document.getElementById('markPrice'),
      indexPrice: document.getElementById('indexPrice'),
      tradesList: document.getElementById('tradesList'),
      positionsList: document.getElementById('positionsList'),
      ordersList: document.getElementById('ordersList'),
      historyList: document.getElementById('historyList'),
      availableBalance: document.getElementById('availableBalance'),
      priceInput: document.getElementById('priceInput'),
      amountInput: document.getElementById('amountInput'),
      orderTotal: document.getElementById('orderTotal'),
      placeOrderBtn: document.getElementById('placeOrderBtn'),
      leverageSlider: document.getElementById('leverageSlider'),
      leverageValue: document.getElementById('leverageValue'),
      buyBtn: document.getElementById('buyBtn'),
      sellBtn: document.getElementById('sellBtn'),
      limitTab: document.getElementById('limitTab'),
      marketTab: document.getElementById('marketTab'),
      positionsTab: document.getElementById('positionsTab'),
      ordersTab: document.getElementById('ordersTab'),
      historyTab: document.getElementById('historyTab'),
      marketModal: document.getElementById('marketModal'),
      marketSearch: document.getElementById('marketSearch'),
      favoriteMarkets: document.getElementById('favoriteMarkets'),
      allMarkets: document.getElementById('allMarkets'),
      changeMarketBtn: document.getElementById('changeMarketBtn'),
      refreshDataBtn: document.getElementById('refreshDataBtn'),
      priceChart: document.getElementById('priceChart')
    };

    // Initialize the application
    document.addEventListener('DOMContentLoaded', async () => {
      initializeEventListeners();
      await loadMarkets();
      initializeChart();
      connectWebSocket();
      startDataUpdates();
    });

    // Initialize event listeners
    function initializeEventListeners() {
      // Wallet connection
      elements.connectBtn.addEventListener('click', connectWallet);

      // Trading panel
      elements.buyBtn.addEventListener('click', () => setOrderSide('buy'));
      elements.sellBtn.addEventListener('click', () => setOrderSide('sell'));
      elements.leverageSlider.addEventListener('input', updateLeverage);
      elements.priceInput.addEventListener('input', calculateOrderTotal);
      elements.amountInput.addEventListener('input', calculateOrderTotal);
      elements.placeOrderBtn.addEventListener('click', placeOrder);

      // Leverage presets
      document.getElementById('leveragePreset5').addEventListener('click', () => setLeverage(5));
      document.getElementById('leveragePreset10').addEventListener('click', () => setLeverage(10));

      // Percentage buttons
      document.querySelectorAll('[data-multiplier]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const multiplier = parseFloat(e.target.dataset.multiplier);
          const maxAmount = state.walletBalance / (elements.priceInput.value || state.priceData[state.priceData.length - 1]?.close);
          elements.amountInput.value = (maxAmount * multiplier).toFixed(4);
          calculateOrderTotal();
        });
      });

      // Tabs
      elements.limitTab.addEventListener('click', () => setOrderType('limit'));
      elements.marketTab.addEventListener('click', () => setOrderType('market'));
      elements.positionsTab.addEventListener('click', () => showTab('positions'));
      elements.ordersTab.addEventListener('click', () => showTab('orders'));
      elements.historyTab.addEventListener('click', () => showTab('history'));

      // Market selection
      elements.changeMarketBtn.addEventListener('click', openMarketModal);
      elements.refreshDataBtn.addEventListener('click', refreshData);
    }

    // Connect to Phantom wallet
    async function connectWallet() {
      if (window.solana && window.solana.isPhantom) {
        try {
          const resp = await window.solana.connect();
          const pubKey = resp.publicKey.toString();
          state.connected = true;
          
          elements.walletAddress.textContent = `${pubKey.slice(0, 4)}...${pubKey.slice(-4)}`;
          elements.connectBtn.classList.add('hidden');
          elements.walletInfo.classList.remove('hidden');
          
          // Fetch wallet balance (mock)
          state.walletBalance = 2500; // Mock balance
          elements.walletBalance.textContent = state.walletBalance.toFixed(2) + ' USDC';
          elements.availableBalance.textContent = state.walletBalance.toFixed(2);
          
          // Load user data
          loadUserPositions();
          loadUserOrders();
          loadUserHistory();
        } catch (err) {
          console.error("Wallet connection error:", err);
          alert("Failed to connect wallet");
        }
      } else {
        window.open('https://phantom.app/', '_blank');
      }
    }

    // Load available markets
    async function loadMarkets() {
      try {
        // Mock data - in a real app you would fetch this from your API
        state.markets = [
          { symbol: 'BTC-PERP', name: 'BTC Perpetual', price: 109823.4, change24h: -0.18, volume: 11.8, oi: 27.25, maxLeverage: 20 },
          { symbol: 'ETH-PERP', name: 'ETH Perpetual', price: 2763.15, change24h: 4.56, volume: 27.25, oi: 2.76, maxLeverage: 20 },
          { symbol: 'SOL-PERP', name: 'SOL Perpetual', price: 163.46, change24h: 2.46, volume: 10.18, oi: 1.63, maxLeverage: 20 },
          { symbol: 'SUI-PERP', name: 'SUI Perpetual', price: 3.45, change24h: 0.11, volume: 1.32, oi: 0.35, maxLeverage: 10 },
          { symbol: 'HYPE-PERP', name: 'HYPE Perpetual', price: 41.59, change24h: 8.13, volume: 0.5, oi: 0.42, maxLeverage: 10 }
        ];

        updateMarketData();
      } catch (error) {
        console.error("Failed to load markets:", error);
      }
    }

    // Connect to WebSocket for real-time data
    function connectWebSocket() {
      if (wsConnection) wsConnection.close();

      // Mock WebSocket connection - in a real app this would connect to your WebSocket endpoint
      console.log("Connecting to WebSocket...");
      
      // Simulate WebSocket updates
      setInterval(() => {
        simulateWebSocketUpdate();
      }, 1000);
    }

    // Simulate WebSocket updates (mock)
    function simulateWebSocketUpdate() {
      if (!state.priceData.length) return;

      // Simulate price change
      const lastPrice = state.priceData[state.priceData.length - 1].close;
      const newPrice = lastPrice * (1 + (Math.random() * 0.002 - 0.001)); // Random small change
      const change = newPrice - lastPrice;
      const changePercent = (change / lastPrice) * 100;

      // Update price
      updatePrice(newPrice, change, changePercent);

      // Simulate order book updates
      simulateOrderBookUpdates();

      // Simulate new trades
      simulateNewTrades(newPrice);
    }

    // Update price display
    function updatePrice(price, change, changePercent) {
      const priceFormatted = price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const changeFormatted = change.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const changePercentFormatted = changePercent.toFixed(2);
      
      elements.marketPrice.textContent = `$${priceFormatted}`;
      elements.currentPrice.textContent = `$${priceFormatted}`;
      
      if (change >= 0) {
        elements.priceChange.textContent = `+${changeFormatted} (+${changePercentFormatted}%)`;
        elements.priceChange.className = 'text-sm text-green-400';
        elements.currentPrice.classList.add('text-green-400');
        elements.currentPrice.classList.remove('text-red-400');
      } else {
        elements.priceChange.textContent = `${changeFormatted} (${changePercentFormatted}%)`;
        elements.priceChange.className = 'text-sm text-red-400';
        elements.currentPrice.classList.add('text-red-400');
        elements.currentPrice.classList.remove('text-green-400');
      }

      // Add to price history
      const now = new Date();
      state.priceData.push({
        time: now,
        open: price,
        high: price * (1 + Math.random() * 0.001),
        low: price * (1 - Math.random() * 0.001),
        close: price
      });

      // Keep only the last 100 data points
      if (state.priceData.length > 100) {
        state.priceData.shift();
      }

      // Update chart
      updateChart();
    }

    // Simulate order book updates
    function simulateOrderBookUpdates() {
      if (!state.priceData.length) return;
      const lastPrice = state.priceData[state.priceData.length - 1].close;

      // Generate bids (below current price)
      const bids = [];
      for (let i = 0; i < config.maxOrderbookDepth; i++) {
        const price = lastPrice * (1 - (i + 1) * 0.0005);
        const size = Math.random() * 0.5;
        bids.push({ price, size });
      }

      // Generate asks (above current price)
      const asks = [];
      for (let i = 0; i < config.maxOrderbookDepth; i++) {
        const price = lastPrice * (1 + (i + 1) * 0.0005);
        const size = Math.random() * 0.5;
        asks.push({ price, size });
      }

      state.orderbook = { bids, asks };
      updateOrderBook();
    }

    // Update order book display
    function updateOrderBook() {
      // Bids
      elements.bidsList.innerHTML = state.orderbook.bids.map(order => `
        <div class="orderbook-row flex justify-between text-green-400 text-sm">
          <span>${order.price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
          <span>${order.size.toFixed(5)}</span>
        </div>
      `).join('');

      // Asks
      elements.asksList.innerHTML = state.orderbook.asks.map(order => `
        <div class="orderbook-row flex justify-between text-red-400 text-sm">
          <span>${order.price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
          <span>${order.size.toFixed(5)}</span>
        </div>
      `).join('');
    }

    // Simulate new trades
    function simulateNewTrades(currentPrice) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      
      // Generate random trades
      const side = Math.random() > 0.5 ? 'buy' : 'sell';
      const size = (Math.random() * 0.5).toFixed(5);
      
      const trade = {
        price: currentPrice * (1 + (Math.random() * 0.001 - 0.0005)),
        size,
        side,
        time: timeStr
      };

      // Add to beginning of array
      state.trades.unshift(trade);
      
      // Keep only the last 20 trades
      if (state.trades.length > 20) {
        state.trades.pop();
      }

      updateTradesList();
    }

    // Update trades list
    function updateTradesList() {
      elements.tradesList.innerHTML = state.trades.map(trade => `
        <div class="flex justify-between text-sm flasher-${trade.side}">
          <span class="${trade.side === 'buy' ? 'text-green-400' : 'text-red-400'}">
            ${trade.price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
          </span>
          <span>${trade.size}</span>
          <span class="text-gray-400">${trade.time}</span>
        </div>
      `).join('');
    }

    // Initialize price chart
    function initializeChart() {
      const ctx = elements.priceChart.getContext('2d');
      
      state.chart = new Chart(ctx, {
        type: 'candlestick',
        data: {
          datasets: [{
            label: 'Price',
            data: [],
            color: {
              up: '#10b981',
              down: '#ef4444',
              unchanged: '#64748b',
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'minute'
              }
            },
            y: {
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const data = context.raw;
                  return [
                    `O: $${data.o.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                    `H: $${data.h.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                    `L: $${data.l.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                    `C: $${data.c.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                  ];
                }
              }
            }
          }
        }
      });
    }

    // Update chart with new data
    function updateChart() {
      if (!state.chart) return;
      
      const chartData = state.priceData.map(item => ({
        x: item.time,
        o: item.open,
        h: item.high,
        l: item.low,
        c: item.close
      }));
      
      state.chart.data.datasets[0].data = chartData;
      state.chart.update();
    }

    // Set order side (buy/sell)
    function setOrderSide(side) {
      state.selectedSide = side;
      
      if (side === 'buy') {
        elements.buyBtn.classList.add('bg-green-600', 'hover:bg-green-700');
        elements.buyBtn.classList.remove('bg-zinc-800');
        elements.sellBtn.classList.add('bg-zinc-800');
        elements.sellBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
        elements.placeOrderBtn.textContent = 'Place Buy Order';
        elements.placeOrderBtn.className = 'w-full bg-green-600 hover:bg-green-700 py-3 rounded font-medium';
      } else {
        elements.sellBtn.classList.add('bg-red-600', 'hover:bg-red-700');
        elements.sellBtn.classList.remove('bg-zinc-800');
        elements.buyBtn.classList.add('bg-zinc-800');
        elements.buyBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
        elements.placeOrderBtn.textContent = 'Place Sell Order';
        elements.placeOrderBtn.className = 'w-full bg-red-600 hover:bg-red-700 py-3 rounded font-medium';
      }
    }

    // Set order type (limit/market)
    function setOrderType(type) {
      if (type === 'limit') {
        elements.limitTab.classList.add('bg-purple-600');
        elements.limitTab.classList.remove('bg-zinc-800');
        elements.marketTab.classList.add('bg-zinc-800');
        elements.marketTab.classList.remove('bg-purple-600');
        elements.priceInput.disabled = false;
      } else {
        elements.marketTab.classList.add('bg-purple-600');
        elements.marketTab.classList.remove('bg-zinc-800');
        elements.limitTab.classList.add('bg-zinc-800');
        elements.limitTab.classList.remove('bg-purple-600');
        elements.priceInput.disabled = true;
        elements.priceInput.value = '';
        calculateOrderTotal();
      }
    }

    // Update leverage
    function updateLeverage() {
      state.leverage = parseInt(elements.leverageSlider.value);
      elements.leverageValue.textContent = `${state.leverage}x`;
    }

    // Set leverage to specific value
    function setLeverage(value) {
      state.leverage = value;
      elements.leverageSlider.value = value;
      elements.leverageValue.textContent = `${value}x`;
      
      // Update button states
      document.getElementById('leveragePreset5').className = `text-xs px-2 py-1 ${value === 5 ? 'bg-purple-600' : 'bg-zinc-800'} rounded`;
      document.getElementById('leveragePreset10').className = `text-xs px-2 py-1 ${value === 10 ? 'bg-purple-600' : 'bg-zinc-800'} rounded`;
    }

    // Calculate order total
    function calculateOrderTotal() {
      const price = parseFloat(elements.priceInput.value) || state.priceData[state.priceData.length - 1]?.close || 0;
      const amount = parseFloat(elements.amountInput.value) || 0;
      const total = price * amount;
      
      elements.orderTotal.textContent = total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' USDC';
    }

    // Place order (mock implementation)
    function placeOrder() {
      if (!state.connected) {
        alert('Please connect your wallet first');
        return;
      }

      const price = parseFloat(elements.priceInput.value) || state.priceData[state.priceData.length - 1]?.close || 0;
      const amount = parseFloat(elements.amountInput.value) || 0;
      
      if (amount <= 0) {
        alert('Please enter a valid amount');
        return;
      }

      // Mock order placement
      const order = {
        id: Date.now().toString(),
        side: state.selectedSide,
        price,
        amount,
        leverage: state.leverage,
        time: new Date().toLocaleTimeString(),
        status: 'open'
      };

      // Add to orders list
      state.orders.unshift(order);
      updateOrdersList();

      // Show confirmation
      alert(`Order placed: ${order.side.toUpperCase()} ${order.amount} BTC at ${order.price.toFixed(2)} USDC with ${order.leverage}x leverage`);
      
      // Clear inputs
      elements.amountInput.value = '';
      calculateOrderTotal();
    }

    // Load user positions (mock)
    function loadUserPositions() {
      // Mock positions
      state.positions = [
        {
          id: '1',
          symbol: 'BTC-PERP',
          side: 'long',
          entryPrice: 108500.25,
          amount: 0.05,
          markPrice: 109823.40,
          liqPrice: 102340.50,
          pnl: 66.16,
          pnlPercent: 1.22,
          leverage: 5,
          collateral: 1085.00
        },
        {
          id: '2',
          symbol: 'ETH-PERP',
          side: 'short',
          entryPrice: 2810.75,
          amount: 0.5,
          markPrice: 2763.15,
          liqPrice: 2910.25,
          pnl: 23.80,
          pnlPercent: 1.69,
          leverage: 10,
          collateral: 281.08
        }
      ];

      updatePositionsList();
    }

    // Update positions list
    function updatePositionsList() {
      if (state.positions.length === 0) {
        elements.positionsList.innerHTML = `
          <div class="text-center py-8 text-gray-500 text-sm">
            No open positions
          </div>
        `;
        return;
      }

      elements.positionsList.innerHTML = state.positions.map(pos => `
        <div class="bg-zinc-800 rounded-lg p-3">
          <div class="flex justify-between items-center mb-2">
            <div class="flex items-center space-x-2">
              <span class="font-medium">${pos.symbol}</span>
              <span class="text-xs px-1 ${pos.side === 'long' ? 'bg-green-600' : 'bg-red-600'} rounded">
                ${pos.side.toUpperCase()}
              </span>
              <span class="text-xs text-gray-400">${pos.leverage}x</span>
            </div>
            <span class="${pos.pnl >= 0 ? 'text-green-400' : 'text-red-400'} text-sm">
              ${pos.pnl >= 0 ? '+' : ''}${pos.pnl.toFixed(2)} (${pos.pnlPercent.toFixed(2)}%)
            </span>
          </div>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <div class="text-gray-400">Entry</div>
            <div class="text-right">${pos.entryPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
            <div class="text-gray-400">Mark</div>
            <div class="text-right">${pos.markPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
            <div class="text-gray-400">Size</div>
            <div class="text-right">${pos.amount.toFixed(4)}</div>
            <div class="text-gray-400">Liq Price</div>
            <div class="text-right">${pos.liqPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
            <div class="text-gray-400">Collateral</div>
            <div class="text-right">${pos.collateral.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
          </div>
          <div class="flex space-x-2 mt-3">
            <button class="flex-1 py-1 bg-zinc-700 hover:bg-zinc-600 rounded text-xs">Close</button>
            <button class="flex-1 py-1 bg-zinc-700 hover:bg-zinc-600 rounded text-xs">TP/SL</button>
          </div>
        </div>
      `).join('');
    }

    // Load user orders (mock)
    function loadUserOrders() {
      // Mock orders
      state.orders = [
        {
          id: '1',
          symbol: 'BTC-PERP',
          side: 'buy',
          price: 108200.00,
          amount: 0.02,
          filled: 0.00,
          type: 'limit',
          time: '12:34:56',
          status: 'open'
        },
        {
          id: '2',
          symbol: 'ETH-PERP',
          side: 'sell',
          price: 2800.00,
          amount: 0.5,
          filled: 0.25,
          type: 'limit',
          time: '10:20:30',
          status: 'partial'
        }
      ];

      updateOrdersList();
    }

    // Update orders list
    function updateOrdersList() {
      if (state.orders.length === 0) {
        elements.ordersList.innerHTML = `
          <div class="text-center py-8 text-gray-500 text-sm">
            No open orders
          </div>
        `;
        return;
      }

      elements.ordersList.innerHTML = state.orders.map(order => `
        <div class="bg-zinc-800 rounded-lg p-3">
          <div class="flex justify-between items-center mb-1">
            <div class="flex items-center space-x-2">
              <span class="text-sm font-medium">${order.symbol}</span>
              <span class="text-xs px-1 ${order.side === 'buy' ? 'bg-green-600' : 'bg-red-600'} rounded">
                ${order.side.toUpperCase()}
              </span>
            </div>
            <span class="text-xs ${order.status === 'open' ? 'text-green-400' : 'text-yellow-400'}">
              ${order.status.toUpperCase()}
            </span>
          </div>
          <div class="grid grid-cols-2 gap-1 text-xs">
            <div class="text-gray-400">Price</div>
            <div class="text-right">${order.price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
            <div class="text-gray-400">Amount</div>
            <div class="text-right">${order.amount.toFixed(4)}</div>
            <div class="text-gray-400">Filled</div>
            <div class="text-right">${order.filled.toFixed(4)}</div>
            <div class="text-gray-400">Type</div>
            <div class="text-right">${order.type.toUpperCase()}</div>
            <div class="text-gray-400">Time</div>
            <div class="text-right">${order.time}</div>
          </div>
          <div class="flex space-x-2 mt-2">
            <button class="flex-1 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">Cancel</button>
          </div>
        </div>
      `).join('');
    }

    // Load user trade history (mock)
    function loadUserHistory() {
      // Mock history
      state.history = [
        {
          id: '1',
          symbol: 'BTC-PERP',
          side: 'buy',
          price: 108000.00,
          amount: 0.01,
          fee: 2.16,
          pnl: 18.23,
          time: '2023-06-15 09:45:23',
          type: 'market'
        },
        {
          id: '2',
          symbol: 'ETH-PERP',
          side: 'sell',
          price: 2825.50,
          amount: 0.2,
          fee: 1.13,
          pnl: -8.75,
          time: '2023-06-14 14:30:10',
          type: 'limit'
        }
      ];

      updateHistoryList();
    }

    // Update history list
    function updateHistoryList() {
      if (state.history.length === 0) {
        elements.historyList.innerHTML = `
          <div class="text-center py-8 text-gray-500 text-sm">
            No trade history
          </div>
        `;
        return;
      }

      elements.historyList.innerHTML = state.history.map(trade => `
        <div class="bg-zinc-800 rounded-lg p-3">
          <div class="flex justify-between items-center mb-1">
            <div class="flex items-center space-x-2">
              <span class="text-sm font-medium">${trade.symbol}</span>
              <span class="text-xs px-1 ${trade.side === 'buy' ? 'bg-green-600' : 'bg-red-600'} rounded">
                ${trade.side.toUpperCase()}
              </span>
            </div>
            <span class="text-xs text-gray-400">${trade.time.split(' ')[0]}</span>
          </div>
          <div class="grid grid-cols-2 gap-1 text-xs">
            <div class="text-gray-400">Price</div>
            <div class="text-right">${trade.price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
            <div class="text-gray-400">Amount</div>
            <div class="text-right">${trade.amount.toFixed(4)}</div>
            <div class="text-gray-400">Fee</div>
            <div class="text-right">${trade.fee.toFixed(2)}</div>
            <div class="text-gray-400">PNL</div>
            <div class="text-right ${trade.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">
              ${trade.pnl >= 0 ? '+' : ''}${trade.pnl.toFixed(2)}
            </div>
            <div class="text-gray-400">Type</div>
            <div class="text-right">${trade.type.toUpperCase()}</div>
          </div>
        </div>
      `).join('');
    }

    // Show specific tab content
    function showTab(tabName) {
      elements.positionsList.classList.add('hidden');
      elements.ordersList.classList.add('hidden');
      elements.historyList.classList.add('hidden');
      
      elements.positionsTab.classList.remove('bg-purple-600');
      elements.ordersTab.classList.remove('bg-purple-600');
      elements.historyTab.classList.remove('bg-purple-600');
      
      elements.positionsTab.classList.add('bg-zinc-800');
      elements.ordersTab.classList.add('bg-zinc-800');
      elements.historyTab.classList.add('bg-zinc-800');

      if (tabName === 'positions') {
        elements.positionsList.classList.remove('hidden');
        elements.positionsTab.classList.add('bg-purple-600');
        elements.positionsTab.classList.remove('bg-zinc-800');
      } else if (tabName === 'orders') {
        elements.ordersList.classList.remove('hidden');
        elements.ordersTab.classList.add('bg-purple-600');
        elements.ordersTab.classList.remove('bg-zinc-800');
      } else if (tabName === 'history') {
        elements.historyList.classList.remove('hidden');
        elements.historyTab.classList.add('bg-purple-600');
        elements.historyTab.classList.remove('bg-zinc-800');
      }
    }

    // Open market selection modal
    function openMarketModal() {
      elements.marketModal.classList.remove('hidden');
      updateMarketModal();
    }

    // Close modal
    function closeModal() {
      elements.marketModal.classList.add('hidden');
    }

    // Update market modal content
    function updateMarketModal() {
      // Favorite markets (mock)
      const favoriteMarkets = ['BTC-PERP', 'ETH-PERP'];
      
      elements.favoriteMarkets.innerHTML = state.markets
        .filter(m => favoriteMarkets.includes(m.symbol))
        .map(m => createMarketButton(m))
        .join('');
      
      elements.allMarkets.innerHTML = state.markets
        .filter(m => !favoriteMarkets.includes(m.symbol))
        .map(m => createMarketButton(m))
        .join('');
    }

    // Create market button for modal
    function createMarketButton(market) {
      return `
        <button onclick="selectMarket('${market.symbol}')" 
          class="w-full p-2 hover:bg-zinc-800 rounded text-left flex justify-between items-center">
          <div>
            <div class="font-medium">${market.symbol}</div>
            <div class="text-xs text-gray-400">${market.name}</div>
          </div>
          <div class="text-right">
            <div>$${market.price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
            <div class="text-xs ${market.change24h >= 0 ? 'text-green-400' : 'text-red-400'}">
              ${market.change24h >= 0 ? '+' : ''}${market.change24h.toFixed(2)}%
            </div>
          </div>
        </button>
      `;
    }

    // Select new market
    function selectMarket(symbol) {
      state.currentMarket = symbol;
      elements.selectedMarket.textContent = symbol;
      closeModal();
      refreshData();
    }

    // Update market data display
    function updateMarketData() {
      const market = state.markets.find(m => m.symbol === state.currentMarket);
      if (!market) return;

      elements.selectedMarket.textContent = market.symbol;
      elements.marketPrice.textContent = `$${market.price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      
      const changeClass = market.change24h >= 0 ? 'text-green-400' : 'text-red-400';
      const changeSymbol = market.change24h >= 0 ? '+' : '';
      elements.priceChange.className = `text-sm ${changeClass}`;
      elements.priceChange.textContent = `${changeSymbol}${market.change24h.toFixed(2)}%`;
      elements.priceChange24h.className = `text-xs ${changeClass}`;
      elements.priceChange24h.textContent = `${changeSymbol}${market.change24h.toFixed(2)}%`;
      
      // Mock some price range data
      const high = market.price * (1 + Math.abs(market.change24h) / 100;
      const low = market.price * (1 - Math.abs(market.change24h) / 100;
      
      elements.high24h.textContent = `$${high.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      elements.low24h.textContent = `$${low.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      elements.volume24h.textContent = `$${(market.volume * 1000).toLocaleString()}`;
      elements.openInterest.textContent = `$${(market.oi * 1000).toLocaleString()}`;
      
      // Mock funding data
      const fundingRate = (Math.random() * 0.0005 - 0.00025).toFixed(6);
      elements.fundingRate.textContent = `${fundingRate}%`;
      elements.nextFunding.textContent = '1h 23m';
      elements.markPrice.textContent = `$${(market.price * (1 + parseFloat(fundingRate) / 10000)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      elements.indexPrice.textContent = `$${market.price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    // Refresh all data
    function refreshData() {
      updateMarketData();
      
      // Mock price data
      const market = state.markets.find(m => m.symbol === state.currentMarket);
      if (market) {
        state.priceData = [];
        for (let i = 24; i >= 0; i--) {
          const time = new Date(Date.now() - i * 3600 * 1000);
          const basePrice = market.price * (1 + (Math.random() * 0.02 - 0.01));
          state.priceData.push({
            time,
            open: basePrice,
            high: basePrice * (1 + Math.random() * 0.01),
            low: basePrice * (1 - Math.random() * 0.01),
            close: basePrice * (1 + (Math.random() * 0.002 - 0.001))
          });
        }
        updateChart();
      }
      
      // Update order book and trades
      simulateOrderBookUpdates();
      simulateNewTrades(market?.price || 0);
    }

    // Start periodic data updates
    function startDataUpdates() {
      // Initial data load
      refreshData();
      
      // Set up periodic updates
      setInterval(() => {
        refreshData();
      }, config.updateInterval);
    }

    // Make functions available globally for HTML event handlers
    window.selectMarket = selectMarket;
    window.closeModal = closeModal;
  </script>
<script>
  // Activation basique des boutons
  document.getElementById('connectBtn').addEventListener('click', async () => {
  try {
    await connectWallet();
  } catch (error) {
    console.error('Erreur connexion wallet:', error);
    alert('Erreur lors de la connexion au portefeuille.');
  }
});

  // Simulation de changement de marché
  document.querySelectorAll('[onclick*="selectMarket"]').forEach(btn => {
    btn.addEventListener('click', function() {
      const market = this.getAttribute('data-market');
      alert(`Marché sélectionné: ${market}`);
    });
  });

  // Activer les onglets
  ['positionsTab', 'ordersTab', 'historyTab'].forEach(id => {
    document.getElementById(id)?.addEventListener('click', function() {
      alert(`Onglet ${id} cliqué`);
    });
  });
</script>
</body>
</html>