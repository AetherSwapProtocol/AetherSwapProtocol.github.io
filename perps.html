<!DOCTYPE html>
<html lang="en" class="bg-[#0c0c16] text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AetherSwap | Perps</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@solana/web3.js@1.88.0/lib/index.iife.js"></script>
  <script src="https://unpkg.com/@project-serum/anchor@0.24.2/dist/umd/index.js"></script>
  <script src="https://unpkg.com/@solana/spl-token@0.3.5/lib/index.iife.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/@wallet-standard/solana"></script>
  <script src="https://unpkg.com/@solana/wallet-adapter-wallets@0.9.1/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@solana/wallet-adapter-base@0.9.1/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@solana/wallet-adapter-react-ui/styles.css"></script>
  <script src="https://unpkg.com/@solana/wallet-adapter-react@0.18.1/lib/umd/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://s3.tradingview.com/tv.js"></script>
</head>
<body class="bg-[#0c0c16] text-white">
  <header class="w-full flex justify-between items-center p-4 border-b border-[#1f1f2e]">
    <h1 class="text-xl font-bold bg-gradient-to-r from-purple-500 to-blue-500 text-transparent bg-clip-text">AetherSwap Perps</h1>
    <button id="connectBtn" class="px-4 py-2 rounded bg-purple-600 hover:bg-purple-700 transition">Connect Wallet</button>
  </header>

  <main class="flex flex-col md:flex-row gap-4 p-4">
    <!-- LEFT PANEL -->
    <section class="md:w-1/4 space-y-4">
      <!-- Market Selector -->
      <div class="bg-[#1c1c2c] p-4 rounded">
        <label class="block mb-2 font-medium">Select Market</label>
        <select id="pairSelector" class="w-full bg-[#0c0c16] text-white p-2 rounded border border-[#2c2c40]">
          <option value="SOL/USDC">SOL/USDC</option>
          <option value="BTC/USDC">BTC/USDC</option>
          <option value="ETH/USDC">ETH/USDC</option>
        </select>
      </div>

      <!-- Long/Short Form -->
      <div class="bg-[#1c1c2c] p-4 rounded space-y-4">
        <div class="flex justify-between">
          <button id="longBtn" class="w-1/2 bg-green-600 hover:bg-green-700 p-2 rounded">Long</button>
          <button id="shortBtn" class="w-1/2 bg-red-600 hover:bg-red-700 p-2 rounded">Short</button>
        </div>
        <div>
          <label class="block mb-1">Leverage</label>
          <input type="range" min="1" max="20" value="5" class="w-full" id="leverageRange" />
          <p id="leverageDisplay" class="text-sm text-center mt-1">Leverage: 5x</p>
        </div>
        <div>
          <label class="block mb-1">Amount (USDC)</label>
          <input id="tradeAmount" type="number" class="w-full p-2 rounded bg-[#0c0c16] border border-[#2c2c40]" />
        </div>
        <div class="text-sm text-gray-300 space-y-1">
          <p id="priceEstimation">Est. Entry Price: --</p>
          <p id="feeEstimation">Fee: --</p>
          <p id="liqEstimation">Est. Liquidation Price: --</p>
        </div>
        <button class="w-full bg-blue-600 hover:bg-blue-700 p-2 rounded">Open Position</button>
      </div>
    </section>

    <!-- CENTER PANEL -->
    <section class="md:w-2/4 bg-[#1c1c2c] p-2 rounded">
      <div id="tvchart" class="w-full h-[400px]"></div>
    </section>

    <!-- RIGHT PANEL -->
    <section class="md:w-1/4 bg-[#1c1c2c] p-4 rounded">
      <h2 class="text-lg font-semibold mb-2">Positions</h2>
      <ul id="positionsList" class="space-y-2 text-sm">
        <li class="text-gray-400">No open positions.</li>
      </ul>
    </section>
  </main>

  <script>
    // Phantom Wallet Connection
    const connectBtn = document.getElementById('connectBtn');
    let provider = window.phantom?.solana;

    connectBtn.addEventListener('click', async () => {
      try {
        const resp = await provider.connect();
        connectBtn.textContent = "Connected: " + resp.publicKey.toString().slice(0, 6) + "..." + resp.publicKey.toString().slice(-4);
      } catch (err) {
        alert("Wallet connection failed.");
      }
    });

    // Leverage Slider Display
    const leverageRange = document.getElementById('leverageRange');
    const leverageDisplay = document.getElementById('leverageDisplay');
    leverageRange.oninput = () => {
      leverageDisplay.textContent = "Leverage: " + leverageRange.value + "x";
    };

    // Update Price via Birdeye
    const priceEstimation = document.getElementById('priceEstimation');
    const feeEstimation = document.getElementById('feeEstimation');
    const liqEstimation = document.getElementById('liqEstimation');

    async function fetchPrice(symbol = 'SOL/USDC') {
      try {
        const token = symbol.split('/')[0];
        const res = await fetch(`https://public-api.birdeye.so/public/price?address=${getTokenAddress(token)}`, {
          headers: { "X-API-KEY": "demo" }
        });
        const data = await res.json();
        const price = data?.data?.value || 0;
        priceEstimation.textContent = `Est. Entry Price: $${price.toFixed(2)}`;
        const amount = parseFloat(document.getElementById('tradeAmount').value) || 0;
        const fee = amount * 0.001;
        feeEstimation.textContent = `Fee: ~$${fee.toFixed(3)}`;
        const liq = price - price / leverageRange.value;
        liqEstimation.textContent = `Est. Liquidation Price: $${liq.toFixed(2)}`;
      } catch {
        priceEstimation.textContent = "Est. Entry Price: --";
      }
    }

    document.getElementById('tradeAmount').addEventListener('input', () => fetchPrice(document.getElementById('pairSelector').value));
    leverageRange.addEventListener('input', () => fetchPrice(document.getElementById('pairSelector').value));
    document.getElementById('pairSelector').addEventListener('change', e => {
      fetchPrice(e.target.value);
      loadTradingView(e.target.value);
    });

    // Mapping for token symbols to Birdeye address (partial for demo)
    function getTokenAddress(symbol) {
      const map = {
        'SOL': 'So11111111111111111111111111111111111111112',
        'BTC': '9n4nbM75f5Ui33ZbPYXn59EwSgE8CGsHtAeTH5YFeJ9E',
        'ETH': '2ndTPdQduVdp3Vv4YBPGdGcMYcXWqDPUDrocxCz6sJdt'
      };
      return map[symbol] || map['SOL'];
    }

    // TradingView Integration
    function loadTradingView(pair = "SOL/USDC") {
      new TradingView.widget({
        container_id: "tvchart",
        autosize: true,
        symbol: "BINANCE:" + pair.replace("/", ""),
        interval: "15",
        timezone: "Etc/UTC",
        theme: "dark",
        style: "1",
        locale: "en",
        toolbar_bg: "#1c1c2c",
        enable_publishing: false,
        allow_symbol_change: true,
        hide_top_toolbar: false,
        save_image: false,
        hide_legend: false
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadTradingView("SOL/USDC");
      fetchPrice("SOL/USDC");
    });
  </script>
</body>
</html>