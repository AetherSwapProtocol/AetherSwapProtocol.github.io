<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Noûra 2182 — IA Galactique</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

  /* Reset basique */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    background: #0b0f25;
    overflow: hidden;
    font-family: 'Orbitron', monospace;
    color: #a6b0ff;
    user-select: none;
    display: flex;
    flex-direction: column;
  }
  #space-canvas {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 0;
    background: radial-gradient(ellipse at center, #0b0f25 0%, #000010 70%);
  }

  #app {
    position: relative;
    z-index: 1;
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    max-width: 700px;
    margin: auto;
    padding: 12px;
    height: 100vh;
    backdrop-filter: blur(30px);
  }

  header {
    font-size: 2rem;
    font-weight: 700;
    text-align: center;
    color: #7f88ff;
    text-shadow:
      0 0 4px #8695ff,
      0 0 10px #7f88ff,
      0 0 20px #4b52b7;
    padding-bottom: 14px;
  }

  #chat {
    flex: 1 1 auto;
    background: rgba(24, 30, 66, 0.55);
    border-radius: 24px;
    overflow-y: auto;
    padding: 16px;
    box-shadow:
      inset 0 0 15px #4c57aa66,
      0 0 35px #3b3f8a88;
  }

  .message {
    max-width: 70%;
    margin-bottom: 16px;
    font-size: 1rem;
    line-height: 1.4;
    border-radius: 24px;
    padding: 14px 20px;
    box-shadow: 0 3px 12px rgb(0 0 0 / 0.4);
    opacity: 0;
    transform: translateY(15px);
    animation: fadeSlideUp 0.4s ease forwards;
    position: relative;
    word-wrap: break-word;
    user-select: text;
  }

  @keyframes fadeSlideUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .message.user {
    background: linear-gradient(135deg, #5968ffcc, #3348ffcc);
    color: #e0e6ff;
    align-self: flex-end;
    text-align: right;
    box-shadow:
      0 0 15px #5968ffc0,
      0 0 25px #3348ffcc;
  }
  .message.bot {
    background: linear-gradient(135deg, #483b7acc, #6b64e7cc);
    color: #d1d6ff;
    align-self: flex-start;
    text-align: left;
    box-shadow:
      0 0 15px #6b64e7cc,
      0 0 25px #483b7acc;
  }

  #input-area {
    margin-top: 12px;
    background: rgba(18, 24, 58, 0.7);
    border-radius: 32px;
    display: flex;
    align-items: center;
    padding: 8px 16px;
    box-shadow: 0 0 22px #4f59caaa;
  }

  #input-text {
    flex: 1 1 auto;
    font-size: 1.1rem;
    border: none;
    background: transparent;
    color: #b9c0ff;
    padding: 12px 16px;
    border-radius: 20px;
    min-height: 44px;
    resize: none;
    font-family: 'Orbitron', monospace;
    outline-offset: 2px;
    box-shadow:
      inset 0 0 12px #5968ffbb;
  }

  #input-text::placeholder {
    color: #6670a8bb;
  }

  button {
    background: #3a45b3;
    border: none;
    color: #d1d7ff;
    font-weight: 700;
    font-size: 1.1rem;
    padding: 12px 22px;
    margin-left: 12px;
    border-radius: 24px;
    cursor: pointer;
    transition: background 0.35s ease, box-shadow 0.35s ease;
    box-shadow:
      0 0 20px #5c65e1cc;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  button:hover:not(:disabled) {
    background: #5365e7;
    box-shadow:
      0 0 28px #8593ffcc;
  }
  button:disabled {
    background: #2a3177;
    cursor: not-allowed;
    box-shadow: none;
  }

  /* Icon micro */
  #voice-btn svg {
    fill: #b0b6ff;
    filter: drop-shadow(0 0 2px #5968ffbb);
  }

  /* Loading animation */
  #loading-indicator {
    width: 26px;
    height: 26px;
    border: 3px solid #4455cc;
    border-top: 3px solid #a0aaff;
    border-radius: 50%;
    animation: spin 1.2s linear infinite;
    margin-left: 14px;
    display: none;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Typing effect bubble */
  .typing-bubble {
    position: relative;
    background: #5566dccc;
    border-radius: 24px;
    padding: 14px 20px;
    color: #e0e6ffcc;
    font-style: italic;
    user-select: none;
    animation: blinkCursor 1.2s step-end infinite;
  }

  @keyframes blinkCursor {
    50% { border-right: 3px solid #a8b2ff; }
    100% { border-right: 3px solid transparent; }
  }

  /* Scrollbar custom */
  #chat::-webkit-scrollbar {
    width: 8px;
  }
  #chat::-webkit-scrollbar-track {
    background: #0b0f25;
  }
  #chat::-webkit-scrollbar-thumb {
    background: #5064ccaa;
    border-radius: 10px;
  }

  /* Responsive */
  @media (max-width: 600px) {
    #app {
      max-width: 100vw;
      padding: 8px;
    }
    #input-text {
      font-size: 1rem;
      min-height: 38px;
    }
    button {
      padding: 10px 16px;
      font-size: 1rem;
      margin-left: 8px;
    }
  }
</style>
</head>
<body>

<canvas id="space-canvas"></canvas>

<div id="app" role="main" aria-label="Interface de chat IA Noûra">
  <header>Noûra 2182 — IA Galactique</header>
  <section id="chat" aria-live="polite" aria-atomic="false" role="log"></section>
  <form id="input-area" aria-label="Formulaire d’envoi de message" autocomplete="off">
    <textarea id="input-text" rows="1" placeholder="Parle à Noûra..." aria-label="Message utilisateur"></textarea>
    <button id="send-btn" type="submit" aria-label="Envoyer le message">Envoyer</button>
    <button id="voice-btn" type="button" aria-label="Démarrer la reconnaissance vocale">
      <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true" focusable="false">
        <path d="M12 14a2 2 0 0 0 2-2V6a2 2 0 0 0-4 0v6a2 2 0 0 0 2 2zm4-2a4 4 0 0 1-8 0H6a6 6 0 0 0 12 0h-2zm-4 6v4m-4 0h8" stroke="#b0b6ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
      </svg>
    </button>
    <div id="loading-indicator" role="status" aria-live="assertive" aria-label="Chargement en cours"></div>
  </form>
</div>

<script>
  const OPENROUTER_KEY = "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";

  const chat = document.getElementById('chat');
  const inputText = document.getElementById('input-text');
  const sendBtn = document.getElementById('send-btn');
  const voiceBtn = document.getElementById('voice-btn');
  const loadingIndicator = document.getElementById('loading-indicator');

  let history = JSON.parse(localStorage.getItem('noura2182_history') || '[]');
  let isProcessing = false;

  // Utilitaire : afficher un message
  function addMessage(text, sender) {
    const msg = document.createElement('div');
    msg.className = 'message ' + sender;
    msg.textContent = text;
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
    return msg;
  }

  // Typing effect
  async function typeMessage(element, text, delay = 20) {
    element.textContent = '';
    for (const char of text) {
      element.textContent += char;
      await new Promise(r => setTimeout(r, delay));
    }
  }

  // Charger historique
  function loadHistory() {
    for (const msg of history) {
      addMessage(msg.content, msg.role === 'user' ? 'user' : 'bot');
    }
  }

  // Sauvegarder historique
  function saveHistory() {
    localStorage.setItem('noura2182_history', JSON.stringify(history));
  }

  // Synthèse vocale avancée
  function speak(text) {
    if (!window.speechSynthesis) return;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'fr-FR';
    utterance.pitch = 1 + Math.random() * 0.3;  // Légère variation pitch pour naturel
    utterance.rate = 0.9 + Math.random() * 0.2;
    speechSynthesis.cancel();
    speechSynthesis.speak(utterance);
  }

  // Appel API OpenRouter
  async function callAPI(prompt) {
    const body = {
      model: 'gpt-3.5-turbo',
      messages: [{role: 'user', content: prompt}]
    };
    try {
      const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + OPENROUTER_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const errData = await res.json();
        throw new Error(errData.message || 'Erreur API inconnue');
      }
      const data = await res.json();
      return data.choices[0].message.content.trim();
    } catch(e) {
      console.error(e);
      return "Désolé, Noûra est momentanément indisponible.";
    }
  }

  // Gestion de la conversation
  async function sendMessage() {
    if (isProcessing) return;
    const prompt = inputText.value.trim();
    if (!prompt) return;
    isProcessing = true;
    loadingIndicator.style.display = 'inline-block';

    // Affiche le message utilisateur
    addMessage(prompt, 'user');
    history.push({role: 'user', content: prompt});
    saveHistory();

    inputText.value = '';
    inputText.style.height = 'auto';

    // Affiche bulle de saisie animée
    const botMsg = addMessage('', 'bot');
    botMsg.classList.add('typing-bubble');

    // Appel API et écriture progressive
    const response = await callAPI(prompt);
    botMsg.classList.remove('typing-bubble');
    await typeMessage(botMsg, response);

    history.push({role: 'assistant', content: response});
    saveHistory();

    loadingIndicator.style.display = 'none';
    isProcessing = false;

    speak(response);
  }

  // Event envoi par bouton ou Enter
  sendBtn.addEventListener('click', sendMessage);
  inputText.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Ajuste la hauteur de la textarea
  inputText.addEventListener('input', () => {
    inputText.style.height = 'auto';
    inputText.style.height = inputText.scrollHeight + 'px';
  });

  // Reconnaissance vocale
  let recognition;
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'fr-FR';
    recognition.interimResults = false;
    recognition.continuous = false;

    recognition.onstart = () => {
      loadingIndicator.style.display = 'inline-block';
      voiceBtn.disabled = true;
      voiceBtn.setAttribute('aria-pressed', 'true');
    };
    recognition.onend = () => {
      loadingIndicator.style.display = 'none';
      voiceBtn.disabled = false;
      voiceBtn.setAttribute('aria-pressed', 'false');
    };
    recognition.onerror = e => {
      loadingIndicator.style.display = 'none';
      voiceBtn.disabled = false;
      voiceBtn.setAttribute('aria-pressed', 'false');
      alert('Erreur reconnaissance vocale : ' + e.error);
    };
    recognition.onresult = e => {
      const transcript = e.results[0][0].transcript;
      inputText.value = transcript;
      sendMessage();
    };

    voiceBtn.addEventListener('click', () => {
      if (voiceBtn.disabled) return;
      recognition.start();
    });
  } else {
    voiceBtn.disabled = true;
    voiceBtn.title = 'Reconnaissance vocale non supportée sur ce navigateur';
  }

  // Initialisation
  window.onload = () => {
    loadHistory();
    inputText.focus();
  };

  /* ==== Fond spatial animé WebGL minimal ==== */
  (() => {
    const canvas = document.getElementById('space-canvas');
    const ctx = canvas.getContext('2d');
    let w, h;
    let stars = [];

    function resize() {
      w = canvas.width = window.innerWidth;
      h = canvas.height = window.innerHeight;
    }

    class Star {
      constructor() {
        this.reset();
      }
      reset() {
        this.x = Math.random() * w;
        this.y = Math.random() * h;
        this.size = Math.random() * 1.2 + 0.3;
        this.speed = (this.size * 0.7) + 0.15;
        this.opacity = 0.6 + Math.random() * 0.4;
      }
      update() {
        this.x -= this.speed;
        if (this.x < 0) this.x = w;
      }
      draw() {
        ctx.beginPath();
        ctx.fillStyle = `rgba(150,150,255,${this.opacity})`;
        ctx.shadowColor = 'rgba(150, 150, 255, 0.7)';
        ctx.shadowBlur = this.size * 2;
        ctx.arc(this.x, this.y, this.size, 0, 2 * Math.PI);
        ctx.fill();
      }
    }

    function initStars() {
      stars = [];
      for (let i = 0; i < 120; i++) {
        stars.push(new Star());
      }
    }

    function animate() {
      ctx.clearRect(0, 0, w, h);
      stars.forEach(star => {
        star.update();
        star.draw();
      });
      requestAnimationFrame(animate);
    }

    window.addEventListener('resize', () => {
      resize();
      initStars();
    });

    resize();
    initStars();
    animate();
  })();

</script>

</body>
</html>