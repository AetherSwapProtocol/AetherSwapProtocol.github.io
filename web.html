<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AetherSwap complet</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@solana/web3.js@1.70.1/lib/index.iife.min.js"></script>
<style>
  body { background: #0f172a; color: #e0e7ff; font-family: 'Inter', sans-serif; }
  .container { max-width: 400px; margin: 40px auto; padding: 20px; background: #1e293b; border-radius: 8px; }
  button:disabled { opacity: 0.6; cursor: not-allowed; }
  a { color: #60a5fa; text-decoration: underline; }
</style>
</head>
<body>

<div class="container">
  <h1 class="text-2xl font-bold mb-4 text-center">AetherSwap</h1>

  <label for="inputAmount" class="block mb-1">Montant SOL à swapper</label>
  <input id="inputAmount" type="number" min="0" step="0.000000001" placeholder="Ex: 0.1" class="w-full p-2 mb-4 rounded bg-gray-800 text-white" />

  <label for="tokenOut" class="block mb-1">Token de sortie</label>
  <select id="tokenOut" class="w-full p-2 mb-6 rounded bg-gray-800 text-white">
    <option value="">Sélectionner un token</option>
    <option value="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v">USDC</option>
    <option value="Es9vMFrzaCERBL6DgmzMC4sQSTBQLZYNwA9eUocQ7p9w">USDT</option>
    <!-- Ajouter ici d'autres tokens si besoin -->
  </select>

  <button id="connectBtn" class="w-full bg-purple-600 hover:bg-purple-700 p-3 rounded mb-3 font-semibold">Connecter Phantom</button>
  <button id="swapBtn" class="w-full bg-green-600 hover:bg-green-700 p-3 rounded font-semibold" disabled>Swap</button>

  <div id="status" class="mt-4 text-center text-sm text-gray-300"></div>
</div>

<script>
  const SOL_MINT = "So11111111111111111111111111111111111111112";
  const connectBtn = document.getElementById('connectBtn');
  const swapBtn = document.getElementById('swapBtn');
  const inputAmount = document.getElementById('inputAmount');
  const tokenOut = document.getElementById('tokenOut');
  const status = document.getElementById('status');

  let walletPublicKey = null;

  function shorten(address) {
    return address.slice(0, 4) + '…' + address.slice(-4);
  }

  async function connectWallet() {
    if (!window.solana || !window.solana.isPhantom) {
      status.textContent = 'Phantom Wallet non détecté';
      return;
    }
    try {
      const resp = await window.solana.connect();
      walletPublicKey = resp.publicKey.toString();
      status.textContent = `Connecté: ${shorten(walletPublicKey)}`;
      connectBtn.disabled = true;
      connectBtn.textContent = 'Wallet connecté';
      swapBtn.disabled = false;
    } catch (e) {
      status.textContent = 'Connexion au wallet refusée';
    }
  }

  async function fetchQuote(amount, inputMint, outputMint) {
    const amountLamports = Math.floor(amount * 1e9);
    const url = `https://quote-api.jup.ag/v6/quote?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amountLamports}&slippage=1`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Erreur récupération quote');
    const json = await res.json();
    if (!json.data || json.data.length === 0) throw new Error('Aucune route trouvée');
    return json.data[0];
  }

  async function swap() {
    const amount = parseFloat(inputAmount.value);
    const outMint = tokenOut.value;

    if (!walletPublicKey) {
      status.textContent = 'Connectez votre wallet';
      return;
    }
    if (!amount || amount <= 0) {
      status.textContent = 'Montant invalide';
      return;
    }
    if (!outMint) {
      status.textContent = 'Sélectionnez un token de sortie';
      return;
    }

    swapBtn.disabled = true;
    status.textContent = 'Obtention du meilleur taux...';

    try {
      const quote = await fetchQuote(amount, SOL_MINT, outMint);

      const swapBody = {
        quoteResponse: quote,
        userPublicKey: walletPublicKey,
        slippageBps: 100,       // 1% slippage
        dynamicComputeUnitLimit: true,
        dynamicSlippage: true,
        prioritizationFeeLamports: {
          priorityLevelWithMaxLamports: {
            maxLamports: 1000000,
            priorityLevel: "veryHigh"
          }
        }
      };

      const resp = await fetch('https://lite-api.jup.ag/swap/v1/swap', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(swapBody)
      });

      if (!resp.ok) throw new Error('Erreur préparation swap');

      const { swapTransaction } = await resp.json();

      const tx = solanaWeb3.Transaction.from(
        Uint8Array.from(atob(swapTransaction), c => c.charCodeAt(0))
      );

      const signedTx = await window.solana.signTransaction(tx);

      const connection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com');
      status.textContent = 'Envoi de la transaction...';

      const txid = await connection.sendRawTransaction(signedTx.serialize());

      status.innerHTML = `Swap envoyé ! <a href="https://solscan.io/tx/${txid}" target="_blank" rel="noopener noreferrer">Voir sur Solscan</a>`;
    } catch (err) {
      status.textContent = `Erreur : ${err.message}`;
      console.error(err);
    } finally {
      swapBtn.disabled = false;
    }
  }

  connectBtn.addEventListener('click', connectWallet);
  swapBtn.addEventListener('click', swap);
</script>

</body>
</html>