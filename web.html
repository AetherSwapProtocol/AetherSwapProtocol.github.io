<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AetherSwap | Jupiter Integration</title>
  <script src="https://unpkg.com/@solana/web3.js@1.70.1/lib/index.iife.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <style>
    body { background-color: #0f172a; color: white; font-family: sans-serif; }
    select, input, button { background: #1e293b; color: white; border: 1px solid #334155; padding: 8px; border-radius: 4px; }
    button:hover { background: #3b82f6; }
  </style>
</head>
<body class="p-6">
  <h1 class="text-xl mb-4">AetherSwap (via Jupiter)</h1>

  <div class="mb-4">
    <button id="connectWalletBtn">ðŸ”Œ Connecter Phantom</button>
    <span id="walletAddress" class="ml-4 text-green-400"></span>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <div>
      <label>Token A (From):</label><br>
      <input type="text" id="tokenA" placeholder="Adresse mint token A">
    </div>
    <div>
      <label>Token B (To):</label><br>
      <input type="text" id="tokenB" placeholder="Adresse mint token B">
    </div>
    <div>
      <label>Montant:</label><br>
      <input type="number" id="amount" placeholder="Montant en Token A">
    </div>
    <div>
      <label>Slippage (%):</label><br>
      <input type="number" id="slippage" placeholder="0.5" value="0.5" step="0.1">
    </div>
  </div>

  <div class="mb-4">
    <button id="getQuoteBtn">ðŸ’¡ Obtenir le prix</button>
    <span id="quoteResult" class="ml-4 text-yellow-300"></span>
  </div>

  <div class="mb-4">
    <button id="swapBtn" disabled>ðŸš€ Swap</button>
  </div>

  <div id="txResult" class="mt-4 text-sm text-blue-400"></div>

  <script>
    const { Connection, PublicKey, Transaction } = solanaWeb3;
    const connection = new Connection("https://api.mainnet-beta.solana.com");

    let wallet = null;

    document.getElementById("connectWalletBtn").onclick = async () => {
      if (window.solana && window.solana.isPhantom) {
        const resp = await window.solana.connect();
        wallet = window.solana;
        document.getElementById("walletAddress").textContent = resp.publicKey.toBase58();
      } else {
        alert("Phantom n'est pas installÃ©.");
      }
    };

    let latestQuote = null;

    document.getElementById("getQuoteBtn").onclick = async () => {
      const tokenA = document.getElementById("tokenA").value.trim();
      const tokenB = document.getElementById("tokenB").value.trim();
      const amount = parseFloat(document.getElementById("amount").value);
      const slippage = parseFloat(document.getElementById("slippage").value);

      if (!wallet || !tokenA || !tokenB || !amount || isNaN(slippage)) {
        alert("Merci de remplir tous les champs et de connecter votre wallet.");
        return;
      }

      const amount_in_lamports = amount * 10 ** 6; // simplification (6 dÃ©cimales)

      const quoteUrl = `https://quote-api.jup.ag/v6/quote?inputMint=${tokenA}&outputMint=${tokenB}&amount=${Math.floor(amount_in_lamports)}&slippageBps=${Math.floor(slippage * 100)}&onlyDirectRoutes=false`;

      const res = await fetch(quoteUrl);
      const data = await res.json();

      if (!data.data || data.data.length === 0) {
        document.getElementById("quoteResult").textContent = "Aucune route trouvÃ©e.";
        return;
      }

      latestQuote = data.data[0];
      document.getElementById("quoteResult").textContent = `Vous recevez ~${(latestQuote.outAmount / 1e6).toFixed(6)} Token B`;

      document.getElementById("swapBtn").disabled = false;
    };

    document.getElementById("swapBtn").onclick = async () => {
      if (!wallet || !latestQuote) return;

      const swapRes = await fetch('https://lite-api.jup.ag/swap/v1/swap', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          quoteResponse: latestQuote,
          userPublicKey: wallet.publicKey.toBase58(),
          wrapUnwrapSOL: true,
          dynamicSlippage: true,
          prioritizationFeeLamports: {
            priorityLevelWithMaxLamports: {
              maxLamports: 1000000,
              priorityLevel: "veryHigh"
            }
          }
        })
      });

      const swapData = await swapRes.json();
      const txBuf = Uint8Array.from(Buffer.from(swapData.swapTransaction, 'base64'));
      const tx = Transaction.from(txBuf);

      const signed = await wallet.signTransaction(tx);
      const sig = await connection.sendRawTransaction(signed.serialize(), { skipPreflight: false });

      document.getElementById("txResult").innerHTML = `Transaction envoyÃ©e : <a href="https://solscan.io/tx/${sig}" target="_blank">${sig}</a>`;
    };
  </script>
</body>
</html>