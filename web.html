<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Noûra 2182 - IA Galactique</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

  body, html {
    margin: 0; padding: 0; height: 100%;
    background: linear-gradient(135deg, #0a0f25 0%, #2a1c44 100%);
    font-family: 'Orbitron', monospace;
    color: #b0b6ff;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  #app {
    width: 90vw;
    max-width: 720px;
    height: 90vh;
    background: rgba(20,20,50,0.85);
    box-shadow:
      0 0 25px #534dffaa,
      inset 0 0 15px #3b35bfaa;
    border-radius: 25px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  header {
    font-size: 2.2rem;
    font-weight: 700;
    text-align: center;
    padding: 20px 10px 10px;
    color: #8a89ff;
    text-shadow: 0 0 8px #8a89ffbb;
    user-select: none;
  }

  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 15px 20px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    background: rgba(12,12,40,0.3);
    scrollbar-width: thin;
    scrollbar-color: #7c79ff44 transparent;
  }
  #chat::-webkit-scrollbar {
    width: 8px;
  }
  #chat::-webkit-scrollbar-thumb {
    background: #7c79ff88;
    border-radius: 10px;
  }
  #chat::-webkit-scrollbar-track {
    background: transparent;
  }

  .message {
    max-width: 75%;
    padding: 14px 18px;
    border-radius: 24px;
    box-shadow: 0 0 15px #5c5aff88;
    font-size: 1rem;
    line-height: 1.4;
    word-break: break-word;
    opacity: 0;
    transform: translateY(15px);
    animation: fadeUp 0.3s forwards;
    user-select: text;
  }
  @keyframes fadeUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .user {
    background: linear-gradient(135deg, #5968ffcc, #3348ffcc);
    color: #d9dcff;
    align-self: flex-end;
    text-align: right;
    box-shadow: 0 0 22px #3348ffbb;
  }
  .bot {
    background: linear-gradient(135deg, #4a3b8ccc, #6b64e7cc);
    color: #e0e6ff;
    align-self: flex-start;
    box-shadow: 0 0 22px #6b64e7cc;
  }

  #input-area {
    display: flex;
    padding: 15px 20px;
    background: rgba(15,15,50,0.9);
    box-shadow: inset 0 0 15px #4049a833;
  }
  #input-text {
    flex: 1;
    font-size: 1.1rem;
    font-family: 'Orbitron', monospace;
    padding: 12px 16px;
    border-radius: 20px;
    border: none;
    background: rgba(30,30,70,0.8);
    color: #c0c6ff;
    resize: none;
    min-height: 42px;
    max-height: 150px;
    outline-offset: 3px;
    box-shadow: inset 0 0 15px #4b4effcc;
    transition: box-shadow 0.3s ease;
  }
  #input-text::placeholder {
    color: #7a7fff99;
  }
  #input-text:focus {
    box-shadow: inset 0 0 22px #7a7affdd;
  }

  button {
    margin-left: 14px;
    padding: 12px 18px;
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    font-size: 1.1rem;
    background: #5c5cffdd;
    border: none;
    border-radius: 24px;
    color: white;
    cursor: pointer;
    transition: background 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 0 25px #5c5cffcc;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  button:hover:not(:disabled) {
    background: #7a7affee;
    box-shadow: 0 0 35px #7a7affee;
  }
  button:disabled {
    background: #333a6666;
    cursor: not-allowed;
    box-shadow: none;
  }

  /* Voice icon */
  #voice-btn svg {
    fill: #d0d6ff;
    filter: drop-shadow(0 0 2px #6a6fffcc);
    width: 24px;
    height: 24px;
  }

  /* Loading spinner */
  #loading-indicator {
    width: 28px;
    height: 28px;
    border: 3.5px solid #5555ff44;
    border-top: 3.5px solid #a0aaffcc;
    border-radius: 50%;
    animation: spin 1.2s linear infinite;
    margin-left: 16px;
    display: none;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Typing effect */
  .typing-bubble {
    font-style: italic;
    background: #555effaa;
    box-shadow: 0 0 12px #5353ffbb;
    user-select: none;
  }

  /* Responsive */
  @media (max-width: 600px) {
    #app {
      width: 100vw;
      height: 100vh;
      border-radius: 0;
    }
    #input-text {
      font-size: 1rem;
      min-height: 36px;
    }
    button {
      padding: 10px 14px;
      font-size: 1rem;
      margin-left: 8px;
    }
  }
</style>
</head>
<body>

<div id="app" role="main" aria-label="Interface de chat Noûra 2182 IA Galactique">
  <header>Noûra 2182 — IA Galactique</header>

  <section id="chat" aria-live="polite" aria-atomic="false" role="log"></section>

  <form id="input-area" aria-label="Envoyer un message à Noûra" autocomplete="off">
    <textarea id="input-text" rows="1" placeholder="Parle à Noûra..." aria-label="Message utilisateur"></textarea>
    <button id="send-btn" type="submit" aria-label="Envoyer message">Envoyer</button>
    <button id="voice-btn" type="button" aria-label="Démarrer la reconnaissance vocale">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path d="M12 14a2 2 0 0 0 2-2V6a2 2 0 0 0-4 0v6a2 2 0 0 0 2 2zm4-2a4 4 0 0 1-8 0H6a6 6 0 0 0 12 0h-2zm-4 6v4m-4 0h8" stroke="#d0d6ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
      </svg>
    </button>
    <div id="loading-indicator" role="status" aria-live="assertive" aria-label="Chargement"></div>
  </form>
</div>

<script>
  // Clé API OpenRouter fournie (attention : exposée ici)
  const OPENROUTER_API_KEY = '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';

  const chat = document.getElementById('chat');
  const inputText = document.getElementById('input-text');
  const sendBtn = document.getElementById('send-btn');
  const voiceBtn = document.getElementById('voice-btn');
  const loadingIndicator = document.getElementById('loading-indicator');

  let history = JSON.parse(localStorage.getItem('noura2182_history') || '[]');
  let isProcessing = false;

  // Fonction pour afficher un message dans la discussion
  function addMessage(text, sender) {
    const msg = document.createElement('div');
    msg.className = 'message ' + sender;
    msg.textContent = text;
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
    return msg;
  }

  // Typing effect (écriture progressive)
  async function typeMessage(element, text, delay = 20) {
    element.textContent = '';
    for (const char of text) {
      element.textContent += char;
      await new Promise(r => setTimeout(r, delay));
    }
  }

  // Charger l'historique sauvegardé
  function loadHistory() {
    for (const msg of history) {
      addMessage(msg.content, msg.role === 'user' ? 'user' : 'bot');
    }
  }

  // Sauvegarder l'historique
  function saveHistory() {
    localStorage.setItem('noura2182_history', JSON.stringify(history));
  }

  // Synthèse vocale avancée
  function speak(text) {
    if (!window.speechSynthesis) return;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'fr-FR';
    utterance.pitch = 1 + Math.random() * 0.3;
    utterance.rate = 0.9 + Math.random() * 0.2;
    speechSynthesis.cancel();
    speechSynthesis.speak(utterance);
  }

  // Appel API OpenRouter
  async function callOpenRouterAPI(prompt) {
    const payload = {
      model: 'openai/gpt-4o',
      messages: [{ role: 'user', content: prompt }],
    };

    try {
      const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${OPENROUTER_API_KEY}`
        },
        body: JSON.stringify(payload),
      });
      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.message || 'Erreur API inconnue');
      }
      const data = await response.json();
      return data.choices[0].message.content.trim();
    } catch (e) {
      console.error('API error:', e);
      return "Désolé, Noûra est momentanément indisponible.";
    }
  }

  // Envoi du message utilisateur, réception et affichage de la réponse IA
  async function sendMessage() {
    if (isProcessing) return;
    const prompt = inputText.value.trim();
    if (!prompt) return;
    isProcessing = true;
    loadingIndicator.style.display = 'inline-block';

    // Afficher message utilisateur
    addMessage(prompt, 'user');
    history.push({ role: 'user', content: prompt });
    saveHistory();

    inputText.value = '';
    inputText.disabled = true;
    sendBtn.disabled = true;
    voiceBtn.disabled = true;

    // Appeler API
    const botMsgElement = addMessage('', 'bot');
    // Animation typing
    const responseText = await callOpenRouterAPI(prompt);

    await typeMessage(botMsgElement, responseText);
    speak(responseText);

    history.push({ role: 'assistant', content: responseText });
    saveHistory();

    inputText.disabled = false;
    sendBtn.disabled = false;
    voiceBtn.disabled = false;
    inputText.focus();

    loadingIndicator.style.display = 'none';
    isProcessing = false;
  }

  // Reconnaissance vocale
  let recognition;
  let recognizing = false;
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'fr-FR';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      recognizing = true;
      voiceBtn.style.background = '#7a7affee';
    };
    recognition.onend = () => {
      recognizing = false;
      voiceBtn.style.background = '';
    };
    recognition.onerror = (event) => {
      console.warn('Reconnaissance vocale erreur:', event.error);
      recognizing = false;
      voiceBtn.style.background = '';
    };
    recognition.onresult = (event) => {
      const speechResult = event.results[0][0].transcript;
      inputText.value = speechResult;
      sendMessage();
    };
  } else {
    voiceBtn.style.display = 'none';
  }

  voiceBtn.addEventListener('click', () => {
    if (recognition) {
      if (recognizing) {
        recognition.stop();
      } else {
        recognition.start();
      }
    }
  });

  sendBtn.addEventListener('click', e => {
    e.preventDefault();
    sendMessage();
  });

  inputText.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  loadHistory();
  inputText.focus();
</script>

</body>
</html>