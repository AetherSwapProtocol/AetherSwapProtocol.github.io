<!DOCTYPE html>
<html>
<head>
    <title>DiumSwap</title>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 20px; background: #0f0f1a; color: white; }
        .container { max-width: 800px; margin: 0 auto; }
        .swap-box { background: #1e1e2e; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        button { background: #22c55e; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        select, input { width: 100%; padding: 10px; margin: 10px 0; background: #2d2d3d; color: white; border: none; border-radius: 5px; }
        #chart { background: #1e1e2e; border-radius: 12px; padding: 15px; margin-top: 20px; }
        #log { margin-top: 20px; color: #aaa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>DiumSwap</h1>
        
        <!-- Connexion Wallet -->
        <button id="connectWallet">Connect Phantom Wallet</button>
        <div id="walletAddress"></div>

        <!-- Swap Box -->
        <div class="swap-box">
            <h2>Swap</h2>
            <input type="number" id="swapAmount" placeholder="0.0" value="0.1" step="0.01">
            <select id="tokenIn">
                <option value="SOL">SOL</option>
                <option value="USDC">USDC</option>
            </select>
            <span>â†’</span>
            <select id="tokenOut">
                <option value="USDC">USDC</option>
                <option value="SOL">SOL</option>
            </select>
            <button id="executeSwap">Swap</button>
        </div>

        <!-- Chart -->
        <div id="chart">
            <canvas id="priceChart"></canvas>
        </div>

        <!-- Transactions Log -->
        <div id="log"></div>
    </div>

    <script>
        // Config
        const RAYDIUM_API_URL = "https://api.raydium.io/v2/main/route";
        const SOLANA_CONNECTION = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com");
        let wallet;
        let publicKey;

        // UI Elements
        const connectBtn = document.getElementById("connectWallet");
        const swapBtn = document.getElementById("executeSwap");
        const walletDisplay = document.getElementById("walletAddress");
        const logDiv = document.getElementById("log");

        // Connexion Wallet
        connectBtn.addEventListener("click", async () => {
            if (!window.solana) {
                logError("Phantom Wallet not installed!");
                return;
            }
            try {
                wallet = window.solana;
                await wallet.connect();
                publicKey = wallet.publicKey.toString();
                walletDisplay.textContent = `Connected: ${publicKey.slice(0, 6)}...${publicKey.slice(-4)}`;
                logSuccess("Wallet connected!");
                loadPriceChart();
            } catch (err) {
                logError("Wallet connection failed: " + err.message);
            }
        });

        // Swap via Raydium
        swapBtn.addEventListener("click", async () => {
            if (!wallet?.isConnected) {
                logError("Connect your wallet first!");
                return;
            }

            const amount = document.getElementById("swapAmount").value;
            const tokenIn = document.getElementById("tokenIn").value;
            const tokenOut = document.getElementById("tokenOut").value;

            try {
                const quote = await fetchRaydiumQuote(tokenIn, tokenOut, amount);
                const tx = await buildRaydiumTransaction(quote);
                const txid = await sendTransaction(tx);

                logSuccess(`Swap executed! TX: <a href="https://solscan.io/tx/${txid}" target="_blank">${txid}</a>`);
            } catch (err) {
                logError(`Swap failed: ${err.message}`);
            }
        });

        // Raydium API Functions
        async function fetchRaydiumQuote(tokenIn, tokenOut, amount) {
            const response = await fetch(RAYDIUM_API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    inputMint: tokenIn === "SOL" ? "So11111111111111111111111111111111111111112" : "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
                    outputMint: tokenOut === "SOL" ? "So11111111111111111111111111111111111111112" : "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
                    amount: Math.floor(amount * (tokenIn === "SOL" ? 1e9 : 1e6)),
                    slippage: 1
                })
            });
            return await response.json();
        }

        async function buildRaydiumTransaction(quote) {
            const instructions = quote.transaction.instructions.map(instr => solanaWeb3.TransactionInstruction.from(instr));
            const tx = new solanaWeb3.Transaction().add(...instructions);
            tx.feePayer = publicKey;
            tx.recentBlockhash = (await SOLANA_CONNECTION.getRecentBlockhash()).blockhash;
            return tx;
        }

        async function sendTransaction(tx) {
            const signedTx = await wallet.signTransaction(tx);
            const txid = await SOLANA_CONNECTION.sendRawTransaction(signedTx.serialize());
            return txid;
        }

        // Chart Loading
        function loadPriceChart() {
            const ctx = document.getElementById("priceChart").getContext("2d");
            new Chart(ctx, {
                type: "line",
                data: {
                    labels: ["1h", "6h", "12h", "24h"],
                    datasets: [{
                        label: "SOL/USDC",
                        data: [95, 97, 96.5, 98],
                        borderColor: "#22c55e",
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Logging
        function logError(msg) {
            logDiv.innerHTML += `<p style="color: #ff6b6b">[ERROR] ${msg}</p>`;
        }

        function logSuccess(msg) {
            logDiv.innerHTML += `<p style="color: #6bff6b">[SUCCESS] ${msg}</p>`;
        }
    </script>
</body>
</html>