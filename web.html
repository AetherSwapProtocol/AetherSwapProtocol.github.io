<!DOCTYPE html>
<html>
<head>
    <title>REAL Solana Swap</title>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
        button { background: #9945FF; color: white; border: none; padding: 10px 20px; cursor: pointer; }
        #log { margin-top: 20px; text-align: left; max-width: 600px; margin: 20px auto; }
    </style>
</head>
<body>
    <h1>REAL Solana Swap</h1>
    <button id="connect">Connect Phantom Wallet</button>
    <button id="swap">Swap 0.1 SOL to USDC</button>
    <div id="log"></div>

    <script>
        const log = (msg) => { document.getElementById('log').innerHTML += `<p>${msg}</p>`; };
        const connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com");
        let wallet;

        // 1. Connexion au wallet
        document.getElementById("connect").addEventListener("click", async () => {
            if (!window.solana) return log("Install Phantom Wallet first!");
            try {
                wallet = window.solana;
                await wallet.connect();
                log(`Connected: ${wallet.publicKey.toString()}`);
            } catch (err) {
                log("Error: " + err.message);
            }
        });

        // 2. Swap SOL → USDC via Jupiter
        document.getElementById("swap").addEventListener("click", async () => {
            if (!wallet?.isConnected) return log("Connect your wallet first!");

            try {
                // Étape 1: Récupérer le meilleur prix via Jupiter API
                const quote = await fetch(
                    "https://quote-api.jup.ag/v6/quote?inputMint=So11111111111111111111111111111111111111112&outputMint=EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v&amount=100000000", // 0.1 SOL (en lamports)
                    { headers: { "Content-Type": "application/json" } }
                );
                const { swapTransaction } = await quote.json();
                log("Quote received. Sending transaction...");

                // Étape 2: Envoyer la transaction signée
                const tx = solanaWeb3.Transaction.from(Buffer.from(swapTransaction, "base64"));
                const signedTx = await wallet.signTransaction(tx);
                const txid = await connection.sendRawTransaction(signedTx.serialize());
                log(`Swap success! TX: <a href="https://solscan.io/tx/${txid}" target="_blank">${txid}</a>`);
            } catch (err) {
                log("SWAP FAILED: " + err.message);
            }
        });
    </script>
</body>
</html>