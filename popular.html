<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>AetherSwap – Popular Tokens</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: #121212;
      color: #FFF;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding-bottom: 90px;
    }
    .glass {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      transition: background 0.2s;
      position: relative;
    }
    .glass:hover {
      background: rgba(255,255,255,0.1);
    }
    .skeleton {
      height: 64px;
      border-radius: 12px;
      background: rgba(255,255,255,0.1);
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%,100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    .modal-bg {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 50;
      justify-content: center;
      align-items: center;
    }
    .modal-bg.active { display: flex; }
    .modal {
      background: #1F1F1F;
      border-radius: 16px;
      padding: 20px;
      width: 90%;
      max-width: 480px;
      max-height: 90vh;
      overflow: auto;
    }
    .network-option, .token-card { cursor: pointer; }
    .network-option img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
    }
    .network-option:hover, .network-option.selected {
      background: rgba(255,255,255,0.05);
    }
    .network-option.selected {
      background: rgba(255,255,255,0.1);
    }
    .badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #2563EB;
      padding: 4px;
      border-radius: 50%;
      color: #FFF;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
      height: 70px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(12px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .nav-item {
      flex: 1;
      text-align: center;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
    }
    .nav-item.active { color: #FFF; }
    .nav-trade {
      position: absolute;
      top: -28px;
      left: 50%;
      transform: translateX(-50%);
      background: #2563EB;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #FFF;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      z-index: 60;
    }

    .sparkline {
      width: 100px;
      height: 30px;
    }
    .star-btn {
      position: absolute;
      top: 8px;
      left: 8px;
      font-size: 18px;
      color: rgba(255, 255, 255, 0.5);
      transition: color 0.2s;
    }
    .star-btn.favored { color: #FFD700; }

    .time-tab {
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: 0.2s;
      color: #A3A3A3;
    }
    .time-tab.active {
      background: linear-gradient(135deg, #2563EB, #7C3AED);
      color: #FFF;
    }
  </style>
</head>
<body>
  <header class="text-center py-4">
    <h1 class="text-2xl font-bold text-white">Popular Tokens</h1>
  </header>
<body class="p-4">

  <button id="openChainsBtn" class="w-full p-3 bg-[#1F1F1F] rounded-lg flex justify-between items-center mb-4">
    <span id="chainsLbl">Select Networks (0)</span><span>▼</span>
  </button>
  <div id="chainsModal" class="modal-bg">
    <div class="modal">
      <div class="flex gap-2 mb-4">
        <input id="searchChain" placeholder="Search chains..." class="flex-1 p-3 bg-[#2A2A2A] rounded-lg text-white"/>
        <button id="clearChains" class="px-4 py-3 bg-red-600 rounded-lg">Clear</button>
      </div>
      <div id="chainGrid" class="grid grid-cols-4 gap-3 mb-4"></div>
      <input id="tokenInput" placeholder="Paste token address…" class="w-full mb-4 p-3 bg-[#2A2A2A] rounded-lg text-white"/>
      <button id="fetchBtn" class="w-full p-3 bg-[#2563EB] rounded-lg text-white">Load Tokens</button>
    </div>
  </div>

  <div id="tokenModal" class="modal-bg">
    <div class="modal">
      <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-3"><img id="tdLogo" class="w-8 h-8 rounded-full"/><h3 id="tdName" class="text-lg font-semibold"></h3></div>
        <button id="tdClose" class="text-white text-xl">&times;</button>
      </div>
      <div class="mb-4">
        <label class="block text-sm mb-1">Contract:</label>
        <div class="flex justify-between items-center bg-[#2A2A2A] p-3 rounded-lg">
          <span id="tdAddr" class="truncate"></span>
          <button id="tdCopy" class="ml-2 px-2 py-1 bg-[#2563EB] rounded">Copy</button>
        </div>
      </div>
      <div id="tdLinks" class="space-y-2 mb-4"></div>
      <button id="tdTrade" class="w-full p-3 bg-green-500 rounded-lg">Trade this token</button>
    </div>
  </div>

  <div class="flex gap-2 overflow-x-auto mb-4 scrollbar-hide">
    <button class="time-tab active" data-range="h1">1h</button>
    <button class="time-tab" data-range="h24">24h</button>
    <button class="time-tab" data-range="d7">7d</button>
  </div>

  <div id="tokens" class="space-y-4"></div>

  <nav class="bottom-nav">
    <a href="index.html" class="nav-item"><svg class="w-6 h-6 inline"></svg><br>Home</a>
    <a href="#" class="nav-item"><svg class="w-6 h-6 inline"></svg><br>Explore</a>
    <a href="swap.html" class="nav-item nav-trade"><svg class="w-6 h-6 inline"></svg></a>
    <a href="#" class="nav-item"><svg class="w-6 h-6 inline"></svg><br>Portfolio</a>
    <a href="#" class="nav-item"><svg class="w-6 h-6 inline"></svg><br>Profile</a>
  </nav>

  <script>
(function(){
  const chains = ["ethereum","bsc","polygon","arbitrum","avalanche","fantom","optimism","solana","tron","cronos","metis","harmony","nova","klaytn","okexchain","moonbeam","celo","aurora","base","linea","sui","aptos","zksync","starknet","moonriver","the-open-network","evmos","theta","milkomeda","palm","sepolia","rinkeby","goerli","ropsten","kovan","arbnova","bnbchain-test","optimism-kovan","moonbase","celo-alfajores","fantom-testnet","clv12","godwoken","heco","one","meter"];
  const openChainsBtn=document.getElementById("openChainsBtn"), chainsLbl=document.getElementById("chainsLbl"), chainsModal=document.getElementById("chainsModal");
  const chainGrid=document.getElementById("chainGrid"), searchChain=document.getElementById("searchChain"), clearChains=document.getElementById("clearChains");
  const tokenInput=document.getElementById("tokenInput"), fetchBtn=document.getElementById("fetchBtn"), tokensContainer=document.getElementById("tokens");
  const tokenModal=document.getElementById("tokenModal"), tdClose=document.getElementById("tdClose"), tdLogo=document.getElementById("tdLogo"), tdName=document.getElementById("tdName"), tdAddr=document.getElementById("tdAddr"), tdCopy=document.getElementById("tdCopy"), tdLinks=document.getElementById("tdLinks"), tdTrade=document.getElementById("tdTrade");
  const timeTabs=Array.from(document.querySelectorAll(".time-tab"));
  let selected=new Set(), cache={}, favorites=JSON.parse(localStorage.getItem("favorites")||"[]"), lastData=[], loading=false, range="h24";

// Build grid
chains.forEach(id => {
  const d = document.createElement("div");
  d.className = "network-option flex flex-col items-center p-2 cursor-pointer";
  const img = document.createElement("img");
  img.src = `https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/${id}/info/logo.png`;
  img.onerror = () => img.style.visibility = "hidden";
  const span = document.createElement("span");
  span.textContent = id;
  span.className = "text-xs text-center mt-1";
  d.append(img, span);
  d.dataset.chain = id;

  d.onclick = () => {
    if (selected.has(id)) {
      selected.delete(id);
      d.classList.remove("selected");
    } else {
      selected.add(id);
      d.classList.add("selected");
    }
    chainsLbl.textContent = `Select Networks (${selected.size})`;
  };
  chainGrid.appendChild(d);
});

// Gestion des clics
openChainsBtn.onclick = () => chainsModal.classList.add("active");
chainsModal.onclick = e => e.target === chainsModal && chainsModal.classList.remove("active");
clearChains.onclick = () => {
  selected.clear();
  document.querySelectorAll(".network-option.selected").forEach(e => e.classList.remove("selected"));
  chainsLbl.textContent = "Select Networks (0)";
};

// Recherche réseaux
searchChain.oninput = () => {
  const val = searchChain.value.toLowerCase();
  document.querySelectorAll(".network-option").forEach(e => {
    e.style.display = e.dataset.chain.includes(val) ? "flex" : "none";
  });
};

// Gestion du temps
timeTabs.forEach(btn => btn.onclick = () => {
  timeTabs.forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  range = btn.dataset.range;
  lastData = [];
  tokensContainer.innerHTML = "";
});

// Modal token
tdClose.onclick = () => tokenModal.classList.remove("active");
tokenModal.onclick = e => e.target === tokenModal && tokenModal.classList.remove("active");

// Boutons token
tdCopy.onclick = () => {
  navigator.clipboard.writeText(tdAddr.textContent);
  tdCopy.textContent = "Copied!";
  setTimeout(() => tdCopy.textContent = "Copy", 1500);
};
tdTrade.onclick = () => window.open(`https://app.uniswap.org/#/swap?inputCurrency=${tdAddr.textContent}`, "_blank");

// Chargement initial
fetchBtn.onclick = loadTokens;

// Scroll infini
window.addEventListener("scroll", () => {
  if (!loading && window.innerHeight + window.scrollY > document.body.offsetHeight - 200) {
    loadMore();
  }
});

// -- Fonctions critiques --
async function loadTokens() {
  const addr = tokenInput.value.trim();
  if (selected.size === 0 && !addr) {
    alert("⚠️ Select at least 1 network or paste a token address");
    return;
  }

  loading = true;
  tokensContainer.innerHTML = Array(6).fill('<div class="skeleton h-20"></div>').join('');

  try {
    const tasks = [...selected].map(chain => {
      const cacheKey = addr ? `${chain}-${addr}` : `${chain}-top-pairs`;
      if (cache[cacheKey] && cache[cacheKey].length > 0) {
        return cache[cacheKey];
      }

      const url = addr 
        ? `https://api.dexscreener.com/latest/dex/tokens/${addr}`
        : `https://api.dexscreener.com/latest/dex/pairs/${chain}`;

      return fetch(url, { timeout: 5000 })
        .then(res => {
          if (!res.ok) throw new Error(`API ${res.status}`);
          return res.json();
        })
        .then(data => {
          const pairs = addr ? data.pairs : data.pairs.slice(0, 50); // Limite pour les tops
          pairs.forEach(p => p.chain = chain); // Ajoute la chaine à chaque paire
          cache[cacheKey] = pairs;
          return pairs;
        })
        .catch(e => {
          console.error(`[API] ${chain} failed:`, e);
          return [];
        });
    });

    const results = await Promise.all(tasks);
    lastData = results.flat()
      .filter(p => p) // Retire les undefined
      .sort((a, b) => (b.volume?.h24 || 0) - (a.volume?.h24 || 0));

    tokensContainer.innerHTML = "";
    if (lastData.length === 0) {
      tokensContainer.innerHTML = `
        <div class="text-center py-10">
          <p class="text-red-500">No tokens found</p>
          ${addr ? `<p>Check if the address is correct on <a href="https://dexscreener.com/${[...selected][0]}/${addr}" target="_blank" class="text-blue-500">DexScreener</a></p>` : ""}
        </div>
      `;
    } else {
      loadMore();
    }
  } catch (e) {
    console.error("[LOAD TOKENS ERROR]", e);
    tokensContainer.innerHTML = `
      <div class="text-center py-10 text-red-500">
        Failed to load data. Check console for details.
      </div>
    `;
  } finally {
    loading = false;
  }
}

function loadMore() {
  if (loading || !lastData.length) return;
  loading = true;

  const chunk = lastData.splice(0, 10);
  chunk.forEach(pair => {
    const div = document.createElement("div");
    div.className = "token-card glass p-4 grid grid-cols-3 gap-2 items-center hover:bg-gray-100 rounded-lg";
    div.innerHTML = `
      <div class="flex items-center gap-2 col-span-2">
        <img src="${pair.baseToken.logoURI || 'https://via.placeholder.com/24'}" 
             class="w-6 h-6 rounded-full" 
             onerror="this.src='https://via.placeholder.com/24'">
        <span class="font-medium">${pair.baseToken.symbol}</span>
      </div>
      <div class="text-right">$${parseFloat(pair.priceUsd).toFixed(6)}</div>
      <div class="text-right ${pair.priceChange.h24 >= 0 ? 'text-green-500' : 'text-red-500'}">
        ${pair.priceChange.h24?.toFixed(2) || '0.00'}%
      </div>
      <div class="col-span-3 flex justify-between items-center">
        <small class="text-gray-500">${pair.chain}</small>
        <button class="star-btn ${favorites.includes(pair.pairAddress) ? 'text-yellow-500' : 'text-gray-400'}">★</button>
      </div>
    `;

    div.onclick = () => showTokenDetails(pair);
    div.querySelector(".star-btn").onclick = (e) => {
      e.stopPropagation();
      toggleFavorite(pair.pairAddress, e.target);
    };

    tokensContainer.appendChild(div);
  });

  loading = false;
}

// ... (keep your existing showTokenDetails, toggleFavorite, etc.)
})();
</script>
</body>
</html>