<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AetherSwap | Professional Solana DEX</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <script src="https://unpkg.com/@solana/web3.js@1.84.0/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@phantom-labs/inject-sdk@2.3.1/dist/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #7e22ce;
            --secondary: #3b82f6;
            --dark: #0a0a0a;
            --darker: #111827;
            --darkest: #1f2937;
        }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: var(--dark);
            color: white;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        .gradient-text {
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .gradient-border {
            position: relative;
            border-radius: 1rem;
        }
        
        .gradient-border::before {
            content: "";
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: inherit;
            background: linear-gradient(45deg, var(--primary), var(--secondary), var(--primary));
            z-index: -1;
            background-size: 200% 200%;
            animation: gradient 3s ease infinite;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .swap-container {
            background-color: var(--darker);
            border-radius: 1rem;
        }
        
        .token-selector {
            background-color: var(--darkest);
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .token-selector:hover {
            background-color: #374151;
        }
        
        .swap-button {
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            transition: all 0.2s;
        }
        
        .swap-button:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .mobile-nav {
            backdrop-filter: blur(10px);
        }
        
        .nav-icon {
            transition: all 0.3s;
        }
        
        .nav-icon.active {
            color: var(--primary);
        }
        
        .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: all 0.2s;
        }
        
        .tooltip-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        .token-img {
            background-color: #1f2937;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23374151"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>');
            background-size: cover;
            background-position: center;
        }
        
        .token-img-fallback {
            background-color: #1f2937;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: bold;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <!-- Main Navigation -->
    <nav class="container mx-auto px-6 py-6 flex justify-between items-center">
        <a href="index.html" class="flex items-center space-x-2">
            <div class="w-10 h-10 rounded-full gradient-border flex items-center justify-center">
                <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center">
                    ←
                </div>
            </div>
            <span class="text-2xl font-bold gradient-text">AetherSwap</span>
        </a>
        <button id="connect-wallet" class="gradient-border px-6 py-2 rounded-full font-medium hover:opacity-90 transition">
            Connect Wallet
        </button>
    </nav>

    <!-- Main Swap Interface -->
    <main class="container mx-auto px-4 py-8 max-w-md">
        <div class="gradient-border p-1 rounded-2xl">
            <div class="swap-container rounded-2xl p-6">
                <div class="flex flex-col space-y-4">
                    <!-- From Token Section -->
                    <div class="bg-gray-800 rounded-xl p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-400">From</span>
                            <span id="from-balance" class="text-sm text-gray-400">Balance: 0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <input id="from-amount" type="number" placeholder="0.0" 
                                   class="bg-transparent text-2xl w-full outline-none">
                            <div class="flex items-center space-x-2 token-selector px-3 py-2 rounded-lg" id="from-token-selector">
                                <div class="w-6 h-6 rounded-full token-img flex items-center justify-center overflow-hidden">
                                    <img src="https://aetherswapprotocol.github.io/sol.png" alt="SOL" class="w-full h-full object-cover">
                                </div>
                                <span>SOL</span>
                                <span>▼</span>
                            </div>
                        </div>
                        <div class="flex justify-end mt-1">
                            <button id="max-from" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-0.5 rounded">
                                MAX
                            </button>
                        </div>
                    </div>
                    
                    <!-- Switch Tokens Button -->
                    <div class="flex justify-center -my-2">
                        <button id="switch-tokens" class="p-2 rounded-full bg-gray-800 hover:bg-gray-700 transition transform hover:rotate-180">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    
                    <!-- To Token Section -->
                    <div class="bg-gray-800 rounded-xl p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-400">To</span>
                            <span id="to-balance" class="text-sm text-gray-400">Balance: 0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <input id="to-amount" type="number" placeholder="0.0" 
                                   class="bg-transparent text-2xl w-full outline-none" disabled>
                            <div class="flex items-center space-x-2 token-selector px-3 py-2 rounded-lg" id="to-token-selector">
                                <div class="w-6 h-6 rounded-full token-img flex items-center justify-center overflow-hidden">
                                    <img src="https://cryptologos.cc/logos/usd-coin-usdc-logo.png" alt="USDC" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.classList.add('token-img-fallback')">
                                </div>
                                <span>USDC</span>
                                <span>▼</span>
                            </div>
                        </div>
                    </div>

                    <!-- Price Info -->
                    <div id="price-info" class="text-center text-sm text-gray-400">
                        <div class="inline-flex items-center">
                            <div class="h-3 w-3 mr-2 rounded-full bg-gray-600 animate-pulse"></div>
                            Loading price...
                        </div>
                    </div>

                    <!-- Slippage Settings -->
                    <div class="pt-2">
                        <div class="flex justify-between items-center text-xs text-gray-400 mb-1">
                            <div class="flex items-center space-x-1 tooltip-container">
                                <span>Slippage</span>
                                <i class="fas fa-info-circle text-xs"></i>
                                <span class="tooltip absolute z-10 bg-gray-900 text-white text-xs p-2 rounded w-40">
                                    Maximum price difference you're willing to accept
                                </span>
                            </div>
                            <span id="slippage-value">0.5%</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="range" id="slippage" min="0.1" max="5" step="0.1" value="0.5" class="w-full">
                            <span class="text-xs w-10 text-center bg-gray-800 py-1 rounded">0.5%</span>
                        </div>
                    </div>

                    <!-- Fees Info -->
                    <div id="swap-fees" class="text-center text-xs text-gray-400">
                        <div class="inline-flex items-center">
                            <div class="h-2 w-2 mr-2 rounded-full bg-gray-600 animate-pulse"></div>
                            Loading fees...
                        </div>
                    </div>
                    
                    <!-- Swap Button -->
                    <div class="pt-2">
                        <button id="swap-button" class="swap-button rounded-lg py-3 font-semibold w-full flex items-center justify-center" disabled>
                            <span id="swap-button-text">Swap</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Token Selector Modal -->
    <div id="token-selector-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-xl max-w-md w-full max-h-[80vh] overflow-hidden gradient-border">
            <div class="bg-gray-900 rounded-xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Select Token</h3>
                    <button id="close-token-selector" class="text-2xl hover:text-purple-400">&times;</button>
                </div>
                
                <!-- Token Search -->
                <div class="relative mb-4">
                    <div class="flex items-center px-4 py-2 bg-gray-800 rounded-lg">
                        <i class="fas fa-search text-gray-400 mr-2"></i>
                        <input type="text" id="token-search-input" placeholder="Search token..." 
                               class="w-full bg-transparent outline-none text-sm">
                    </div>
                </div>
                
                <!-- Popular Tokens -->
                <div class="mb-4">
                    <h4 class="text-sm font-medium mb-2">Popular Tokens</h4>
                    <div class="flex flex-wrap gap-2" id="popular-tokens">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                
                <!-- Token List -->
                <div class="border-t border-gray-800 pt-4">
                    <div class="flex justify-between text-xs text-gray-400 mb-2">
                        <span>Token</span>
                        <span>Balance</span>
                    </div>
                    
                    <div id="token-list" class="overflow-y-auto max-h-[40vh] pr-2">
                        <!-- Tokens will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Swap Confirmation Modal -->
    <div id="confirm-swap-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-xl max-w-md w-full gradient-border">
            <div class="bg-gray-900 rounded-xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Confirm Swap</h3>
                    <button id="close-confirm-modal" class="text-2xl hover:text-purple-400">&times;</button>
                </div>
                
                <div class="bg-gray-800 rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 rounded-full token-img flex items-center justify-center overflow-hidden">
                                <img id="confirm-from-token-img" src="" class="w-full h-full object-cover" loading="lazy">
                            </div>
                            <span id="confirm-from-amount" class="font-medium">0</span>
                            <span id="confirm-from-token" class="text-gray-400"></span>
                        </div>
                        <span>→</span>
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 rounded-full token-img flex items-center justify-center overflow-hidden">
                                <img id="confirm-to-token-img" src="" class="w-full h-full object-cover" loading="lazy">
                            </div>
                            <span id="confirm-to-amount" class="font-medium">0</span>
                            <span id="confirm-to-token" class="text-gray-400"></span>
                        </div>
                    </div>
                    
                    <div class="space-y-2 text-sm text-gray-400 pt-2 border-t border-gray-700">
                        <div class="flex justify-between">
                            <span>Exchange Rate</span>
                            <span id="confirm-exchange-rate">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Price Impact</span>
                            <span id="confirm-price-impact" class="text-green-400">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Network Fees</span>
                            <span id="confirm-network-fees">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Minimum Received</span>
                            <span id="confirm-min-received">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button id="cancel-swap" class="flex-1 py-3 rounded-lg border border-gray-600 hover:bg-gray-800 transition">
                        Cancel
                    </button>
                    <button id="confirm-swap" class="flex-1 py-3 rounded-lg swap-button font-semibold flex items-center justify-center">
                        <span>Confirm Swap</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Status Modal -->
    <div id="tx-status-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-xl max-w-md w-full gradient-border">
            <div class="bg-gray-900 rounded-xl p-6 text-center">
                <div id="tx-success" class="hidden">
                    <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Swap Successful!</h3>
                    <p class="text-gray-400 mb-6">Your transaction has been confirmed on the Solana blockchain.</p>
                    <a id="view-explorer" href="#" target="_blank" class="swap-button rounded-lg py-3 font-semibold w-full block">
                        View on Explorer
                    </a>
                </div>
                
                <div id="tx-loading" class="hidden">
                    <div class="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                    <h3 class="text-xl font-bold mb-2">Processing Swap</h3>
                    <p class="text-gray-400 mb-6">Waiting for transaction confirmation...</p>
                    <div class="text-xs text-gray-500" id="tx-status-message">
                        Sending transaction to network
                    </div>
                </div>
                
                <div id="tx-error" class="hidden">
                    <div class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-times text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Swap Failed</h3>
                    <p class="text-gray-400 mb-4" id="tx-error-message"></p>
                    <button id="tx-error-close" class="swap-button rounded-lg py-3 font-semibold w-full">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-navbar" class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-900/75 backdrop-blur-md border-t border-gray-800 z-50 shadow-lg">
        <div class="flex items-center justify-around py-3 px-4">
            <!-- Swap Button -->
            <a href="swap.html" class="nav-link flex flex-col items-center text-xs px-4 py-1 rounded-lg transition">
                <div class="w-10 h-10 mb-1 flex items-center justify-center rounded-full bg-gray-800 hover:bg-purple-700 transition">
                    <i class="fas fa-exchange-alt text-lg nav-icon"></i>
                </div>
                <span>Swap</span>
            </a>
            
            <!-- Menu Button -->
            <button id="menu-btn" class="flex flex-col items-center text-xs px-4 py-1 rounded-lg transition">
                <div class="w-12 h-12 mb-1 -mt-4 flex items-center justify-center rounded-full bg-gradient-to-r from-purple-600 to-blue-500 shadow-lg transition">
                    <i class="fas fa-bars text-xl"></i>
                </div>
                <span>Menu</span>
            </button>
            
            <!-- LaunchLab Button -->
            <a href="launchlab.html" class="nav-link flex flex-col items-center text-xs px-4 py-1 rounded-lg transition">
                <div class="w-10 h-10 mb-1 flex items-center justify-center rounded-full bg-gray-800 hover:bg-purple-700 transition">
                    <i class="fas fa-rocket text-lg nav-icon"></i>
                </div>
                <span>LaunchLab</span>
            </a>
        </div>
    </div>

    <!-- Menu Popup -->
    <div id="menu-popup" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden z-60 flex flex-col items-center justify-center p-6">
        <div class="bg-gray-900 rounded-lg shadow-lg w-full max-w-sm p-6 space-y-6 text-center">
            <h2 class="gradient-text text-xl font-semibold mb-4">Main Menu</h2>
            <a href="index.html" class="block py-3 px-6 rounded-md bg-gradient-to-r from-purple-600 to-blue-500 text-white font-semibold transition">Back to Home</a>
            <button id="close-menu" class="mt-6 px-5 py-2 rounded-md border border-purple-400 text-purple-400 hover:bg-purple-400 hover:text-gray-900 transition">Close</button>
        </div>
    </div>

    <script>
        // Configuration Constants
        const TOKENS = {
            SOL: {
                name: "SOL",
                symbol: "SOL",
                mint: "So11111111111111111111111111111111111111112",
                decimals: 9,
                logo: "https://cryptologos.cc/logos/solana-sol-logo.png",
                verified: true
            },
            USDC: {
                name: "USD Coin",
                symbol: "USDC",
                mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
                decimals: 6,
                logo: "https://cryptologos.cc/logos/usd-coin-usdc-logo.png",
                verified: true
            },
            USDT: {
                name: "Tether",
                symbol: "USDT",
                mint: "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB",
                decimals: 6,
                logo: "https://cryptologos.cc/logos/tether-usdt-logo.png",
                verified: true
            },
            BONK: {
                name: "Bonk",
                symbol: "BONK",
                mint: "DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263",
                decimals: 5,
                logo: "https://arweave.net/hQiPZOsRZXGXBJd_82PhVdlM_hACsT_q6wqwf5cSY7I",
                verified: true
            }
        };

        // Popular tokens to show first
        const POPULAR_TOKENS = ['SOL', 'USDC', 'USDT', 'BONK', 'RAY', 'ORCA', 'JUP', 'PYTH'];

        // Application State
        const state = {
            fromToken: TOKENS.SOL,
            toToken: TOKENS.USDC,
            fromAmount: 0,
            toAmount: 0,
            walletConnected: false,
            walletPublicKey: null,
            currentPrice: 0,
            loading: false,
            slippage: 0.5,
            currentSelectorTarget: null,
            tokenList: [],
            tokenImages: {}
        };

        // Price Cache
        const PRICE_CACHE = {};
        const CACHE_DURATION = 30000; // 30 seconds

        // Initialize Solana Connection
        const connection = new solanaWeb3.Connection(
            solanaWeb3.clusterApiUrl('mainnet-beta'), 
            'confirmed'
        );

        // DOM Elements
        const elements = {
            connectWalletBtn: document.getElementById('connect-wallet'),
            fromAmountInput: document.getElementById('from-amount'),
            toAmountInput: document.getElementById('to-amount'),
            fromBalance: document.getElementById('from-balance'),
            toBalance: document.getElementById('to-balance'),
            fromTokenSelector: document.getElementById('from-token-selector'),
            toTokenSelector: document.getElementById('to-token-selector'),
            switchTokensBtn: document.getElementById('switch-tokens'),
            swapButton: document.getElementById('swap-button'),
            priceInfo: document.getElementById('price-info'),
            slippageInput: document.getElementById('slippage'),
            slippageValue: document.getElementById('slippage-value'),
            swapFees: document.getElementById('swap-fees'),
            tokenSelectorModal: document.getElementById('token-selector-modal'),
            closeTokenSelector: document.getElementById('close-token-selector'),
            tokenSearchInput: document.getElementById('token-search-input'),
            tokenList: document.getElementById('token-list'),
            popularTokens: document.getElementById('popular-tokens'),
            maxFromBtn: document.getElementById('max-from'),
            confirmSwapModal: document.getElementById('confirm-swap-modal'),
            closeConfirmModal: document.getElementById('close-confirm-modal'),
            confirmFromTokenImg: document.getElementById('confirm-from-token-img'),
            confirmFromAmount: document.getElementById('confirm-from-amount'),
            confirmFromToken: document.getElementById('confirm-from-token'),
            confirmToTokenImg: document.getElementById('confirm-to-token-img'),
            confirmToAmount: document.getElementById('confirm-to-amount'),
            confirmToToken: document.getElementById('confirm-to-token'),
            confirmExchangeRate: document.getElementById('confirm-exchange-rate'),
            confirmPriceImpact: document.getElementById('confirm-price-impact'),
            confirmNetworkFees: document.getElementById('confirm-network-fees'),
            confirmMinReceived: document.getElementById('confirm-min-received'),
            cancelSwap: document.getElementById('cancel-swap'),
            confirmSwap: document.getElementById('confirm-swap'),
            txStatusModal: document.getElementById('tx-status-modal'),
            txSuccess: document.getElementById('tx-success'),
            txLoading: document.getElementById('tx-loading'),
            txError: document.getElementById('tx-error'),
            txErrorMessage: document.getElementById('tx-error-message'),
            txErrorClose: document.getElementById('tx-error-close'),
            txStatusMessage: document.getElementById('tx-status-message'),
            viewExplorer: document.getElementById('view-explorer'),
            mobileNavbar: document.getElementById('mobile-navbar'),
            menuBtn: document.getElementById('menu-btn'),
            menuPopup: document.getElementById('menu-popup'),
            closeMenuBtn: document.getElementById('close-menu')
        };

        // Initialize Application
        function init() {
            setupEventListeners();
            updateTokenSelectors();
            fetchTokenList();
            fetchPrice();
            updateSlippage();
            highlightActiveNavLink();
            preloadTokenImages();
        }

        // Preload token images for better UX
        function preloadTokenImages() {
            Object.values(TOKENS).forEach(token => {
                if (token.logo) {
                    const img = new Image();
                    img.src = token.logo;
                    state.tokenImages[token.symbol] = img;
                }
            });
        }

        // Set Up Event Listeners
        function setupEventListeners() {
            elements.connectWalletBtn.addEventListener('click', connectWallet);
            elements.fromAmountInput.addEventListener('input', () => debounce(updateToAmount, 500));
            elements.switchTokensBtn.addEventListener('click', switchTokens);
            elements.swapButton.addEventListener('click', showConfirmModal);
            elements.slippageInput.addEventListener('input', updateSlippage);
            elements.fromTokenSelector.addEventListener('click', () => openTokenSelector('from'));
            elements.toTokenSelector.addEventListener('click', () => openTokenSelector('to'));
            elements.closeTokenSelector.addEventListener('click', closeModal);
            elements.tokenSearchInput.addEventListener('input', searchTokens);
            elements.maxFromBtn.addEventListener('click', setMaxAmount);
            
            // Confirm modal events
            elements.closeConfirmModal.addEventListener('click', closeConfirmModal);
            elements.cancelSwap.addEventListener('click', closeConfirmModal);
            elements.confirmSwap.addEventListener('click', executeSwap);
            
            // Transaction status events
            elements.txErrorClose.addEventListener('click', () => {
                elements.txStatusModal.classList.add('hidden');
            });
            
            // Mobile menu events
            elements.menuBtn.addEventListener('click', openMenu);
            elements.closeMenuBtn.addEventListener('click', closeMenu);
            elements.menuPopup.addEventListener('click', (e) => {
                if (e.target === elements.menuPopup) closeMenu();
            });
        }

        // Highlight Active Navigation Link
        function highlightActiveNavLink() {
            const currentPage = window.location.pathname.split('/').pop();
            document.querySelectorAll('.nav-link').forEach(link => {
                const href = link.getAttribute('href');
                if (href === currentPage) {
                    link.classList.add('text-purple-400');
                    link.querySelector('.nav-icon').classList.add('text-purple-400');
                }
            });
        }

        // Debounce Function
        let debounceTimer;
        function debounce(func, delay) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(func, delay);
        }

        // Connect Wallet
        async function connectWallet() {
            try {
                if (window.phantom?.solana?.isPhantom) {
                    setLoading(true, elements.connectWalletBtn);
                    
                    const provider = window.phantom.solana;
                    const response = await provider.connect();
                    state.walletPublicKey = response.publicKey.toString();
                    state.walletConnected = true;
                    
                    elements.connectWalletBtn.textContent = 
                        `${state.walletPublicKey.slice(0, 4)}...${state.walletPublicKey.slice(-4)}`;
                    
                    await loadBalances();
                    updateSwapButton();
                    
                    setLoading(false, elements.connectWalletBtn);
                } else {
                    window.open('https://phantom.app/', '_blank');
                    throw new Error('Phantom Wallet not installed');
                }
            } catch (error) {
                console.error('Connection error:', error);
                setLoading(false, elements.connectWalletBtn);
                elements.connectWalletBtn.textContent = 'Connect Wallet';
                showError(`Error: ${error.message}`, true);
            }
        }

        // Fetch token list from CoinGecko
        async function fetchTokenList() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&category=solana-ecosystem&order=market_cap_desc');
                const data = await response.json();
                
                // Process token data
                state.tokenList = data.map(token => ({
                    id: token.id,
                    symbol: token.symbol.toUpperCase(),
                    name: token.name,
                    logo: token.image,
                    marketCap: token.market_cap,
                    currentPrice: token.current_price
                }));
                
                // Sort by market cap
                state.tokenList.sort((a, b) => b.marketCap - a.marketCap);
                
                // Populate popular tokens
                populatePopularTokens();
                
            } catch (error) {
                console.error('Error fetching token list:', error);
                // Fallback to our default tokens
                state.tokenList = Object.values(TOKENS);
            }
        }

        // Populate popular tokens section
        function populatePopularTokens() {
            elements.popularTokens.innerHTML = '';
            
            // Get top 8 tokens by market cap
            const popular = state.tokenList.slice(0, 8);
            
            popular.forEach(token => {
                const button = document.createElement('button');
                button.className = 'px-3 py-1 bg-gray-800 rounded-lg hover:bg-gray-700 transition flex items-center';
                button.innerHTML = `
                    <div class="w-4 h-4 mr-1 rounded-full overflow-hidden">
                        <img src="${token.logo}" alt="${token.symbol}" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.classList.add('token-img-fallback')">
                    </div>
                    <span>${token.symbol}</span>
                `;
                button.addEventListener('click', () => selectToken(token.symbol));
                elements.popularTokens.appendChild(button);
            });
        }

        // Load Token Balances
        async function loadBalances() {
            if (!state.walletConnected) return;
            
            try {
                setLoading(true);
                
                // Load SOL balance
                if (state.fromToken.symbol === 'SOL' || state.toToken.symbol === 'SOL') {
                    const solBalance = await connection.getBalance(
                        new solanaWeb3.PublicKey(state.walletPublicKey)
                    );
                    const solBalanceElement = state.fromToken.symbol === 'SOL' ? elements.fromBalance : elements.toBalance;
                    solBalanceElement.textContent = `Balance: ${(solBalance / solanaWeb3.LAMPORTS_PER_SOL).toFixed(2)}`;
                }
                
                // Load token balances
                for (const token of [state.fromToken, state.toToken]) {
                    if (token.symbol === 'SOL') continue;
                    
                    const balanceElement = token === state.fromToken ? elements.fromBalance : elements.toBalance;
                    const accounts = await connection.getTokenAccountsByOwner(
                        new solanaWeb3.PublicKey(state.walletPublicKey),
                        { mint: new solanaWeb3.PublicKey(token.mint) }
                    );
                    
                    if (accounts.value.length > 0) {
                        const balance = await connection.getTokenAccountBalance(accounts.value[0].pubkey);
                        balanceElement.textContent = `Balance: ${(balance.value.uiAmount || 0).toFixed(token.decimals > 5 ? 0 : 2)}`;
                    } else {
                        balanceElement.textContent = `Balance: 0`;
                    }
                }
                
                setLoading(false);
            } catch (error) {
                console.error('Balance load error:', error);
                setLoading(false);
                showError('Failed to load balances', false);
            }
        }

        // Set max amount from balance
        function setMaxAmount() {
            if (!state.walletConnected) {
                showError('Connect your wallet first', false);
                return;
            }
            
            const balanceText = elements.fromBalance.textContent;
            const balance = parseFloat(balanceText.replace('Balance: ', ''));
            
            if (isNaN(balance) || balance <= 0) {
                showError('No balance available', false);
                return;
            }
            
            // Leave a little for fees if it's SOL
            let maxAmount = balance;
            if (state.fromToken.symbol === 'SOL') {
                maxAmount = Math.max(0, balance - 0.05); // Leave 0.05 SOL for fees
            }
            
            elements.fromAmountInput.value = maxAmount.toFixed(state.fromToken.decimals);
            state.fromAmount = maxAmount;
            updateToAmount();
        }

        // Validate Swap Amounts
        function validateAmounts() {
            if (state.fromAmount <= 0) {
                showError("Amount must be greater than 0", false);
                return false;
            }
            if (state.fromToken.symbol === state.toToken.symbol) {
                showError("Cannot swap identical tokens", false);
                return false;
            }
            return true;
        }

        // Update Output Amount
        async function updateToAmount() {
            state.fromAmount = parseFloat(elements.fromAmountInput.value) || 0;
            
            if (state.fromAmount > 0) {
                try {
                    setLoading(true, elements.toAmountInput);
                    
                    if (state.currentPrice === 0) {
                        await fetchPrice();
                    }
                    
                    state.toAmount = state.fromAmount * state.currentPrice;
                    elements.toAmountInput.value = state.toAmount.toFixed(state.toToken.decimals);
                    updatePriceInfo();
                    await estimateFees();
                    
                    setLoading(false, elements.toAmountInput);
                } catch (error) {
                    console.error('Price fetch error:', error);
                    setLoading(false, elements.toAmountInput);
                    showError('Failed to calculate amount', false);
                }
            } else {
                elements.toAmountInput.value = '';
                state.toAmount = 0;
                updatePriceInfo();
                elements.swapFees.textContent = 'Fees: -';
            }
            
            updateSwapButton();
        }

        // Fetch Token Price
        async function fetchPrice() {
            const cacheKey = `${state.fromToken.mint}_${state.toToken.mint}`;
            
            if (PRICE_CACHE[cacheKey] && 
                Date.now() - PRICE_CACHE[cacheKey].timestamp < CACHE_DURATION) {
                state.currentPrice = PRICE_CACHE[cacheKey].price;
                updatePriceInfo();
                return;
            }

            try {
                setLoading(true, elements.priceInfo);
                
                const response = await fetch(
                    `https://price.jup.ag/v4/price?ids=${state.fromToken.mint}&vsToken=${state.toToken.mint}`
                );
                const data = await response.json();
                
                if (!data.data || !data.data[state.fromToken.mint]) {
                    throw new Error('Price data not available');
                }
                
                PRICE_CACHE[cacheKey] = {
                    price: data.data[state.fromToken.mint].price,
                    timestamp: Date.now()
                };
                
                state.currentPrice = data.data[state.fromToken.mint].price;
                updatePriceInfo();
                setLoading(false, elements.priceInfo);
            } catch (error) {
                console.error('Price fetch error:', error);
                setLoading(false, elements.priceInfo);
                elements.priceInfo.textContent = 'Price unavailable';
                throw error;
            }
        }

        // Estimate Swap Fees
        async function estimateFees() {
            if (!state.fromAmount || state.fromAmount <= 0) return;
            
            try {
                const amountInLamports = state.fromAmount * Math.pow(10, state.fromToken.decimals);
                const quoteResponse = await fetch(
                    `https://quote-api.jup.ag/v4/quote?inputMint=${state.fromToken.mint}&outputMint=${state.toToken.mint}&amount=${amountInLamports}&slippage=${state.slippage}`
                );
                const quoteData = await quoteResponse.json();
                
                if (quoteData.data && quoteData.data.length > 0) {
                    const fees = quoteData.data[0].feeAmount / Math.pow(10, state.toToken.decimals);
                    elements.swapFees.textContent = `Fees: ~${fees.toFixed(6)} ${state.toToken.symbol}`;
                }
            } catch (error) {
                console.error('Fee estimation error:', error);
                elements.swapFees.textContent = 'Fees: -';
            }
        }

        // Update Price Display
        function updatePriceInfo() {
            if (state.fromAmount > 0 && state.currentPrice > 0) {
                elements.priceInfo.innerHTML = 
                    `1 ${state.fromToken.symbol} = ${state.currentPrice.toFixed(6)} ${state.toToken.symbol}`;
            } else if (state.currentPrice > 0) {
                elements.priceInfo.innerHTML = 
                    `1 ${state.fromToken.symbol} = ${state.currentPrice.toFixed(6)} ${state.toToken.symbol}`;
            }
        }

        // Switch Tokens
        function switchTokens() {
            [state.fromToken, state.toToken] = [state.toToken, state.fromToken];
            updateTokenSelectors();
            elements.fromAmountInput.value = '';
            elements.toAmountInput.value = '';
            state.fromAmount = 0;
            state.toAmount = 0;
            fetchPrice();
            if (state.walletConnected) {
                loadBalances();
            }
            updateSwapButton();
        }

        // Update Token Selectors
        function updateTokenSelectors() {
            elements.fromTokenSelector.innerHTML = `
                <div class="w-6 h-6 rounded-full token-img flex items-center justify-center overflow-hidden">
                    <img src="${state.fromToken.logo}" alt="${state.fromToken.symbol}" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.classList.add('token-img-fallback')">
                </div>
                <span>${state.fromToken.symbol}</span>
                <span>▼</span>
            `;
            
            elements.toTokenSelector.innerHTML = `
                <div class="w-6 h-6 rounded-full token-img flex items-center justify-center overflow-hidden">
                    <img src="${state.toToken.logo}" alt="${state.toToken.symbol}" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.classList.add('token-img-fallback')">
                </div>
                <span>${state.toToken.symbol}</span>
                <span>▼</span>
            `;
        }

        // Update Slippage
        function updateSlippage() {
            state.slippage = parseFloat(elements.slippageInput.value);
            elements.slippageValue.textContent = `${state.slippage}%`;
            document.querySelector('.rounded.w-10').textContent = `${state.slippage}%`;
            if (state.fromAmount > 0) {
                estimateFees();
            }
        }

        // Update Swap Button State
        function updateSwapButton() {
            elements.swapButton.disabled = !(state.walletConnected && state.fromAmount > 0 && state.toAmount > 0);
        }

        // Show Confirm Swap Modal
        async function showConfirmModal() {
            if (!validateAmounts()) return;
            
            try {
                setLoading(true, elements.swapButton);
                
                // Get quote with all details
                const amountInLamports = state.fromAmount * Math.pow(10, state.fromToken.decimals);
                const quoteResponse = await fetch(
                    `https://quote-api.jup.ag/v4/quote?inputMint=${state.fromToken.mint}&outputMint=${state.toToken.mint}&amount=${amountInLamports}&slippage=${state.slippage}`
                );
                const quoteData = await quoteResponse.json();
                
                if (!quoteData.data || quoteData.data.length === 0) {
                    throw new Error('No route found for this swap');
                }
                
                const bestRoute = quoteData.data[0];
                
                // Update confirm modal with details
                elements.confirmFromTokenImg.src = state.fromToken.logo;
                elements.confirmFromAmount.textContent = state.fromAmount.toFixed(state.fromToken.decimals);
                elements.confirmFromToken.textContent = state.fromToken.symbol;
                elements.confirmToTokenImg.src = state.toToken.logo;
                elements.confirmToAmount.textContent = state.toAmount.toFixed(state.toToken.decimals);
                elements.confirmToToken.textContent = state.toToken.symbol;
                
                elements.confirmExchangeRate.textContent = `1 ${state.fromToken.symbol} = ${state.currentPrice.toFixed(6)} ${state.toToken.symbol}`;
                elements.confirmPriceImpact.textContent = '<0.01%';
                elements.confirmNetworkFees.textContent = `${(bestRoute.feeAmount / Math.pow(10, state.toToken.decimals)).toFixed(6)} ${state.toToken.symbol}`;
                
                const minReceived = state.toAmount * (1 - (state.slippage / 100));
                elements.confirmMinReceived.textContent = `${minReceived.toFixed(state.toToken.decimals)} ${state.toToken.symbol}`;
                
                // Store route for execution
                state.currentRoute = bestRoute;
                
                // Show modal
                elements.confirmSwapModal.classList.remove('hidden');
                
                setLoading(false, elements.swapButton);
            } catch (error) {
                console.error('Confirm swap error:', error);
                setLoading(false, elements.swapButton);
                showError(`Failed to prepare swap: ${error.message}`, false);
            }
        }

        // Close Confirm Modal
        function closeConfirmModal() {
            elements.confirmSwapModal.classList.add('hidden');
        }

        // Execute Swap
        async function executeSwap() {
            if (!state.currentRoute) return;
            
            try {
                // Show loading state
                closeConfirmModal();
                elements.txStatusModal.classList.remove('hidden');
                elements.txLoading.classList.remove('hidden');
                elements.txSuccess.classList.add('hidden');
                elements.txError.classList.add('hidden');
                elements.txStatusMessage.textContent = 'Preparing transaction...';
                
                // Get swap transaction
                const swapResponse = await fetch('https://quote-api.jup.ag/v4/swap', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        route: state.currentRoute,
                        userPublicKey: state.walletPublicKey,
                        wrapUnwrapSOL: true
                    })
                });
                
                const swapData = await swapResponse.json();
                
                if (!swapData.swapTransaction) {
                    throw new Error('Failed to prepare swap transaction');
                }
                
                // Execute swap
                const provider = window.phantom.solana;
                elements.txStatusMessage.textContent = 'Waiting for wallet approval...';
                
                const { signature } = await provider.signAndSendTransaction(
                    new Uint8Array(Object.values(swapData.swapTransaction))
                );
                
                elements.txStatusMessage.textContent = 'Waiting for confirmation...';
                
                // Wait for confirmation
                await connection.confirmTransaction(signature, 'confirmed');
                
                // Show success
                elements.txLoading.classList.add('hidden');
                elements.txSuccess.classList.remove('hidden');
                elements.viewExplorer.href = `https://solscan.io/tx/${signature}`;
                
                // Reset form
                elements.fromAmountInput.value = '';
                elements.toAmountInput.value = '';
                state.fromAmount = 0;
                state.toAmount = 0;
                elements.swapFees.textContent = 'Fees: -';
                
                // Update balances after confirmation
                setTimeout(async () => {
                    await loadBalances();
                }, 3000);
                
            } catch (error) {
                console.error('Swap error:', error);
                elements.txLoading.classList.add('hidden');
                elements.txError.classList.remove('hidden');
                elements.txErrorMessage.textContent = error.message;
            }
        }

        // Token Selector Modal
        function openTokenSelector(target) {
            state.currentSelectorTarget = target;
            elements.tokenSelectorModal.classList.remove('hidden');
            populateTokenList();
        }

        function closeModal() {
            elements.tokenSelectorModal.classList.add('hidden');
            elements.tokenSearchInput.value = '';
        }

        function populateTokenList() {
            elements.tokenList.innerHTML = '';
            
            // Show verified tokens first
            const verifiedTokens = state.tokenList.filter(t => t.verified || TOKENS[t.symbol]);
            const otherTokens = state.tokenList.filter(t => !verifiedTokens.includes(t));
            
            if (verifiedTokens.length > 0) {
                const verifiedHeader = document.createElement('div');
                verifiedHeader.className = 'text-xs text-gray-500 mb-2 mt-4';
                verifiedHeader.textContent = 'Verified Tokens';
                elements.tokenList.appendChild(verifiedHeader);
                
                verifiedTokens.forEach(token => {
                    addTokenToList(token);
                });
            }
            
            if (otherTokens.length > 0) {
                const otherHeader = document.createElement('div');
                otherHeader.className = 'text-xs text-gray-500 mb-2 mt-4';
                otherHeader.textContent = 'Other Tokens';
                elements.tokenList.appendChild(otherHeader);
                
                otherTokens.forEach(token => {
                    addTokenToList(token);
                });
            }
        }

        function addTokenToList(token) {
            const tokenElement = document.createElement('div');
            tokenElement.className = 'token-item hover:bg-gray-800 p-3 rounded-lg cursor-pointer flex justify-between items-center';
            
            const tokenData = TOKENS[token.symbol] || token;
            
            tokenElement.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-full token-img flex items-center justify-center overflow-hidden">
                        <img src="${tokenData.logo}" alt="${tokenData.symbol}" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.classList.add('token-img-fallback')">
                    </div>
                    <div>
                        <div class="font-medium">${tokenData.symbol}</div>
                        <div class="text-xs text-gray-400">${tokenData.name}</div>
                    </div>
                </div>
                <div class="text-gray-400 text-sm">0</div>
            `;
            
            tokenElement.addEventListener('click', () => selectToken(tokenData.symbol));
            elements.tokenList.appendChild(tokenElement);
        }

        function searchTokens() {
            const searchTerm = elements.tokenSearchInput.value.toLowerCase();
            const tokenItems = elements.tokenList.querySelectorAll('.token-item');
            
            tokenItems.forEach(item => {
                const tokenName = item.querySelector('.font-medium').textContent.toLowerCase();
                const tokenFullName = item.querySelector('.text-xs').textContent.toLowerCase();
                item.style.display = (tokenName.includes(searchTerm) || tokenFullName.includes(searchTerm)) 
                    ? 'flex' 
                    : 'none';
            });
        }

        function selectToken(tokenSymbol) {
            const token = TOKENS[tokenSymbol] || state.tokenList.find(t => t.symbol === tokenSymbol);
            
            if (!token) {
                showError('Token not supported yet', false);
                return;
            }
            
            if (state.currentSelectorTarget === 'from') {
                state.fromToken = token;
            } else {
                state.toToken = token;
            }
            
            updateTokenSelectors();
            fetchPrice();
            if (state.walletConnected) {
                loadBalances();
            }
            
            // If both tokens are set and from amount is entered, update the quote
            if (state.fromAmount > 0) {
                updateToAmount();
            }
            
            closeModal();
        }

        // Show Error Message
        function showError(message, isFatal) {
            const errorEl = document.createElement('div');
            errorEl.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl ${
                isFatal ? 'bg-red-600' : 'bg-yellow-500'
            } text-white flex items-start z-50`;
            
            errorEl.innerHTML = `
                <i class="fas fa-exclamation-circle mr-2 mt-0.5"></i>
                <div>
                    <p class="font-medium">${isFatal ? 'Error' : 'Warning'}</p>
                    <p class="text-sm">${message}</p>
                </div>
                <button class="ml-4" onclick="this.parentElement.remove()">
                    &times;
                </button>
            `;
            
            document.body.appendChild(errorEl);
            setTimeout(() => errorEl.remove(), 5000);
        }

        // Set Loading State
        function setLoading(isLoading, element = null) {
            state.loading = isLoading;
            
            if (element) {
                if (isLoading) {
                    element.disabled = true;
                    if (!element.querySelector('.loading-spinner')) {
                        const spinner = document.createElement('div');
                        spinner.className = 'loading-spinner';
                        element.insertBefore(spinner, element.firstChild);
                    }
                } else {
                    element.disabled = false;
                    const spinner = element.querySelector('.loading-spinner');
                    if (spinner) {
                        spinner.remove();
                    }
                }
            }
        }

        // Mobile Menu Functions
        function openMenu() {
            elements.menuPopup.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeMenu() {
            elements.menuPopup.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>