<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AetherSwap Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@jup-ag/core@latest/dist/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bn.js@5.2.1/lib/bn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0f0f13;
      color: #fff;
    }
    .token-item:hover {
      background-color: rgba(56, 43, 168, 0.3);
    }
    .gradient-bg {
      background: linear-gradient(135deg, #7c3aed 0%, #3b82f6 100%);
    }
  </style>
</head>
<body class="min-h-screen">

  <div class="max-w-md mx-auto p-4">
    <!-- Header -->
    <header class="flex justify-between items-center mb-8">
      <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-500 to-blue-500 bg-clip-text text-transparent">AetherSwap Pro</h1>
      <button id="connect-wallet" class="gradient-bg hover:opacity-90 px-4 py-2 rounded-lg font-medium text-white">
        Connect Wallet
      </button>
    </header>

    <!-- Swap Box -->
    <div class="bg-gray-900 rounded-xl p-5 border border-gray-800 shadow-lg">
      <!-- From Token -->
      <div class="mb-4">
        <div class="flex justify-between mb-2 text-sm text-gray-400">
          <span>From</span>
          <span>Balance: <span id="from-balance">0</span></span>
        </div>
        <div class="flex items-center bg-gray-800 rounded-lg p-3">
          <input type="number" id="from-amount" placeholder="0.0" min="0" step="any"
            class="flex-1 bg-transparent text-2xl outline-none text-white"/>
          <button id="select-from-token" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg min-w-[120px]">
            <img id="from-token-icon" class="w-6 h-6 rounded-full" />
            <span id="from-token-symbol">SOL</span>
          </button>
        </div>
      </div>

      <!-- Swap Icon -->
      <div class="flex justify-center my-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v6h6M20 20v-6h-6m0 0l7-7m-7 7l-7 7" />
        </svg>
      </div>

      <!-- To Token -->
      <div class="mb-6">
        <div class="flex justify-between mb-2 text-sm text-gray-400">
          <span>To</span>
          <span>Balance: <span id="to-balance">0</span></span>
        </div>
        <div class="flex items-center bg-gray-800 rounded-lg p-3">
          <input type="number" id="to-amount" placeholder="0.0" readonly
            class="flex-1 bg-transparent text-2xl outline-none text-white"/>
          <button id="select-to-token" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg min-w-[120px]">
            <img id="to-token-icon" class="w-6 h-6 rounded-full" />
            <span id="to-token-symbol">Select</span>
          </button>
        </div>
      </div>

      <!-- Info -->
      <div class="bg-gray-800 rounded-lg p-3 text-sm mb-4">
        <div class="flex justify-between py-1">
          <span class="text-gray-400">Rate</span>
          <span id="exchange-rate">-</span>
        </div>
        <div class="flex justify-between py-1">
          <span class="text-gray-400">Price Impact</span>
          <span id="price-impact">-</span>
        </div>
        <div class="flex justify-between py-1">
          <span class="text-gray-400">Network Fee</span>
          <span id="network-fee">-</span>
        </div>
      </div>

      <!-- Swap -->
      <button id="execute-swap" class="gradient-bg w-full py-3 rounded-xl font-medium text-white disabled:opacity-50" disabled>
        Connect Wallet
      </button>
    </div>
  </div>

  <script>
    const { Connection, PublicKey } = solanaWeb3;
    const BN = window.bn.BN;

    const state = {
      connection: new Connection("https://rpc.helius.xyz"),
      wallet: null,
      jupiter: null,
      tokens: [],
      fromToken: null,
      toToken: null,
      balances: {},
      routes: null,
      slippage: 0.5
    };

    const el = {
      connectBtn: document.getElementById('connect-wallet'),
      fromAmount: document.getElementById('from-amount'),
      toAmount: document.getElementById('to-amount'),
      fromTokenSymbol: document.getElementById('from-token-symbol'),
      toTokenSymbol: document.getElementById('to-token-symbol'),
      fromTokenIcon: document.getElementById('from-token-icon'),
      toTokenIcon: document.getElementById('to-token-icon'),
      fromBalance: document.getElementById('from-balance'),
      toBalance: document.getElementById('to-balance'),
      exchangeRate: document.getElementById('exchange-rate'),
      priceImpact: document.getElementById('price-impact'),
      networkFee: document.getElementById('network-fee'),
      selectFrom: document.getElementById('select-from-token'),
      selectTo: document.getElementById('select-to-token'),
      switchBtn: document.getElementById('switch-tokens'),
      swapBtn: document.getElementById('execute-swap'),
    };

    async function loadTokens() {
      try {
        const res = await fetch('https://token.jup.ag/strict');
        state.tokens = await res.json();
        state.tokens.unshift({
          chainId: 101,
          address: 'So11111111111111111111111111111111111111112',
          symbol: 'SOL',
          name: 'Solana',
          decimals: 9,
          logoURI: 'https://raw.githubusercontent.com/solana-labs/token-list/main/assets/mainnet/So11111111111111111111111111111111111111112/logo.png',
        });
      } catch (err) {
        console.error("Token fetch failed", err);
      }
    }

    function updateTokenDisplay() {
      el.fromTokenSymbol.textContent = state.fromToken?.symbol || 'Select';
      el.fromTokenIcon.src = state.fromToken?.logoURI || '';
      el.toTokenSymbol.textContent = state.toToken?.symbol || 'Select';
      el.toTokenIcon.src = state.toToken?.logoURI || '';
    }

    async function connectWallet() {
      if (!window.solana || !window.solana.isPhantom) {
        Toastify({ text: "Phantom not found!", backgroundColor: "#f87171" }).showToast();
        return;
      }

      const resp = await window.solana.connect();
      state.wallet = window.solana;
      el.connectBtn.textContent = `${resp.publicKey.toString().slice(0,4)}...${resp.publicKey.toString().slice(-4)}`;
      el.swapBtn.textContent = 'Swap';
      el.swapBtn.disabled = false;
      updateBalances();
    }

    async function updateBalances() {
      if (!state.wallet?.publicKey) return;
      const pubkey = state.wallet.publicKey;

      for (const token of [state.fromToken, state.toToken]) {
        if (!token) continue;
        try {
          if (token.symbol === 'SOL') {
            const bal = await state.connection.getBalance(pubkey);
            state.balances[token.address] = bal / 10 ** token.decimals;
          } else {
            const res = await state.connection.getTokenAccountsByOwner(pubkey, {
              mint: new PublicKey(token.address)
            });
            if (res.value.length > 0) {
              const data = res.value[0].account.data.slice(64, 72);
              const amount = new BN(data, 'le').toNumber();
              state.balances[token.address] = amount / 10 ** token.decimals;
            } else {
              state.balances[token.address] = 0;
            }
          }
        } catch (e) {
          console.warn('Balance error', e);
        }
      }

      el.fromBalance.textContent = (state.balances[state.fromToken?.address] || 0).toFixed(4);
      el.toBalance.textContent = (state.balances[state.toToken?.address] || 0).toFixed(4);
    }

    async function computeRoutes() {
      if (!state.fromToken || !state.toToken) return;
      const amt = parseFloat(el.fromAmount.value);
      if (isNaN(amt) || amt <= 0) return;

      const inLamports = Math.floor(amt * 10 ** state.fromToken.decimals);
      try {
        state.routes = await state.jupiter.computeRoutes({
          inputMint: new PublicKey(state.fromToken.address),
          outputMint: new PublicKey(state.toToken.address),
          amount: inLamports,
          slippageBps: state.slippage * 100,
          onlyDirectRoutes: false,
        });

        const best = state.routes.routesInfos[0];
        const outAmt = best.outAmount / 10 ** state.toToken.decimals;
        el.toAmount.value = outAmt.toFixed(6);
        el.exchangeRate.textContent = `1 ${state.fromToken.symbol} = ${(outAmt / amt).toFixed(6)} ${state.toToken.symbol}`;
        el.priceImpact.textContent = `${(best.priceImpactPct * 100).toFixed(2)}%`;
        el.networkFee.textContent = `${(best.otherAmountThreshold / 10 ** state.toToken.decimals).toFixed(4)} ${state.toToken.symbol}`;
      } catch (e) {
        console.error("Route error", e);
        el.exchangeRate.textContent = "-";
        el.toAmount.value = "";
      }
    }

    function setupEvents() {
      el.connectBtn.onclick = connectWallet;
      el.fromAmount.oninput = computeRoutes;
      el.switchBtn.onclick = () => {
        [state.fromToken, state.toToken] = [state.toToken, state.fromToken];
        updateTokenDisplay();
        updateBalances();
        computeRoutes();
      };
      el.swapBtn.onclick = async () => {
        try {
          const { execute } = await state.jupiter.exchange({
            routeInfo: state.routes.routesInfos[0],
          });
          const result = await execute();
          if (result.error) throw new Error(result.error);
          Toastify({ text: `Swap successful!`, backgroundColor: "#4ade80" }).showToast();
          updateBalances();
        } catch (e) {
          Toastify({ text: `Swap failed: ${e.message}`, backgroundColor: "#f87171" }).showToast();
        }
      };
    }

    async function init() {
      await loadTokens();
      state.fromToken = state.tokens.find(t => t.symbol === 'SOL');
      state.toToken = state.tokens.find(t => t.symbol === 'USDC');
      updateTokenDisplay();
      state.jupiter = await Jupiter.load({
        connection: state.connection,
        cluster: 'mainnet-beta',
        user: null,
        wrapUnwrapSOL: true,
      });
      setupEvents();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>