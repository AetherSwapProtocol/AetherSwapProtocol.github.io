<!-- === Bloc 1 : Structure HTML de base + Header avec logo === -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AetherSwap</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background-color: #0d0e1b; color: #fff; }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background-color: #111222;
      border-bottom: 1px solid #2e2f44;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .logo-area {
      display: flex;
      align-items: center;
    }
    .logo-area img {
      width: 32px;
      height: 32px;
      margin-right: 12px;
    }
    .logo-area span {
      font-size: 20px;
      font-weight: bold;
      background: linear-gradient(90deg, #f72585, #7209b7, #3a0ca3, #4361ee, #4cc9f0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .wallet-btn {
      background: #1b1c31;
      border: 1px solid #333556;
      padding: 8px 16px;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .wallet-btn:hover {
      background: #2b2d4d;
    }
  </style>
</head>
<body>

<header>
  <div class="logo-area">
    <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD...TRONQUÉ..." alt="AetherSwap Logo"/>
    <span>AetherSwap</span>
  </div>
  <button class="wallet-btn" onclick="openWalletModal()">Connect Wallet</button>
</header>
<!-- === Bloc 2 : Footer navigation + structure principale === -->
<style>
  main {
    padding: 24px;
    max-width: 600px;
    margin: 0 auto;
  }

  nav.footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    background: #111222;
    border-top: 1px solid #2e2f44;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 12px 0;
    z-index: 1000;
  }

  nav.footer button {
    background: none;
    border: none;
    color: #aaa;
    font-size: 14px;
    cursor: pointer;
    transition: color 0.2s;
  }

  nav.footer button:hover {
    color: #fff;
  }

  nav.footer .active {
    color: #4cc9f0;
    font-weight: bold;
  }
</style>

<main id="main-content">
  <!-- Modules dynamiques (swap/dashboard/token details...) ici -->
</main>

<nav class="footer">
  <button class="active" onclick="showTab('swap')">Swap</button>
  <button onclick="showTab('portfolio')">Portfolio</button>
  <button onclick="showTab('chart')">Chart</button>
  <button onclick="showTab('more')">More</button>
</nav>

<script>
  function showTab(tab) {
    const buttons = document.querySelectorAll("nav.footer button");
    buttons.forEach(btn => btn.classList.remove("active"));
    document.querySelector(`nav.footer button[onclick="showTab('${tab}')"]`).classList.add("active");

    // Placeholder pour affichage dynamique
    const main = document.getElementById("main-content");
    main.innerHTML = `<p style="text-align:center; padding: 50px;">Loading ${tab}...</p>`;
  }
</script>
<!-- === Bloc 3 : Dashboard Swap === -->
<section id="swap" class="section">
  <h2>Dashboard / Swap</h2>

  <div class="token-selector">
    <input id="amt-in" type="number" placeholder="0.0" />
    <span class="token-symbol" id="sym-in">Select</span>
    <button onclick="openModal('in')">Select Token</button>
  </div>

  <div class="token-selector">
    <input id="amt-out" type="number" placeholder="0.0" disabled />
    <span class="token-symbol" id="sym-out">Select</span>
    <button onclick="openModal('out')">Select Token</button>
  </div>

  <div class="quote" id="quote-text">—</div>

  <button id="btn-swap" class="btn-primary" disabled>Swap</button>

  <div id="pair-info" class="hidden">
    <h3 id="pname">PAIR</h3>
    <div>
      <span id="pprice" class="price">0</span>
      <span id="pchange" class="change">(±0%)</span>
    </div>
    <canvas id="pchart"></canvas>
    <button onclick="openChart()">Show chart</button>
  </div>
</section>
<!-- === Bloc 4 : Modals === -->
<!-- Token Selection Modal -->
<div id="modal-tk" class="modal">
  <div class="modal-content">
    <h3>Select a token</h3>
    <input id="tk-search" placeholder="Search or paste mint" />
    <div id="popular" style="display:flex;gap:8px;margin:8px 0;"></div>
    <div id="tk-list" style="max-height:300px;overflow-y:auto;"></div>
    <button class="btn-primary" onclick="closeModal()">Close</button>
  </div>
</div>

<!-- Chart Modal -->
<div id="modal-chart" class="modal">
  <div class="modal-content">
    <h3>Price Chart</h3>
    <canvas id="chart-lg" style="width:100%;height:200px;"></canvas>
    <button class="btn-primary" onclick="closeChart()">Close</button>
  </div>
</div>
<!-- === Bloc 5 : Scripts === -->
<script>
let state = { tokens: [], in: null, out: null, wallet: null, provider: null, slippageBps:50, route: null };

// Connect Phantom
document.getElementById('btn-connect').onclick = async () => {
  if (window.solana?.isPhantom) {
    let resp = await solana.connect();
    state.wallet = resp.publicKey.toString();
    state.provider = solana;
    document.getElementById('btn-connect').innerText = state.wallet.slice(0,4) + '…' + state.wallet.slice(-4);
    updateSwap();
  } else alert('Install Phantom');
};

// Load tokens from Jupiter
async function loadTokens() {
  let resp = await fetch('https://quote-api.jup.ag/v6/tokens');
  state.tokens = (await resp.json()).data;
  renderPopular();
}
loadTokens();

function renderPopular() {
  const pop = ['USDC','SOL','RAY','USDT'];
  let html = '';
  pop.forEach(sym => {
    const t = state.tokens.find(x => x.symbol === sym);
    if (t) html += `<div class="popular-token" onclick="selectToken('${t.address}')">${t.symbol}</div>`;
  });
  document.getElementById('popular').innerHTML = html;
}

// Token Modal logic
let curDir = '';
function openModal(dir) {
  curDir = dir;
  document.getElementById('modal-tk').style.display = 'flex';
  renderPopular();
  renderTokenList();
}
function closeModal() { document.getElementById('modal-tk').style.display = 'none'; }

document.getElementById('tk-search').oninput = renderTokenList;
function renderTokenList() {
  const q = document.getElementById('tk-search').value.trim().toLowerCase();
  let list = state.tokens.filter(t =>
    t.symbol.toLowerCase().includes(q) ||
    t.name.toLowerCase().includes(q) ||
    t.address.toLowerCase() === q
  );
  list = list.slice(0,50);
  document.getElementById('tk-list').innerHTML = list.map(t =>
    `<div class="token-item" onclick="selectToken('${t.address}')">
      <span>${t.symbol} (${t.name.length>15 ? t.name.slice(0,15)+'…' : t.name})</span>
      <span title="${t.address}">${t.address.slice(0,6)}…${t.address.slice(-4)}</span>
    </div>`
  ).join('');
}

function selectToken(addr) {
  const tok = state.tokens.find(x => x.address === addr);
  if (!tok) return;
  const span = curDir === 'in' ? 'sym-in' : 'sym-out';
  state[curDir] = tok;
  document.getElementById(span).innerText = tok.symbol;
  closeModal();
  updateSwap();
}

// Swap/Quote logic
document.getElementById('amt-in').oninput = updateSwap;

async function updateSwap() {
  const ai = parseFloat(document.getElementById('amt-in').value);
  if (!state.in || !state.out || !ai || !state.wallet) {
    document.getElementById('btn-swap').disabled = true;
    document.getElementById('quote-text').innerText = '—';
    return;
  }

  const amt = Math.round(ai * 10**state.in.decimals);
  const url = `https://quote-api.jup.ag/v6/quote?inputMint=${state.in.address}&outputMint=${state.out.address}&amount=${amt}&slippageBps=${state.slippageBps}&feeBps=15`;

  let res = await fetch(url).then(r => r.json());
  if (!res.data || res.data.length === 0) return;

  const rt = res.data[0];
  const outAmt = rt.outAmount / 10**state.out.decimals;
  const minOut = rt.outAmountWithSlippage / 10**state.out.decimals;

  document.getElementById('amt-out').value = outAmt.toFixed(6);
  document.getElementById('quote-text').innerText = 
    `Route: ${rt.route.map(r => r.marketName).join(' → ')} | Min received: ${minOut.toFixed(6)}`;

  document.getElementById('btn-swap').disabled = false;
  state.route = rt;
  renderPair(rt);
}

function renderPair(rt) {
  const a = state.in, b = state.out;
  document.getElementById('pname').innerText = `${a.symbol} / ${b.symbol}`;
  const price = rt.outAmount / rt.inAmount;
  document.getElementById('pprice').innerText = price.toFixed(6);
  const diff = ((Math.random()*2 - 1) * 2).toFixed(2);
  document.getElementById('pchange').innerText = `(${diff > 0 ? '+' : ''}${diff}%)`;

  document.getElementById('pair-info').classList.remove('hidden');
  const ctx = document.getElementById('pchart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [{ data: Array.from({length:20},(_,i)=>price*(1 + Math.sin(i/3)*0.01)), borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(), fill: false }]},
    options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
  });
}

// Execute Swap
document.getElementById('btn-swap').onclick = async () => {
  const rt = state.route;
  document.getElementById('btn-swap').innerText = 'Swapping...';

  const body = {
    route: rt,
    userPublicKey: state.wallet,
    wrapUnwrapSOL: true,
    feeBps: 15,
    feeAccount: "H3z4XmmpLwjm2MhfRuEFhK4DjGHhkbQvmgSUUCTrm6hw"
  };

  const res = await fetch('https://quote-api.jup.ag/v6/swap', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  }).then(r => r.json());

  if (!res.swapTransaction) {
    alert('Swap failed');
    document.getElementById('btn-swap').innerText = 'Swap';
    return;
  }

  const tx = Uint8Array.from(atob(res.swapTransaction), c => c.charCodeAt(0));
  const signed = await state.provider.signTransaction({ serialized: tx });
  const resp = await state.provider.sendTransaction({ serialized: signed.serialize() }, { skipPreflight: true });

  alert('Swap completed! TxID: ' + resp);
  document.getElementById('btn-swap').innerText = 'Swap';
};

// Chart modal
function openChart(){ document.getElementById('modal-chart').style.display = 'flex'; }
function closeChart(){ document.getElementById('modal-chart').style.display = 'none'; }

// Navigation
document.querySelectorAll('.bottom-nav .nav-item').forEach((el, i) => {
  el.onclick = () => {
    const tabs = ['swap', 'portfolio', 'settings', 'legal'];
    document.querySelectorAll('.bottom-nav .nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    tabs.forEach((id, idx) => document.getElementById(id).classList.toggle('hidden', idx !== i));
  };
});

// Load Chart.js
const script = document.createElement('script');
script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
document.head.appendChild(script);
</script>
</body>
</html>