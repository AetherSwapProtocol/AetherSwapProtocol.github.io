<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AetherSwap | Production Ready DEX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@solana/web3.js@1.70.1/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@project-serum/anchor@0.29.0/dist/anchor.min.js"></script>
    <!-- Phantom Wallet Integration -->
    <script src="https://unpkg.com/@phantom-labs/inject-sdk@latest/dist/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: #0a0a0a;
            color: #ffffff;
        }
        
        .gradient-text {
            background: linear-gradient(90deg, #7e22ce 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .gradient-border {
            position: relative;
            border-radius: 1rem;
        }
        
        .gradient-border::before {
            content: "";
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 1rem;
            background: linear-gradient(45deg, #7e22ce, #3b82f6, #7e22ce);
            z-index: -1;
            animation: gradient 3s ease infinite;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .token-selector {
            background-color: #1f2937;
            border-radius: 0.75rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .token-selector:hover {
            background-color: #374151;
        }
        
        .swap-button {
            background: linear-gradient(90deg, #7e22ce 0%, #3b82f6 100%);
            border-radius: 0.75rem;
            padding: 1rem;
            font-weight: 600;
            width: 100%;
            transition: all 0.2s;
        }
        
        .swap-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .swap-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">
    <nav class="container mx-auto px-6 py-6 flex justify-between items-center">
        <a href="index.html" class="flex items-center space-x-2">
            <div class="w-10 h-10 rounded-full gradient-border flex items-center justify-center">
                <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center">
                    ←
                </div>
            </div>
            <span class="text-2xl font-bold gradient-text">AetherSwap</span>
        </a>
        
        <button id="connect-wallet" class="gradient-border px-6 py-2 rounded-full font-medium text-white hover:opacity-90 transition">
            Connect Wallet
        </button>
    </nav>

    <main class="container mx-auto px-4 py-8 max-w-md">
        <div class="gradient-border p-1 rounded-2xl">
            <div class="bg-gray-900 rounded-2xl p-6">
                <div class="flex flex-col space-y-4">
                    <div class="bg-gray-800 rounded-xl p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-400">From</span>
                            <span id="from-balance" class="text-sm text-gray-400">Balance: 0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <input id="from-amount" type="number" placeholder="0.0" class="bg-transparent text-2xl w-full outline-none">
                            <div class="flex items-center space-x-2 token-selector" id="from-token-selector">
                                <img src="https://cryptologos.cc/logos/solana-sol-logo.png" alt="SOL" class="w-6 h-6">
                                <span>SOL</span>
                                <span>▼</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-center">
                        <button id="switch-tokens" class="p-2 rounded-full bg-gray-800 hover:bg-gray-700 transition">
                            ↓↑
                        </button>
                    </div>
                    
                    <div class="bg-gray-800 rounded-xl p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-400">To</span>
                            <span id="to-balance" class="text-sm text-gray-400">Balance: 0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <input id="to-amount" type="number" placeholder="0.0" class="bg-transparent text-2xl w-full outline-none" disabled>
                            <div class="flex items-center space-x-2 token-selector" id="to-token-selector">
                                <img src="https://cryptologos.cc/logos/usd-coin-usdc-logo.png" alt="USDC" class="w-6 h-6">
                                <span>USDC</span>
                                <span>▼</span>
                            </div>
                        </div>
                    </div>

                    <div id="price-info" class="text-center text-sm text-gray-400">
                        Loading price...
                    </div>
                    
                    <div class="pt-4">
                        <button id="swap-button" class="swap-button" disabled>
                            Swap
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Configuration
        const TOKENS = {
            SOL: {
                name: "SOL",
                mint: "So11111111111111111111111111111111111111112",
                decimals: 9,
                logo: "https://cryptologos.cc/logos/solana-sol-logo.png"
            },
            USDC: {
                name: "USDC",
                mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
                decimals: 6,
                logo: "https://cryptologos.cc/logos/usd-coin-usdc-logo.png"
            },
            BONK: {
                name: "BONK",
                mint: "DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263",
                decimals: 5,
                logo: "https://arweave.net/hQiPZOsRZXGXBJd_82PhVdlM_hACsT_q6wqwf5cSY7I"
            }
        };

        // État de l'application
        let state = {
            fromToken: TOKENS.SOL,
            toToken: TOKENS.USDC,
            fromAmount: 0,
            toAmount: 0,
            walletConnected: false,
            walletPublicKey: null,
            currentPrice: 0,
            loading: false
        };

        // Initialisation Solana
        const connection = new solanaWeb3.Connection(
            solanaWeb3.clusterApiUrl('mainnet-beta'), 
            'confirmed'
        );

        // Éléments UI
        const connectWalletBtn = document.getElementById('connect-wallet');
        const fromAmountInput = document.getElementById('from-amount');
        const toAmountInput = document.getElementById('to-amount');
        const fromBalance = document.getElementById('from-balance');
        const toBalance = document.getElementById('to-balance');
        const fromTokenSelector = document.getElementById('from-token-selector');
        const toTokenSelector = document.getElementById('to-token-selector');
        const switchTokensBtn = document.getElementById('switch-tokens');
        const swapButton = document.getElementById('swap-button');
        const priceInfo = document.getElementById('price-info');

        // Événements
        connectWalletBtn.addEventListener('click', connectWallet);
        fromAmountInput.addEventListener('input', updateToAmount);
        switchTokensBtn.addEventListener('click', switchTokens);
        swapButton.addEventListener('click', executeSwap);

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            updateTokenSelectors();
            fetchPrice();
        });

        // Connexion Wallet
        async function connectWallet() {
            try {
                if (window.phantom?.solana?.isPhantom) {
                    setLoading(true, connectWalletBtn);
                    
                    const provider = window.phantom.solana;
                    const response = await provider.connect();
                    state.walletPublicKey = response.publicKey.toString();
                    state.walletConnected = true;
                    
                    // Mettre à jour l'UI
                    connectWalletBtn.textContent = 
                        `${state.walletPublicKey.slice(0, 4)}...${state.walletPublicKey.slice(-4)}`;
                    
                    // Charger les balances
                    await loadBalances();
                    updateSwapButton();
                    
                    setLoading(false, connectWalletBtn);
                } else {
                    window.open('https://phantom.app/', '_blank');
                    throw new Error('Phantom Wallet not installed');
                }
            } catch (error) {
                console.error('Connection error:', error);
                setLoading(false, connectWalletBtn);
                connectWalletBtn.textContent = 'Connect Wallet';
                showError(`Error: ${error.message}`);
            }
        }

        // Chargement des balances
        async function loadBalances() {
            try {
                setLoading(true);
                
                // SOL Balance
                if (state.fromToken.name === 'SOL' || state.toToken.name === 'SOL') {
                    const solBalance = await connection.getBalance(
                        new solanaWeb3.PublicKey(state.walletPublicKey)
                    );
                    const solBalanceElement = state.fromToken.name === 'SOL' ? fromBalance : toBalance;
                    solBalanceElement.textContent = `Balance: ${(solBalance / solanaWeb3.LAMPORTS_PER_SOL).toFixed(2)}`;
                }
                
                // USDC Balance
                if (state.fromToken.name === 'USDC' || state.toToken.name === 'USDC') {
                    const usdcAccounts = await connection.getTokenAccountsByOwner(
                        new solanaWeb3.PublicKey(state.walletPublicKey),
                        { mint: new solanaWeb3.PublicKey(TOKENS.USDC.mint) }
                    );
                    
                    const usdcBalanceElement = state.fromToken.name === 'USDC' ? fromBalance : toBalance;
                    if (usdcAccounts.value.length > 0) {
                        const balance = await connection.getTokenAccountBalance(
                            usdcAccounts.value[0].pubkey
                        );
                        usdcBalanceElement.textContent = `Balance: ${(balance.value.uiAmount || 0).toFixed(2)}`;
                    } else {
                        usdcBalanceElement.textContent = `Balance: 0`;
                    }
                }

                // BONK Balance
                if (state.fromToken.name === 'BONK' || state.toToken.name === 'BONK') {
                    const bonkAccounts = await connection.getTokenAccountsByOwner(
                        new solanaWeb3.PublicKey(state.walletPublicKey),
                        { mint: new solanaWeb3.PublicKey(TOKENS.BONK.mint) }
                    );
                    
                    const bonkBalanceElement = state.fromToken.name === 'BONK' ? fromBalance : toBalance;
                    if (bonkAccounts.value.length > 0) {
                        const balance = await connection.getTokenAccountBalance(
                            bonkAccounts.value[0].pubkey
                        );
                        bonkBalanceElement.textContent = `Balance: ${(balance.value.uiAmount || 0).toFixed(0)}`;
                    } else {
                        bonkBalanceElement.textContent = `Balance: 0`;
                    }
                }
                
                setLoading(false);
            } catch (error) {
                console.error('Balance load error:', error);
                setLoading(false);
                showError('Failed to load balances');
            }
        }

        // Mise à jour du montant de sortie
        async function updateToAmount() {
            state.fromAmount = parseFloat(fromAmountInput.value) || 0;
            
            if (state.fromAmount > 0) {
                try {
                    setLoading(true, toAmountInput);
                    
                    if (state.currentPrice === 0) {
                        await fetchPrice();
                    }
                    
                    state.toAmount = state.fromAmount * state.currentPrice;
                    toAmountInput.value = state.toAmount.toFixed(6);
                    updatePriceInfo();
                    
                    setLoading(false, toAmountInput);
                } catch (error) {
                    console.error('Price fetch error:', error);
                    setLoading(false, toAmountInput);
                    showError('Failed to calculate amount');
                }
            } else {
                toAmountInput.value = '';
                state.toAmount = 0;
                updatePriceInfo();
            }
            
            updateSwapButton();
        }

        // Récupération du prix du marché
        async function fetchPrice() {
            try {
                setLoading(true, priceInfo);
                
                const response = await fetch(
                    `https://price.jup.ag/v4/price?ids=${state.fromToken.mint}&vsToken=${state.toToken.mint}`
                );
                const data = await response.json();
                state.currentPrice = data.data[state.fromToken.mint].price;
                
                updatePriceInfo();
                setLoading(false, priceInfo);
            } catch (error) {
                console.error('Price fetch error:', error);
                setLoading(false, priceInfo);
                priceInfo.textContent = 'Price unavailable';
                throw error;
            }
        }

        // Met à jour l'affichage du prix
        function updatePriceInfo() {
            if (state.fromAmount > 0 && state.currentPrice > 0) {
                priceInfo.textContent = 
                    `1 ${state.fromToken.name} = ${state.currentPrice.toFixed(4)} ${state.toToken.name}`;
            } else if (state.currentPrice > 0) {
                priceInfo.textContent = 
                    `1 ${state.fromToken.name} = ${state.currentPrice.toFixed(4)} ${state.toToken.name}`;
            }
        }

        // Échange des tokens
        function switchTokens() {
            [state.fromToken, state.toToken] = [state.toToken, state.fromToken];
            updateTokenSelectors();
            fromAmountInput.value = '';
            toAmountInput.value = '';
            state.fromAmount = 0;
            state.toAmount = 0;
            fetchPrice();
            if (state.walletConnected) {
                loadBalances();
            }
            updateSwapButton();
        }

        // Mise à jour des sélecteurs de tokens
        function updateTokenSelectors() {
            fromTokenSelector.innerHTML = `
                <img src="${state.fromToken.logo}" alt="${state.fromToken.name}" class="w-6 h-6">
                <span>${state.fromToken.name}</span>
                <span>▼</span>
            `;
            
            toTokenSelector.innerHTML = `
                <img src="${state.toToken.logo}" alt="${state.toToken.name}" class="w-6 h-6">
                <span>${state.toToken.name}</span>
                <span>▼</span>
            `;
        }

        // Mise à jour du bouton de swap
        function updateSwapButton() {
            swapButton.disabled = !(state.walletConnected && state.fromAmount > 0 && state.toAmount > 0);
        }

        // Exécution du swap
        async function executeSwap() {
            if (!state.walletConnected || state.fromAmount <= 0) return;
            
            try {
                setLoading(true, swapButton);
                swapButton.textContent = 'Processing...';
                swapButton.disabled = true;
                
                // Get quote
                const amountInLamports = state.fromAmount * Math.pow(10, state.fromToken.decimals);
                const quoteResponse = await fetch(
                    `https://quote-api.jup.ag/v4/quote?inputMint=${state.fromToken.mint}&outputMint=${state.toToken.mint}&amount=${amountInLamports}&slippage=0.5`
                );
                const quoteData = await quoteResponse.json();
                
                if (!quoteData.data || quoteData.data.length === 0) {
                    throw new Error('No route found for this swap');
                }
                
                const bestRoute = quoteData.data[0];
                
                // Get swap transaction
                const swapResponse = await fetch('https://quote-api.jup.ag/v4/swap', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        route: bestRoute,
                        userPublicKey: state.walletPublicKey,
                        wrapUnwrapSOL: true
                    })
                });
                
                const swapData = await swapResponse.json();
                
                // Execute swap
                const provider = window.phantom.solana;
                const { signature } = await provider.signAndSendTransaction(
                    new Uint8Array(Object.values(swapData.swapTransaction))
                );
                
                // Show success
                swapButton.textContent = 'Swap Successful!';
                setTimeout(() => {
                    swapButton.textContent = 'Swap';
                    updateSwapButton();
                }, 2000);
                
                // Update balances
                await new Promise(resolve => setTimeout(resolve, 3000)); // Wait for confirmation
                await loadBalances();
                
            } catch (error) {
                console.error('Swap error:', error);
                swapButton.textContent = 'Swap Failed';
                setTimeout(() => {
                    swapButton.textContent = 'Swap';
                    updateSwapButton();
                }, 2000);
                showError(`Swap failed: ${error.message}`);
            } finally {
                setLoading(false, swapButton);
            }
        }

        // Affiche une erreur
        function showError(message) {
            const errorElement = document.createElement('div');
            errorElement.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-md shadow-lg';
            errorElement.textContent = message;
            document.body.appendChild(errorElement);
            
            setTimeout(() => {
                errorElement.remove();
            }, 5000);
        }

        // Gestion du loading state
        function setLoading(isLoading, element = null) {
            state.loading = isLoading;
            
            if (element) {
                if (isLoading) {
                    element.disabled = true;
                    if (!element.querySelector('.loading-spinner')) {
                        const spinner = document.createElement('div');
                        spinner.className = 'loading-spinner';
                        element.insertBefore(spinner, element.firstChild);
                    }
                } else {
                    element.disabled = false;
                    const spinner = element.querySelector('.loading-spinner');
                    if (spinner) {
                        spinner.remove();
                    }
                }
            }
        }
    </script>
</body>
</html>