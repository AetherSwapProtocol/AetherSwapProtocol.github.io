<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AetherSwap¬†| Pro Solana DEX</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
  <script src="https://unpkg.com/@solana/web3.js@1.85.0/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@solana/spl-token@0.3.12/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@solana/spl-token-2022@0.1.0/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary: #7e22ce;
      --secondary: #3b82f6;
      --dark: #0a0a0a;
      --darker: #111827;
      --darkest: #1f2937;
    }
    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--dark);
      color: white;
      min-height: 100vh;
      padding-bottom: 80px;
    }
    .gradient-border {
      position: relative;
      border-radius: 1rem;
    }
    .gradient-border::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: inherit;
      background: linear-gradient(45deg, var(--primary), var(--secondary), var(--primary));
      z-index: -1;
      background-size: 200% 200%;
      animation: gradient 3s ease infinite;
    }
    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .swap-button {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transition: all 0.2s;
    }
    .swap-button:hover:not(:disabled) {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .token-img-fallback {
      background: var(--darkest);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      font-weight: bold;
      color: #6b7280;
    }
    .chart-container {
      position: relative;
      height: 150px;
      cursor: pointer;
    }
    .chart-fullscreen {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 60;
    }
  </style>
</head>

<body x-data="dex()" x-init="init()" class="antialiased">

  <!-- Header -->
  <nav class="container mx-auto px-6 py-6 flex justify-between items-center">
    <a href="index.html" class="flex items-center space-x-2">
      <div class="w-10 h-10 rounded-full gradient-border flex items-center justify-center">
        <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center">‚Üê</div>
      </div>
      <span class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-blue-400">AetherSwap</span>
    </a>
    <button @click="connect()" class="gradient-border px-6 py-2 rounded-full font-medium hover:opacity-90 transition" x-text="walletLabel"></button>
  </nav>

  <!-- Swap Panel -->
  <main class="container mx-auto px-4 max-w-md">
    <div class="gradient-border p-1 rounded-2xl">
      <div class="bg-darkest rounded-2xl p-6">
        
        <!-- From -->
        <div class="bg-gray-800 rounded-xl p-4 mb-4 space-y-2">
          <div class="flex justify-between text-sm text-gray-400">From <span x-text="fromBalance"></span></div>
          <div class="flex items-center">
            <input type="number" x-model="fromAmount" @input.debounce.500="updateTo()" placeholder="0.0" class="bg-transparent text-2xl w-full outline-none"/>
            <button @click="openSelector('from')" class="flex items-center token-selector px-3 py-2 rounded-lg space-x-2">
              <img :src="fromToken.logo" alt="" class="w-6 h-6 rounded-full object-cover" @error="fallback($event)" />
              <span x-text="fromToken.symbol"></span><i class="fas fa-chevron-down"></i>
            </button>
          </div>
          <div class="flex justify-end space-x-2">
            <button @click="setMax()" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-0.5 rounded">MAX</button>
            <button @click="setHalf()" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-0.5 rounded">50%</button>
          </div>
        </div>

        <!-- Switch -->
        <div class="flex justify-center -mt-4 -mb-4">
          <button @click="swapTokens()" class="p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition transform hover:rotate-180">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>

        <!-- To -->
        <div class="bg-gray-800 rounded-xl p-4 mb-2 space-y-2">
          <div class="flex justify-between text-sm text-gray-400">To <span x-text="toBalance"></span></div>
          <div class="flex items-center">
            <input type="number" x-model="toAmount" disabled class="bg-transparent text-2xl w-full outline-none"/>
            <button @click="openSelector('to')" class="flex items-center token-selector px-3 py-2 rounded-lg space-x-2">
              <img :src="toToken.logo" alt="" class="w-6 h-6 rounded-full object-cover" @error="fallback($event)" />
              <span x-text="toToken.symbol"></span><i class="fas fa-chevron-down"></i>
            </button>
          </div>
          <div class="text-xs text-gray-400 text-right" x-show="usdTo">‚âà $<span x-text="usdTo"></span></div>
        </div>

        <!-- Price + Chart -->
        <div class="text-sm text-gray-400 text-center mb-2" x-show="price">1 <span x-text="fromToken.symbol"></span> = <span x-text="price"></span> <span x-text="toToken.symbol"></span></div>
        <div class="chart-container mb-4" @click="toggleChart()">
          <template x-if="!chartOpen">
            <div class="h-full flex justify-center items-center"><span class="text-xs text-gray-500">Click to open chart üìà</span></div>
          </template>
          <div id="miniChart" class="absolute inset-0"></div>
        </div>

        <!-- Slippage & Fees -->
        <div class="flex justify-between items-center text-sm text-gray-400 pt-2">
          <div class="flex items-center space-x-1"><span>Slippage</span><i class="fas fa-info-circle"></i></div>
          <span x-text="slippage + '%'"></span>
        </div>
        <input type="range" min="0.1" max="5" step="0.1" x-model="slippage" @input="computeAll()" class="w-full mb-1"/>
        <div class="text-xs text-gray-400 text-center">Fees: <span x-text="fees + ' ' + toToken.symbol"></span></div>

        <!-- Swap Button -->
        <button @click="showConfirm()" :disabled="!canSwap" class="swap-button rounded-lg py-3 font-semibold w-full" x-text="swapButtonLabel"></button>
      </div>
    </div>
  </main>

  <!-- Confirm Modal -->
  <div x-show="showConfirmModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
    <div class="bg-gray-900 rounded-xl gradient-border max-w-md w-full p-6 space-y-4">
      <div class="flex justify-between items-center">
        <h3 class="text-xl font-bold">Confirm Swap</h3>
        <button @click="showConfirmModal=false" class="text-2xl">√ó</button>
      </div>
      <div class="bg-gray-800 rounded-lg p-4 space-y-2">
        <div class="flex justify-between items-center">
          <div class="flex items-center space-x-2">
            <img :src="fromToken.logo" class="w-8 h-8 rounded-full"/>
            <span x-text="fromAmount"></span><span x-text="fromToken.symbol"></span>
          </div>
          <span>‚Üí</span>
          <div class="flex items-center space-x-2">
            <img :src="toToken.logo" class="w-8 h-8 rounded-full"/>
            <span x-text="toAmount"></span><span x-text="toToken.symbol"></span>
          </div>
        </div>
        <div class="text-sm text-gray-400 space-y-1 pt-2 border-t border-gray-700">
          <div class="flex justify-between"><span>Rate</span><span x-text="rateDisplay"></span></div>
          <div class="flex justify-between"><span>Price Impact</span><span x-text="priceImpact"></span></div>
          <div class="flex justify-between"><span>Network Fees</span><span x-text="fees + ' ' + toToken.symbol"></span></div>
          <div class="flex justify-between"><span>Minimum Received</span><span x-text="minReceived"></span></div>
        </div>
      </div>
      <div class="flex space-x-3">
        <button @click="showConfirmModal=false" class="flex-1 py-3 rounded-lg border border-gray-600">Cancel</button>
        <button @click="executeSwap()" class="flex-1 py-3 rounded-lg swap-button">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Transaction Modal -->
  <div x-show="txStatus!='none'" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
    <div class="bg-gray-900 rounded-xl gradient-border max-w-md w-full p-6 text-center">
      <template x-if="txStatus=='loading'">
        <div>
          <div class="w-16 h-16 border-4 border-purple-500 border-t-transparent animate-spin rounded-full mx-auto mb-4"></div>
          <h3 class="text-xl font-bold">Processing Swap...</h3>
          <p class="text-gray-400" x-text="txMessage"></p>
        </div>
      </template>
      <template x-if="txStatus=='success'">
        <div>
          <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-check text-2xl"></i></div>
          <h3 class="text-xl font-bold">Swap Successful!</h3>
          <a :href="explorerLink" target="_blank" class="swap-button block py-3 rounded-lg">View on Explorer</a>
        </div>
      </template>
      <template x-if="txStatus=='error'">
        <div>
          <div class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-times text-2xl"></i></div>
          <h3 class="text-xl font-bold">Swap Failed</h3>
          <p class="text-gray-400" x-text="txMessage"></p>
          <button @click="txStatus='none'" class="swap-button rounded-lg py-3 w-full">Close</button>
        </div>
      </template>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-900/80 backdrop-blur-md border-t border-gray-800 z-50 shadow-lg">
    <div class="flex justify-around py-3">
      <a href="swap.html" class="flex flex-col items-center text-xs text-white"><i class="fas fa-exchange-alt text-lg"></i><span>Swap</span></a>
      <a href="index.html" class="flex flex-col items-center text-xs text-white"><i class="fas fa-home text-lg"></i><span>Home</span></a>
      <a href="launchlab.html" class="flex flex-col items-center text-xs text-white"><i class="fas fa-rocket text-lg"></i><span>LaunchLab</span></a>
    </div>
  </nav>

  <!-- Token Selector Modal -->
  <div x-show="showSelector" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
    <div class="bg-gray-900 rounded-xl gradient-border max-w-md w-full max-h-[80vh] overflow-hidden">
      <div class="bg-gray-900 p-6 space-y-4">
        <div class="flex justify-between items-center"><h3 class="text-xl">Select Token</h3><button @click="showSelector=false" class="text-2xl">√ó</button></div>
        <input type="text" x-model="search" @input.debounce.300="searchTokens()" placeholder="Paste mint or search name" class="w-full bg-gray-800 rounded-lg px-4 py-2 text-sm outline-none"/>
        <div class="h-40 overflow-y-auto space-y-2 divide-y divide-gray-800 mt-4">
          <template x-for="tok in filteredTokens" :key="tok.address">
            <div class="flex items-center justify-between p-2 cursor-pointer hover:bg-gray-800" @click="selectToken(tok)">
              <div class="flex items-center space-x-3">
                <img :src="tok.logo" alt="" class="w-8 h-8 rounded-full object-cover" @error="fallback($event)"/>
                <div><span class="font-medium" x-text="tok.symbol"></span><div class="text-xs text-gray-400" x-text="tok.name"></div></div>
              </div>
              <span class="text-gray-400 text-xs" x-text="tok.symbol"></span>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>

  <script>
  function dex(){
    return {
      walletLabel: 'Connect Wallet',
      wallet: null,
      connection: null,
      fromToken: {symbol:'SOL', address: 'So11111111111111111111111111111111111111112', logo:'https://cryptologos.cc/logos/solana-sol-logo.png', decimals:9},
      toToken: {symbol:'USDC', address: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGkZwyTDt1v', logo:'https://cryptologos.cc/logos/usd-coin-usdc-logo.png', decimals:6},
      fromAmount: 0, toAmount: 0, price: null, usdTo: null, slippage: 0.5, fees: '‚Äì', chartOpen: false,
      showConfirmModal: false, txStatus: 'none', txMessage: '', explorerLink: '',
      showSelector: false, selectorTarget: null, tokens: [], filteredTokens: [], search: '', route: null,

      async init() {
        this.connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'), 'confirmed');
        await this.fetchTokenList();
        await this.loadBalances();
      },

      async connect() {
        if (this.wallet) return;
        try {
          const provider = window.phantom?.solana;
          if (!provider?.isPhantom) throw new Error('Install Phantom Wallet');
          await provider.connect();
          this.wallet = provider;
          const pk = provider.publicKey.toBase58();
          this.walletLabel = pk.slice(0,4) + '‚Ä¶' + pk.slice(-4);
          await this.loadBalances();
        } catch(e){ alert(e.message); }
      },

      async fetchTokenList(){
        try {
          const res = await fetch('https://api.jup.ag/v4/tokens');
          const json = await res.json();
          this.tokens = Object.values(json.tokens);
          this.filteredTokens = this.tokens;
        } catch(e){ console.error(e); }
      },

      searchTokens(){
        const term = this.search.toLowerCase();
        this.filteredTokens = this.tokens.filter(t =>
          t.symbol.toLowerCase().includes(term) ||
          t.name.toLowerCase().includes(term) ||
          t.address === term
        );
      },

      selectToken(tok){
        const token = { symbol: tok.symbol, name: tok.name, address: tok.address, logo: tok.logo, decimals: tok.decimals };
        this[ this.selectorTarget + 'Token' ] = token;
        this.showSelector = false;
        await this.computeAll();
      },

      fallback(e){
        e.target.closest('img').classList.add('token-img-fallback');
      },

      async loadBalances(){
        if (!this.wallet) return;
        const publicKey = this.wallet.publicKey;
        const solBal = await this.connection.getBalance(publicKey);
        this.fromBalance = this.fromToken.symbol=='SOL' ? (solBal / 1e9).toFixed(4) + ' SOL' : '';
        this.toBalance = this.toToken.symbol=='SOL' ? (solBal / 1e9).toFixed(4) + ' SOL' : '';
        // Add token accounts if needed...
      },

      setMax(){ this.fromAmount = parseFloat((parseFloat(this.fromBalance)||0)-0.05).toFixed(this.fromToken.decimals); this.computeAll(); },
      setHalf(){ this.fromAmount = (parseFloat(this.fromBalance)||0)/2; this.computeAll(); },

      swapTokens(){
        [this.fromToken, this.toToken] = [this.toToken, this.fromToken];
        this.computeAll();
      },

      async computeAll(){
        if(this.fromAmount <= 0) { this.toAmount = 0; this.price = null; this.usdTo = null; return; }
        const amount = Math.floor(this.fromAmount * 10 ** this.fromToken.decimals);
        const priceRes = await fetch(`https://api.jup.ag/v4/price?ids=${this.fromToken.address}&vsToken=${this.toToken.address}`);
        const priceJson = await priceRes.json();
        this.price = priceJson?.data?.[this.fromToken.address]?.price.toFixed(6);
        this.toAmount = parseFloat((this.fromAmount * this.price).toFixed(this.toToken.decimals));
        this.usdTo = (this.toAmount * (await window.coingecko.fetchPrice(this.toToken.symbol) || 1)).toFixed(2);
        // Fees estimate
        this.fees = '‚âà ' + ((parseFloat(this.toAmount) * 0.001).toFixed(this.toToken.decimals)) + ' ' + this.toToken.symbol;
      },

      get canSwap(){ return this.wallet && this.fromAmount > 0 && this.toAmount > 0; },
      get swapButtonLabel(){ return this.canSwap ? 'Swap' : 'Enter amount'; },

      showConfirm(){
        if(!this.canSwap) return;
        this.showConfirmModal = true;
      },

      async executeSwap(){
        this.showConfirmModal = false;
        this.txStatus = 'loading'; this.txMessage = 'Getting quote‚Ä¶';
        try {
          const quoteRes = await fetch('https://quote-api.jup.ag/v4/quote', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({inputMint:this.fromToken.address, outputMint:this.toToken.address, amount:Math.floor(this.fromAmount*10**this.fromToken.decimals), slippage:this.slippage})
          });
          const quoteJson = await quoteRes.json();
          const route = quoteJson.data[0];
          // Swap
          const swapRes = await fetch('https://quote-api.jup.ag/v4/swap', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({route, userPublicKey:this.wallet.publicKey.toBase58(), wrapUnwrapSOL:true})
          });
          const swapJson = await swapRes.json();
          const txBuffer = Uint8Array.from(Object.values(swapJson.swapTransaction));
          this.txMessage = 'Sending transaction‚Ä¶';
          const signed = await this.wallet.signAndSendTransaction(txBuffer);
          this.txMessage = 'Confirming‚Ä¶';
          await this.connection.confirmTransaction(signed.signature, 'confirmed');
          this.txStatus = 'success';
          this.explorerLink = 'https://solscan.io/tx/' + signed.signature;
          await this.loadBalances();
        } catch(e) {
          console.error(e);
          this.txStatus = 'error'; this.txMessage = e.message || 'Swap failed';
        }
      },

      toggleChart(){
        this.chartOpen = true;
        const div = document.createElement('div');
        div.className = 'chart-fullscreen';
        div.innerHTML = '<iframe src="https://s.tradingview.com/embed-widget/mini-symbol-overview/?symbol=' +
          this.fromToken.symbol + this.toToken.symbol + '" style="width:100%;height:100%;border:none;"></iframe>';
        div.addEventListener('click', () => { div.remove(); this.chartOpen = false });
        document.body.appendChild(div);
      }
    };
  }
  </script>
</body>
</html>