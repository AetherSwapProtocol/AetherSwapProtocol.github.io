<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AetherSwap | Swap Interface</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@solana/web3.js@1.70.1/lib/index.iife.min.js"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans flex flex-col">

  <!-- Navigation -->
  <nav
    class="flex items-center justify-between px-6 py-4 border-b border-gray-800 bg-gray-800"
  >
    <!-- Bouton retour -->
    <a
      href="index.html"
      class="flex items-center space-x-2 hover:text-purple-400 transition"
    >
      <i class="fas fa-arrow-left"></i>
      <span class="font-semibold text-lg">Retour</span>
    </a>

    <!-- Wallet -->
    <button
      id="walletBtn"
      class="flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-full transition"
    >
      <i class="fas fa-wallet text-purple-400"></i>
      <span id="walletAddress">Connect Wallet</span>
    </button>
  </nav>

  <!-- Main Interface -->
  <main class="flex-grow container mx-auto max-w-md p-6 flex flex-col space-y-6">
    <h1 class="text-3xl font-bold text-center mb-4">Swap Tokens</h1>

    <!-- From Token -->
    <div class="bg-gray-800 rounded-xl p-4 space-y-2">
      <label class="text-gray-400 font-semibold">From Token Mint</label>
      <input
        id="fromTokenMint"
        type="text"
        placeholder="Ex: So11111111111111111111111111111111111111112 (WSOL)"
        class="w-full p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-600"
      />
    </div>

    <!-- To Token -->
    <div class="bg-gray-800 rounded-xl p-4 space-y-2">
      <label class="text-gray-400 font-semibold">To Token Mint</label>
      <input
        id="toTokenMint"
        type="text"
        placeholder="Ex: EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v (USDC)"
        class="w-full p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-600"
      />
    </div>

    <!-- Amount -->
    <div class="bg-gray-800 rounded-xl p-4 space-y-2">
      <label class="text-gray-400 font-semibold">Amount</label>
      <input
        id="amount"
        type="number"
        min="0"
        step="0.0001"
        placeholder="0.0"
        class="w-full p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-600"
      />
    </div>

    <!-- Prix en temps réel -->
    <div
      id="priceInfo"
      class="text-center p-3 bg-gray-700 rounded text-sm text-gray-300 min-h-[40px]"
    >
      Entrez les données pour voir le prix en temps réel.
    </div>

    <!-- Bouton Swap -->
    <button
      id="swapBtn"
      disabled
      class="w-full bg-gradient-to-r from-purple-600 to-blue-500 py-3 rounded-xl font-bold text-white hover:opacity-90 transition disabled:opacity-50"
    >
      Connectez votre wallet pour swap
    </button>
  </main>

  <script>
    // Connexion à Solana
    const connection = new solanaWeb3.Connection(
      "https://api.mainnet-beta.solana.com"
    );
    let wallet = null;

    // Elements DOM
    const walletBtn = document.getElementById("walletBtn");
    const walletAddressSpan = document.getElementById("walletAddress");
    const fromTokenInput = document.getElementById("fromTokenMint");
    const toTokenInput = document.getElementById("toTokenMint");
    const amountInput = document.getElementById("amount");
    const priceInfoDiv = document.getElementById("priceInfo");
    const swapBtn = document.getElementById("swapBtn");

    // Met à jour le status et le bouton swap selon le wallet
    function updateUIOnWalletConnect(pubKey) {
      walletAddressSpan.textContent =
        pubKey.slice(0, 4) + "..." + pubKey.slice(-4);
      swapBtn.disabled = false;
      swapBtn.textContent = "Swap Now";
    }

    // Connecter Phantom Wallet
    walletBtn.addEventListener("click", async () => {
      if (window.solana && window.solana.isPhantom) {
        try {
          wallet = window.solana;
          await wallet.connect();
          updateUIOnWalletConnect(wallet.publicKey.toString());
          fetchPriceIfPossible();
        } catch (err) {
          alert("Erreur lors de la connexion au wallet");
          console.error(err);
        }
      } else {
        alert("Veuillez installer Phantom Wallet !");
      }
    });

    // Fonction qui récupère le prix en temps réel via Jupiter API
    async function fetchPrice(fromMint, toMint, amount) {
      if (!fromMint || !toMint || !amount || amount <= 0) {
        priceInfoDiv.textContent =
          "Entrez des tokens valides et un montant supérieur à 0.";
        return;
      }
      priceInfoDiv.textContent = "Chargement du prix...";

      // Jupiter API accepte le montant en lamports (1e6 pour tokens à 6 décimales)
      // ATTENTION: Cette démo considère 6 décimales, adapter pour chaque token en prod
      const amountIn = Math.floor(amount * 1e6);

      const url = `https://quote-api.jup.ag/v6/quote?inputMint=${fromMint}&outputMint=${toMint}&amount=${amountIn}&slippageBps=100`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (data.data && data.data.length > 0) {
          const quote = data.data[0];
          const outAmount = quote.outAmount / 1e6;
          const rate = outAmount / amount;
          priceInfoDiv.textContent = `1 ${fromMint.slice(0, 4)} ≈ ${rate.toFixed(
            6
          )} ${toMint.slice(0, 4)} | Vous recevrez environ ${outAmount.toFixed(
            6
          )} ${toMint.slice(0, 4)}`;
        } else {
          priceInfoDiv.textContent = "Aucune cotation disponible pour cette paire.";
        }
      } catch (e) {
        priceInfoDiv.textContent = "Erreur lors de la récupération du prix.";
        console.error(e);
      }
    }

    // Déclenche la récupération prix quand les inputs changent
    function fetchPriceIfPossible() {
      const fromMint = fromTokenInput.value.trim();
      const toMint = toTokenInput.value.trim();
      const amount = parseFloat(amountInput.value.trim());
      if (fromMint && toMint && amount > 0) {
        fetchPrice(fromMint, toMint, amount);
      } else {
        priceInfoDiv.textContent = "Entrez les données pour voir le prix en temps réel.";
      }
    }

    fromTokenInput.addEventListener("input", fetchPriceIfPossible);
    toTokenInput.addEventListener("input", fetchPriceIfPossible);
    amountInput.addEventListener("input", fetchPriceIfPossible);

    // Bouton Swap simulé (réel : utiliser Jupiter swap API + signer tx)
    swapBtn.addEventListener("click", () => {
      if (!wallet) {
        alert("Veuillez connecter votre wallet d'abord.");
        return;
      }
      const fromMint = fromTokenInput.value.trim();
      const toMint = toTokenInput.value.trim();
      const amount = parseFloat(amountInput.value.trim());

      if (!fromMint || !toMint || !amount || amount <= 0) {
        alert("Veuillez entrer des données valides.");
        return;
      }

      swapBtn.disabled = true;
      swapBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Swap en cours...`;

      // Simuler un délai swap (à remplacer par swap réel)
      setTimeout(() => {
        alert(
          `Swap simulé: ${amount} de ${fromMint.slice(
            0,
            6
          )} vers ${toMint.slice(0, 6)} effectué avec succès !`
        );
        swapBtn.disabled = false;
        swapBtn.textContent = "Swap Now";
      }, 2000);
    });
  </script>
</body>
</html>