<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AetherSwap | Next-Gen Privacy DEX</title>
  
  <!-- Enhanced Meta Tags -->
  <meta name="description" content="Swap tokens instantly on Solana with ZK-privacy and lightning-fast speeds">
  <meta name="keywords" content="Solana, DEX, Swap, Crypto, DeFi, Web5, ZKP">
  <meta name="theme-color" content="#6366f1">
  
  <!-- Preload Critical Resources -->
  <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
  <link rel="preload" href="https://unpkg.com/@solana/web3.js@latest" as="script">
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300..700&display=swap" as="style">
  
  <!-- Modern CSS with Layers -->
  <style>
    @layer base, components, utilities;
    
    @layer base {
      :root {
        --primary: #6366f1;
        --secondary: #8b5cf6;
        --dark: #0f172a;
        --darker: #020617;
        --card: #1e293b;
      }
      
      [data-theme="light"] {
        --primary: #4f46e5;
        --secondary: #7c3aed;
        --dark: #f1f5f9;
        --darker: #e2e8f0;
        --card: #ffffff;
      }
    }
    
    @layer components {
      body {
        background: radial-gradient(circle at 10% 20%, var(--darker), var(--dark));
        color: white;
        font-family: 'Inter', sans-serif;
        min-height: 100dvh;
        margin: 0;
        display: grid;
        place-items: center;
        padding: 1rem;
      }
      
      .glass-card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.36);
        
        @container (width > 400px) {
          width: min(100%, 28rem);
        }
      }
      
      .token-input {
        background: rgba(15, 23, 42, 0.5);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        
        &:focus {
          box-shadow: 0 0 0 2px var(--primary);
        }
      }
      
      .gradient-btn {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        background-size: 200% 200%;
        transition: all 0.3s ease, background-position 0.5s;
        
        &:hover {
          transform: translateY(-2px);
          box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.4);
          background-position: 100% 100%;
        }
      }
    }
    
    @layer utilities {
      .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      
      .text-balance {
        text-wrap: balance;
      }
    }
    
    /* View Transition API */
    @keyframes fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .swap-transition {
      view-transition-name: swap-card;
      animation: fade-in 0.3s ease;
    }
  </style>
  
  <!-- Tailwind with JIT -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,aspect-ratio,line-clamp,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>
  
  <!-- Solana Web3 -->
  <script src="https://unpkg.com/@solana/web3.js@latest"></script>
</head>
<body>
  <!-- View Transition Wrapper -->
  <div class="swap-transition">
    <!-- Theme Toggle -->
    <div class="absolute top-4 left-4 flex items-center gap-2">
      <button id="theme-toggle" class="p-2 rounded-full bg-gray-800 hover:bg-gray-700 transition-colors">
        <span class="dark:hidden">üåô</span>
        <span class="hidden dark:inline">‚òÄÔ∏è</span>
      </button>
      
      <!-- Language Selector -->
      <select id="language-select" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <option value="en">üá¨üáß English</option>
        <option value="fr">üá´üá∑ Fran√ßais</option>
      </select>
    </div>
    
    <!-- Main Swap Interface -->
    <main class="glass-card w-full p-6 rounded-2xl space-y-6 container-type:inline-size">
      <header class="text-center">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-indigo-400 to-purple-500 bg-clip-text text-transparent text-balance">
          AetherSwap
        </h1>
        <p class="text-gray-400 mt-1 text-sm">ZK-Powered Solana Swaps</p>
      </header>
      
      <!-- Wallet Connection -->
      <button id="connect-wallet" class="gradient-btn w-full flex items-center justify-center gap-2 py-3 rounded-xl font-medium text-white">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4" />
        </svg>
        <span data-i18n="connect_wallet">Connect Wallet</span>
      </button>
      
      <!-- Swap Form -->
      <div class="space-y-4">
        <!-- From Token -->
        <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700/50">
          <div class="flex justify-between items-center mb-2">
            <label class="block text-sm text-gray-300" data-i18n="from">From</label>
            <div class="text-xs text-gray-400 flex items-center">
              <span data-i18n="balance">Balance</span>: <span id="from-balance" class="ml-1 font-medium">0</span>
              <button id="max-btn" class="ml-2 text-indigo-400 hover:text-indigo-300 text-xs font-medium" data-i18n="max">Max</button>
            </div>
          </div>
          <div class="flex items-center justify-between gap-2">
            <input id="from-amount" type="number" min="0" step="any" placeholder="0.0" 
                   class="token-input text-2xl font-medium w-full bg-transparent focus:outline-none text-white" />
            <token-select id="from-token"></token-select>
          </div>
        </div>
        
        <!-- Swap Direction -->
        <div class="flex justify-center -my-3 z-10 relative">
          <button id="swap-direction" class="swap-btn bg-gray-800 p-3 rounded-full border-2 border-gray-700 hover:bg-gray-700 shadow-lg transition-transform duration-300 hover:rotate-180">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
            </svg>
          </button>
        </div>
        
        <!-- To Token -->
        <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700/50">
          <div class="flex justify-between items-center mb-2">
            <label class="block text-sm text-gray-300" data-i18n="to">To</label>
            <div class="text-xs text-gray-400">
              <span data-i18n="balance">Balance</span>: <span id="to-balance" class="ml-1 font-medium">0</span>
            </div>
          </div>
          <div class="flex items-center justify-between gap-2">
            <input id="to-amount" type="text" placeholder="0.0" disabled
                   class="token-input text-2xl font-medium w-full bg-transparent text-white" />
            <token-select id="to-token"></token-select>
          </div>
        </div>
      </div>
      
      <!-- Advanced Settings -->
      <details class="bg-gray-800/30 rounded-lg overflow-hidden">
        <summary class="px-4 py-3 text-sm cursor-pointer flex justify-between items-center">
          <span data-i18n="advanced_settings">Advanced Settings</span>
          <svg class="w-4 h-4 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </summary>
        <div class="px-4 pb-3 pt-1 space-y-3">
          <!-- Slippage -->
          <div class="flex justify-between items-center text-sm">
            <label for="slippage" class="text-gray-300" data-i18n="slippage">Slippage tolerance:</label>
            <div class="flex gap-2">
              <button class="slippage-btn px-2 py-1 rounded text-xs bg-gray-700 hover:bg-gray-600" value="0.1">0.1%</button>
              <button class="slippage-btn px-2 py-1 rounded text-xs bg-indigo-600 text-white" value="0.5">0.5%</button>
              <button class="slippage-btn px-2 py-1 rounded text-xs bg-gray-700 hover:bg-gray-600" value="1">1%</button>
            </div>
          </div>
          
          <!-- Turbo Mode -->
          <div class="flex justify-between items-center text-sm">
            <label class="text-gray-300" data-i18n="turbo_mode">Turbo Mode:</label>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="turbo-toggle" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:bg-indigo-600 transition-colors">
                <div class="absolute top-0.5 left-0.5 bg-white border border-gray-300 rounded-full h-5 w-5 transition-transform peer-checked:translate-x-full"></div>
              </div>
            </label>
          </div>
          
          <!-- Private Swap -->
          <div class="flex justify-between items-center text-sm">
            <label class="text-gray-300" data-i18n="private_swap">Private Swap (ZK):</label>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="zk-toggle" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:bg-indigo-600 transition-colors">
                <div class="absolute top-0.5 left-0.5 bg-white border border-gray-300 rounded-full h-5 w-5 transition-transform peer-checked:translate-x-full"></div>
              </div>
            </label>
          </div>
        </div>
      </details>
      
      <!-- Swap Button -->
      <button id="swap-btn" class="gradient-btn w-full py-3 rounded-xl font-bold text-white text-lg shadow-lg hover:shadow-indigo-500/20 transition-all" data-i18n="swap">
        Swap Now
      </button>
      
      <!-- Transaction Status -->
      <div id="tx-status" class="min-h-[24px] text-center text-sm">
        <!-- Dynamic content -->
      </div>
      
      <!-- Network Status -->
      <div class="flex items-center justify-center gap-2 text-xs text-gray-400">
        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        <span>Solana Mainnet</span>
      </div>
    </main>
  </div>
  
  <!-- Custom Token Select Element -->
  <template id="token-select-template">
    <div class="relative">
      <button class="token-select-button flex items-center gap-2 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm min-w-[120px]">
        <span class="token-icon">üü£</span>
        <span class="token-symbol">SOL</span>
        <svg class="w-4 h-4 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <div class="token-dropdown hidden absolute z-10 mt-1 w-full bg-gray-800 border border-gray-700 rounded-lg shadow-lg overflow-hidden">
        <div class="p-2 border-b border-gray-700">
          <input type="text" placeholder="Search tokens..." class="w-full p-2 bg-gray-900 rounded text-sm">
        </div>
        <div class="max-h-60 overflow-y-auto">
          <!-- Tokens populated by JS -->
        </div>
      </div>
    </div>
  </template>
  
  <!-- Transaction Dialog -->
  <dialog id="tx-dialog" class="bg-gray-800 rounded-xl border border-gray-700 backdrop:bg-black/50 p-0 max-w-md w-full">
    <div class="p-6 space-y-4">
      <h3 class="text-xl font-bold text-center" data-i18n="confirm_swap">Confirm Swap</h3>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-400" data-i18n="rate">Rate</span>
          <span id="tx-rate">1 SOL = 24.52 USDC</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-400" data-i18n="minimum_received">Minimum received</span>
          <span id="tx-min-received">24.42 USDC</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-400" data-i18n="price_impact">Price impact</span>
          <span id="tx-price-impact">0.12%</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-400" data-i18n="network_fee">Network fee</span>
          <span id="tx-network-fee">0.0005 SOL</span>
        </div>
      </div>
      <div class="pt-4 flex gap-3">
        <button id="tx-cancel" class="flex-1 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors" data-i18n="cancel">Cancel</button>
        <button id="tx-confirm" class="flex-1 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg transition-colors" data-i18n="confirm">Confirm</button>
      </div>
    </div>
  </dialog>
  
  <!-- JavaScript Implementation -->
  <script type="module">
    // ======== CONSTANTS ========
    const RPC_ENDPOINT = 'https://api.mainnet-beta.solana.com';
    const DEFAULT_TOKENS = [
      { symbol: "SOL", mint: "So11111111111111111111111111111111111111112", decimals: 9, icon: "üü£", name: "Solana" },
      { symbol: "USDC", mint: "EPjFWdd5AufqSSqeM2q6DQNpMQcFcSq2GmKkExN6TfK", decimals: 6, icon: "üîµ", name: "USD Coin" },
      { symbol: "USDT", mint: "Es9vMFrzaCERaEfeT5gDEgCk5kL7zESg8TLEosrpT5wE", decimals: 6, icon: "üü¢", name: "Tether USD" }
    ];
    
    // ======== STATE ========
    let state = {
      wallet: null,
      tokens: [...DEFAULT_TOKENS],
      balances: {},
      rates: {},
      slippage: 0.5,
      turboMode: false,
      zkMode: false,
      language: 'en',
      connection: new solanaWeb3.Connection(RPC_ENDPOINT, 'confirmed')
    };
    
    // ======== TRANSLATIONS ========
    const translations = {
      en: {
        connect_wallet: "Connect Wallet",
        connected: "Connected",
        from: "From",
        to: "To",
        balance: "Balance",
        max: "Max",
        advanced_settings: "Advanced Settings",
        slippage: "Slippage tolerance:",
        turbo_mode: "Turbo Mode:",
        private_swap: "Private Swap (ZK):",
        swap: "Swap Now",
        confirm_swap: "Confirm Swap",
        rate: "Rate",
        minimum_received: "Minimum received",
        price_impact: "Price impact",
        network_fee: "Network fee",
        cancel: "Cancel",
        confirm: "Confirm",
        wallet_not_connected: "Please connect your wallet",
        invalid_amount: "Please enter a valid amount",
        fetching_quote: "Fetching quote...",
        processing_transaction: "Processing transaction...",
        swap_failed: "Swap failed",
        swap_success: "Swap successful!"
      },
      fr: {
        connect_wallet: "Connecter Portefeuille",
        connected: "Connect√©",
        from: "De",
        to: "√Ä",
        balance: "Solde",
        max: "Max",
        advanced_settings: "Param√®tres Avanc√©s",
        slippage: "Tol√©rance de slippage :",
        turbo_mode: "Mode Turbo :",
        private_swap: "√âchange Priv√© (ZK) :",
        swap: "√âchanger Maintenant",
        confirm_swap: "Confirmer l'√âchange",
        rate: "Taux",
        minimum_received: "Minimum re√ßu",
        price_impact: "Impact sur le prix",
        network_fee: "Frais de r√©seau",
        cancel: "Annuler",
        confirm: "Confirmer",
        wallet_not_connected: "Veuillez connecter votre portefeuille",
        invalid_amount: "Veuillez entrer un montant valide",
        fetching_quote: "Obtention du devis...",
        processing_transaction: "Traitement de la transaction...",
        swap_failed: "√âchange √©chou√©",
        swap_success: "√âchange r√©ussi !"
      }
    };
    
    // ======== UTILITY FUNCTIONS ========
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }
    
    function updateLanguage(lang) {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = translations[lang][key] || translations['en'][key];
      });
    }
    
    // ======== WEB COMPONENTS ========
    class TokenSelect extends HTMLElement {
      constructor() {
        super();
        const template = document.getElementById('token-select-template').content;
        this.attachShadow({ mode: 'open' }).appendChild(template.cloneNode(true));
        
        this.button = this.shadowRoot.querySelector('.token-select-button');
        this.dropdown = this.shadowRoot.querySelector('.token-dropdown');
        this.search = this.shadowRoot.querySelector('input');
        this.list = this.shadowRoot.querySelector('.token-dropdown > div');
        this.selectedToken = DEFAULT_TOKENS[0];
        
        this.button.addEventListener('click', () => this.toggleDropdown());
        document.addEventListener('click', (e) => {
          if (!this.contains(e.target)) this.closeDropdown();
        });
      }
      
      toggleDropdown() {
        this.dropdown.classList.toggle('hidden');
      }
      
      closeDropdown() {
        this.dropdown.classList.add('hidden');
      }
      
      setTokens(tokens) {
        this.list.innerHTML = '';
        tokens.forEach(token => {
          const item = document.createElement('div');
          item.className = 'flex items-center p-3 hover:bg-gray-700 cursor-pointer';
          item.innerHTML = `
            <span class="mr-2">${token.icon || 'üü¢'}</span>
            <span class="flex-1">${token.symbol}</span>
            <span class="text-gray-400 text-sm">${token.name || ''}</span>
          `;
          item.addEventListener('click', () => {
            this.selectToken(token);
            this.closeDropdown();
          });
          this.list.appendChild(item);
        });
      }
      
      selectToken(token) {
        this.selectedToken = token;
        this.shadowRoot.querySelector('.token-icon').textContent = token.icon || 'üü¢';
        this.shadowRoot.querySelector('.token-symbol').textContent = token.symbol;
        this.dispatchEvent(new CustomEvent('token-change', { detail: token }));
      }
    }
    
    customElements.define('token-select', TokenSelect);
    
    // ======== INITIALIZATION ========
    document.addEventListener('DOMContentLoaded', async () => {
      await initTheme();
      await initLanguage();
      await initTokenList();
      initEventListeners();
      
      // Check for wallet
      if ('solana' in window) {
        try {
          await connectWallet();
        } catch (e) {
          console.error('Wallet connection error:', e);
        }
      }
    });
    
    async function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (savedTheme === 'dark' || (!savedTheme && systemDark)) {
        document.documentElement.setAttribute('data-theme', 'dark');
      } else {
        document.documentElement.setAttribute('data-theme', 'light');
      }
      
      document.getElementById('theme-toggle').addEventListener('click', () => {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
      });
    }
    
    async function initLanguage() {
      const savedLang = localStorage.getItem('language') || navigator.language.slice(0, 2) || 'en';
      state.language = ['en', 'fr'].includes(savedLang) ? savedLang : 'en';
      document.getElementById('language-select').value = state.language;
      updateLanguage(state.language);
      
      document.getElementById('language-select').addEventListener('change', (e) => {
        state.language = e.target.value;
        localStorage.setItem('language', state.language);
        updateLanguage(state.language);
      });
    }
    
    async function initTokenList() {
      try {
        // Initialize token selects
        document.querySelectorAll('token-select').forEach(select => {
          select.setTokens(state.tokens);
          // Set default tokens
          if (select.id === 'from-token') {
            select.selectToken(DEFAULT_TOKENS[0]); // SOL
          } else if (select.id === 'to-token') {
            select.selectToken(DEFAULT_TOKENS[1]); // USDC
          }
        });
      } catch (e) {
        console.error('Failed to load token list:', e);
      }
    }
    
    function initEventListeners() {
      // Wallet connection
      document.getElementById('connect-wallet').addEventListener('click', connectWallet);
      
      // Swap direction
      document.getElementById('swap-direction').addEventListener('click', () => {
        const fromSelect = document.getElementById('from-token');
        const toSelect = document.getElementById('to-token');
        
        // Swap tokens
        [fromSelect.selectedToken, toSelect.selectedToken] = [toSelect.selectedToken, fromSelect.selectedToken];
        fromSelect.selectToken(fromSelect.selectedToken);
        toSelect.selectToken(toSelect.selectedToken);
        
        // Keep amounts but recalculate
        updateQuote();
      });
      
      // Max button
      document.getElementById('max-btn').addEventListener('click', () => {
        const fromAmount = document.getElementById('from-amount');
        fromAmount.value = document.getElementById('from-balance').textContent;
        updateQuote();
      });
      
      // Amount input
      document.getElementById('from-amount').addEventListener('input', debounce(updateQuote, 300));
      
      // Slippage buttons
      document.querySelectorAll('.slippage-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          state.slippage = parseFloat(btn.value);
          document.querySelectorAll('.slippage-btn').forEach(b => 
            b.classList.toggle('bg-indigo-600', b === btn));
          updateQuote();
        });
      });
      
      // Turbo mode toggle
      document.getElementById('turbo-toggle').addEventListener('change', (e) => {
        state.turboMode = e.target.checked;
      });
      
      // ZK mode toggle
      document.getElementById('zk-toggle').addEventListener('change', (e) => {
        state.zkMode = e.target.checked;
      });
      
      // Swap button
      document.getElementById('swap-btn').addEventListener('click', prepareSwap);
      
      // Token select changes
      document.getElementById('from-token').addEventListener('token-change', async (e) => {
        await updateBalances();
        updateQuote();
      });
      
      document.getElementById('to-token').addEventListener('token-change', async (e) => {
        await updateBalances();
        updateQuote();
      });
      
      // Transaction dialog
      document.getElementById('tx-cancel').addEventListener('click', () => {
        document.getElementById('tx-dialog').close();
      });
    }
    
    // ======== WALLET FUNCTIONS ========
    async function connectWallet() {
      if (!window.solana || !window.solana.isPhantom) {
        showError('Please install Phantom Wallet');
        return;
      }
      
      try {
        const response = await window.solana.connect();
        state.wallet = new solanaWeb3.PublicKey(response.publicKey.toString());
        updateWalletUI();
        await updateBalances();
      } catch (e) {
        showError('Wallet connection failed');
        console.error(e);
      }
    }
    
    function updateWalletUI() {
      const btn = document.getElementById('connect-wallet');
      if (state.wallet) {
        const shortAddress = `${state.wallet.toString().slice(0, 4)}...${state.wallet.toString().slice(-4)}`;
        btn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
          <span>${shortAddress}</span>
        `;
      } else {
        btn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4" />
          </svg>
          <span>${translations[state.language].connect_wallet}</span>
        `;
      }
    }
    
    // ======== BALANCE & QUOTE FUNCTIONS ========
    async function updateBalances() {
      if (!state.wallet) return;
      
      const fromToken = document.getElementById('from-token').selectedToken;
      const toToken = document.getElementById('to-token').selectedToken;
      
      try {
        const [fromBal, toBal] = await Promise.all([
          getTokenBalance(state.wallet, fromToken.mint, fromToken.decimals),
          getTokenBalance(state.wallet, toToken.mint, toToken.decimals)
        ]);
        
        document.getElementById('from-balance').textContent = fromBal.toFixed(4);
        document.getElementById('to-balance').textContent = toBal.toFixed(4);
      } catch (e) {
        console.error('Failed to update balances:', e);
      }
    }
    
    async function getTokenBalance(publicKey, mintAddress, decimals) {
      if (mintAddress === "So11111111111111111111111111111111111111112") {
        // SOL balance
        const balance = await state.connection.getBalance(publicKey);
        return balance / Math.pow(10, decimals);
      } else {
        // SPL token balance
        const accounts = await state.connection.getTokenAccountsByOwner(
          publicKey, 
          { mint: new solanaWeb3.PublicKey(mintAddress) }
        );
        
        if (accounts.value.length === 0) return 0;
        
        const accountInfo = accounts.value[0].account.data;
        const amount = new DataView(accountInfo).getBigUint64(64, true);
        
        return Number(amount) / Math.pow(10, decimals);
      }
    }
    
    async function updateQuote() {
      const fromAmount = parseFloat(document.getElementById('from-amount').value);
      if (!fromAmount || fromAmount <= 0) {
        document.getElementById('to-amount').value = '';
        return;
      }
      
      const fromToken = document.getElementById('from-token').selectedToken;
      const toToken = document.getElementById('to-token').selectedToken;
      
      showLoading('fetching_quote');
      
      try {
        // Simulate rate - in a real app you would fetch this from an API
        const rate = await simulateExchangeRate(fromToken, toToken, fromAmount);
        const toAmount = fromAmount * rate;
        
        document.getElementById('to-amount').value = toAmount.toFixed(6);
        
        // Update transaction dialog preview
        document.getElementById('tx-rate').textContent = `1 ${fromToken.symbol} = ${rate.toFixed(6)} ${toToken.symbol}`;
        document.getElementById('tx-min-received').textContent = `${(toAmount * (1 - state.slippage/100)).toFixed(6)} ${toToken.symbol}`;
        document.getElementById('tx-price-impact').textContent = "0.12%"; // Simulated
        document.getElementById('tx-network-fee').textContent = "0.0005 SOL"; // Simulated
        
        clearStatus();
      } catch (e) {
        showError('Failed to get quote');
        console.error(e);
      }
    }
    
    async function simulateExchangeRate(fromToken, toToken, amount) {
      // Simulate different rates based on token pairs
      if (fromToken.symbol === 'SOL' && toToken.symbol === 'USDC') {
        return 24.5 + (Math.random() * 0.5 - 0.25); // Randomize slightly
      } else if (fromToken.symbol === 'USDC' && toToken.symbol === 'SOL') {
        return 1/24.5 + (Math.random() * 0.01 - 0.005);
      } else if (fromToken.symbol === 'USDT' && toToken.symbol === 'USDC') {
        return 0.99 + (Math.random() * 0.02 - 0.01);
      } else {
        return 1.0; // Default 1:1 for unknown pairs
      }
    }
    
    // ======== SWAP EXECUTION ========
    async function prepareSwap() {
      if (!state.wallet) {
        showError('wallet_not_connected');
        return;
      }
      
      const fromAmount = parseFloat(document.getElementById('from-amount').value);
      if (!fromAmount || fromAmount <= 0) {
        showError('invalid_amount');
        return;
      }
      
      // Show confirmation dialog
      const dialog = document.getElementById('tx-dialog');
      dialog.showModal();
      
      // Dialog event listeners
      document.getElementById('tx-confirm').addEventListener('click', () => {
        dialog.close();
        executeSwap();
      }, { once: true });
    }
    
    async function executeSwap() {
      const fromToken = document.getElementById('from-token').selectedToken;
      const toToken = document.getElementById('to-token').selectedToken;
      const fromAmount = parseFloat(document.getElementById('from-amount').value);
      const toAmount = parseFloat(document.getElementById('to-amount').value);
      
      showLoading('processing_transaction');
      
      try {
        //