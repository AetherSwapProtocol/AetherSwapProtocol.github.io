<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AetherSwap | Production Ready DEX</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Solana Web3.js (stable version) -->
  <script src="https://unpkg.com/@solana/web3.js@1.70.1/lib/index.iife.min.js"></script>

  <!-- Phantom SDK (restauration temporaire à latest pour que ça fonctionne) -->
  <script src="https://unpkg.com/@phantom-labs/inject-sdk@latest/dist/sdk.js"></script>

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-papLFy+dIw7pz8T+pGRjtxuS8NXk5sBoEULjZkk+RV8P0Qr6YdC1+xOh6Ba7D08F9+nH1cc0GbvZDrsWkF3MpA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <!-- Google Fonts: Space Grotesk -->
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    body {
      font-family: 'Space Grotesk', sans-serif;
    }
  </style>
</head>
        :root {
            --primary: #7e22ce;
            --secondary: #3b82f6;
            --dark: #0a0a0a;
            --darker: #111827;
            --darkest: #1f2937;
        }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: var(--dark);
            color: white;
            min-height: 100vh;
            padding-bottom: 80px; /* Space for mobile nav */
        }
        
        .gradient-text {
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .gradient-border {
            position: relative;
            border-radius: 1rem;
        }
        
        .gradient-border::before {
            content: "";
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: inherit;
            background: linear-gradient(45deg, var(--primary), var(--secondary), var(--primary));
            z-index: -1;
            background-size: 200% 200%;
            animation: gradient 3s ease infinite;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .swap-container {
            background-color: var(--darker);
            border-radius: 1rem;
        }
        
        .token-selector {
            background-color: var(--darkest);
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .token-selector:hover {
            background-color: #374151;
        }
        
        .swap-button {
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            transition: all 0.2s;
        }
        
        .swap-button:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .mobile-nav {
            backdrop-filter: blur(10px);
        }
        
        .nav-icon {
            transition: all 0.3s;
        }
        
        .nav-icon.active {
            color: var(--primary);
        }
        
        .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: all 0.2s;
        }
        
        .tooltip-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Main Navigation -->
    <nav class="container mx-auto px-6 py-6 flex justify-between items-center">
        <a href="index.html" class="flex items-center space-x-2">
            <div class="w-10 h-10 rounded-full gradient-border flex items-center justify-center">
                <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center">
                    ←
                </div>
            </div>
            <span class="text-2xl font-bold gradient-text">AetherSwap</span>
        </a>
        <button id="connect-wallet" class="gradient-border px-6 py-2 rounded-full font-medium hover:opacity-90 transition">
            Connect Wallet
        </button>
    </nav>

    <!-- Main Swap Interface -->
    <main class="container mx-auto px-4 py-8 max-w-md">
        <div class="gradient-border p-1 rounded-2xl">
            <div class="swap-container rounded-2xl p-6">
                <div class="flex flex-col space-y-4">
                    <!-- From Token Section -->
                    <div class="bg-gray-800 rounded-xl p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-400">From</span>
                            <span id="from-balance" class="text-sm text-gray-400">Balance: 0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <input id="from-amount" type="number" placeholder="0.0" 
                                   class="bg-transparent text-2xl w-full outline-none">
                            <div class="flex items-center space-x-2 token-selector px-3 py-2 rounded-lg" id="from-token-selector">
                                <img src="https://raw.githubusercontent.com/solana-labs/token-list/main/assets/mainnet/So11111111111111111111111111111111111111112/logo.png" alt="SOL" class="w-6 h-6">
                                <span>SOL</span>
                                <span>▼</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Switch Tokens Button -->
                    <div class="flex justify-center">
                        <button id="switch-tokens" class="p-2 rounded-full bg-gray-800 hover:bg-gray-700 transition">
                            ↓↑
                        </button>
                    </div>
                    
                    <!-- To Token Section -->
                    <div class="bg-gray-800 rounded-xl p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-400">To</span>
                            <span id="to-balance" class="text-sm text-gray-400">Balance: 0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <input id="to-amount" type="number" placeholder="0.0" 
                                   class="bg-transparent text-2xl w-full outline-none" disabled>
                            <div class="flex items-center space-x-2 token-selector px-3 py-2 rounded-lg" id="to-token-selector">
                                <img src="https://raw.githubusercontent.com/solana-labs/token-list/main/assets/mainnet/A1B2C3.../logo.png" alt="USDC" class="w-6 h-6">
                                <span>USDC</span>
                                <span>▼</span>
                            </div>
                        </div>
                    </div>

                    <!-- Price Info -->
                    <div id="price-info" class="text-center text-sm text-gray-400">
                        Loading price...
                    </div>

                    <!-- Slippage Settings -->
                    <div class="pt-2">
                        <div class="flex justify-between items-center text-xs text-gray-400 mb-1">
                            <div class="flex items-center space-x-1 tooltip-container">
                                <span>Slippage</span>
                                <i class="fas fa-info-circle text-xs"></i>
                                <span class="tooltip absolute z-10 bg-gray-900 text-white text-xs p-2 rounded w-40">
                                    Maximum price difference you're willing to accept
                                </span>
                            </div>
                            <span id="slippage-value">0.5%</span>
                        </div>
                        <input type="range" id="slippage" min="0.1" max="5" step="0.1" value="0.5" class="w-full">
                    </div>

                    <!-- Fees Info -->
                    <div id="swap-fees" class="text-center text-xs text-gray-400">
                        Fees: -
                    </div>
                    
                    <!-- Swap Button -->
                    <div class="pt-2">
                        <button id="swap-button" class="swap-button rounded-lg py-3 font-semibold w-full" disabled>
                            Swap
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Token Selector Modal -->
    <div id="token-selector-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-xl max-w-md w-full max-h-[80vh] overflow-hidden gradient-border">
            <div class="bg-gray-900 rounded-xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Select Token</h3>
                    <button id="close-token-selector" class="text-2xl hover:text-purple-400">&times;</button>
                </div>
                
                <!-- Token Search -->
                <div class="relative mb-4">
                    <div class="flex items-center px-4 py-2 bg-gray-800 rounded-lg">
                        <i class="fas fa-search text-gray-400 mr-2"></i>
                        <input type="text" id="token-search-input" placeholder="Search token..." 
                               class="w-full bg-transparent outline-none text-sm">
                    </div>
                </div>
                
                <!-- Popular Tokens -->
                <div class="mb-4">
                    <h4 class="text-sm font-medium mb-2">Popular Tokens</h4>
                    <div class="flex flex-wrap gap-2">
                        <button class="px-3 py-1 bg-gray-800 rounded-lg hover:bg-gray-700 transition" data-token="SOL">SOL</button>
                        <button class="px-3 py-1 bg-gray-800 rounded-lg hover:bg-gray-700 transition" data-token="USDC">USDC</button>
                        <button class="px-3 py-1 bg-gray-800 rounded-lg hover:bg-gray-700 transition" data-token="BONK">BONK</button>
                        <button class="px-3 py-1 bg-gray-800 rounded-lg hover:bg-gray-700 transition" data-token="USDT">USDT</button>
                    </div>
                </div>
                
                <!-- Token List -->
                <div class="border-t border-gray-800 pt-4">
                    <div class="flex justify-between text-xs text-gray-400 mb-2">
                        <span>Token</span>
                        <span>Balance</span>
                    </div>
                    
                    <div id="token-list" class="overflow-y-auto max-h-[40vh] pr-2">
                        <!-- Tokens will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="w-full mt-6 mb-4 select-none">
        <div class="max-w-5xl mx-auto flex flex-col md:flex-row items-center justify-center gap-4 text-sm text-gray-400 text-center">
            <span class="w-full md:w-auto">
                © 2025 AetherSwap Protocol. All rights reserved.
                <a href="https://github.com/aetherswapprotocol/AetherSwapProtocol/blob/main/LICENSE" target="_blank" rel="noopener noreferrer" class="underline hover:text-white ml-1">
                
                </a>
            </span>

            <a href="https://t.me/AetherFounder" 
               target="_blank" 
               rel="noopener noreferrer"
               class="gradient-border flex items-center gap-1 px-3 py-1 font-medium hover:opacity-80 transition rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M21.5 3.5l-19 7.5 5.5 2.5 1.5 6 2.5-7 4 3.5 5-14z"/>
                </svg>
                <span>Founder</span>
            </a>
        </div>
    </footer>

    <!-- Mobile Navigation -->
    <div id="mobile-navbar" class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-900/75 backdrop-blur-md border-t border-gray-800 z-50 shadow-lg">
        <div class="flex items-center justify-around py-3 px-4">
            <!-- Swap Button -->
            <a href="swap.html" class="nav-link flex flex-col items-center text-xs px-4 py-1 rounded-lg transition">
                <div class="w-10 h-10 mb-1 flex items-center justify-center rounded-full bg-gray-800 hover:bg-purple-700 transition">
                    <i class="fas fa-exchange-alt text-lg nav-icon"></i>
                </div>
                <span>Swap</span>
            </a>
            
            <!-- Menu Button -->
            <button id="menu-btn" class="flex flex-col items-center text-xs px-4 py-1 rounded-lg transition">
                <div class="w-10 h-10 mb-1 -mt-4 flex items-center justify-center rounded-full bg-gradient-to-r from-purple-600 to-blue-500 shadow-lg transition">
                    <i class="fas fa-bars text-xl"></i>
                </div>
                <span>Menu</span>
            </button>
            
            <!-- LaunchLab Button -->
            <a href="launchlab.html" class="nav-link flex flex-col items-center text-xs px-4 py-1 rounded-lg transition">
                <div class="w-10 h-10 mb-1 flex items-center justify-center rounded-full bg-gray-800 hover:bg-purple-700 transition">
                    <i class="fas fa-rocket text-lg nav-icon"></i>
                </div>
                <span>LaunchLab</span>
            </a>
        </div>
    </div>

    <!-- Menu Popup -->
    <div id="menu-popup" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden z-60 flex flex-col items-center justify-center p-6">
        <div class="bg-gray-900 rounded-lg shadow-lg w-full max-w-sm p-6 space-y-6 text-center">
            <h2 class="gradient-text text-xl font-semibold mb-4">Main Menu</h2>
            <a href="index.html" class="block py-3 px-6 rounded-md bg-gradient-to-r from-purple-600 to-blue-500 text-white font-semibold transition">Back to Home</a>
            <button id="close-menu" class="mt-6 px-5 py-2 rounded-md border border-purple-400 text-purple-400 hover:bg-purple-400 hover:text-gray-900 transition">Close</button>
        </div>
    </div>

    <script>
        // Configuration Constants
        const TOKENS = {
            SOL: {
                name: "SOL",
                mint: "So11111111111111111111111111111111111111112",
                decimals: 9,
                logo: "https://cryptologos.cc/logos/solana-sol-logo.png"
            },
            USDC: {
                name: "USDC",
                mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
                decimals: 6,
                logo: "https://cryptologos.cc/logos/usd-coin-usdc-logo.png"
            },
            BONK: {
                name: "BONK",
                mint: "DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263",
                decimals: 5,
                logo: "https://arweave.net/hQiPZOsRZXGXBJd_82PhVdlM_hACsT_q6wqwf5cSY7I"
            },
            USDT: {
                name: "USDT",
                mint: "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB",
                decimals: 6,
                logo: "https://cryptologos.cc/logos/tether-usdt-logo.png"
            }
        };

        // Application State
        const state = {
            fromToken: TOKENS.SOL,
            toToken: TOKENS.USDC,
            fromAmount: 0,
            toAmount: 0,
            walletConnected: false,
            walletPublicKey: null,
            currentPrice: 0,
            loading: false,
            slippage: 0.5,
            currentSelectorTarget: null
        };

        // Price Cache
        const PRICE_CACHE = {};
        const CACHE_DURATION = 30000; // 30 seconds

        // Initialize Solana Connection
        const connection = new solanaWeb3.Connection(
            solanaWeb3.clusterApiUrl('mainnet-beta'), 
            'confirmed'
        );

        // DOM Elements
        const elements = {
            connectWalletBtn: document.getElementById('connect-wallet'),
            fromAmountInput: document.getElementById('from-amount'),
            toAmountInput: document.getElementById('to-amount'),
            fromBalance: document.getElementById('from-balance'),
            toBalance: document.getElementById('to-balance'),
            fromTokenSelector: document.getElementById('from-token-selector'),
            toTokenSelector: document.getElementById('to-token-selector'),
            switchTokensBtn: document.getElementById('switch-tokens'),
            swapButton: document.getElementById('swap-button'),
            priceInfo: document.getElementById('price-info'),
            slippageInput: document.getElementById('slippage'),
            slippageValue: document.getElementById('slippage-value'),
            swapFees: document.getElementById('swap-fees'),
            tokenSelectorModal: document.getElementById('token-selector-modal'),
            closeTokenSelector: document.getElementById('close-token-selector'),
            tokenSearchInput: document.getElementById('token-search-input'),
            tokenList: document.getElementById('token-list'),
            mobileNavbar: document.getElementById('mobile-navbar'),
            menuBtn: document.getElementById('menu-btn'),
            menuPopup: document.getElementById('menu-popup'),
            closeMenuBtn: document.getElementById('close-menu')
        };

        // Initialize Application
        function init() {
            setupEventListeners();
            updateTokenSelectors();
            fetchPrice();
            updateSlippage();
            highlightActiveNavLink();
        }

        // Set Up Event Listeners
        function setupEventListeners() {
            elements.connectWalletBtn.addEventListener('click', connectWallet);
            elements.fromAmountInput.addEventListener('input', () => debounce(updateToAmount, 500));
            elements.switchTokensBtn.addEventListener('click', switchTokens);
            elements.swapButton.addEventListener('click', executeSwap);
            elements.slippageInput.addEventListener('input', updateSlippage);
            elements.fromTokenSelector.addEventListener('click', () => openTokenSelector('from'));
            elements.toTokenSelector.addEventListener('click', () => openTokenSelector('to'));
            elements.closeTokenSelector.addEventListener('click', closeModal);
            elements.tokenSearchInput.addEventListener('input', searchTokens);
            
            // Mobile menu events
            elements.menuBtn.addEventListener('click', openMenu);
            elements.closeMenuBtn.addEventListener('click', closeMenu);
            elements.menuPopup.addEventListener('click', (e) => {
                if (e.target === elements.menuPopup) closeMenu();
            });
            
            // Add click handlers for token chips
            document.querySelectorAll('[data-token]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tokenName = e.target.dataset.token;
                    selectToken(tokenName);
                });
            });
        }

        // Highlight Active Navigation Link
        function highlightActiveNavLink() {
            const currentPage = window.location.pathname.split('/').pop();
            document.querySelectorAll('.nav-link').forEach(link => {
                const href = link.getAttribute('href');
                if (href === currentPage) {
                    link.classList.add('text-purple-400');
                    link.querySelector('.nav-icon').classList.add('text-purple-400');
                }
            });
        }

        // Debounce Function
        let debounceTimer;
        function debounce(func, delay) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(func, delay);
        }

        // Connect Wallet
        async function connectWallet() {
            try {
                if (window.phantom?.solana?.isPhantom) {
                    setLoading(true, elements.connectWalletBtn);
                    
                    const provider = window.phantom.solana;
                    const response = await provider.connect();
                    state.walletPublicKey = response.publicKey.toString();
                    state.walletConnected = true;
                    
                    elements.connectWalletBtn.textContent = 
                        `${state.walletPublicKey.slice(0, 4)}...${state.walletPublicKey.slice(-4)}`;
                    
                    await loadBalances();
                    updateSwapButton();
                    
                    setLoading(false, elements.connectWalletBtn);
                } else {
                    window.open('https://phantom.app/', '_blank');
                    throw new Error('Phantom Wallet not installed');
                }
            } catch (error) {
                console.error('Connection error:', error);
                setLoading(false, elements.connectWalletBtn);
                elements.connectWalletBtn.textContent = 'Connect Wallet';
                showError(`Error: ${error.message}`, true);
            }
        }

        // Load Token Balances
        async function loadBalances() {
            if (!state.walletConnected) return;
            
            try {
                setLoading(true);
                
                // Load SOL balance
                if (state.fromToken.name === 'SOL' || state.toToken.name === 'SOL') {
                    const solBalance = await connection.getBalance(
                        new solanaWeb3.PublicKey(state.walletPublicKey)
                    );
                    const solBalanceElement = state.fromToken.name === 'SOL' ? elements.fromBalance : elements.toBalance;
                    solBalanceElement.textContent = `Balance: ${(solBalance / solanaWeb3.LAMPORTS_PER_SOL).toFixed(2)}`;
                }
                
                // Load token balances
                for (const token of [state.fromToken, state.toToken]) {
                    if (token.name === 'SOL') continue;
                    
                    const balanceElement = token === state.fromToken ? elements.fromBalance : elements.toBalance;
                    const accounts = await connection.getTokenAccountsByOwner(
                        new solanaWeb3.PublicKey(state.walletPublicKey),
                        { mint: new solanaWeb3.PublicKey(token.mint) }
                    );
                    
                    if (accounts.value.length > 0) {
                        const balance = await connection.getTokenAccountBalance(accounts.value[0].pubkey);
                        balanceElement.textContent = `Balance: ${(balance.value.uiAmount || 0).toFixed(token.decimals > 5 ? 0 : 2)}`;
                    } else {
                        balanceElement.textContent = `Balance: 0`;
                    }
                }
                
                setLoading(false);
            } catch (error) {
                console.error('Balance load error:', error);
                setLoading(false);
                showError('Failed to load balances', false);
            }
        }

        // Validate Swap Amounts
        function validateAmounts() {
            if (state.fromAmount <= 0) {
                showError("Amount must be greater than 0", false);
                return false;
            }
            if (state.fromToken.name === state.toToken.name) {
                showError("Cannot swap identical tokens", false);
                return false;
            }
            return true;
        }

        // Update Output Amount
        async function updateToAmount() {
            state.fromAmount = parseFloat(elements.fromAmountInput.value) || 0;
            
            if (state.fromAmount > 0) {
                try {
                    setLoading(true, elements.toAmountInput);
                    
                    if (state.currentPrice === 0) {
                        await fetchPrice();
                    }
                    
                    state.toAmount = state.fromAmount * state.currentPrice;
                    elements.toAmountInput.value = state.toAmount.toFixed(state.toToken.decimals);
                    updatePriceInfo();
                    await estimateFees();
                    
                    setLoading(false, elements.toAmountInput);
                } catch (error) {
                    console.error('Price fetch error:', error);
                    setLoading(false, elements.toAmountInput);
                    showError('Failed to calculate amount', false);
                }
            } else {
                elements.toAmountInput.value = '';
                state.toAmount = 0;
                updatePriceInfo();
                elements.swapFees.textContent = 'Fees: -';
            }
            
            updateSwapButton();
        }

        // Fetch Token Price
        async function fetchPrice() {
            const cacheKey = `${state.fromToken.mint}_${state.toToken.mint}`;
            
            if (PRICE_CACHE[cacheKey] && 
                Date.now() - PRICE_CACHE[cacheKey].timestamp < CACHE_DURATION) {
                state.currentPrice = PRICE_CACHE[cacheKey].price;
                updatePriceInfo();
                return;
            }

            try {
                setLoading(true, elements.priceInfo);
                
                const response = await fetch(
                    `https://price.jup.ag/v4/price?ids=${state.fromToken.mint}&vsToken=${state.toToken.mint}`
                );
                const data = await response.json();
                
                PRICE_CACHE[cacheKey] = {
                    price: data.data[state.fromToken.mint].price,
                    timestamp: Date.now()
                };
                
                state.currentPrice = data.data[state.fromToken.mint].price;
                updatePriceInfo();
                setLoading(false, elements.priceInfo);
            } catch (error) {
                console.error('Price fetch error:', error);
                setLoading(false, elements.priceInfo);
                elements.priceInfo.textContent = 'Price unavailable';
                throw error;
            }
        }

        // Estimate Swap Fees
        async function estimateFees() {
            if (!state.fromAmount || state.fromAmount <= 0) return;
            
            try {
                const amountInLamports = state.fromAmount * Math.pow(10, state.fromToken.decimals);
                const quoteResponse = await fetch(
                    `https://quote-api.jup.ag/v4/quote?inputMint=${state.fromToken.mint}&outputMint=${state.toToken.mint}&amount=${amountInLamports}&slippage=${state.slippage}`
                );
                const quoteData = await quoteResponse.json();
                
                if (quoteData.data && quoteData.data.length > 0) {
                    const fees = quoteData.data[0].feeAmount / Math.pow(10, state.toToken.decimals);
                    elements.swapFees.textContent = `Fees: ~${fees.toFixed(6)} ${state.toToken.name}`;
                }
            } catch (error) {
                console.error('Fee estimation error:', error);
                elements.swapFees.textContent = 'Fees: -';
            }
        }

        // Update Price Display
        function updatePriceInfo() {
            if (state.fromAmount > 0 && state.currentPrice > 0) {
                elements.priceInfo.textContent = 
                    `1 ${state.fromToken.name} = ${state.currentPrice.toFixed(6)} ${state.toToken.name}`;
            } else if (state.currentPrice > 0) {
                elements.priceInfo.textContent = 
                    `1 ${state.fromToken.name} = ${state.currentPrice.toFixed(6)} ${state.toToken.name}`;
            }
        }

        // Switch Tokens
        function switchTokens() {
            [state.fromToken, state.toToken] = [state.toToken, state.fromToken];
            updateTokenSelectors();
            elements.fromAmountInput.value = '';
            elements.toAmountInput.value = '';
            state.fromAmount = 0;
            state.toAmount = 0;
            fetchPrice();
            if (state.walletConnected) {
                loadBalances();
            }
            updateSwapButton();
        }

        // Update Token Selectors
        function updateTokenSelectors() {
            elements.fromTokenSelector.innerHTML = `
                <img src="${state.fromToken.logo}" alt="${state.fromToken.name}" class="w-6 h-6">
                <span>${state.fromToken.name}</span>
                <span>▼</span>
            `;
            
            elements.toTokenSelector.innerHTML = `
                <img src="${state.toToken.logo}" alt="${state.toToken.name}" class="w-6 h-6">
                <span>${state.toToken.name}</span>
                <span>▼</span>
            `;
        }

        // Update Slippage
        function updateSlippage() {
            state.slippage = parseFloat(elements.slippageInput.value);
            elements.slippageValue.textContent = `${state.slippage}%`;
            if (state.fromAmount > 0) {
                estimateFees();
            }
        }

        // Update Swap Button State
        function updateSwapButton() {
            elements.swapButton.disabled = !(state.walletConnected && state.fromAmount > 0 && state.toAmount > 0);
        }

        // Execute Swap
        async function executeSwap() {
            if (!validateAmounts()) return;
            
            try {
                setLoading(true, elements.swapButton);
                elements.swapButton.textContent = 'Processing...';
                elements.swapButton.disabled = true;
                
                // Get quote
                const amountInLamports = state.fromAmount * Math.pow(10, state.fromToken.decimals);
                const quoteResponse = await fetch(
                    `https://quote-api.jup.ag/v4/quote?inputMint=${state.fromToken.mint}&outputMint=${state.toToken.mint}&amount=${amountInLamports}&slippage=${state.slippage}`
                );
                const quoteData = await quoteResponse.json();
                
                if (!quoteData.data || quoteData.data.length === 0) {
                    throw new Error('No route found for this swap');
                }
                
                const bestRoute = quoteData.data[0];
                
                // Get swap transaction
                const swapResponse = await fetch('https://quote-api.jup.ag/v4/swap', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        route: bestRoute,
                        userPublicKey: state.walletPublicKey,
                        wrapUnwrapSOL: true
                    })
                });
                
                const swapData = await swapResponse.json();
                
                // Execute swap
                const provider = window.phantom.solana;
                const { signature } = await provider.signAndSendTransaction(
                    new Uint8Array(Object.values(swapData.swapTransaction))
                );
                
                // Show success
                elements.swapButton.textContent = 'Swap Successful!';
                setTimeout(() => {
                    elements.swapButton.textContent = 'Swap';
                    updateSwapButton();
                }, 2000);
                
                // Reset form
                elements.fromAmountInput.value = '';
                elements.toAmountInput.value = '';
                state.fromAmount = 0;
                state.toAmount = 0;
                elements.swapFees.textContent = 'Fees: -';
                
                // Update balances after confirmation
                setTimeout(async () => {
                    await loadBalances();
                }, 3000);
                
            } catch (error) {
                console.error('Swap error:', error);
                elements.swapButton.textContent = 'Swap Failed';
                setTimeout(() => {
                    elements.swapButton.textContent = 'Swap';
                    updateSwapButton();
                }, 2000);
                showError(`Swap failed: ${error.message}`, true);
            } finally {
                setLoading(false, elements.swapButton);
            }
        }

        // Token Selector Modal
        function openTokenSelector(target) {
            state.currentSelectorTarget = target;
            elements.tokenSelectorModal.classList.remove('hidden');
            populateTokenList();
        }

        function closeModal() {
            elements.tokenSelectorModal.classList.add('hidden');
        }

        function populateTokenList() {
            elements.tokenList.innerHTML = '';
            
            Object.values(TOKENS).forEach(token => {
                const tokenElement = document.createElement('div');
                tokenElement.className = 'token-item hover:bg-gray-800 p-3 rounded-lg cursor-pointer';
                tokenElement.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <img src="${token.logo}" alt="${token.name}" class="w-8 h-8 rounded-full">
                        <div>
                            <div class="font-medium">${token.name}</div>
                        </div>
                    </div>
                    <div class="text-gray-400 text-sm">0</div>
                `;
                
                tokenElement.addEventListener('click', () => selectToken(token.name));
                elements.tokenList.appendChild(tokenElement);
            });
        }

        function searchTokens() {
            const searchTerm = elements.tokenSearchInput.value.toLowerCase();
            const tokenItems = elements.tokenList.querySelectorAll('.token-item');
            
            tokenItems.forEach(item => {
                const tokenName = item.querySelector('.font-medium').textContent.toLowerCase();
                item.style.display = tokenName.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        function selectToken(tokenName) {
            if (state.currentSelectorTarget === 'from') {
                state.fromToken = TOKENS[tokenName];
            } else {
                state.toToken = TOKENS[tokenName];
            }
            updateTokenSelectors();
            fetchPrice();
            if (state.walletConnected) {
                loadBalances();
            }
            closeModal();
        }

        // Show Error Message
        function showError(message, isFatal) {
            const errorEl = document.createElement('div');
            errorEl.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl ${
                isFatal ? 'bg-red-600' : 'bg-yellow-500'
            } text-white flex items-start z-50`;
            
            errorEl.innerHTML = `
                <i class="fas fa-exclamation-circle mr-2 mt-0.5"></i>
                <div>
                    <p class="font-medium">${isFatal ? 'Error' : 'Warning'}</p>
                    <p class="text-sm">${message}</p>
                </div>
                <button class="ml-4" onclick="this.parentElement.remove()">
                    &times;
                </button>
            `;
            
            document.body.appendChild(errorEl);
            setTimeout(() => errorEl.remove(), 5000);
        }

        // Set Loading State
        function setLoading(isLoading, element = null) {
            state.loading = isLoading;
            
            if (element) {
                if (isLoading) {
                    element.disabled = true;
                    if (!element.querySelector('.loading-spinner')) {
                        const spinner = document.createElement('div');
                        spinner.className = 'loading-spinner';
                        element.insertBefore(spinner, element.firstChild);
                    }
                } else {
                    element.disabled = false;
                    const spinner = element.querySelector('.loading-spinner');
                    if (spinner) {
                        spinner.remove();
                    }
                }
            }
        }

        // Mobile Menu Functions
        function openMenu() {
            elements.menuPopup.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeMenu() {
            elements.menuPopup.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>