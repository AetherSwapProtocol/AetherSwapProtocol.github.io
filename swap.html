<!DOCTYPE html>
<html lang="fr">
<head>
    <base target="_self">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AetherSwap - DEX Solana (Single-File Demo)</title>
    <meta name="description" content="DEX Solana simple (AetherSwap) - connect Phantom/Solflare, swap SPL tokens via XY=K AMM, show pool liquidity, real-time prices via oracles (Pyth/Switchboard) - single HTML file" />
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" />
    <!-- Tailwind CSS via CDN for rapid UI prototyping -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <script>
      // Tailwind customizations (optional)
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#0b5ed7",
              secondary: "#1f2a44",
              surface: "#0b1220",
              card: "#0e1a2b",
              accent: "#22c55e",
              warning: "#f59e0b"
            },
            fontFamily: {
              sans: ["Inter", "ui-sans-serif", "system-ui"]
            }
          }
        }
      }
    </script>
    <style>
      /* Minimal extra CSS for tiny UI touches, kept simple for a single-file approach */
      .token-row { align-items: center; display: flex; gap: 0.5rem; }
      .token-logo { width: 28px; height: 28px; border-radius: 6px; object-fit: cover; }
      .card { border-radius: 12px; }
      .shadow-soft { box-shadow: 0 8px 24px rgba(0,0,0,.08); }
      .glow { box-shadow: 0 0 0 0 rgba(34,197,94,0.0); transition: box-shadow .2s ease; }
      .glow:hover { box-shadow: 0 0 0 6px rgba(34,197,94,.15); }
      .dropdown { position: relative; display: inline-block; }
      .dropdown-menu { position: absolute; z-index: 50; top: 100%; left: 0; min-width: 240px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 6px; margin-top: 6px; }
      .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">

  <!-- Header / Navbar -->
  <header class="bg-white shadow-sm">
    <nav class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="https://picsum.photos/40?random=9" alt="AetherSwap Logo" width="40" height="40" class="rounded-full" loading="lazy" />
        <span class="text-2xl font-semibold tracking-tight">AetherSwap</span>
        <span class="text-sm text-gray-500 hidden sm:inline">Solana DEX - Demo</span>
      </div>

      <div class="flex items-center gap-3">
        <a href="#" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100" data-section="swap">Swap</a>
        <a href="#" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100" data-section="pool">Pool</a>
        <a href="#" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100" data-section="liquidity">Liquidity</a>
        <button id="connect-wallet" class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600 focus:outline-none" aria-label="Connect wallet">
          <span id="wallet-status" class="mr-2">Connect</span>
          <i class="fas fa-wallet"></i>
        </button>
      </div>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 py-6" role="main">
    <section id="swap-section" class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
      <!-- Left: Swap Card -->
      <div class="card bg-white p-4 sm:p-6 shadow-soft">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold">Ãchanger SPL (AMM simple)</h2>
          <span class="text-xs text-gray-500" aria-live="polite" id="mode-label">Mode: SimulÃ©</span>
        </div>

        <!-- Wallet + balances -->
        <div class="border border-gray-200 rounded-md p-4 mb-4" aria-label="Wallet and balances">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
              <i class="fas fa-wallet text-xl text-gray-600"></i>
              <span class="font-semibold">Adresse du Wallet</span>
            </div>
            <button id="refresh-balances" class="text-xs text-blue-600 hover:underline" title="RafraÃ®chir les soldes">RafraÃ®chir</button>
          </div>
          <div id="wallet-address" class="text-sm text-gray-700 mb-2"></div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <!-- SOL balance -->
            <div class="flex items-center p-3 rounded-md bg-gray-50" aria-label="SOL balance">
              <img src="https://picsum.photos/40?random=10" class="token-logo" alt="Logo SOL" loading="lazy" />
              <div class="ml-2 w-full">
                <div class="flex items-center justify-between">
                  <span class="font-medium">SOL Balance</span>
                  <span id="balance-sol" class="text-sm text-gray-600">0 SOL</span>
                </div>
                <div class="text-xs text-gray-500">DÃ©tenu sur le wallet</div>
              </div>
            </div>

            <!-- USDC-like (demo SPL) balance placeholder -->
            <div class="flex items-center p-3 rounded-md bg-gray-50" aria-label="Token-in balance">
              <img src="https://picsum.photos/40?random=11" class="token-logo" alt="Logo Token AETH" loading="lazy" />
              <div class="ml-2 w-full">
                <div class="flex items-center justify-between">
                  <span class="font-medium" id="tokenA-name">AETH</span>
                  <span id="balance-tokenA" class="text-sm text-gray-600">0.000000 AETH</span>
                </div>
                <div class="text-xs text-gray-500" id="tokenA-desc">Token rÃ©servÃ© de dÃ©monstration</div>
              </div>
            </div>

            <!-- Token B balance -->
            <div class="flex items-center p-3 rounded-md bg-gray-50" aria-label="Token-out balance">
              <img src="https://picsum.photos/40?random=12" class="token-logo" alt="Logo Token B LUM" loading="lazy" />
              <div class="ml-2 w-full">
                <div class="flex items-center justify-between">
                  <span class="font-medium" id="tokenB-name">LUM</span>
                  <span id="balance-tokenB" class="text-sm text-gray-600">0.000000 LUM</span>
                </div>
                <div class="text-xs text-gray-500" id="tokenB-desc">Token rÃ©servÃ© de dÃ©monstration</div>
              </div>
            </div>

          </div>
        </div>

        <!-- Token selectors and amount -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3" aria-label="Token selectors">
          <!-- Input token selector -->
          <div class="border border-gray-200 rounded-md p-3 bg-white" role="group" aria-label="Token in selector">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium">Token d'entrÃ©e</span>
              <span class="text-xs text-gray-500" id="tokenIn-balance-label">Balance</span>
            </div>
            <div class="flex items-center gap-2">
              <button class="flex items-center justify-center w-full bg-gray-100 border border-gray-200 rounded-md p-2" id="tokenInBtn" aria-label="SÃ©lectionner le token d'entrÃ©e">
                <img id="tokenInLogo" class="token-logo" src="https://picsum.photos/40?random=20" alt="Logo du token entrer" loading="lazy" />
                <span id="tokenInName" class="ml-2 font-medium">AETH</span>
                <i class="fas fa-chevron-down text-gray-500 ml-1"></i>
              </button>
            </div>
          </div>

          <!-- Output token selector -->
          <div class="border border-gray-200 rounded-md p-3 bg-white" role="group" aria-label="Token out selector">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium">Token de sortie</span>
              <span class="text-xs text-gray-500" id="tokenOut-balance-label">Balance</span>
            </div>
            <div class="flex items-center gap-2">
              <button class="flex items-center justify-center w-full bg-gray-100 border border-gray-200 rounded-md p-2" id="tokenOutBtn" aria-label="SÃ©lectionner le token de sortie">
                <img id="tokenOutLogo" class="token-logo" src="https://picsum.photos/40?random=25" alt="Logo du token sortie" loading="lazy" />
                <span id="tokenOutName" class="ml-2 font-medium">LUM</span>
                <i class="fas fa-chevron-down text-gray-500 ml-1"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Amount input / results -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div>
            <label for="amountIn" class="block text-sm font-medium mb-1">Montant d'entrÃ©e</label>
            <div class="relative">
              <input id="amountIn" inputmode="decimal" type="text" placeholder="0.00" class="w-full border border-gray-300 rounded-md pl-3 pr-10 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" aria-label="Montant d'entrÃ©e" />
              <span class="absolute right-2 top-1/2 -translate-y-1/2 text-sm text-gray-500" id="inputCurrency">AETH</span>
            </div>
          </div>

          <div>
            <label for="amountOut" class="block text-sm font-medium mb-1">Montant sortie estimÃ©</label>
            <input id="amountOut" type="text" disabled class="w-full border border-gray-300 rounded-md pl-3 pr-10 py-2 bg-gray-100" aria-label="Montant sortie estimÃ©" />
          </div>
        </div>

        <!-- Slippage / Fees -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
          <div class="border border-gray-200 rounded-md p-3 bg-white" aria-label="Slippage">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium">Slippage tolÃ©rÃ©</span>
              <span id="slippageValue" class="text-xs text-gray-500">0.50%</span>
            </div>
            <input id="slippage" type="range" min="0.05" max="5" step="0.05" value="0.5" class="w-full" aria-label="Slippage tolÃ©rÃ©">
          </div>

          <div class="border border-gray-200 rounded-md p-3 bg-white" aria-label="Swap fee">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium">Frais de swap</span>
              <span id="feeValue" class="text-xs text-gray-500">0.30%</span>
            </div>
            <div class="text-sm text-gray-700">
              Tarification simulÃ©e dans cette dÃ©mo. Le mÃªme ratio s'applique sur le pool.
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center gap-3">
          <button id="swapBtn" class="bg-primary text-white px-5 py-2 rounded-md hover:bg-blue-600" aria-label="ExÃ©cuter le swap">Ãchanger</button>
          <button id="reverseBtn" class="ml-auto px-3 py-2 rounded-md border border-gray-300 hover:bg-gray-50" aria-label="Inverser les tokens">Inverser</button>
        </div>

        <!-- Oracle price display -->
        <div class="mt-4 p-3 border border-gray-200 rounded-md bg-gray-50" aria-label="Prix temps rÃ©el">
          <div class="flex items-center justify-between mb-2">
            <span class="font-medium">Prix en temps rÃ©el</span>
            <span class="text-sm text-gray-500" id="oracleSource">Oracle: CoinGecko (fallback)</span>
          </div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="p-2 bg-white rounded-md border">
              SOL/USD: <span id="priceSolUsd" class="font-semibold float-right">-</span>
            </div>
            <div class="p-2 bg-white rounded-md border">
              AETH/LUM (demo pool): <span id="demoPoolPrice" class="font-semibold float-right">-</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Pool visualization / liquidity -->
      <div class="card bg-white p-4 sm:p-6 shadow-soft" aria-label="Pool et liquiditÃ©">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">Pool AMM - XY = K</h3>
          <span class="text-xs text-gray-500" id="pool-kdesc">K = rÃ©serveA Ã rÃ©serveB</span>
        </div>

        <!-- Pool reserves -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div class="p-3 bg-gray-50 border rounded-md">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium" id="poolResA-label">RÃ©serve AETH</span>
              <span class="text-xs text-gray-500" id="poolResA-amount">0.000000 AETH</span>
            </div>
            <div class="h-2 bg-gray-200 rounded-full">
              <div id="poolGraphA" class="h-2 bg-green-500 rounded-full" style="width: 50%"></div>
            </div>
          </div>

          <div class="p-3 bg-gray-50 border rounded-md">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium" id="poolResB-label">RÃ©serve LUM</span>
              <span class="text-xs text-gray-500" id="poolResB-amount">0.000000 LUM</span>
            </div>
            <div class="h-2 bg-gray-200 rounded-full">
              <div id="poolGraphB" class="h-2 bg-blue-500 rounded-full" style="width: 50%"></div>
            </div>
          </div>
        </div>

        <div class="text-sm text-gray-600 mb-2" id="pool-k-info">Constante K: 0</div>

        <!-- Quick add liquidity (simulated) -->
        <div class="mt-3">
          <div class="text-sm font-medium mb-2">LiquiditÃ© personnelle (simulÃ©e)</div>
          <div class="flex items-center gap-2">
            <input id="liqA" type="text" placeholder="Amount AETH" class="w-full border rounded-md px-2 py-1" aria-label="Ajouter liquiditÃ© AETH (simulÃ©)">
            <input id="liqB" type="text" placeholder="Amount LUM" class="w-full border rounded-md px-2 py-1" aria-label="Ajouter liquiditÃ© LUM (simulÃ©)">
            <button id="addLiquidityBtn" class="px-3 py-1 rounded-md bg-green-500 text-white hover:bg-green-600" aria-label="Ajouter liquiditÃ© simulÃ©e">Ajouter</button>
          </div>
          <div class="text-xs text-gray-500 mt-1">Note: Cette section est simulÃ©e en front-end pour dÃ©montrer le flux AMM.</div>
        </div>
      </div>
    </section>

    <!-- Section pied de page rapide (on-ramp) -->
    <section id="onramp-section" class="mt-8 p-4 bg-white rounded-md shadow-soft">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Acheter de la crypto via on-ramp</h3>
        <span class="text-xs text-gray-500">IntÃ©grÃ© via des services publics (ex: MoonPay, Ramp)</span>
      </div>
      <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
        <button class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700" id="buySOL" aria-label="Acheter SOL">
          Acheter SOL
        </button>
        <button class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700" id="buyAETH" aria-label="Acheter AETH">
          Acheter AETH (Demo)
        </button>
        <button class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700" id="buyLUM" aria-label="Acheter LUM">
          Acheter LUM (Demo)
        </button>
      </div>
    </section>

  </main>

  <!-- Footer -->
  <footer class="bg-white border-t mt-8">
    <div class="max-w-7xl mx-auto px-4 py-6 text-sm text-gray-600">
      Pseudo-Dex demonstratif. Pas dâactivitÃ©s rÃ©elles sur la chaÃ®ne sans clÃ© API et tests sur devnet. AetherSwap est une maquette UI.
    </div>
  </footer>

  <!-- Modales et scripts -->
  <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center" role="dialog" aria-label="Confirmation swap">
    <div class="bg-white rounded-md p-4 md:p-6 w-full max-w-md shadow-md">
      <h4 class="text-lg font-semibold mb-2">Confirmer le swap</h4>
      <p class="text-sm text-gray-700 mb-4" id="confirmDetails">DÃ©tails du swap...</p>
      <div class="flex justify-end gap-2">
        <button id="cancelSwap" class="px-4 py-2 rounded-md border border-gray-300">Annuler</button>
        <button id="confirmSwap" class="px-4 py-2 rounded-md bg-green-500 text-white hover:bg-green-600">Confirmer</button>
      </div>
    </div>
  </div>

  <!-- Scripts principaux (tout en un fichier) -->
  <script>
  ///////////////////////////////
  //  TOUTE LA LOGIQUE UI & DEMO
  ///////////////////////////////

  // Data: tokens (demo SPL tokens) and pool reserves
  const TOKENS = [
    {
      id: "SOL",
      name: "SOL",
      symbol: "SOL",
      mint: "", // native
      decimals: 9,
      logo: "https://picsum.photos/40?random=10",
      type: "SOL",
    },
    {
      id: "AETH",
      name: "Aether Token",
      symbol: "AETH",
      mint: "DemoMintAETH1111111111111111111111111",
      decimals: 6,
      logo: "https://picsum.photos/40?random=11",
      type: "SPL",
    },
    {
      id: "LUM",
      name: "Lumen Token",
      symbol: "LUM",
      mint: "DemoMintLUM1111111111111111111111111",
      decimals: 6,
      logo: "https://picsum.photos/40?random=12",
      type: "SPL",
    }
  ];

  // Simple in-browser pool (demo only)
  // Start with some reserves (in smallest units)
  let pool = {
    tokenA: "AETH",
    tokenB: "LUM",
    reserveA: 1_000_000_000, // 1,000,000 AETH if decimals=6
    reserveB: 1_000_000_000, // 1,000,000 LUM
  };

  // User balances (demo, store in memory; live wallets can override SOL balance)
  const userBalances = {
    SOL: 0,
    AETH: 0,
    LUM: 0
  };

  // Slippage and fee configuration (in %)
  let SLIPPAGE_TOLERANCE = 0.5; // percent
  const FEE_PERCENT = 0.30; // 0.30%

  // Current token selections
  let tokenIn = TOKENS[1];  // AETH
  let tokenOut = TOKENS[2]; // LUM

  // Wallet state
  let walletPublicKey = null;
  let walletConnected = false;
  let walletProviderName = null; // Phantom or Solflare

  // DOM helpers
  const walletStatusEl = document.getElementById("wallet-status");
  const connectBtn = document.getElementById("connect-wallet");
  const tokenInBtn = document.getElementById("tokenInBtn");
  const tokenOutBtn = document.getElementById("tokenOutBtn");
  const tokenInName = document.getElementById("tokenInName");
  const tokenOutName = document.getElementById("tokenOutName");
  const tokenInLogo = document.getElementById("tokenInLogo");
  const tokenOutLogo = document.getElementById("tokenOutLogo");
  const balanceSolEl = document.getElementById("balance-sol");
  const balanceTokenAEl = document.getElementById("balance-tokenA");
  const balanceTokenBEl = document.getElementById("balance-tokenB");
  const inputAmountEl = document.getElementById("amountIn");
  const amountOutEl = document.getElementById("amountOut");
  const slippageEl = document.getElementById("slippage");
  const slippageValueEl = document.getElementById("slippageValue");
  const feeValueEl = document.getElementById("feeValue");
  const oracleSolUsd = document.getElementById("priceSolUsd");
  const poolPriceEl = document.getElementById("demoPoolPrice");
  const poolResAEl = document.getElementById("poolResA-amount");
  const poolResBEl = document.getElementById("poolResB-amount");
  const poolKInfo = document.getElementById("pool-k-info");
  const poolKDesc = document.getElementById("pool-kdesc");
  const confirmModal = document.getElementById("confirmModal");
  const confirmDetails = document.getElementById("confirmDetails");
  const cancelSwap = document.getElementById("cancelSwap");
  const confirmSwap = document.getElementById("confirmSwap");
  const modeLabel = document.getElementById("mode-label");
  const swapBtn = document.getElementById("swapBtn");
  const reverseBtn = document.getElementById("reverseBtn");

  // On-ramp buttons
  document.getElementById("buySOL").addEventListener("click", () => {
    window.open("https://buy.moonpay.com?apiKey=pk_test_DEMO&currencyCode=sol&walletAddress=" + (walletPublicKey ?? ""), "_blank");
  });
  document.getElementById("buyAETH").addEventListener("click", () => {
    window.open("https://buy.moonpay.com?apiKey=pk_test_DEMO&currencyCode=" + tokenIn.symbol + "&walletAddress=" + (walletPublicKey ?? ""), "_blank");
  });
  document.getElementById("buyLUM").addEventListener("click", () => {
    window.open("https://buy.moonpay.com?apiKey=pk_test_DEMO&currencyCode=" + tokenOut.symbol + "&walletAddress=" + (walletPublicKey ?? ""), "_blank");
  });

  // Initialize UI
  function initUI() {
    // Set initial token display
    updateTokenDisplays();
    updateBalanceDisplays();
    recalcAmountOut();

    // Slippage zero-based value display
    slippageEl.addEventListener("input", () => {
      SLIPPAGE_TOLERANCE = parseFloat(slippageEl.value);
      slippageValueEl.textContent = SLIPPAGE_TOLERANCE.toFixed(2) + "%";
      recalcAmountOut();
    });
  }

  // Wallet connection (Phantom or Solflare)
  async function connectWallet() {
    // Prefer Phantom if present
    if (window.solana && window.solana.isPhantom) {
      walletProviderName = "Phantom";
      try {
        const resp = await window.solana.connect();
        walletPublicKey = resp.publicKey.toString();
        walletConnected = true;
        walletStatusEl.textContent = "ConnectÃ©: " + shortenAddress(walletPublicKey);
        modeLabel.textContent = "Mode: Solana (via Jupiter)";

        // Listen for disconnect
        window.solana.on("disconnect", () => {
          walletConnected = false;
          walletPublicKey = null;
          walletStatusEl.textContent = "Connect";
        });

        // Refresh balances from Solana RPC (devnet for demo)
        await fetchBalancesFromRPC(walletPublicKey);
        // Set a sample SOL balance if none
        if (getBalanceFromState().SOL === 0) {
          // Query actual SOL balance
          const lamports = await getSOLBalanceFromRPC(walletPublicKey);
          userBalances.SOL = lamports / 1e9;
          updateBalanceDisplays();
        }

      } catch (e) {
        console.error("Wallet connection failed (Phantom):", e);
      }
      return;
    }

    // Try Solflare (if available)
    if (window.solflare && window.solflare.isSolflare) {
      walletProviderName = "Solflare";
      try {
        const resp = await window.solflare.connect();
        walletPublicKey = resp.publicKey.toString();
        walletConnected = true;
        walletStatusEl.textContent = "ConnectÃ©: " + shortenAddress(walletPublicKey);
      } catch (e) {
        console.error("Wallet connection failed (Solflare):", e);
      }
      return;
    }

    // No wallet found
    alert("Aucun portefeuille Solana dÃ©tectÃ©. Essayez Phantom ou Solflare.");
  }

  // Utility: shorten address
  function shortenAddress(addr) {
    if (!addr) return "";
    return addr.slice(0, 4) + "â¦" + addr.slice(-4);
  }

  // Fetch balances via Solana RPC (devnet) for SOL and demo SPL tokens
  async function fetchBalancesFromRPC(pubkey) {
    // SOL balance will be loaded in getBalanceFromRPC
    // Query SOL
    try {
      const lamports = await getSOLBalanceFromRPC(pubkey);
      userBalances.SOL = lamports / 1e9;
    } catch (e) {
      console.warn("SOL balance fetch failed:", e);
    }

    // Demo: SPL balances (AETH and LUM) - may be zero in devnet unless minted; we'll try to fetch token accounts
    try {
      const balances = await getSPLBalancesFromRPC(pubkey);
      // Map balances by symbol/mini-mint
      const balA = balances.AETH || 0;
      const balB = balances.LUM || 0;
      userBalances.AETH = balA;
      userBalances.LUM = balB;
    } catch (e) {
      console.warn("SPL balances fetch failed (demo):", e);
    }

    updateBalanceDisplays();
  }

  // RPC calls (devnet)
  async function rpcPost(payload) {
    return fetch("https://api.devnet.solana.com", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    }).then(r => r.json());
  }

  async function getSOLBalanceFromRPC(pubkey) {
    const resp = await rpcPost({ "jsonrpc": "2.0", "id": 1, "method": "getBalance", "params": [pubkey] });
    if (resp && resp.result != null) return resp.result;
    throw new Error("Invalid SOL balance response");
  }

  async function getSPLBalancesFromRPC(pubkey) {
    // Token program id
    const TOKEN_PROGRAM_ID = "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA";
    const resp = await rpcPost({
      "jsonrpc": "2.0",
      "id": 1,
      "method": "getTokenAccountsByOwner",
      "params": [
        pubkey,
        { "programId": TOKEN_PROGRAM_ID },
        { "encoding": "jsonParsed" }
      ]
    });
    const balances = {};
    if (resp && resp.result && resp.result.value) {
      for (const account of resp.result.value) {
        const info = account.account.data?. parsed?.info || (account.account.data?.parsed?.info ?? {});
        const mint = info.mint;
        const tokenAmount = info.tokenAmount;
        if (tokenAmount && typeof tokenAmount.uiAmount === "number") {
          // Map by known demo mints
          if (mint && mint.toLowerCase().includes("demoMintAeth".toLowerCase())) {
            balances.AETH = (tokenAmount.uiAmount || 0);
          } else if (mint && mint.toLowerCase().includes("demoMintLUM".toLowerCase())) {
            balances.LUM = (tokenAmount.uiAmount || 0);
          }
        }
      }
    }
    return balances;
  }

  // Update balances in UI
  function updateBalanceDisplays() {
    balanceSolEl.textContent = formatSOL(userBalances.SOL) + " SOL";
    balanceTokenAEl.textContent = formatToken(userBalances.AETH, 6) + " AETH";
    balanceTokenBEl.textContent = formatToken(userBalances.LUM, 6) + " LUM";

    // Update tokenIn/out balance labels
    document.getElementById("tokenIn-balance-label").textContent = "Balance: " + formatToken(userBalances[tokenIn.id], tokenIn.decimals) + " " + tokenIn.symbol;
    document.getElementById("tokenOut-balance-label").textContent = "Balance: " + formatToken(userBalances[tokenOut.id], tokenOut.decimals) + " " + tokenOut.symbol;

    // Also show in the header tokenIn/out balances on the selectors
    tokenInName.textContent = tokenIn.symbol;
    tokenOutName.textContent = tokenOut.symbol;
    tokenInLogo.src = tokenIn.logo;
    tokenOutLogo.src = tokenOut.logo;
  }

  // Helpers: formatters
  function formatToken(amount, decimals) {
    if (amount == null || isNaN(amount)) amount = 0;
    const m = Math.pow(10, decimals);
    return (amount / (m)).toFixed(decimals > 2 ? decimals : 4).replace(/\.?0+$/,"");
  }

  function formatSOL(v) {
    if (!v && v !== 0) return "0.000";
    return Number(v).toFixed(6);
  }

  function setPoolUI() {
    // Show pool reserves in human-friendly format
    const a = pool.reserveA;
    const b = pool.reserveB;
    poolResAEl.textContent = formatToken(a / Math.pow(10, TOKENS.find(t => t.id === pool.tokenA).decimals), TOKENS.find(t => t.id === pool.tokenA).decimals) + " " + pool.tokenA;
    poolResBEl.textContent = formatToken(b / Math.pow(10, TOKENS.find(t => t.id === pool.tokenB).decimals), TOKENS.find(t => t.id === pool.tokenB).decimals) + " " + pool.tokenB;
    poolKInfo.textContent = "K = " + (pool.reserveA * pool.reserveB).toLocaleString();
    poolKDesc.textContent = "K = " + pool.reserveA.toLocaleString() + " Ã " + pool.reserveB.toLocaleString();
    // Simple graph fill (visual)
    const aPct = Math.min(100, Math.max(5, Math.round((pool.reserveA / (pool.reserveA + pool.reserveB)) * 100)));
    document.getElementById("poolGraphA").style.width = aPct + "%";
    document.getElementById("poolGraphB").style.width = (100 - aPct) + "%";
    poolPriceEl.textContent = "Prix pool AETH/LUM: " + computePoolPrice().toFixed(6);
    poolResAEl.title = "RÃ©serve AETH: " + pool.reserveA;
    poolResBEl.title = "RÃ©serve LUM: " + pool.reserveB;
  }

  function computePoolPrice() {
    // price of 1 AETH in LUM terms (reserveB / reserveA)
    if (pool.reserveA <= 0) return 0;
    return (pool.reserveB / pool.reserveA);
  }

  // Recalculate amountOut based on amountIn and current reserves
  function recalcAmountOut() {
    const amountInRaw = parseFloat((inputAmountEl.value || "0").toString().trim() || "0");
    if (!amountInRaw || amountInRaw <= 0) {
      amountOutEl.value = "";
      return;
    }
    // Convert amountIn to smallest units for the pool's tokenIn decimals
    const inDecimals = tokenIn.decimals;
    const amountInSmall = Math.round(amountInRaw * Math.pow(10, inDecimals));

    // Determine reserves in smallest units
    const resIn = pool.reserveA;
    const resOut = pool.reserveB;
    // Apply typical AMM formula with fee
    const amountInWithFee = Math.floor(amountInSmall * (1000 - Math.floor(FEE_PERCENT * 10))) ; // 0.30% -> 1000-3 = 997, scaled
    // If tokenIn is AETH, amountInWithFee affects reserveA -> reserveB
    const numerator = amountInWithFee * resOut;
    const denominator = (resIn * 1000) + amountInWithFee;
    // amountOut in smallest units
    let amountOutSmall = 0;
    if (denominator > 0) amountOutSmall = Math.floor(numerator / denominator);
    // Convert back to tokenOut decimals
    const outDecimals = tokenOut.decimals;
    const amountOut = amountOutSmall / Math.pow(10, outDecimals);
    amountOutEl.value = amountOut.toFixed(outDecimals > 2 ? outDecimals : 6).replace(/\.?0+$/,"");
  }

  // Update display based on current token selections
  function updateTokenDisplays() {
    tokenInName.textContent = tokenIn.symbol;
    tokenOutName.textContent = tokenOut.symbol;
    tokenInLogo.src = tokenIn.logo;
    tokenOutLogo.src = tokenOut.logo;

    // Balance labels
    document.getElementById("tokenIn-balance-label").textContent = "Balance: " + formatToken(userBalances[tokenIn.id], tokenIn.decimals) + " " + tokenIn.symbol;
    document.getElementById("tokenOut-balance-label").textContent = "Balance: " + formatToken(userBalances[tokenOut.id], tokenOut.decimals) + " " + tokenOut.symbol;
  }

  // Change token in/out (with round-robin swap)
  function swapTokensInUI() {
    const tmp = tokenIn;
    tokenIn = tokenOut;
    tokenOut = tmp;
    // Update inputs
    inputAmountEl.value = "";
    // Update UI
    updateTokenDisplays();
    recalcAmountOut();
    // Update mode label (optional)
    modeLabel.textContent = "Mode: SimulÃ©";
  }

  // 1) Simple in-browser swap (AMM) - updates user balances and pool reserves
  function performLocalSwap() {
    // Read amountIn
    const amountInRaw = parseFloat((inputAmountEl.value || "0").toString().trim() || "0");
    if (!amountInRaw || amountInRaw <= 0) {
      alert("Veuillez saisir un montant d'entrÃ©e valide.");
      return;
    }

    // Basic balance check
    const inDecimals = tokenIn.decimals;
    const amountInSmall = Math.round(amountInRaw * Math.pow(10, inDecimals));

    // User balance for tokenIn
    const balIn = userBalances[tokenIn.id] || 0;
    const balInRaw = balIn; // since demo balances are in token units
    if (amountInRaw > balInRaw) {
      alert("Solde insuffisant pour l'entrÃ©e.");
      return;
    }

    // Compute amountOut using constant product formula with fee
    const resIn = pool.reserveA;
    const resOut = pool.reserveB;

    const amountInWithFee = Math.floor(amountInSmall * (1000 - Math.floor(FEE_PERCENT * 10))); // e.g., 0.3% => 997
    const numerator = amountInWithFee * resOut;
    const denominator = (resIn * 1000) + amountInWithFee;
    let amountOutSmall = 0;
    if (denominator > 0) amountOutSmall = Math.floor(numerator / denominator);

    // Convert to display units
    const outDecimals = tokenOut.decimals;
    const amountOut = amountOutSmall / Math.pow(10, outDecimals);

    if (amountOut <= 0) {
      alert("Montant de sortie nul. Essayez un montant d'entrÃ©e plus Ã©levÃ©.");
      return;
    }

    // Update user balances (tokenIn decreases, tokenOut increases)
    userBalances[tokenIn.id] = (userBalances[tokenIn.id] || 0) - amountInRaw;
    userBalances[tokenOut.id] = (userBalances[tokenOut.id] || 0) + amountOut;

    // Update reserves
    pool.reserveA += amountInSmall;
    pool.reserveB -= amountOutSmall;

    // Re-render
    updateBalanceDisplays();
    setPoolUI();
    recalcAmountOut();

    // Show a tiny toast (alert) or console
    console.log("Swap exÃ©cutÃ© en local:", amountInRaw, tokenIn.symbol, "->", amountOut, tokenOut.symbol);
  }

  // 2) Jupiter-like real path (solana) - simulated or real path if possible
  // This function tries to fetch a route from Jupiter's API and then asks wallet to sign & send
  async function performJupiterSwapSimulatedOrReal() {
    if (!walletConnected || !walletPublicKey) {
      alert("Veuillez connecter votre portefeuille Solana (Phantom/Solflare).");
      return;
    }

    // In this demo, we attempt a real-like swap via Jupiter's quote endpoint.
    // We construct a swap request for WSOL (SOL-wrapped) and a demo SPL token (AETH or LUM).
    // To keep it robust, we will fallback to local swap if the API call fails.

    // Build inputs
    const inputMint = "So11111111111111111111111111111111111111112"; // WSOL mint
    const outputMint = "DemoMintLUM1111111111111111111111111"; // Demo token; may fail (fallback to local)
    // Amount to swap - in lamports if SOL, but since we use a demo in-app pool, we won't strictly rely on lamports
    // We'll attempt a faux lamports amount
    const amountInForQuote = Math.max(1_000_000, Math.floor(parseFloat(inputAmountEl.value || "0") * 1e6)); // pseudo
    const slippage = SLIPPAGE_TOLERANCE;

    const url = `https://quote-api.jup.ag/v4/quote?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amountInForQuote}&slippage=${slippage}`;
    try {
      const resp = await fetch(url);
      const data = await resp.json();
      // If we have routes, show the best route
      if (data && data.data && data.data.length > 0) {
        const route = data.data[0];
        // The 'tx' field is a base64-serialized Solana transaction for the swap
        const txBase64 = route?.txs?.length > 0 ? route.txs[0] : data?.data?.[0]?.tx;
        // Display a confirmation dialog with route summary
        confirmModal.dataset.routeInfo = JSON.stringify(route);
        confirmDetails.textContent = "Route dÃ©tectÃ© via Jupiter: " + (route?.name ?? "Unknown") +
          " | Estimation sortie: " + (route?.outAmount ?? "N/A") +
          " | Prix: " + (route?.price ?? "N/A");
        showModal();
        // On confirm: attempt to sign and send through wallet
        confirmSwap.onclick = async () => {
          hideModal();
          if (txBase64) {
            try {
              // Phantom specific: signAndSendTransaction expects a serialized transaction in base64
              // Some wallets use "signAndSendTransaction" with an Array of transactions.
              const provider = window.solana;
              if (provider && provider.isPhantom) {
                const result = await provider.request({
                  method: "signAndSendTransaction",
                  params: [
                    txBase64 // base64 string
                  ]
                });
                console.log("Transaction sent:", result);
                // After sending, refresh balances (in real use, you'd await finality)
                await fetchBalancesFromRPC(walletPublicKey);
              } else {
                throw new Error("Wallet not Phantom-compatible for signAndSendTransaction");
              }
            } catch (e) {
              console.warn("Jupiter swap via wallet failed, falling back to local AMM.", e);
              performLocalSwap();
            }
          } else {
            // Fallback to local
            performLocalSwap();
          }
        };
      } else {
        throw new Error("No route data received. Falling back to local swap.");
      }
    } catch (e) {
      console.warn("Jupiter API path failed, using local AMM. Error:", e);
      performLocalSwap();
    }
  }

  function showModal() {
    confirmModal.classList.remove("hidden");
  }
  function hideModal() {
    confirmModal.classList.add("hidden");
  }

  // 3) Uniswap-like path (EVM) - local simulation
  // For demonstration, we reuse the same in-browser AMM logic but label it as "Uniswap (EVM)"
  function performUniswapLikeSwap() {
    // Simple local swap call
    performLocalSwap();
  }

  // 4) Real-time price fetch (oracle-like, with fallback)
  async function fetchOraclePrices() {
    // Try Pyth/Switchboard endpoints if available; otherwise fallback to CoinGecko REST
    let priceSolUsd = null;
        let sourceName = "CoinGecko (fallback)";
    try {
      // CoinGecko
      const resp = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd");
      if (resp.ok) {
        const data = await resp.json();
        if (data?.solana?.usd) {
          priceSolUsd = data.solana.usd;
          sourceName = "CoinGecko";
        }
      }
    } catch (e) {
      console.warn("Price fetch failed (CoinGecko):", e);
    }

    // If a second service exists, we could query Switchboard/Pyth here similarly
    // For demonstration purposes, we'll set a knob to display "oracle" source
    if (priceSolUsd != null) {
      oracleSolUsd.textContent = priceSolUsd.toFixed(2) + " USD";
      // Also update demo pool price
      const poolP = computePoolPrice();
      poolPriceEl.textContent = "Pool est. SOL/LUM: " + poolP.toFixed(6);
    } else {
      oracleSolUsd.textContent = "-";
    }
  }

  // 5) Add liquidity (simulated)
  document.getElementById("addLiquidityBtn").addEventListener("click", () => {
    const aStr = document.getElementById("liqA").value || "0";
    const bStr = document.getElementById("liqB").value || "0";
    const a = parseFloat(aStr);
    const b = parseFloat(bStr);
    if (isNaN(a) || isNaN(b) || a <= 0 || b <= 0) {
      alert("Entrez des montants valides pour ajouter de la liquiditÃ© simulÃ©e.");
      return;
    }
    // Update pool reserves (demo)
    pool.reserveA += Math.round(a * Math.pow(10, TOKENS.find(t => t.id === pool.tokenA).decimals));
    pool.reserveB += Math.round(b * Math.pow(10, TOKENS.find(t => t.id === pool.tokenB).decimals));
    // Subtract from user balances if they have them (demo)
    userBalances[pool.tokenA] = (userBalances[pool.tokenA] || 0) - a;
    userBalances[pool.tokenB] = (userBalances[pool.tokenB] || 0) - b;
    updateBalanceDisplays();
    setPoolUI();
  });

  // 6) Event wiring: anchor navigation should be JS-controlled (prevent default)
  document.querySelectorAll("a[data-section]").forEach(a => {
    a.addEventListener("click", (e) => {
      e.preventDefault();
      const section = a.getAttribute("data-section");
      document.getElementById("swap-section").scrollIntoView({ behavior: "smooth" });
      // could switch visible section if multiple; here we just scroll
    });
  });

  // Token dropdowns: simple toggles and selection
  // Build a simple dropdown list for tokens
  function buildTokenDropdowns() {
    // TokenIn
    const inList = document.createElement("div");
    inList.className = "dropdown-menu hidden";
    inList.id = "tokenInMenu";
    TOKENS.forEach(t => {
      const item = document.createElement("div");
      item.className = "flex items-center gap-2 px-3 py-2 rounded-md cursor-pointer hover:bg-gray-100";
      item.innerHTML = `<img src="${t.logo}" class="token-logo" alt="Logo ${t.symbol}" loading="lazy" /><span>${t.symbol} - ${t.name}</span>`;
      item.addEventListener("click", () => {
        tokenIn = t;
        // refresh button label
        tokenInName.textContent = t.symbol;
        tokenInLogo.src = t.logo;
        // close
        closeTokenInMenu();
        // update balances and input
        updateBalanceDisplays();
        recalcAmountOut();
      });
      inList.appendChild(item);
    });
    document.body.appendChild(inList);
    // TokenOut
    const outList = document.createElement("div");
    outList.className = "dropdown-menu hidden";
    outList.id = "tokenOutMenu";
    TOKENS.forEach(t => {
      const item = document.createElement("div");
      item.className = "flex items-center gap-2 px-3 py-2 rounded-md cursor-pointer hover:bg-gray-100";
      item.innerHTML = `<img src="${t.logo}" class="token-logo" alt="Logo ${t.symbol}" loading="lazy" /><span>${t.symbol} - ${t.name}</span>`;
      item.addEventListener("click", () => {
        tokenOut = t;
        tokenOutName.textContent = t.symbol;
        tokenOutLogo.src = t.logo;
        closeTokenOutMenu();
        updateBalanceDisplays();
        recalcAmountOut();
      });
      outList.appendChild(item);
    });
    document.body.appendChild(outList);
  }

  function openTokenInMenu() {
    const el = document.getElementById("tokenInMenu");
    el.classList.toggle("hidden");
  }
  function closeTokenInMenu() {
    const el = document.getElementById("tokenInMenu");
    el.classList.add("hidden");
  }
  function openTokenOutMenu() {
    const el = document.getElementById("tokenOutMenu");
    el.classList.toggle("hidden");
  }
  function closeTokenOutMenu() {
    const el = document.getElementById("tokenOutMenu");
    el.classList.add("hidden");
  }

  // Wire token selection buttons
  tokenInBtn.addEventListener("click", (e) => {
    e.preventDefault();
    // Show menu near the button
    const menu = document.getElementById("tokenInMenu");
    // position near the button (just place below)
    const rect = tokenInBtn.getBoundingClientRect();
    menu.style.left = rect.left + "px";
    menu.style.top = (rect.bottom + window.scrollY + 6) + "px";
    menu.classList.remove("hidden");
  });
  tokenOutBtn.addEventListener("click", (e) => {
    e.preventDefault();
    const menu = document.getElementById("tokenOutMenu");
    const rect = tokenOutBtn.getBoundingClientRect();
    menu.style.left = rect.left + "px";
    menu.style.top = (rect.bottom + window.scrollY + 6) + "px";
    menu.classList.remove("hidden");
  });

  // Input change: recalc amountOut live
  inputAmountEl.addEventListener("input", recalcAmountOut);

  // Swap & reverse actions
  swapBtn.addEventListener("click", () => {
    // If wallet connected and a real swap path could be taken, attempt Jupiter; else local
    performJupiterSwapSimulatedOrReal();
  });

  reverseBtn.addEventListener("click", () => {
    swapTokensInUI();
    recalcAmountOut();
  });

  // Connect button
  connectBtn.addEventListener("click", async () => {
    await connectWallet();
  });

  // Modal actions
  cancelSwap.addEventListener("click", () => hideModal());
  confirmSwap.addEventListener("click", () => {
    hideModal();
    // If a real sign request was already fired, the logic above handles it;
  });

  // Initial token dropdowns
  buildTokenDropdowns();

  // Initialize UI on load
  window.addEventListener("load", () => {
    initUI();
    setPoolUI();
    // Initial balances for demo if wallet not connected
    if (!walletConnected) {
      userBalances.SOL = 0.123456;
      userBalances.AETH = 1234.5678;
      userBalances.LUM = 9876.5432;
      updateBalanceDisplays();
      recalcAmountOut();
    }
    // Fetch oracle prices
    fetchOraclePrices();
    // Periodic price refresh (every 30 seconds)
    setInterval(fetchOraclePrices, 30000);
  });

  // Accessibility: close dropdowns if click outside
  document.addEventListener("click", (e) => {
    const tokenInMenu = document.getElementById("tokenInMenu");
    const tokenOutMenu = document.getElementById("tokenOutMenu");
    if (tokenInMenu && !tokenInMenu.contains(e.target) && !tokenInBtn.contains(e.target)) {
      tokenInMenu.classList.add("hidden");
    }
    if (tokenOutMenu && !tokenOutMenu.contains(e.target) && !tokenOutBtn.contains(e.target)) {
      tokenOutMenu.classList.add("hidden");
    }
  });

  // Initialize: set initial UI text
  document.getElementById("inputCurrency").textContent = tokenIn.symbol;
  document.getElementById("mode-label").textContent = "Mode: SimulÃ©";

  // End of script
  </script>

  <!-- Simple JSON-LD Schema (SEO) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "AetherSwap",
    "url": "https://example.com/aetherswap",
    "description": "Demo single-file DEX UI for Solana with Phantom/Solflare wallet, basic AMM, and real-time price display via oracles (Pyth/Switchboard).",
    "potentialAction": {
      "@type": "ReadAction",
      "target": ["https://example.com/aetherswap"]
    }
  }
  </script>

</body>
</html>