<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AetherSwap Advanced DEX</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@jup-ag/core@latest/dist/index.iife.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0f0f13;
      color: #ffffff;
    }
    .token-item:hover {
      background: rgba(56, 43, 168, 0.3);
    }
    .gradient-bg {
      background: linear-gradient(135deg, #7c3aed 0%, #3b82f6 100%);
    }
  </style>
</head>
<body class="min-h-screen">

<div class="max-w-md mx-auto p-4">
  <!-- Header with Wallet Connection -->
  <header class="flex justify-between items-center mb-8">
    <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-500 to-blue-500 bg-clip-text text-transparent">AetherSwap Pro</h1>
    <button id="connect-wallet" class="gradient-bg hover:opacity-90 px-4 py-2 rounded-lg font-medium text-white">
      Connect Wallet
    </button>
  </header>

  <!-- Main Swap Interface -->
  <div class="bg-gray-900 rounded-xl p-5 shadow-lg border border-gray-800">
    <!-- From Token Section -->
    <div class="mb-4">
      <div class="flex justify-between mb-2">
        <label class="text-sm text-gray-300">From</label>
        <span class="text-sm text-gray-400">Balance: <span id="from-balance">0</span></span>
      </div>
      <div class="flex items-center bg-gray-800 rounded-lg p-3">
        <input 
          type="number" 
          id="from-amount" 
          placeholder="0.0" 
          class="flex-1 bg-transparent text-2xl outline-none text-white"
          min="0"
          step="any"
        >
        <button id="select-from-token" class="flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg min-w-[120px]">
          <img id="from-token-icon" class="w-6 h-6 rounded-full" onerror="this.src='https://placeholder.com/token.png'">
          <span id="from-token-symbol">SOL</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Swap Button -->
    <div class="flex justify-center my-3">
      <button id="switch-tokens" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7l4-4m0 0l4 4m-4-4v18m0 0l-4-4m4 4l4-4"></path>
        </svg>
      </button>
    </div>

    <!-- To Token Section -->
    <div class="mb-6">
      <div class="flex justify-between mb-2">
        <label class="text-sm text-gray-300">To</label>
        <span class="text-sm text-gray-400">Balance: <span id="to-balance">0</span></span>
      </div>
      <div class="flex items-center bg-gray-800 rounded-lg p-3">
        <input 
          type="number" 
          id="to-amount" 
          placeholder="0.0" 
          readonly
          class="flex-1 bg-transparent text-2xl outline-none text-white"
        >
        <button id="select-to-token" class="flex items-center space-x-2 bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg min-w-[120px]">
          <img id="to-token-icon" class="w-6 h-6 rounded-full" onerror="this.src='https://placeholder.com/token.png'">
          <span id="to-token-symbol">Select</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Swap Details -->
    <div class="bg-gray-800 rounded-lg p-3 mb-4 text-sm">
      <div class="flex justify-between py-2">
        <span class="text-gray-400">Rate</span>
        <span id="exchange-rate" class="font-mono">-</span>
      </div>
      <div class="flex justify-between py-2">
        <span class="text-gray-400">Price Impact</span>
        <span id="price-impact" class="font-mono">-</span>
      </div>
      <div class="flex justify-between py-2">
        <span class="text-gray-400">Network Fee</span>
        <span id="network-fee" class="font-mono">-</span>
      </div>
    </div>

    <!-- Main Swap Button -->
    <button id="execute-swap" class="gradient-bg hover:opacity-90 w-full py-3 rounded-xl font-medium text-white disabled:opacity-50" disabled>
      Connect Wallet
    </button>
  </div>
</div>

<!-- Token Selection Modal -->
<div id="token-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden">
  <div class="bg-gray-900 border border-gray-800 rounded-xl w-full max-w-md mx-4 max-h-[80vh] overflow-hidden">
    <div class="p-4 border-b border-gray-800 flex justify-between items-center">
      <h3 class="text-white font-semibold">Select Token</h3>
      <button id="close-token-modal" class="text-gray-400 hover:text-white text-xl">&times;</button>
    </div>
    <div class="p-4">
      <div class="relative mb-4">
        <input 
          id="token-search" 
          type="text" 
          placeholder="Search token name or mint address..." 
          class="w-full bg-gray-800 px-4 py-2 rounded-lg text-white outline-none"
        >
      </div>
      <div id="token-list" class="space-y-2 overflow-y-auto max-h-[60vh]"></div>
    </div>
  </div>
</div>

<!-- Loading Indicator -->
<div id="loading-indicator" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden">
  <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-purple-500"></div>
</div>

<script>
  // Global state
  const state = {
    connection: new Connection("https://rpc.triton.one"),
    wallet: null,
    jupiter: null,
    tokens: [],
    fromToken: null,
    toToken: null,
    balances: {},
    routes: null,
    slippage: 0.5 // 0.5%
  };

  // DOM Elements
  const elements = {
    connectWallet: document.getElementById('connect-wallet'),
    executeSwap: document.getElementById('execute-swap'),
    fromAmount: document.getElementById('from-amount'),
    toAmount: document.getElementById('to-amount'),
    fromTokenSymbol: document.getElementById('from-token-symbol'),
    toTokenSymbol: document.getElementById('to-token-symbol'),
    fromTokenIcon: document.getElementById('from-token-icon'),
    toTokenIcon: document.getElementById('to-token-icon'),
    fromBalance: document.getElementById('from-balance'),
    toBalance: document.getElementById('to-balance'),
    exchangeRate: document.getElementById('exchange-rate'),
    priceImpact: document.getElementById('price-impact'),
    networkFee: document.getElementById('network-fee'),
    tokenModal: document.getElementById('token-modal'),
    tokenSearch: document.getElementById('token-search'),
    tokenList: document.getElementById('token-list'),
    closeTokenModal: document.getElementById('close-token-modal'),
    selectFromToken: document.getElementById('select-from-token'),
    selectToToken: document.getElementById('select-to-token'),
    switchTokens: document.getElementById('switch-tokens'),
    loadingIndicator: document.getElementById('loading-indicator')
  };

  // Initialize the application
  async function init() {
    await loadTokens();
    await initJupiter();
    setupEventListeners();
    setDefaultTokens();
  }

  // Load token list from Jupiter API
  async function loadTokens() {
    try {
      const response = await fetch('https://token.jup.ag/strict');
      state.tokens = await response.json();
      
      // Add SOL to the list if not present
      if (!state.tokens.some(t => t.symbol === 'SOL')) {
        state.tokens.unshift({
          chainId: 101,
          address: 'So11111111111111111111111111111111111111112',
          symbol: 'SOL',
          name: 'Solana',
          decimals: 9,
          logoURI: 'https://raw.githubusercontent.com/solana-labs/token-list/main/assets/mainnet/So11111111111111111111111111111111111111112/logo.png',
          tags: ['native']
        });
      }
    } catch (error) {
      console.error('Failed to load tokens:', error);
      // Fallback token list
      state.tokens = [{
        chainId: 101,
        address: 'So11111111111111111111111111111111111111112',
        symbol: 'SOL',
        name: 'Solana',
        decimals: 9,
        logoURI: 'https://raw.githubusercontent.com/solana-labs/token-list/main/assets/mainnet/So11111111111111111111111111111111111111112/logo.png',
        tags: ['native']
      }];
    }
  }

  // Initialize Jupiter SDK
  async function initJupiter() {
    state.jupiter = await Jupiter.load({
      connection: state.connection,
      cluster: 'mainnet-beta',
      user: state.wallet?.publicKey || null,
      wrapUnwrapSOL: true,
      platformFeeAndAccounts: undefined,
      routeCacheDuration: 10_000
    });
  }

  // Set default tokens
  function setDefaultTokens() {
    state.fromToken = state.tokens.find(t => t.symbol === 'SOL');
    state.toToken = state.tokens.find(t => t.symbol === 'USDC');
    
    updateTokenDisplay();
    updateBalances();
  }

  // Update token display in UI
  function updateTokenDisplay() {
    if (state.fromToken) {
      elements.fromTokenSymbol.textContent = state.fromToken.symbol;
      elements.fromTokenIcon.src = state.fromToken.logoURI || 'https://placeholder.com/token.png';
    }
    
    if (state.toToken) {
      elements.toTokenSymbol.textContent = state.toToken.symbol;
      elements.toTokenIcon.src = state.toToken.logoURI || 'https://placeholder.com/token.png';
    }
  }

  // Update balances
  async function updateBalances() {
    if (!state.wallet?.publicKey) return;
    
    try {
      // Update from token balance
      if (state.fromToken) {
        if (state.fromToken.symbol === 'SOL') {
          const balance = await state.connection.getBalance(state.wallet.publicKey);
          state.balances[state.fromToken.address] = balance / Math.pow(10, state.fromToken.decimals);
        } else {
          const account = await state.connection.getTokenAccountsByOwner(state.wallet.publicKey, {
            mint: new PublicKey(state.fromToken.address)
          });
          const balance = account.value[0]?.account.data.slice(64, 72) || new Uint8Array(8);
          state.balances[state.fromToken.address] = new BN(balance, 'le').toNumber() / Math.pow(10, state.fromToken.decimals);
        }
        elements.fromBalance.textContent = state.balances[state.fromToken.address]?.toFixed(4) || '0';
      }
      
      // Update to token balance
      if (state.toToken) {
        if (state.toToken.symbol === 'SOL') {
          const balance = await state.connection.getBalance(state.wallet.publicKey);
          state.balances[state.toToken.address] = balance / Math.pow(10, state.toToken.decimals);
        } else {
          const account = await state.connection.getTokenAccountsByOwner(state.wallet.publicKey, {
            mint: new PublicKey(state.toToken.address)
          });
          const balance = account.value[0]?.account.data.slice(64, 72) || new Uint8Array(8);
          state.balances[state.toToken.address] = new BN(balance, 'le').toNumber() / Math.pow(10, state.toToken.decimals);
        }
        elements.toBalance.textContent = state.balances[state.toToken.address]?.toFixed(4) || '0';
      }
    } catch (error) {
      console.error('Error updating balances:', error);
    }
  }

  // Calculate swap routes
  async function calculateRoutes() {
    if (!state.fromToken || !state.toToken || !elements.fromAmount.value) return;
    
    const amount = parseFloat(elements.fromAmount.value);
    if (isNaN(amount) || amount <= 0) return;
    
    const amountInLamports = Math.floor(amount * Math.pow(10, state.fromToken.decimals));
    
    try {
      state.routes = await state.jupiter.computeRoutes({
        inputMint: new PublicKey(state.fromToken.address),
        outputMint: new PublicKey(state.toToken.address),
        amount: amountInLamports,
        slippageBps: state.slippage * 100,
        onlyDirectRoutes: false
      });
      
      updateRouteInfo();
    } catch (error) {
      console.error('Route calculation failed:', error);
      state.routes = null;
      elements.toAmount.value = '';
      elements.exchangeRate.textContent = '-';
      elements.priceImpact.textContent = '-';
      elements.networkFee.textContent = '-';
    }
  }

  // Update route information in UI
  function updateRouteInfo() {
    if (!state.routes || state.routes.routesInfos.length === 0) {
      elements.toAmount.value = '';
      elements.exchangeRate.textContent = '-';
      elements.priceImpact.textContent = '-';
      elements.networkFee.textContent = '-';
      return;
    }
    
    const bestRoute = state.routes.routesInfos[0];
    const outAmount = bestRoute.outAmount / Math.pow(10, state.toToken.decimals);
    const inAmount = bestRoute.inAmount / Math.pow(10, state.fromToken.decimals);
    
    elements.toAmount.value = outAmount.toFixed(6);
    elements.exchangeRate.textContent = `1 ${state.fromToken.symbol} = ${(outAmount / inAmount).toFixed(6)} ${state.toToken.symbol}`;
    elements.priceImpact.textContent = `${(bestRoute.priceImpactPct * 100).toFixed(2)}%`;
    elements.networkFee.textContent = `${bestRoute.otherAmountThreshold / Math.pow(10, state.toToken.decimals)} ${state.toToken.symbol}`;
  }

  // Execute swap
  async function executeSwap() {
    if (!state.wallet || !state.routes || state.routes.routesInfos.length === 0) return;
    
    try {
      setLoading(true);
      
      const { execute } = await state.jupiter.exchange({
        routeInfo: state.routes.routesInfos[0]
      });
      
      const swapResult = await execute();
      
      if (swapResult.error) {
        throw new Error(swapResult.error);
      }
      
      // Show success
      alert(`Swap successful! Tx: ${swapResult.txid}`);
      
      // Refresh balances
      await updateBalances();
    } catch (error) {
      console.error('Swap failed:', error);
      alert(`Swap failed: ${error.message}`);
    } finally {
      setLoading(false);
    }
  }

  // Set loading state
  function setLoading(loading) {
    elements.loadingIndicator.style.display = loading ? 'flex' : 'none';
    elements.executeSwap.disabled = loading;
  }

  // Setup event listeners
  function setupEventListeners() {
    // Wallet connection
    elements.connectWallet.addEventListener('click', async () => {
      if (window.solana && window.solana.isPhantom) {
        try {
          const response = await window.solana.connect();
          state.wallet = window.solana;
          elements.connectWallet.textContent = `${response.publicKey.toString().slice(0, 4)}...${response.publicKey.toString().slice(-4)}`;
          elements.executeSwap.textContent = 'Swap';
          elements.executeSwap.disabled = false;
          await updateBalances();
        } catch (error) {
          console.error('Wallet connection failed:', error);
        }
      } else {
        alert('Phantom wallet not detected!');
      }
    });
    
    // Token selection
    elements.selectFromToken.addEventListener('click', () => {
      openTokenModal('from');
    });
    
    elements.selectToToken.addEventListener('click', () => {
      openTokenModal('to');
    });
    
    // Token modal
    elements.closeTokenModal.addEventListener('click', () => {
      elements.tokenModal.classList.add('hidden');
    });
    
    // Token search
    elements.tokenSearch.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filteredTokens = state.tokens.filter(token => 
        token.symbol.toLowerCase().includes(searchTerm) || 
        token.name.toLowerCase().includes(searchTerm) ||
        token.address.toLowerCase().includes(searchTerm)
      );
      
      renderTokenList(filteredTokens);
    });
    
    // Amount input
    elements.fromAmount.addEventListener('input', () => {
      calculateRoutes();
    });
    
    // Switch tokens
    elements.switchTokens.addEventListener('click', () => {
      const temp = state.fromToken;
      state.fromToken = state.toToken;
      state.toToken = temp;
      updateTokenDisplay();
      calculateRoutes();
      updateBalances();
    });
    
    // Execute swap
    elements.executeSwap.addEventListener('click', executeSwap);
  }

  // Open token selection modal
  function openTokenModal(target) {
    state.tokenSelectionTarget = target;
    elements.tokenModal.classList.remove('hidden');
    renderTokenList(state.tokens);
    elements.tokenSearch.value = '';
    elements.tokenSearch.focus();
  }

  // Render token list in modal
  function renderTokenList(tokens) {
    elements.tokenList.innerHTML = '';
    
    tokens.slice(0, 100).forEach(token => {
      const tokenElement = document.createElement('div');
      tokenElement.className = 'token-item flex items-center p-3 rounded-lg cursor-pointer';
      tokenElement.innerHTML = `
        <img src="${token.logoURI || 'https://placeholder.com/token.png'}" 
             class="w-8 h-8 rounded-full mr-3" 
             onerror="this.src='https://placeholder.com/token.png'">
        <div class="flex-1">
          <div class="font-medium">${token.symbol}</div>
          <div class="text-sm text-gray-400">${token.name}</div>
        </div>
      `;
      
      tokenElement.addEventListener('click', () => {
        if (state.tokenSelectionTarget === 'from') {
          state.fromToken = token;
        } else {
          state.toToken = token;
        }
        
        updateTokenDisplay();
        calculateRoutes();
        updateBalances();
        elements.tokenModal.classList.add('hidden');
      });
      
      elements.tokenList.appendChild(tokenElement);
    });
  }

  // Initialize the app
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>