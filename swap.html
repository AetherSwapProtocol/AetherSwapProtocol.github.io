<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SwapSolana - DEX 2025</title>
  <style>
    /* RESET & BASE */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
    body { background: #121212; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; padding: 20px; }
    button { cursor: pointer; border: none; border-radius: 6px; padding: 10px 20px; font-weight: bold; transition: all 0.3s; }
    button:hover { opacity: 0.9; }
    input, select { padding: 10px; border-radius: 6px; border: none; width: 100%; margin-bottom: 10px; }
    .container { max-width: 600px; width: 100%; background: #1e1e2f; padding: 30px; border-radius: 12px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); }
    h1 { text-align: center; margin-bottom: 20px; }
    .wallet-section, .swap-section, .profile-section { margin-bottom: 30px; }
    .token-select { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .token-select img { width: 32px; height: 32px; margin-right: 10px; }
    .swap-button { background: #ff7f50; color: #fff; width: 100%; font-size: 18px; }
    .history-item { background: #2a2a3d; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
    .notification { position: fixed; top: 20px; right: 20px; padding: 15px; border-radius: 8px; background: #ff7f50; color: #fff; font-weight: bold; display: none; }
  </style>
</head>
<body>

<div class="container">
  <h1>SwapSolana</h1>

  <!-- Wallet Section -->
  <div class="wallet-section">
    <h2>Connect Wallet</h2>
    <button id="connect-wallet">Connect Wallet</button>
    <div id="wallet-address" style="margin-top:10px;"></div>
    <div id="wallet-balance" style="margin-top:10px;"></div>
  </div>

  <!-- Swap Section -->
  <div class="swap-section">
    <h2>Swap Tokens</h2>
    <div class="token-select">
      <select id="from-token"></select>
      <input type="number" id="from-amount" placeholder="Amount"/>
    </div>
    <div class="token-select">
      <select id="to-token"></select>
      <input type="text" id="to-amount" placeholder="Estimated amount" disabled/>
    </div>
    <div>
      Slippage tolerance: 
      <input type="number" id="slippage" value="0.5" step="0.1"/>%
    </div>
    <button class="swap-button" id="swap-button">Swap</button>
  </div>

  <!-- Profile Section -->
  <div class="profile-section">
    <h2>Profile</h2>
    <div id="profile-info"></div>
  </div>

  <!-- History Section -->
  <div class="history-section">
    <h2>Swap History</h2>
    <div id="history-list"></div>
  </div>
</div>

<div class="notification" id="notification"></div>

<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.79.2/lib/index.iife.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@jup-ag/core@4.5.0/dist/jupiter-iife.min.js"></script>
<script>
  // INIT
  const { Connection, PublicKey } = solanaWeb3;
  let wallet = null;
  const connection = new Connection("https://api.mainnet-beta.solana.com");

  const notification = document.getElementById('notification');
  function showNotification(msg, duration=3000) {
    notification.textContent = msg;
    notification.style.display = 'block';
    setTimeout(()=>{notification.style.display='none'}, duration);
  }

  async function connectWallet() {
    if(window.solana && window.solana.isPhantom) {
      wallet = window.solana;
      try {
        const resp = await wallet.connect();
        document.getElementById('wallet-address').innerText = `Address: ${resp.publicKey.toString()}`;
        const balance = await connection.getBalance(resp.publicKey);
        document.getElementById('wallet-balance').innerText = `Balance: ${(balance/1e9).toFixed(4)} SOL`;
        showNotification("Wallet connected!");
      } catch(e) { showNotification("Connection failed"); }
    } else {
      showNotification("Wallet not found");
    }
  }

  document.getElementById('connect-wallet').addEventListener('click', connectWallet);

  // LOAD TOKENS FROM JUPITER API
  let tokens = [];
  async function loadTokens() {
    try {
      const res = await fetch("https://quote-api.jup.ag/v4/tokens");
      tokens = await res.json();
      const fromSelect = document.getElementById('from-token');
      const toSelect = document.getElementById('to-token');
      tokens.forEach(t=>{
        const option1 = document.createElement('option');
        option1.value = t.address; option1.text = t.symbol;
        fromSelect.appendChild(option1);
        const option2 = document.createElement('option');
        option2.value = t.address; option2.text = t.symbol;
        toSelect.appendChild(option2);
      });
    } catch(e) { showNotification("Failed to load tokens") }
  }
  loadTokens();

  // ESTIMATE SWAP
  async function estimateSwap() {
    const from = document.getElementById('from-token').value;
    const to = document.getElementById('to-token').value;
    const amount = parseFloat(document.getElementById('from-amount').value);
    const slippage = parseFloat(document.getElementById('slippage').value);

    if(!from || !to || !amount) return;

    try {
      const jup = await Jupiter.load({connection, cluster:"mainnet-beta", user: wallet.publicKey});
      const routes = await jup.computeRoutes({inputMint:from, outputMint:to, amount: amount*1e9, slippage:slippage});
      if(routes.routesInfos.length>0) {
        const best = routes.routesInfos[0];
        document.getElementById('to-amount').value = (best.outAmount/1e9).toFixed(6);
      }
    } catch(e) { console.error(e); }
  }

  document.getElementById('from-amount').addEventListener('input', estimateSwap);
  document.getElementById('from-token').addEventListener('change', estimateSwap);
  document.getElementById('to-token').addEventListener('change', estimateSwap);

  // EXECUTE SWAP
  async function executeSwap() {
    if(!wallet) { showNotification("Connect wallet first!"); return; }
    const from = document.getElementById('from-token').value;
    const to = document.getElementById('to-token').value;
    const amount = parseFloat(document.getElementById('from-amount').value);
    const slippage = parseFloat(document.getElementById('slippage').value);
    if(!from || !to || !amount) return showNotification("Invalid input");

    try {
      const jup = await Jupiter.load({connection, cluster:"mainnet-beta", user: wallet.publicKey});
      const routes = await jup.computeRoutes({inputMint:from, outputMint:to, amount: amount*1e9, slippage:slippage});
      if(routes.routesInfos.length==0) return showNotification("No route found");

      const bestRoute = routes.routesInfos[0];
      const swapTx = await jup.exchange({route: bestRoute});
      const txid = await connection.sendRawTransaction(swapTx.serialize());
      await connection.confirmTransaction(txid);
      showNotification("Swap executed: "+txid);

      const historyList = document.getElementById('history-list');
      const item = document.createElement('div'); item.className="history-item";
      item.innerText = `Swapped ${amount} ${tokens.find(t=>t.address===from).symbol} â†’ ${(bestRoute.outAmount/1e9).toFixed(6)} ${tokens.find(t=>t.address===to).symbol} (Tx: ${txid})`;
      historyList.prepend(item);

      // Update balance
      const balance = await connection.getBalance(wallet.publicKey);
      document.getElementById('wallet-balance').innerText = `Balance: ${(balance/1e9).toFixed(4)} SOL`;

    } catch(e) {
      console.error(e);
      showNotification("Swap failed");
    }
  }

  document.getElementById('swap-button').addEventListener('click', executeSwap);

</script>
</body>
</html>