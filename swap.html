<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AetherSwap | Swap Interface</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@solana/web3.js@1.70.1/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      font-family: 'Space Grotesk', sans-serif;
      background: #0a0a0a;
      color: white;
    }
    .gradient-text {
      background: linear-gradient(90deg, #7e22ce 0%, #3b82f6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .token-selector {
      min-width: 140px;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Navigation Bar -->
  <nav class="container mx-auto px-6 py-4 flex justify-between items-center border-b border-gray-800">
    <!-- Back button to index.html -->
    <a href="index.html" class="flex items-center space-x-2 hover:text-purple-400 transition">
      <div class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-700 to-blue-500 flex items-center justify-center">
        <i class="fas fa-arrow-left text-white"></i>
      </div>
      <span class="text-xl font-bold gradient-text">Back</span>
    </a>
    
    <!-- Phantom Wallet Connection Button -->
    <button id="walletBtn" class="flex items-center space-x-2 bg-gray-800 px-4 py-2 rounded-full cursor-pointer hover:bg-gray-700 transition">
      <i class="fas fa-wallet text-purple-400"></i>
      <span id="walletAddress">Connect Wallet</span>
    </button>
  </nav>

  <!-- Main Swap Interface -->
  <main class="container mx-auto px-4 py-8 max-w-md flex-grow flex flex-col space-y-6">
    <h1 class="text-3xl font-bold text-center mb-6 gradient-text">Swap Tokens</h1>

    <!-- From Token Section -->
    <div class="bg-gray-900 rounded-2xl p-6 shadow-xl border border-gray-800 space-y-4">
      <div>
        <label for="fromToken" class="block text-gray-400 mb-1 font-semibold">From</label>
        <div class="flex items-center space-x-3">
          <input
            id="fromAmount"
            type="number"
            min="0"
            step="any"
            placeholder="0.0"
            class="bg-transparent text-2xl w-full focus:outline-none text-white placeholder-gray-500"
          />
          <button id="selectFromToken" class="token-selector flex items-center space-x-2 bg-gray-800 px-4 py-2 rounded-lg hover:bg-gray-700 transition">
            <img id="fromTokenLogo" src="https://cryptologos.cc/logos/solana-sol-logo.png" alt="SOL" class="w-6 h-6 rounded-full" />
            <span id="fromTokenSymbol">SOL</span>
            <i class="fas fa-chevron-down text-xs"></i>
          </button>
        </div>
        <p id="fromBalance" class="text-gray-500 text-sm mt-1">Balance: 0.0</p>
      </div>

      <!-- Switch Tokens Button -->
      <div class="flex justify-center my-2">
        <button id="switchTokens" class="bg-gray-800 p-2 rounded-full hover:bg-gray-700 transition" title="Switch tokens">
          <i class="fas fa-arrow-down text-purple-500"></i>
        </button>
      </div>

      <!-- To Token Section -->
      <div>
        <label for="toToken" class="block text-gray-400 mb-1 font-semibold">To</label>
        <div class="flex items-center space-x-3">
          <input
            id="toAmount"
            type="number"
            min="0"
            step="any"
            placeholder="0.0"
            class="bg-transparent text-2xl w-full focus:outline-none text-white placeholder-gray-500"
            disabled
          />
          <button id="selectToToken" class="token-selector flex items-center space-x-2 bg-gray-800 px-4 py-2 rounded-lg hover:bg-gray-700 transition">
            <img id="toTokenLogo" src="https://cryptologos.cc/logos/usd-coin-usdc-logo.png" alt="USDC" class="w-6 h-6 rounded-full" />
            <span id="toTokenSymbol">USDC</span>
            <i class="fas fa-chevron-down text-xs"></i>
          </button>
        </div>
        <p id="toBalance" class="text-gray-500 text-sm mt-1">Balance: 0.0</p>
      </div>

      <!-- Price Information -->
      <div id="priceInfo" class="mb-4 p-3 bg-gray-800 rounded-lg text-sm text-center text-gray-300 min-h-[48px]">
        Enter an amount to see live price
      </div>

      <!-- Swap Button -->
      <button
        id="swapBtn"
        disabled
        class="w-full bg-gradient-to-r from-purple-600 to-blue-500 py-3 rounded-xl font-bold text-white hover:opacity-90 transition disabled:opacity-50"
      >
        Connect Wallet to Swap
      </button>
    </div>
  </main>

  <!-- Disclaimer Footer -->
  <footer class="container mx-auto px-6 py-4 text-xs text-gray-500 border-t border-gray-800 text-center">
    <p>
      ⚠️ <strong>AetherSwap</strong> is an experimental project.<br />
      Use at your own risk. We are not responsible for any losses.<br />
      By using this service, you agree to our <a href="#" class="underline text-purple-400">terms of use</a>.
    </p>
  </footer>

  <script>
    // ========== CONFIGURATION & CONSTANTS ========== //
    const connection = new solanaWeb3.Connection(
      "https://api.mainnet-beta.solana.com"
    );
    let wallet = null;
    const JUPITER_API = "https://quote-api.jup.ag/v6";

    // Supported tokens with their metadata
    const tokens = {
      SOL: {
        mint: "So11111111111111111111111111111111111111112",
        symbol: "SOL",
        decimals: 9,
        logo: "https://cryptologos.cc/logos/solana-sol-logo.png",
      },
      USDC: {
        mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
        symbol: "USDC",
        decimals: 6,
        logo: "https://cryptologos.cc/logos/usd-coin-usdc-logo.png",
      },
      USDT: {
        mint: "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB",
        symbol: "USDT",
        decimals: 6,
        logo: "https://cryptologos.cc/logos/tether-usdt-logo.png",
      },
      BONK: {
        mint: "DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263",
        symbol: "BONK",
        decimals: 5,
        logo: "https://arweave.net/hQiPZOsRZXGXBJd_82PhVdlM_hACsT_q6wqwf5cSY7I",
      },
    };

    // ========== DOM ELEMENTS ========== //
    const walletBtn = document.getElementById("walletBtn");
    const walletAddressSpan = document.getElementById("walletAddress");

    const fromAmountInput = document.getElementById("fromAmount");
    const fromTokenBtn = document.getElementById("selectFromToken");
    const fromTokenLogo = document.getElementById("fromTokenLogo");
    const fromTokenSymbol = document.getElementById("fromTokenSymbol");
    const fromBalanceText = document.getElementById("fromBalance");

    const toAmountInput = document.getElementById("toAmount");
    const toTokenBtn = document.getElementById("selectToToken");
    const toTokenLogo = document.getElementById("toTokenLogo");
    const toTokenSymbol = document.getElementById("toTokenSymbol");
    const toBalanceText = document.getElementById("toBalance");

    const switchTokensBtn = document.getElementById("switchTokens");
    const priceInfoDiv = document.getElementById("priceInfo");
    const swapBtn = document.getElementById("swapBtn");

    // ========== STATE VARIABLES ========== //
    let fromToken = tokens.SOL;
    let toToken = tokens.USDC;
    let walletPublicKey = null;
    let tokenBalances = {};

    // ========== UTILITY FUNCTIONS ========== //
    function shortenAddress(address) {
      return address.slice(0, 4) + "..." + address.slice(-4);
    }

    function formatBalance(balance, decimals) {
      return (balance / Math.pow(10, decimals)).toFixed(4);
    }

    // Update token display in the UI
    function updateTokenUI() {
      fromTokenLogo.src = fromToken.logo;
      fromTokenSymbol.textContent = fromToken.symbol;
      toTokenLogo.src = toToken.logo;
      toTokenSymbol.textContent = toToken.symbol;

      // Update balances if we have them
      if (tokenBalances[fromToken.symbol]) {
        fromBalanceText.textContent = `Balance: ${formatBalance(tokenBalances[fromToken.symbol], fromToken.decimals)}`;
      } else {
        fromBalanceText.textContent = "Balance: -";
      }

      if (tokenBalances[toToken.symbol]) {
        toBalanceText.textContent = `Balance: ${formatBalance(tokenBalances[toToken.symbol], toToken.decimals)}`;
      } else {
        toBalanceText.textContent = "Balance: -";
      }

      // Reset amounts and price info
      fromAmountInput.value = "";
      toAmountInput.value = "";
      priceInfoDiv.textContent = "Enter an amount to see live price";
    }

    // ========== WALLET CONNECTION ========== //
    async function connectWallet() {
      try {
        // Check if Phantom is installed
        if (window.solana && window.solana.isPhantom) {
          wallet = window.solana;
          
          // Connect to wallet
          const response = await wallet.connect({ onlyIfTrusted: true });
          walletPublicKey = wallet.publicKey.toString();
          
          // Update UI
          walletAddressSpan.textContent = shortenAddress(walletPublicKey);
          swapBtn.disabled = false;
          swapBtn.textContent = "Swap Now";

          // Refresh token balances
          await refreshBalances();
        } else {
          alert("Phantom wallet not found! Please install it from https://phantom.app/");
        }
      } catch (error) {
        console.error("Wallet connection error:", error);
        alert("Failed to connect wallet. Please try again.");
      }
    }

    // ========== TOKEN BALANCES ========== //
    async function refreshBalances() {
      if (!walletPublicKey) return;

      try {
        const publicKey = new solanaWeb3.PublicKey(walletPublicKey);
        
        // Get SOL balance
        const solBalance = await connection.getBalance(publicKey);
        tokenBalances.SOL = solBalance;

        // Get token balances (for other tokens)
        // Note: In a real app, you'd want to implement proper token account detection
        // This is simplified for demonstration
        updateTokenUI();
      } catch (error) {
        console.error("Error fetching balances:", error);
      }
    }

    // ========== PRICE QUOTES ========== //
    async function fetchQuote(amount) {
      if (!amount || amount <= 0) {
        priceInfoDiv.textContent = "Enter an amount to see live price";
        toAmountInput.value = "";
        return;
      }

      try {
        // Convert amount to proper decimals
        const amountInDecimals = Math.floor(amount * Math.pow(10, fromToken.decimals));
        
        // Fetch quote from Jupiter API
        const response = await axios.get(`${JUPITER_API}/quote`, {
          params: {
            inputMint: fromToken.mint,
            outputMint: toToken.mint,
            amount: amountInDecimals,
            slippageBps: 50 // 0.5% slippage
          }
        });

        const quote = response.data;
        
        // Update UI with quote
        const outAmount = (quote.outAmount / Math.pow(10, toToken.decimals)).toFixed(6);
        toAmountInput.value = outAmount;
        
        // Calculate and display price impact
        const priceImpact = quote.priceImpactPct * 100;
        const pricePerToken = (amount / outAmount).toFixed(6);
        
        priceInfoDiv.innerHTML = `
          Price: 1 ${fromToken.symbol} = ${pricePerToken} ${toToken.symbol}<br>
          Price Impact: ${priceImpact.toFixed(2)}%
        `;
      } catch (error) {
        console.error("Error fetching quote:", error);
        priceInfoDiv.textContent = "Error fetching price. Try again later.";
        toAmountInput.value = "";
      }
    }

    // ========== SWAP EXECUTION ========== //
    async function executeSwap() {
      if (!walletPublicKey || !fromAmountInput.value || !toAmountInput.value) {
        alert("Please connect wallet and enter an amount");
        return;
      }

      try {
        swapBtn.disabled = true;
        swapBtn.textContent = "Processing...";

        // Get swap transaction from Jupiter API
        const amountInDecimals = Math.floor(parseFloat(fromAmountInput.value) * Math.pow(10, fromToken.decimals));
        
        const quoteResponse = await axios.post(`${JUPITER_API}/swap`, {
          quoteResponse: {
            inputMint: fromToken.mint,
            outputMint: toToken.mint,
            inAmount: amountInDecimals.toString(),
            outAmount: (parseFloat(toAmountInput.value) * Math.pow(10, toToken.decimals)).toString(),
          },
          userPublicKey: walletPublicKey,
          slippageBps: 50
        });

        const { swapTransaction } = quoteResponse.data;

        // Send transaction
        const transaction = solanaWeb3.VersionedTransaction.deserialize(
          Buffer.from(swapTransaction, 'base64')
        );
        
        // Sign and send
        const signedTx = await wallet.signTransaction(transaction);
        const signature = await connection.sendRawTransaction(signedTx.serialize());
        
        // Confirm transaction
        const confirmation = await connection.confirmTransaction(signature);
        
        if (confirmation.value.err) {
          throw new Error("Transaction failed");
        }

        alert(`Swap successful! Transaction: ${signature}`);
        
        // Refresh balances after swap
        await refreshBalances();
      } catch (error) {
        console.error("Swap error:", error);
        alert("Swap failed. Please try again.");
      } finally {
        swapBtn.disabled = false;
        swapBtn.textContent = "Swap Now";
      }
    }

    // ========== EVENT LISTENERS ========== //
    walletBtn.addEventListener('click', connectWallet);
    swapBtn.addEventListener('click', executeSwap);

    // Switch tokens button
    switchTokensBtn.addEventListener('click', () => {
      [fromToken, toToken] = [toToken, fromToken];
      updateTokenUI();
      
      // If there's an amount, requote with swapped tokens
      if (fromAmountInput.value) {
        fetchQuote(fromAmountInput.value);
      }
    });

    // From amount input - debounce to avoid too many API calls
    let debounceTimer;
    fromAmountInput.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        fetchQuote(fromAmountInput.value);
      }, 500);
    });

    // Token selection buttons (simplified - would normally open a modal)
    fromTokenBtn.addEventListener('click', () => {
      alert("Token selector would open here. Demo shows SOL and USDC only.");
    });

    toTokenBtn.addEventListener('click', () => {
      alert("Token selector would open here. Demo shows SOL and USDC only.");
    });

    // Initialize UI
    updateTokenUI();
  </script>
</body>
</html>